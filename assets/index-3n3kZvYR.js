var Ve=Object.defineProperty;var $e=(R,a,i)=>a in R?Ve(R,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):R[a]=i;var A=(R,a,i)=>$e(R,typeof a!="symbol"?a+"":a,i);(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))p(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const s of e.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&p(s)}).observe(document,{childList:!0,subtree:!0});function i(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function p(n){if(n.ep)return;n.ep=!0;const e=i(n);fetch(n.href,e)}})();var Ee=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function He(R){return R&&R.__esModule&&Object.prototype.hasOwnProperty.call(R,"default")?R.default:R}var le={exports:{}};/*!
 * matter-js 0.20.0 by @liabru
 * http://brm.io/matter-js/
 * License MIT
 * 
 * The MIT License (MIT)
 * 
 * Copyright (c) Liam Brummitt and contributors.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */var We=le.exports,Se;function Qe(){return Se||(Se=1,function(R,a){(function(p,n){R.exports=n()})(We,function(){return function(i){var p={};function n(e){if(p[e])return p[e].exports;var s=p[e]={i:e,l:!1,exports:{}};return i[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=i,n.c=p,n.d=function(e,s,r){n.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:r})},n.r=function(e){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,s){if(s&1&&(e=n(e)),s&8||s&4&&typeof e=="object"&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),s&2&&typeof e!="string")for(var o in e)n.d(r,o,(function(d){return e[d]}).bind(null,o));return r},n.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(s,"a",s),s},n.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},n.p="",n(n.s=20)}([function(i,p){var n={};i.exports=n,function(){n._baseDelta=1e3/60,n._nextId=0,n._seed=0,n._nowStartTime=+new Date,n._warnedOnce={},n._decomp=null,n.extend=function(s,r){var o,d;typeof r=="boolean"?(o=2,d=r):(o=1,d=!0);for(var l=o;l<arguments.length;l++){var g=arguments[l];if(g)for(var h in g)d&&g[h]&&g[h].constructor===Object&&(!s[h]||s[h].constructor===Object)?(s[h]=s[h]||{},n.extend(s[h],d,g[h])):s[h]=g[h]}return s},n.clone=function(s,r){return n.extend({},r,s)},n.keys=function(s){if(Object.keys)return Object.keys(s);var r=[];for(var o in s)r.push(o);return r},n.values=function(s){var r=[];if(Object.keys){for(var o=Object.keys(s),d=0;d<o.length;d++)r.push(s[o[d]]);return r}for(var l in s)r.push(s[l]);return r},n.get=function(s,r,o,d){r=r.split(".").slice(o,d);for(var l=0;l<r.length;l+=1)s=s[r[l]];return s},n.set=function(s,r,o,d,l){var g=r.split(".").slice(d,l);return n.get(s,r,0,-1)[g[g.length-1]]=o,o},n.shuffle=function(s){for(var r=s.length-1;r>0;r--){var o=Math.floor(n.random()*(r+1)),d=s[r];s[r]=s[o],s[o]=d}return s},n.choose=function(s){return s[Math.floor(n.random()*s.length)]},n.isElement=function(s){return typeof HTMLElement<"u"?s instanceof HTMLElement:!!(s&&s.nodeType&&s.nodeName)},n.isArray=function(s){return Object.prototype.toString.call(s)==="[object Array]"},n.isFunction=function(s){return typeof s=="function"},n.isPlainObject=function(s){return typeof s=="object"&&s.constructor===Object},n.isString=function(s){return toString.call(s)==="[object String]"},n.clamp=function(s,r,o){return s<r?r:s>o?o:s},n.sign=function(s){return s<0?-1:1},n.now=function(){if(typeof window<"u"&&window.performance){if(window.performance.now)return window.performance.now();if(window.performance.webkitNow)return window.performance.webkitNow()}return Date.now?Date.now():new Date-n._nowStartTime},n.random=function(s,r){return s=typeof s<"u"?s:0,r=typeof r<"u"?r:1,s+e()*(r-s)};var e=function(){return n._seed=(n._seed*9301+49297)%233280,n._seed/233280};n.colorToNumber=function(s){return s=s.replace("#",""),s.length==3&&(s=s.charAt(0)+s.charAt(0)+s.charAt(1)+s.charAt(1)+s.charAt(2)+s.charAt(2)),parseInt(s,16)},n.logLevel=1,n.log=function(){console&&n.logLevel>0&&n.logLevel<=3&&console.log.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},n.info=function(){console&&n.logLevel>0&&n.logLevel<=2&&console.info.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},n.warn=function(){console&&n.logLevel>0&&n.logLevel<=3&&console.warn.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},n.warnOnce=function(){var s=Array.prototype.slice.call(arguments).join(" ");n._warnedOnce[s]||(n.warn(s),n._warnedOnce[s]=!0)},n.deprecated=function(s,r,o){s[r]=n.chain(function(){n.warnOnce("🔅 deprecated 🔅",o)},s[r])},n.nextId=function(){return n._nextId++},n.indexOf=function(s,r){if(s.indexOf)return s.indexOf(r);for(var o=0;o<s.length;o++)if(s[o]===r)return o;return-1},n.map=function(s,r){if(s.map)return s.map(r);for(var o=[],d=0;d<s.length;d+=1)o.push(r(s[d]));return o},n.topologicalSort=function(s){var r=[],o=[],d=[];for(var l in s)!o[l]&&!d[l]&&n._topologicalSort(l,o,d,s,r);return r},n._topologicalSort=function(s,r,o,d,l){var g=d[s]||[];o[s]=!0;for(var h=0;h<g.length;h+=1){var t=g[h];o[t]||r[t]||n._topologicalSort(t,r,o,d,l)}o[s]=!1,r[s]=!0,l.push(s)},n.chain=function(){for(var s=[],r=0;r<arguments.length;r+=1){var o=arguments[r];o._chained?s.push.apply(s,o._chained):s.push(o)}var d=function(){for(var l,g=new Array(arguments.length),h=0,t=arguments.length;h<t;h++)g[h]=arguments[h];for(h=0;h<s.length;h+=1){var u=s[h].apply(l,g);typeof u<"u"&&(l=u)}return l};return d._chained=s,d},n.chainPathBefore=function(s,r,o){return n.set(s,r,n.chain(o,n.get(s,r)))},n.chainPathAfter=function(s,r,o){return n.set(s,r,n.chain(n.get(s,r),o))},n.setDecomp=function(s){n._decomp=s},n.getDecomp=function(){var s=n._decomp;try{!s&&typeof window<"u"&&(s=window.decomp),!s&&typeof Ee<"u"&&(s=Ee.decomp)}catch{s=null}return s}}()},function(i,p){var n={};i.exports=n,function(){n.create=function(e){var s={min:{x:0,y:0},max:{x:0,y:0}};return e&&n.update(s,e),s},n.update=function(e,s,r){e.min.x=1/0,e.max.x=-1/0,e.min.y=1/0,e.max.y=-1/0;for(var o=0;o<s.length;o++){var d=s[o];d.x>e.max.x&&(e.max.x=d.x),d.x<e.min.x&&(e.min.x=d.x),d.y>e.max.y&&(e.max.y=d.y),d.y<e.min.y&&(e.min.y=d.y)}r&&(r.x>0?e.max.x+=r.x:e.min.x+=r.x,r.y>0?e.max.y+=r.y:e.min.y+=r.y)},n.contains=function(e,s){return s.x>=e.min.x&&s.x<=e.max.x&&s.y>=e.min.y&&s.y<=e.max.y},n.overlaps=function(e,s){return e.min.x<=s.max.x&&e.max.x>=s.min.x&&e.max.y>=s.min.y&&e.min.y<=s.max.y},n.translate=function(e,s){e.min.x+=s.x,e.max.x+=s.x,e.min.y+=s.y,e.max.y+=s.y},n.shift=function(e,s){var r=e.max.x-e.min.x,o=e.max.y-e.min.y;e.min.x=s.x,e.max.x=s.x+r,e.min.y=s.y,e.max.y=s.y+o}}()},function(i,p){var n={};i.exports=n,function(){n.create=function(e,s){return{x:e||0,y:s||0}},n.clone=function(e){return{x:e.x,y:e.y}},n.magnitude=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},n.magnitudeSquared=function(e){return e.x*e.x+e.y*e.y},n.rotate=function(e,s,r){var o=Math.cos(s),d=Math.sin(s);r||(r={});var l=e.x*o-e.y*d;return r.y=e.x*d+e.y*o,r.x=l,r},n.rotateAbout=function(e,s,r,o){var d=Math.cos(s),l=Math.sin(s);o||(o={});var g=r.x+((e.x-r.x)*d-(e.y-r.y)*l);return o.y=r.y+((e.x-r.x)*l+(e.y-r.y)*d),o.x=g,o},n.normalise=function(e){var s=n.magnitude(e);return s===0?{x:0,y:0}:{x:e.x/s,y:e.y/s}},n.dot=function(e,s){return e.x*s.x+e.y*s.y},n.cross=function(e,s){return e.x*s.y-e.y*s.x},n.cross3=function(e,s,r){return(s.x-e.x)*(r.y-e.y)-(s.y-e.y)*(r.x-e.x)},n.add=function(e,s,r){return r||(r={}),r.x=e.x+s.x,r.y=e.y+s.y,r},n.sub=function(e,s,r){return r||(r={}),r.x=e.x-s.x,r.y=e.y-s.y,r},n.mult=function(e,s){return{x:e.x*s,y:e.y*s}},n.div=function(e,s){return{x:e.x/s,y:e.y/s}},n.perp=function(e,s){return s=s===!0?-1:1,{x:s*-e.y,y:s*e.x}},n.neg=function(e){return{x:-e.x,y:-e.y}},n.angle=function(e,s){return Math.atan2(s.y-e.y,s.x-e.x)},n._temp=[n.create(),n.create(),n.create(),n.create(),n.create(),n.create()]}()},function(i,p,n){var e={};i.exports=e;var s=n(2),r=n(0);(function(){e.create=function(o,d){for(var l=[],g=0;g<o.length;g++){var h=o[g],t={x:h.x,y:h.y,index:g,body:d,isInternal:!1};l.push(t)}return l},e.fromPath=function(o,d){var l=/L?\s*([-\d.e]+)[\s,]*([-\d.e]+)*/ig,g=[];return o.replace(l,function(h,t,u){g.push({x:parseFloat(t),y:parseFloat(u)})}),e.create(g,d)},e.centre=function(o){for(var d=e.area(o,!0),l={x:0,y:0},g,h,t,u=0;u<o.length;u++)t=(u+1)%o.length,g=s.cross(o[u],o[t]),h=s.mult(s.add(o[u],o[t]),g),l=s.add(l,h);return s.div(l,6*d)},e.mean=function(o){for(var d={x:0,y:0},l=0;l<o.length;l++)d.x+=o[l].x,d.y+=o[l].y;return s.div(d,o.length)},e.area=function(o,d){for(var l=0,g=o.length-1,h=0;h<o.length;h++)l+=(o[g].x-o[h].x)*(o[g].y+o[h].y),g=h;return d?l/2:Math.abs(l)/2},e.inertia=function(o,d){for(var l=0,g=0,h=o,t,u,c=0;c<h.length;c++)u=(c+1)%h.length,t=Math.abs(s.cross(h[u],h[c])),l+=t*(s.dot(h[u],h[u])+s.dot(h[u],h[c])+s.dot(h[c],h[c])),g+=t;return d/6*(l/g)},e.translate=function(o,d,l){l=typeof l<"u"?l:1;var g=o.length,h=d.x*l,t=d.y*l,u;for(u=0;u<g;u++)o[u].x+=h,o[u].y+=t;return o},e.rotate=function(o,d,l){if(d!==0){var g=Math.cos(d),h=Math.sin(d),t=l.x,u=l.y,c=o.length,f,y,E,S;for(S=0;S<c;S++)f=o[S],y=f.x-t,E=f.y-u,f.x=t+(y*g-E*h),f.y=u+(y*h+E*g);return o}},e.contains=function(o,d){for(var l=d.x,g=d.y,h=o.length,t=o[h-1],u,c=0;c<h;c++){if(u=o[c],(l-t.x)*(u.y-t.y)+(g-t.y)*(t.x-u.x)>0)return!1;t=u}return!0},e.scale=function(o,d,l,g){if(d===1&&l===1)return o;g=g||e.centre(o);for(var h,t,u=0;u<o.length;u++)h=o[u],t=s.sub(h,g),o[u].x=g.x+t.x*d,o[u].y=g.y+t.y*l;return o},e.chamfer=function(o,d,l,g,h){typeof d=="number"?d=[d]:d=d||[8],l=typeof l<"u"?l:-1,g=g||2,h=h||14;for(var t=[],u=0;u<o.length;u++){var c=o[u-1>=0?u-1:o.length-1],f=o[u],y=o[(u+1)%o.length],E=d[u<d.length?u:d.length-1];if(E===0){t.push(f);continue}var S=s.normalise({x:f.y-c.y,y:c.x-f.x}),T=s.normalise({x:y.y-f.y,y:f.x-y.x}),m=Math.sqrt(2*Math.pow(E,2)),x=s.mult(r.clone(S),E),C=s.normalise(s.mult(s.add(S,T),.5)),v=s.sub(f,s.mult(C,m)),w=l;l===-1&&(w=Math.pow(E,.32)*1.75),w=r.clamp(w,g,h),w%2===1&&(w+=1);for(var M=Math.acos(s.dot(S,T)),L=M/w,I=0;I<w;I++)t.push(s.add(s.rotate(x,L*I),v))}return t},e.clockwiseSort=function(o){var d=e.mean(o);return o.sort(function(l,g){return s.angle(d,l)-s.angle(d,g)}),o},e.isConvex=function(o){var d=0,l=o.length,g,h,t,u;if(l<3)return null;for(g=0;g<l;g++)if(h=(g+1)%l,t=(g+2)%l,u=(o[h].x-o[g].x)*(o[t].y-o[h].y),u-=(o[h].y-o[g].y)*(o[t].x-o[h].x),u<0?d|=1:u>0&&(d|=2),d===3)return!1;return d!==0?!0:null},e.hull=function(o){var d=[],l=[],g,h;for(o=o.slice(0),o.sort(function(t,u){var c=t.x-u.x;return c!==0?c:t.y-u.y}),h=0;h<o.length;h+=1){for(g=o[h];l.length>=2&&s.cross3(l[l.length-2],l[l.length-1],g)<=0;)l.pop();l.push(g)}for(h=o.length-1;h>=0;h-=1){for(g=o[h];d.length>=2&&s.cross3(d[d.length-2],d[d.length-1],g)<=0;)d.pop();d.push(g)}return d.pop(),l.pop(),d.concat(l)}})()},function(i,p,n){var e={};i.exports=e;var s=n(3),r=n(2),o=n(7),d=n(0),l=n(1),g=n(11);(function(){e._timeCorrection=!0,e._inertiaScale=4,e._nextCollidingGroupId=1,e._nextNonCollidingGroupId=-1,e._nextCategory=1,e._baseDelta=1e3/60,e.create=function(t){var u={id:d.nextId(),type:"body",label:"Body",parts:[],plugin:{},angle:0,vertices:s.fromPath("L 0 0 L 40 0 L 40 40 L 0 40"),position:{x:0,y:0},force:{x:0,y:0},torque:0,positionImpulse:{x:0,y:0},constraintImpulse:{x:0,y:0,angle:0},totalContacts:0,speed:0,angularSpeed:0,velocity:{x:0,y:0},angularVelocity:0,isSensor:!1,isStatic:!1,isSleeping:!1,motion:0,sleepThreshold:60,density:.001,restitution:0,friction:.1,frictionStatic:.5,frictionAir:.01,collisionFilter:{category:1,mask:4294967295,group:0},slop:.05,timeScale:1,render:{visible:!0,opacity:1,strokeStyle:null,fillStyle:null,lineWidth:null,sprite:{xScale:1,yScale:1,xOffset:0,yOffset:0}},events:null,bounds:null,chamfer:null,circleRadius:0,positionPrev:null,anglePrev:0,parent:null,axes:null,area:0,mass:0,inertia:0,deltaTime:16.666666666666668,_original:null},c=d.extend(u,t);return h(c,t),c},e.nextGroup=function(t){return t?e._nextNonCollidingGroupId--:e._nextCollidingGroupId++},e.nextCategory=function(){return e._nextCategory=e._nextCategory<<1,e._nextCategory};var h=function(t,u){u=u||{},e.set(t,{bounds:t.bounds||l.create(t.vertices),positionPrev:t.positionPrev||r.clone(t.position),anglePrev:t.anglePrev||t.angle,vertices:t.vertices,parts:t.parts||[t],isStatic:t.isStatic,isSleeping:t.isSleeping,parent:t.parent||t}),s.rotate(t.vertices,t.angle,t.position),g.rotate(t.axes,t.angle),l.update(t.bounds,t.vertices,t.velocity),e.set(t,{axes:u.axes||t.axes,area:u.area||t.area,mass:u.mass||t.mass,inertia:u.inertia||t.inertia});var c=t.isStatic?"#14151f":d.choose(["#f19648","#f5d259","#f55a3c","#063e7b","#ececd1"]),f=t.isStatic?"#555":"#ccc",y=t.isStatic&&t.render.fillStyle===null?1:0;t.render.fillStyle=t.render.fillStyle||c,t.render.strokeStyle=t.render.strokeStyle||f,t.render.lineWidth=t.render.lineWidth||y,t.render.sprite.xOffset+=-(t.bounds.min.x-t.position.x)/(t.bounds.max.x-t.bounds.min.x),t.render.sprite.yOffset+=-(t.bounds.min.y-t.position.y)/(t.bounds.max.y-t.bounds.min.y)};e.set=function(t,u,c){var f;typeof u=="string"&&(f=u,u={},u[f]=c);for(f in u)if(Object.prototype.hasOwnProperty.call(u,f))switch(c=u[f],f){case"isStatic":e.setStatic(t,c);break;case"isSleeping":o.set(t,c);break;case"mass":e.setMass(t,c);break;case"density":e.setDensity(t,c);break;case"inertia":e.setInertia(t,c);break;case"vertices":e.setVertices(t,c);break;case"position":e.setPosition(t,c);break;case"angle":e.setAngle(t,c);break;case"velocity":e.setVelocity(t,c);break;case"angularVelocity":e.setAngularVelocity(t,c);break;case"speed":e.setSpeed(t,c);break;case"angularSpeed":e.setAngularSpeed(t,c);break;case"parts":e.setParts(t,c);break;case"centre":e.setCentre(t,c);break;default:t[f]=c}},e.setStatic=function(t,u){for(var c=0;c<t.parts.length;c++){var f=t.parts[c];u?(f.isStatic||(f._original={restitution:f.restitution,friction:f.friction,mass:f.mass,inertia:f.inertia,density:f.density,inverseMass:f.inverseMass,inverseInertia:f.inverseInertia}),f.restitution=0,f.friction=1,f.mass=f.inertia=f.density=1/0,f.inverseMass=f.inverseInertia=0,f.positionPrev.x=f.position.x,f.positionPrev.y=f.position.y,f.anglePrev=f.angle,f.angularVelocity=0,f.speed=0,f.angularSpeed=0,f.motion=0):f._original&&(f.restitution=f._original.restitution,f.friction=f._original.friction,f.mass=f._original.mass,f.inertia=f._original.inertia,f.density=f._original.density,f.inverseMass=f._original.inverseMass,f.inverseInertia=f._original.inverseInertia,f._original=null),f.isStatic=u}},e.setMass=function(t,u){var c=t.inertia/(t.mass/6);t.inertia=c*(u/6),t.inverseInertia=1/t.inertia,t.mass=u,t.inverseMass=1/t.mass,t.density=t.mass/t.area},e.setDensity=function(t,u){e.setMass(t,u*t.area),t.density=u},e.setInertia=function(t,u){t.inertia=u,t.inverseInertia=1/t.inertia},e.setVertices=function(t,u){u[0].body===t?t.vertices=u:t.vertices=s.create(u,t),t.axes=g.fromVertices(t.vertices),t.area=s.area(t.vertices),e.setMass(t,t.density*t.area);var c=s.centre(t.vertices);s.translate(t.vertices,c,-1),e.setInertia(t,e._inertiaScale*s.inertia(t.vertices,t.mass)),s.translate(t.vertices,t.position),l.update(t.bounds,t.vertices,t.velocity)},e.setParts=function(t,u,c){var f;for(u=u.slice(0),t.parts.length=0,t.parts.push(t),t.parent=t,f=0;f<u.length;f++){var y=u[f];y!==t&&(y.parent=t,t.parts.push(y))}if(t.parts.length!==1){if(c=typeof c<"u"?c:!0,c){var E=[];for(f=0;f<u.length;f++)E=E.concat(u[f].vertices);s.clockwiseSort(E);var S=s.hull(E),T=s.centre(S);e.setVertices(t,S),s.translate(t.vertices,T)}var m=e._totalProperties(t);t.area=m.area,t.parent=t,t.position.x=m.centre.x,t.position.y=m.centre.y,t.positionPrev.x=m.centre.x,t.positionPrev.y=m.centre.y,e.setMass(t,m.mass),e.setInertia(t,m.inertia),e.setPosition(t,m.centre)}},e.setCentre=function(t,u,c){c?(t.positionPrev.x+=u.x,t.positionPrev.y+=u.y,t.position.x+=u.x,t.position.y+=u.y):(t.positionPrev.x=u.x-(t.position.x-t.positionPrev.x),t.positionPrev.y=u.y-(t.position.y-t.positionPrev.y),t.position.x=u.x,t.position.y=u.y)},e.setPosition=function(t,u,c){var f=r.sub(u,t.position);c?(t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.velocity.x=f.x,t.velocity.y=f.y,t.speed=r.magnitude(f)):(t.positionPrev.x+=f.x,t.positionPrev.y+=f.y);for(var y=0;y<t.parts.length;y++){var E=t.parts[y];E.position.x+=f.x,E.position.y+=f.y,s.translate(E.vertices,f),l.update(E.bounds,E.vertices,t.velocity)}},e.setAngle=function(t,u,c){var f=u-t.angle;c?(t.anglePrev=t.angle,t.angularVelocity=f,t.angularSpeed=Math.abs(f)):t.anglePrev+=f;for(var y=0;y<t.parts.length;y++){var E=t.parts[y];E.angle+=f,s.rotate(E.vertices,f,t.position),g.rotate(E.axes,f),l.update(E.bounds,E.vertices,t.velocity),y>0&&r.rotateAbout(E.position,f,t.position,E.position)}},e.setVelocity=function(t,u){var c=t.deltaTime/e._baseDelta;t.positionPrev.x=t.position.x-u.x*c,t.positionPrev.y=t.position.y-u.y*c,t.velocity.x=(t.position.x-t.positionPrev.x)/c,t.velocity.y=(t.position.y-t.positionPrev.y)/c,t.speed=r.magnitude(t.velocity)},e.getVelocity=function(t){var u=e._baseDelta/t.deltaTime;return{x:(t.position.x-t.positionPrev.x)*u,y:(t.position.y-t.positionPrev.y)*u}},e.getSpeed=function(t){return r.magnitude(e.getVelocity(t))},e.setSpeed=function(t,u){e.setVelocity(t,r.mult(r.normalise(e.getVelocity(t)),u))},e.setAngularVelocity=function(t,u){var c=t.deltaTime/e._baseDelta;t.anglePrev=t.angle-u*c,t.angularVelocity=(t.angle-t.anglePrev)/c,t.angularSpeed=Math.abs(t.angularVelocity)},e.getAngularVelocity=function(t){return(t.angle-t.anglePrev)*e._baseDelta/t.deltaTime},e.getAngularSpeed=function(t){return Math.abs(e.getAngularVelocity(t))},e.setAngularSpeed=function(t,u){e.setAngularVelocity(t,d.sign(e.getAngularVelocity(t))*u)},e.translate=function(t,u,c){e.setPosition(t,r.add(t.position,u),c)},e.rotate=function(t,u,c,f){if(!c)e.setAngle(t,t.angle+u,f);else{var y=Math.cos(u),E=Math.sin(u),S=t.position.x-c.x,T=t.position.y-c.y;e.setPosition(t,{x:c.x+(S*y-T*E),y:c.y+(S*E+T*y)},f),e.setAngle(t,t.angle+u,f)}},e.scale=function(t,u,c,f){var y=0,E=0;f=f||t.position;for(var S=0;S<t.parts.length;S++){var T=t.parts[S];s.scale(T.vertices,u,c,f),T.axes=g.fromVertices(T.vertices),T.area=s.area(T.vertices),e.setMass(T,t.density*T.area),s.translate(T.vertices,{x:-T.position.x,y:-T.position.y}),e.setInertia(T,e._inertiaScale*s.inertia(T.vertices,T.mass)),s.translate(T.vertices,{x:T.position.x,y:T.position.y}),S>0&&(y+=T.area,E+=T.inertia),T.position.x=f.x+(T.position.x-f.x)*u,T.position.y=f.y+(T.position.y-f.y)*c,l.update(T.bounds,T.vertices,t.velocity)}t.parts.length>1&&(t.area=y,t.isStatic||(e.setMass(t,t.density*y),e.setInertia(t,E))),t.circleRadius&&(u===c?t.circleRadius*=u:t.circleRadius=null)},e.update=function(t,u){u=(typeof u<"u"?u:1e3/60)*t.timeScale;var c=u*u,f=e._timeCorrection?u/(t.deltaTime||u):1,y=1-t.frictionAir*(u/d._baseDelta),E=(t.position.x-t.positionPrev.x)*f,S=(t.position.y-t.positionPrev.y)*f;t.velocity.x=E*y+t.force.x/t.mass*c,t.velocity.y=S*y+t.force.y/t.mass*c,t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.position.x+=t.velocity.x,t.position.y+=t.velocity.y,t.deltaTime=u,t.angularVelocity=(t.angle-t.anglePrev)*y*f+t.torque/t.inertia*c,t.anglePrev=t.angle,t.angle+=t.angularVelocity;for(var T=0;T<t.parts.length;T++){var m=t.parts[T];s.translate(m.vertices,t.velocity),T>0&&(m.position.x+=t.velocity.x,m.position.y+=t.velocity.y),t.angularVelocity!==0&&(s.rotate(m.vertices,t.angularVelocity,t.position),g.rotate(m.axes,t.angularVelocity),T>0&&r.rotateAbout(m.position,t.angularVelocity,t.position,m.position)),l.update(m.bounds,m.vertices,t.velocity)}},e.updateVelocities=function(t){var u=e._baseDelta/t.deltaTime,c=t.velocity;c.x=(t.position.x-t.positionPrev.x)*u,c.y=(t.position.y-t.positionPrev.y)*u,t.speed=Math.sqrt(c.x*c.x+c.y*c.y),t.angularVelocity=(t.angle-t.anglePrev)*u,t.angularSpeed=Math.abs(t.angularVelocity)},e.applyForce=function(t,u,c){var f={x:u.x-t.position.x,y:u.y-t.position.y};t.force.x+=c.x,t.force.y+=c.y,t.torque+=f.x*c.y-f.y*c.x},e._totalProperties=function(t){for(var u={mass:0,area:0,inertia:0,centre:{x:0,y:0}},c=t.parts.length===1?0:1;c<t.parts.length;c++){var f=t.parts[c],y=f.mass!==1/0?f.mass:1;u.mass+=y,u.area+=f.area,u.inertia+=f.inertia,u.centre=r.add(u.centre,r.mult(f.position,y))}return u.centre=r.div(u.centre,u.mass),u}})()},function(i,p,n){var e={};i.exports=e;var s=n(0);(function(){e.on=function(r,o,d){for(var l=o.split(" "),g,h=0;h<l.length;h++)g=l[h],r.events=r.events||{},r.events[g]=r.events[g]||[],r.events[g].push(d);return d},e.off=function(r,o,d){if(!o){r.events={};return}typeof o=="function"&&(d=o,o=s.keys(r.events).join(" "));for(var l=o.split(" "),g=0;g<l.length;g++){var h=r.events[l[g]],t=[];if(d&&h)for(var u=0;u<h.length;u++)h[u]!==d&&t.push(h[u]);r.events[l[g]]=t}},e.trigger=function(r,o,d){var l,g,h,t,u=r.events;if(u&&s.keys(u).length>0){d||(d={}),l=o.split(" ");for(var c=0;c<l.length;c++)if(g=l[c],h=u[g],h){t=s.clone(d,!1),t.name=g,t.source=r;for(var f=0;f<h.length;f++)h[f].apply(r,[t])}}}})()},function(i,p,n){var e={};i.exports=e;var s=n(5),r=n(0),o=n(1),d=n(4);(function(){e.create=function(l){return r.extend({id:r.nextId(),type:"composite",parent:null,isModified:!1,bodies:[],constraints:[],composites:[],label:"Composite",plugin:{},cache:{allBodies:null,allConstraints:null,allComposites:null}},l)},e.setModified=function(l,g,h,t){if(l.isModified=g,g&&l.cache&&(l.cache.allBodies=null,l.cache.allConstraints=null,l.cache.allComposites=null),h&&l.parent&&e.setModified(l.parent,g,h,t),t)for(var u=0;u<l.composites.length;u++){var c=l.composites[u];e.setModified(c,g,h,t)}},e.add=function(l,g){var h=[].concat(g);s.trigger(l,"beforeAdd",{object:g});for(var t=0;t<h.length;t++){var u=h[t];switch(u.type){case"body":if(u.parent!==u){r.warn("Composite.add: skipped adding a compound body part (you must add its parent instead)");break}e.addBody(l,u);break;case"constraint":e.addConstraint(l,u);break;case"composite":e.addComposite(l,u);break;case"mouseConstraint":e.addConstraint(l,u.constraint);break}}return s.trigger(l,"afterAdd",{object:g}),l},e.remove=function(l,g,h){var t=[].concat(g);s.trigger(l,"beforeRemove",{object:g});for(var u=0;u<t.length;u++){var c=t[u];switch(c.type){case"body":e.removeBody(l,c,h);break;case"constraint":e.removeConstraint(l,c,h);break;case"composite":e.removeComposite(l,c,h);break;case"mouseConstraint":e.removeConstraint(l,c.constraint);break}}return s.trigger(l,"afterRemove",{object:g}),l},e.addComposite=function(l,g){return l.composites.push(g),g.parent=l,e.setModified(l,!0,!0,!1),l},e.removeComposite=function(l,g,h){var t=r.indexOf(l.composites,g);if(t!==-1){var u=e.allBodies(g);e.removeCompositeAt(l,t);for(var c=0;c<u.length;c++)u[c].sleepCounter=0}if(h)for(var c=0;c<l.composites.length;c++)e.removeComposite(l.composites[c],g,!0);return l},e.removeCompositeAt=function(l,g){return l.composites.splice(g,1),e.setModified(l,!0,!0,!1),l},e.addBody=function(l,g){return l.bodies.push(g),e.setModified(l,!0,!0,!1),l},e.removeBody=function(l,g,h){var t=r.indexOf(l.bodies,g);if(t!==-1&&(e.removeBodyAt(l,t),g.sleepCounter=0),h)for(var u=0;u<l.composites.length;u++)e.removeBody(l.composites[u],g,!0);return l},e.removeBodyAt=function(l,g){return l.bodies.splice(g,1),e.setModified(l,!0,!0,!1),l},e.addConstraint=function(l,g){return l.constraints.push(g),e.setModified(l,!0,!0,!1),l},e.removeConstraint=function(l,g,h){var t=r.indexOf(l.constraints,g);if(t!==-1&&e.removeConstraintAt(l,t),h)for(var u=0;u<l.composites.length;u++)e.removeConstraint(l.composites[u],g,!0);return l},e.removeConstraintAt=function(l,g){return l.constraints.splice(g,1),e.setModified(l,!0,!0,!1),l},e.clear=function(l,g,h){if(h)for(var t=0;t<l.composites.length;t++)e.clear(l.composites[t],g,!0);return g?l.bodies=l.bodies.filter(function(u){return u.isStatic}):l.bodies.length=0,l.constraints.length=0,l.composites.length=0,e.setModified(l,!0,!0,!1),l},e.allBodies=function(l){if(l.cache&&l.cache.allBodies)return l.cache.allBodies;for(var g=[].concat(l.bodies),h=0;h<l.composites.length;h++)g=g.concat(e.allBodies(l.composites[h]));return l.cache&&(l.cache.allBodies=g),g},e.allConstraints=function(l){if(l.cache&&l.cache.allConstraints)return l.cache.allConstraints;for(var g=[].concat(l.constraints),h=0;h<l.composites.length;h++)g=g.concat(e.allConstraints(l.composites[h]));return l.cache&&(l.cache.allConstraints=g),g},e.allComposites=function(l){if(l.cache&&l.cache.allComposites)return l.cache.allComposites;for(var g=[].concat(l.composites),h=0;h<l.composites.length;h++)g=g.concat(e.allComposites(l.composites[h]));return l.cache&&(l.cache.allComposites=g),g},e.get=function(l,g,h){var t,u;switch(h){case"body":t=e.allBodies(l);break;case"constraint":t=e.allConstraints(l);break;case"composite":t=e.allComposites(l).concat(l);break}return t?(u=t.filter(function(c){return c.id.toString()===g.toString()}),u.length===0?null:u[0]):null},e.move=function(l,g,h){return e.remove(l,g),e.add(h,g),l},e.rebase=function(l){for(var g=e.allBodies(l).concat(e.allConstraints(l)).concat(e.allComposites(l)),h=0;h<g.length;h++)g[h].id=r.nextId();return l},e.translate=function(l,g,h){for(var t=h?e.allBodies(l):l.bodies,u=0;u<t.length;u++)d.translate(t[u],g);return l},e.rotate=function(l,g,h,t){for(var u=Math.cos(g),c=Math.sin(g),f=t?e.allBodies(l):l.bodies,y=0;y<f.length;y++){var E=f[y],S=E.position.x-h.x,T=E.position.y-h.y;d.setPosition(E,{x:h.x+(S*u-T*c),y:h.y+(S*c+T*u)}),d.rotate(E,g)}return l},e.scale=function(l,g,h,t,u){for(var c=u?e.allBodies(l):l.bodies,f=0;f<c.length;f++){var y=c[f],E=y.position.x-t.x,S=y.position.y-t.y;d.setPosition(y,{x:t.x+E*g,y:t.y+S*h}),d.scale(y,g,h)}return l},e.bounds=function(l){for(var g=e.allBodies(l),h=[],t=0;t<g.length;t+=1){var u=g[t];h.push(u.bounds.min,u.bounds.max)}return o.create(h)}})()},function(i,p,n){var e={};i.exports=e;var s=n(4),r=n(5),o=n(0);(function(){e._motionWakeThreshold=.18,e._motionSleepThreshold=.08,e._minBias=.9,e.update=function(d,l){for(var g=l/o._baseDelta,h=e._motionSleepThreshold,t=0;t<d.length;t++){var u=d[t],c=s.getSpeed(u),f=s.getAngularSpeed(u),y=c*c+f*f;if(u.force.x!==0||u.force.y!==0){e.set(u,!1);continue}var E=Math.min(u.motion,y),S=Math.max(u.motion,y);u.motion=e._minBias*E+(1-e._minBias)*S,u.sleepThreshold>0&&u.motion<h?(u.sleepCounter+=1,u.sleepCounter>=u.sleepThreshold/g&&e.set(u,!0)):u.sleepCounter>0&&(u.sleepCounter-=1)}},e.afterCollisions=function(d){for(var l=e._motionSleepThreshold,g=0;g<d.length;g++){var h=d[g];if(h.isActive){var t=h.collision,u=t.bodyA.parent,c=t.bodyB.parent;if(!(u.isSleeping&&c.isSleeping||u.isStatic||c.isStatic)&&(u.isSleeping||c.isSleeping)){var f=u.isSleeping&&!u.isStatic?u:c,y=f===u?c:u;!f.isStatic&&y.motion>l&&e.set(f,!1)}}}},e.set=function(d,l){var g=d.isSleeping;l?(d.isSleeping=!0,d.sleepCounter=d.sleepThreshold,d.positionImpulse.x=0,d.positionImpulse.y=0,d.positionPrev.x=d.position.x,d.positionPrev.y=d.position.y,d.anglePrev=d.angle,d.speed=0,d.angularSpeed=0,d.motion=0,g||r.trigger(d,"sleepStart")):(d.isSleeping=!1,d.sleepCounter=0,g&&r.trigger(d,"sleepEnd"))}})()},function(i,p,n){var e={};i.exports=e;var s=n(3),r=n(9);(function(){var o=[],d={overlap:0,axis:null},l={overlap:0,axis:null};e.create=function(g,h){return{pair:null,collided:!1,bodyA:g,bodyB:h,parentA:g.parent,parentB:h.parent,depth:0,normal:{x:0,y:0},tangent:{x:0,y:0},penetration:{x:0,y:0},supports:[null,null],supportCount:0}},e.collides=function(g,h,t){if(e._overlapAxes(d,g.vertices,h.vertices,g.axes),d.overlap<=0||(e._overlapAxes(l,h.vertices,g.vertices,h.axes),l.overlap<=0))return null;var u=t&&t.table[r.id(g,h)],c;u?c=u.collision:(c=e.create(g,h),c.collided=!0,c.bodyA=g.id<h.id?g:h,c.bodyB=g.id<h.id?h:g,c.parentA=c.bodyA.parent,c.parentB=c.bodyB.parent),g=c.bodyA,h=c.bodyB;var f;d.overlap<l.overlap?f=d:f=l;var y=c.normal,E=c.tangent,S=c.penetration,T=c.supports,m=f.overlap,x=f.axis,C=x.x,v=x.y,w=h.position.x-g.position.x,M=h.position.y-g.position.y;C*w+v*M>=0&&(C=-C,v=-v),y.x=C,y.y=v,E.x=-v,E.y=C,S.x=C*m,S.y=v*m,c.depth=m;var L=e._findSupports(g,h,y,1),I=0;if(s.contains(g.vertices,L[0])&&(T[I++]=L[0]),s.contains(g.vertices,L[1])&&(T[I++]=L[1]),I<2){var k=e._findSupports(h,g,y,-1);s.contains(h.vertices,k[0])&&(T[I++]=k[0]),I<2&&s.contains(h.vertices,k[1])&&(T[I++]=k[1])}return I===0&&(T[I++]=L[0]),c.supportCount=I,c},e._overlapAxes=function(g,h,t,u){var c=h.length,f=t.length,y=h[0].x,E=h[0].y,S=t[0].x,T=t[0].y,m=u.length,x=Number.MAX_VALUE,C=0,v,w,M,L,I,k;for(I=0;I<m;I++){var b=u[I],P=b.x,D=b.y,B=y*P+E*D,O=S*P+T*D,N=B,z=O;for(k=1;k<c;k+=1)L=h[k].x*P+h[k].y*D,L>N?N=L:L<B&&(B=L);for(k=1;k<f;k+=1)L=t[k].x*P+t[k].y*D,L>z?z=L:L<O&&(O=L);if(w=N-O,M=z-B,v=w<M?w:M,v<x&&(x=v,C=I,v<=0))break}g.axis=u[C],g.overlap=x},e._findSupports=function(g,h,t,u){var c=h.vertices,f=c.length,y=g.position.x,E=g.position.y,S=t.x*u,T=t.y*u,m=c[0],x=m,C=S*(y-x.x)+T*(E-x.y),v,w,M;for(M=1;M<f;M+=1)x=c[M],w=S*(y-x.x)+T*(E-x.y),w<C&&(C=w,m=x);return v=c[(f+m.index-1)%f],C=S*(y-v.x)+T*(E-v.y),x=c[(m.index+1)%f],S*(y-x.x)+T*(E-x.y)<C?(o[0]=m,o[1]=x,o):(o[0]=m,o[1]=v,o)}})()},function(i,p,n){var e={};i.exports=e;var s=n(16);(function(){e.create=function(r,o){var d=r.bodyA,l=r.bodyB,g={id:e.id(d,l),bodyA:d,bodyB:l,collision:r,contacts:[s.create(),s.create()],contactCount:0,separation:0,isActive:!0,isSensor:d.isSensor||l.isSensor,timeCreated:o,timeUpdated:o,inverseMass:0,friction:0,frictionStatic:0,restitution:0,slop:0};return e.update(g,r,o),g},e.update=function(r,o,d){var l=o.supports,g=o.supportCount,h=r.contacts,t=o.parentA,u=o.parentB;r.isActive=!0,r.timeUpdated=d,r.collision=o,r.separation=o.depth,r.inverseMass=t.inverseMass+u.inverseMass,r.friction=t.friction<u.friction?t.friction:u.friction,r.frictionStatic=t.frictionStatic>u.frictionStatic?t.frictionStatic:u.frictionStatic,r.restitution=t.restitution>u.restitution?t.restitution:u.restitution,r.slop=t.slop>u.slop?t.slop:u.slop,r.contactCount=g,o.pair=r;var c=l[0],f=h[0],y=l[1],E=h[1];(E.vertex===c||f.vertex===y)&&(h[1]=f,h[0]=f=E,E=h[1]),f.vertex=c,E.vertex=y},e.setActive=function(r,o,d){o?(r.isActive=!0,r.timeUpdated=d):(r.isActive=!1,r.contactCount=0)},e.id=function(r,o){return r.id<o.id?r.id.toString(36)+":"+o.id.toString(36):o.id.toString(36)+":"+r.id.toString(36)}})()},function(i,p,n){var e={};i.exports=e;var s=n(3),r=n(2),o=n(7),d=n(1),l=n(11),g=n(0);(function(){e._warming=.4,e._torqueDampen=1,e._minLength=1e-6,e.create=function(h){var t=h;t.bodyA&&!t.pointA&&(t.pointA={x:0,y:0}),t.bodyB&&!t.pointB&&(t.pointB={x:0,y:0});var u=t.bodyA?r.add(t.bodyA.position,t.pointA):t.pointA,c=t.bodyB?r.add(t.bodyB.position,t.pointB):t.pointB,f=r.magnitude(r.sub(u,c));t.length=typeof t.length<"u"?t.length:f,t.id=t.id||g.nextId(),t.label=t.label||"Constraint",t.type="constraint",t.stiffness=t.stiffness||(t.length>0?1:.7),t.damping=t.damping||0,t.angularStiffness=t.angularStiffness||0,t.angleA=t.bodyA?t.bodyA.angle:t.angleA,t.angleB=t.bodyB?t.bodyB.angle:t.angleB,t.plugin={};var y={visible:!0,lineWidth:2,strokeStyle:"#ffffff",type:"line",anchors:!0};return t.length===0&&t.stiffness>.1?(y.type="pin",y.anchors=!1):t.stiffness<.9&&(y.type="spring"),t.render=g.extend(y,t.render),t},e.preSolveAll=function(h){for(var t=0;t<h.length;t+=1){var u=h[t],c=u.constraintImpulse;u.isStatic||c.x===0&&c.y===0&&c.angle===0||(u.position.x+=c.x,u.position.y+=c.y,u.angle+=c.angle)}},e.solveAll=function(h,t){for(var u=g.clamp(t/g._baseDelta,0,1),c=0;c<h.length;c+=1){var f=h[c],y=!f.bodyA||f.bodyA&&f.bodyA.isStatic,E=!f.bodyB||f.bodyB&&f.bodyB.isStatic;(y||E)&&e.solve(h[c],u)}for(c=0;c<h.length;c+=1)f=h[c],y=!f.bodyA||f.bodyA&&f.bodyA.isStatic,E=!f.bodyB||f.bodyB&&f.bodyB.isStatic,!y&&!E&&e.solve(h[c],u)},e.solve=function(h,t){var u=h.bodyA,c=h.bodyB,f=h.pointA,y=h.pointB;if(!(!u&&!c)){u&&!u.isStatic&&(r.rotate(f,u.angle-h.angleA,f),h.angleA=u.angle),c&&!c.isStatic&&(r.rotate(y,c.angle-h.angleB,y),h.angleB=c.angle);var E=f,S=y;if(u&&(E=r.add(u.position,f)),c&&(S=r.add(c.position,y)),!(!E||!S)){var T=r.sub(E,S),m=r.magnitude(T);m<e._minLength&&(m=e._minLength);var x=(m-h.length)/m,C=h.stiffness>=1||h.length===0,v=C?h.stiffness*t:h.stiffness*t*t,w=h.damping*t,M=r.mult(T,x*v),L=(u?u.inverseMass:0)+(c?c.inverseMass:0),I=(u?u.inverseInertia:0)+(c?c.inverseInertia:0),k=L+I,b,P,D,B,O;if(w>0){var N=r.create();D=r.div(T,m),O=r.sub(c&&r.sub(c.position,c.positionPrev)||N,u&&r.sub(u.position,u.positionPrev)||N),B=r.dot(D,O)}u&&!u.isStatic&&(P=u.inverseMass/L,u.constraintImpulse.x-=M.x*P,u.constraintImpulse.y-=M.y*P,u.position.x-=M.x*P,u.position.y-=M.y*P,w>0&&(u.positionPrev.x-=w*D.x*B*P,u.positionPrev.y-=w*D.y*B*P),b=r.cross(f,M)/k*e._torqueDampen*u.inverseInertia*(1-h.angularStiffness),u.constraintImpulse.angle-=b,u.angle-=b),c&&!c.isStatic&&(P=c.inverseMass/L,c.constraintImpulse.x+=M.x*P,c.constraintImpulse.y+=M.y*P,c.position.x+=M.x*P,c.position.y+=M.y*P,w>0&&(c.positionPrev.x+=w*D.x*B*P,c.positionPrev.y+=w*D.y*B*P),b=r.cross(y,M)/k*e._torqueDampen*c.inverseInertia*(1-h.angularStiffness),c.constraintImpulse.angle+=b,c.angle+=b)}}},e.postSolveAll=function(h){for(var t=0;t<h.length;t++){var u=h[t],c=u.constraintImpulse;if(!(u.isStatic||c.x===0&&c.y===0&&c.angle===0)){o.set(u,!1);for(var f=0;f<u.parts.length;f++){var y=u.parts[f];s.translate(y.vertices,c),f>0&&(y.position.x+=c.x,y.position.y+=c.y),c.angle!==0&&(s.rotate(y.vertices,c.angle,u.position),l.rotate(y.axes,c.angle),f>0&&r.rotateAbout(y.position,c.angle,u.position,y.position)),d.update(y.bounds,y.vertices,u.velocity)}c.angle*=e._warming,c.x*=e._warming,c.y*=e._warming}}},e.pointAWorld=function(h){return{x:(h.bodyA?h.bodyA.position.x:0)+(h.pointA?h.pointA.x:0),y:(h.bodyA?h.bodyA.position.y:0)+(h.pointA?h.pointA.y:0)}},e.pointBWorld=function(h){return{x:(h.bodyB?h.bodyB.position.x:0)+(h.pointB?h.pointB.x:0),y:(h.bodyB?h.bodyB.position.y:0)+(h.pointB?h.pointB.y:0)}},e.currentLength=function(h){var t=(h.bodyA?h.bodyA.position.x:0)+(h.pointA?h.pointA.x:0),u=(h.bodyA?h.bodyA.position.y:0)+(h.pointA?h.pointA.y:0),c=(h.bodyB?h.bodyB.position.x:0)+(h.pointB?h.pointB.x:0),f=(h.bodyB?h.bodyB.position.y:0)+(h.pointB?h.pointB.y:0),y=t-c,E=u-f;return Math.sqrt(y*y+E*E)}})()},function(i,p,n){var e={};i.exports=e;var s=n(2),r=n(0);(function(){e.fromVertices=function(o){for(var d={},l=0;l<o.length;l++){var g=(l+1)%o.length,h=s.normalise({x:o[g].y-o[l].y,y:o[l].x-o[g].x}),t=h.y===0?1/0:h.x/h.y;t=t.toFixed(3).toString(),d[t]=h}return r.values(d)},e.rotate=function(o,d){if(d!==0)for(var l=Math.cos(d),g=Math.sin(d),h=0;h<o.length;h++){var t=o[h],u;u=t.x*l-t.y*g,t.y=t.x*g+t.y*l,t.x=u}}})()},function(i,p,n){var e={};i.exports=e;var s=n(3),r=n(0),o=n(4),d=n(1),l=n(2);(function(){e.rectangle=function(g,h,t,u,c){c=c||{};var f={label:"Rectangle Body",position:{x:g,y:h},vertices:s.fromPath("L 0 0 L "+t+" 0 L "+t+" "+u+" L 0 "+u)};if(c.chamfer){var y=c.chamfer;f.vertices=s.chamfer(f.vertices,y.radius,y.quality,y.qualityMin,y.qualityMax),delete c.chamfer}return o.create(r.extend({},f,c))},e.trapezoid=function(g,h,t,u,c,f){f=f||{},c>=1&&r.warn("Bodies.trapezoid: slope parameter must be < 1."),c*=.5;var y=(1-c*2)*t,E=t*c,S=E+y,T=S+E,m;c<.5?m="L 0 0 L "+E+" "+-u+" L "+S+" "+-u+" L "+T+" 0":m="L 0 0 L "+S+" "+-u+" L "+T+" 0";var x={label:"Trapezoid Body",position:{x:g,y:h},vertices:s.fromPath(m)};if(f.chamfer){var C=f.chamfer;x.vertices=s.chamfer(x.vertices,C.radius,C.quality,C.qualityMin,C.qualityMax),delete f.chamfer}return o.create(r.extend({},x,f))},e.circle=function(g,h,t,u,c){u=u||{};var f={label:"Circle Body",circleRadius:t};c=c||25;var y=Math.ceil(Math.max(10,Math.min(c,t)));return y%2===1&&(y+=1),e.polygon(g,h,y,t,r.extend({},f,u))},e.polygon=function(g,h,t,u,c){if(c=c||{},t<3)return e.circle(g,h,u,c);for(var f=2*Math.PI/t,y="",E=f*.5,S=0;S<t;S+=1){var T=E+S*f,m=Math.cos(T)*u,x=Math.sin(T)*u;y+="L "+m.toFixed(3)+" "+x.toFixed(3)+" "}var C={label:"Polygon Body",position:{x:g,y:h},vertices:s.fromPath(y)};if(c.chamfer){var v=c.chamfer;C.vertices=s.chamfer(C.vertices,v.radius,v.quality,v.qualityMin,v.qualityMax),delete c.chamfer}return o.create(r.extend({},C,c))},e.fromVertices=function(g,h,t,u,c,f,y,E){var S=r.getDecomp(),T,m,x,C,v,w,M,L,I,k,b;for(T=!!(S&&S.quickDecomp),u=u||{},x=[],c=typeof c<"u"?c:!1,f=typeof f<"u"?f:.01,y=typeof y<"u"?y:10,E=typeof E<"u"?E:.01,r.isArray(t[0])||(t=[t]),k=0;k<t.length;k+=1)if(w=t[k],C=s.isConvex(w),v=!C,v&&!T&&r.warnOnce("Bodies.fromVertices: Install the 'poly-decomp' library and use Common.setDecomp or provide 'decomp' as a global to decompose concave vertices."),C||!T)C?w=s.clockwiseSort(w):w=s.hull(w),x.push({position:{x:g,y:h},vertices:w});else{var P=w.map(function(U){return[U.x,U.y]});S.makeCCW(P),f!==!1&&S.removeCollinearPoints(P,f),E!==!1&&S.removeDuplicatePoints&&S.removeDuplicatePoints(P,E);var D=S.quickDecomp(P);for(M=0;M<D.length;M++){var B=D[M],O=B.map(function(U){return{x:U[0],y:U[1]}});y>0&&s.area(O)<y||x.push({position:s.centre(O),vertices:O})}}for(M=0;M<x.length;M++)x[M]=o.create(r.extend(x[M],u));if(c){var N=5;for(M=0;M<x.length;M++){var z=x[M];for(L=M+1;L<x.length;L++){var H=x[L];if(d.overlaps(z.bounds,H.bounds)){var $=z.vertices,W=H.vertices;for(I=0;I<z.vertices.length;I++)for(b=0;b<H.vertices.length;b++){var q=l.magnitudeSquared(l.sub($[(I+1)%$.length],W[b])),K=l.magnitudeSquared(l.sub($[I],W[(b+1)%W.length]));q<N&&K<N&&($[I].isInternal=!0,W[b].isInternal=!0)}}}}}return x.length>1?(m=o.create(r.extend({parts:x.slice(0)},u)),o.setPosition(m,{x:g,y:h}),m):x[0]}})()},function(i,p,n){var e={};i.exports=e;var s=n(0),r=n(8);(function(){e.create=function(o){var d={bodies:[],collisions:[],pairs:null};return s.extend(d,o)},e.setBodies=function(o,d){o.bodies=d.slice(0)},e.clear=function(o){o.bodies=[],o.collisions=[]},e.collisions=function(o){var d=o.pairs,l=o.bodies,g=l.length,h=e.canCollide,t=r.collides,u=o.collisions,c=0,f,y;for(l.sort(e._compareBoundsX),f=0;f<g;f++){var E=l[f],S=E.bounds,T=E.bounds.max.x,m=E.bounds.max.y,x=E.bounds.min.y,C=E.isStatic||E.isSleeping,v=E.parts.length,w=v===1;for(y=f+1;y<g;y++){var M=l[y],L=M.bounds;if(L.min.x>T)break;if(!(m<L.min.y||x>L.max.y)&&!(C&&(M.isStatic||M.isSleeping))&&h(E.collisionFilter,M.collisionFilter)){var I=M.parts.length;if(w&&I===1){var k=t(E,M,d);k&&(u[c++]=k)}else for(var b=v>1?1:0,P=I>1?1:0,D=b;D<v;D++)for(var B=E.parts[D],S=B.bounds,O=P;O<I;O++){var N=M.parts[O],L=N.bounds;if(!(S.min.x>L.max.x||S.max.x<L.min.x||S.max.y<L.min.y||S.min.y>L.max.y)){var k=t(B,N,d);k&&(u[c++]=k)}}}}}return u.length!==c&&(u.length=c),u},e.canCollide=function(o,d){return o.group===d.group&&o.group!==0?o.group>0:(o.mask&d.category)!==0&&(d.mask&o.category)!==0},e._compareBoundsX=function(o,d){return o.bounds.min.x-d.bounds.min.x}})()},function(i,p,n){var e={};i.exports=e;var s=n(0);(function(){e.create=function(r){var o={};return r||s.log("Mouse.create: element was undefined, defaulting to document.body","warn"),o.element=r||document.body,o.absolute={x:0,y:0},o.position={x:0,y:0},o.mousedownPosition={x:0,y:0},o.mouseupPosition={x:0,y:0},o.offset={x:0,y:0},o.scale={x:1,y:1},o.wheelDelta=0,o.button=-1,o.pixelRatio=parseInt(o.element.getAttribute("data-pixel-ratio"),10)||1,o.sourceEvents={mousemove:null,mousedown:null,mouseup:null,mousewheel:null},o.mousemove=function(d){var l=e._getRelativeMousePosition(d,o.element,o.pixelRatio),g=d.changedTouches;g&&(o.button=0,d.preventDefault()),o.absolute.x=l.x,o.absolute.y=l.y,o.position.x=o.absolute.x*o.scale.x+o.offset.x,o.position.y=o.absolute.y*o.scale.y+o.offset.y,o.sourceEvents.mousemove=d},o.mousedown=function(d){var l=e._getRelativeMousePosition(d,o.element,o.pixelRatio),g=d.changedTouches;g?(o.button=0,d.preventDefault()):o.button=d.button,o.absolute.x=l.x,o.absolute.y=l.y,o.position.x=o.absolute.x*o.scale.x+o.offset.x,o.position.y=o.absolute.y*o.scale.y+o.offset.y,o.mousedownPosition.x=o.position.x,o.mousedownPosition.y=o.position.y,o.sourceEvents.mousedown=d},o.mouseup=function(d){var l=e._getRelativeMousePosition(d,o.element,o.pixelRatio),g=d.changedTouches;g&&d.preventDefault(),o.button=-1,o.absolute.x=l.x,o.absolute.y=l.y,o.position.x=o.absolute.x*o.scale.x+o.offset.x,o.position.y=o.absolute.y*o.scale.y+o.offset.y,o.mouseupPosition.x=o.position.x,o.mouseupPosition.y=o.position.y,o.sourceEvents.mouseup=d},o.mousewheel=function(d){o.wheelDelta=Math.max(-1,Math.min(1,d.wheelDelta||-d.detail)),d.preventDefault(),o.sourceEvents.mousewheel=d},e.setElement(o,o.element),o},e.setElement=function(r,o){r.element=o,o.addEventListener("mousemove",r.mousemove,{passive:!0}),o.addEventListener("mousedown",r.mousedown,{passive:!0}),o.addEventListener("mouseup",r.mouseup,{passive:!0}),o.addEventListener("wheel",r.mousewheel,{passive:!1}),o.addEventListener("touchmove",r.mousemove,{passive:!1}),o.addEventListener("touchstart",r.mousedown,{passive:!1}),o.addEventListener("touchend",r.mouseup,{passive:!1})},e.clearSourceEvents=function(r){r.sourceEvents.mousemove=null,r.sourceEvents.mousedown=null,r.sourceEvents.mouseup=null,r.sourceEvents.mousewheel=null,r.wheelDelta=0},e.setOffset=function(r,o){r.offset.x=o.x,r.offset.y=o.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e.setScale=function(r,o){r.scale.x=o.x,r.scale.y=o.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e._getRelativeMousePosition=function(r,o,d){var l=o.getBoundingClientRect(),g=document.documentElement||document.body.parentNode||document.body,h=window.pageXOffset!==void 0?window.pageXOffset:g.scrollLeft,t=window.pageYOffset!==void 0?window.pageYOffset:g.scrollTop,u=r.changedTouches,c,f;return u?(c=u[0].pageX-l.left-h,f=u[0].pageY-l.top-t):(c=r.pageX-l.left-h,f=r.pageY-l.top-t),{x:c/(o.clientWidth/(o.width||o.clientWidth)*d),y:f/(o.clientHeight/(o.height||o.clientHeight)*d)}}})()},function(i,p,n){var e={};i.exports=e;var s=n(0);(function(){e._registry={},e.register=function(r){if(e.isPlugin(r)||s.warn("Plugin.register:",e.toString(r),"does not implement all required fields."),r.name in e._registry){var o=e._registry[r.name],d=e.versionParse(r.version).number,l=e.versionParse(o.version).number;d>l?(s.warn("Plugin.register:",e.toString(o),"was upgraded to",e.toString(r)),e._registry[r.name]=r):d<l?s.warn("Plugin.register:",e.toString(o),"can not be downgraded to",e.toString(r)):r!==o&&s.warn("Plugin.register:",e.toString(r),"is already registered to different plugin object")}else e._registry[r.name]=r;return r},e.resolve=function(r){return e._registry[e.dependencyParse(r).name]},e.toString=function(r){return typeof r=="string"?r:(r.name||"anonymous")+"@"+(r.version||r.range||"0.0.0")},e.isPlugin=function(r){return r&&r.name&&r.version&&r.install},e.isUsed=function(r,o){return r.used.indexOf(o)>-1},e.isFor=function(r,o){var d=r.for&&e.dependencyParse(r.for);return!r.for||o.name===d.name&&e.versionSatisfies(o.version,d.range)},e.use=function(r,o){if(r.uses=(r.uses||[]).concat(o||[]),r.uses.length===0){s.warn("Plugin.use:",e.toString(r),"does not specify any dependencies to install.");return}for(var d=e.dependencies(r),l=s.topologicalSort(d),g=[],h=0;h<l.length;h+=1)if(l[h]!==r.name){var t=e.resolve(l[h]);if(!t){g.push("❌ "+l[h]);continue}e.isUsed(r,t.name)||(e.isFor(t,r)||(s.warn("Plugin.use:",e.toString(t),"is for",t.for,"but installed on",e.toString(r)+"."),t._warned=!0),t.install?t.install(r):(s.warn("Plugin.use:",e.toString(t),"does not specify an install function."),t._warned=!0),t._warned?(g.push("🔶 "+e.toString(t)),delete t._warned):g.push("✅ "+e.toString(t)),r.used.push(t.name))}g.length>0&&s.info(g.join("  "))},e.dependencies=function(r,o){var d=e.dependencyParse(r),l=d.name;if(o=o||{},!(l in o)){r=e.resolve(r)||r,o[l]=s.map(r.uses||[],function(h){e.isPlugin(h)&&e.register(h);var t=e.dependencyParse(h),u=e.resolve(h);return u&&!e.versionSatisfies(u.version,t.range)?(s.warn("Plugin.dependencies:",e.toString(u),"does not satisfy",e.toString(t),"used by",e.toString(d)+"."),u._warned=!0,r._warned=!0):u||(s.warn("Plugin.dependencies:",e.toString(h),"used by",e.toString(d),"could not be resolved."),r._warned=!0),t.name});for(var g=0;g<o[l].length;g+=1)e.dependencies(o[l][g],o);return o}},e.dependencyParse=function(r){if(s.isString(r)){var o=/^[\w-]+(@(\*|[\^~]?\d+\.\d+\.\d+(-[0-9A-Za-z-+]+)?))?$/;return o.test(r)||s.warn("Plugin.dependencyParse:",r,"is not a valid dependency string."),{name:r.split("@")[0],range:r.split("@")[1]||"*"}}return{name:r.name,range:r.range||r.version}},e.versionParse=function(r){var o=/^(\*)|(\^|~|>=|>)?\s*((\d+)\.(\d+)\.(\d+))(-[0-9A-Za-z-+]+)?$/;o.test(r)||s.warn("Plugin.versionParse:",r,"is not a valid version or range.");var d=o.exec(r),l=Number(d[4]),g=Number(d[5]),h=Number(d[6]);return{isRange:!!(d[1]||d[2]),version:d[3],range:r,operator:d[1]||d[2]||"",major:l,minor:g,patch:h,parts:[l,g,h],prerelease:d[7],number:l*1e8+g*1e4+h}},e.versionSatisfies=function(r,o){o=o||"*";var d=e.versionParse(o),l=e.versionParse(r);if(d.isRange){if(d.operator==="*"||r==="*")return!0;if(d.operator===">")return l.number>d.number;if(d.operator===">=")return l.number>=d.number;if(d.operator==="~")return l.major===d.major&&l.minor===d.minor&&l.patch>=d.patch;if(d.operator==="^")return d.major>0?l.major===d.major&&l.number>=d.number:d.minor>0?l.minor===d.minor&&l.patch>=d.patch:l.patch===d.patch}return r===o||r==="*"}})()},function(i,p){var n={};i.exports=n,function(){n.create=function(e){return{vertex:e,normalImpulse:0,tangentImpulse:0}}}()},function(i,p,n){var e={};i.exports=e;var s=n(7),r=n(18),o=n(13),d=n(19),l=n(5),g=n(6),h=n(10),t=n(0),u=n(4);(function(){e._deltaMax=1e3/60,e.create=function(c){c=c||{};var f={positionIterations:6,velocityIterations:4,constraintIterations:2,enableSleeping:!1,events:[],plugin:{},gravity:{x:0,y:1,scale:.001},timing:{timestamp:0,timeScale:1,lastDelta:0,lastElapsed:0,lastUpdatesPerFrame:0}},y=t.extend(f,c);return y.world=c.world||g.create({label:"World"}),y.pairs=c.pairs||d.create(),y.detector=c.detector||o.create(),y.detector.pairs=y.pairs,y.grid={buckets:[]},y.world.gravity=y.gravity,y.broadphase=y.grid,y.metrics={},y},e.update=function(c,f){var y=t.now(),E=c.world,S=c.detector,T=c.pairs,m=c.timing,x=m.timestamp,C;f>e._deltaMax&&t.warnOnce("Matter.Engine.update: delta argument is recommended to be less than or equal to",e._deltaMax.toFixed(3),"ms."),f=typeof f<"u"?f:t._baseDelta,f*=m.timeScale,m.timestamp+=f,m.lastDelta=f;var v={timestamp:m.timestamp,delta:f};l.trigger(c,"beforeUpdate",v);var w=g.allBodies(E),M=g.allConstraints(E);for(E.isModified&&(o.setBodies(S,w),g.setModified(E,!1,!1,!0)),c.enableSleeping&&s.update(w,f),e._bodiesApplyGravity(w,c.gravity),f>0&&e._bodiesUpdate(w,f),l.trigger(c,"beforeSolve",v),h.preSolveAll(w),C=0;C<c.constraintIterations;C++)h.solveAll(M,f);h.postSolveAll(w);var L=o.collisions(S);d.update(T,L,x),c.enableSleeping&&s.afterCollisions(T.list),T.collisionStart.length>0&&l.trigger(c,"collisionStart",{pairs:T.collisionStart,timestamp:m.timestamp,delta:f});var I=t.clamp(20/c.positionIterations,0,1);for(r.preSolvePosition(T.list),C=0;C<c.positionIterations;C++)r.solvePosition(T.list,f,I);for(r.postSolvePosition(w),h.preSolveAll(w),C=0;C<c.constraintIterations;C++)h.solveAll(M,f);for(h.postSolveAll(w),r.preSolveVelocity(T.list),C=0;C<c.velocityIterations;C++)r.solveVelocity(T.list,f);return e._bodiesUpdateVelocities(w),T.collisionActive.length>0&&l.trigger(c,"collisionActive",{pairs:T.collisionActive,timestamp:m.timestamp,delta:f}),T.collisionEnd.length>0&&l.trigger(c,"collisionEnd",{pairs:T.collisionEnd,timestamp:m.timestamp,delta:f}),e._bodiesClearForces(w),l.trigger(c,"afterUpdate",v),c.timing.lastElapsed=t.now()-y,c},e.merge=function(c,f){if(t.extend(c,f),f.world){c.world=f.world,e.clear(c);for(var y=g.allBodies(c.world),E=0;E<y.length;E++){var S=y[E];s.set(S,!1),S.id=t.nextId()}}},e.clear=function(c){d.clear(c.pairs),o.clear(c.detector)},e._bodiesClearForces=function(c){for(var f=c.length,y=0;y<f;y++){var E=c[y];E.force.x=0,E.force.y=0,E.torque=0}},e._bodiesApplyGravity=function(c,f){var y=typeof f.scale<"u"?f.scale:.001,E=c.length;if(!(f.x===0&&f.y===0||y===0))for(var S=0;S<E;S++){var T=c[S];T.isStatic||T.isSleeping||(T.force.y+=T.mass*f.y*y,T.force.x+=T.mass*f.x*y)}},e._bodiesUpdate=function(c,f){for(var y=c.length,E=0;E<y;E++){var S=c[E];S.isStatic||S.isSleeping||u.update(S,f)}},e._bodiesUpdateVelocities=function(c){for(var f=c.length,y=0;y<f;y++)u.updateVelocities(c[y])}})()},function(i,p,n){var e={};i.exports=e;var s=n(3),r=n(0),o=n(1);(function(){e._restingThresh=2,e._restingThreshTangent=Math.sqrt(6),e._positionDampen=.9,e._positionWarming=.8,e._frictionNormalMultiplier=5,e._frictionMaxStatic=Number.MAX_VALUE,e.preSolvePosition=function(d){var l,g,h,t=d.length;for(l=0;l<t;l++)g=d[l],g.isActive&&(h=g.contactCount,g.collision.parentA.totalContacts+=h,g.collision.parentB.totalContacts+=h)},e.solvePosition=function(d,l,g){var h,t,u,c,f,y,E,S,T=e._positionDampen*(g||1),m=r.clamp(l/r._baseDelta,0,1),x=d.length;for(h=0;h<x;h++)t=d[h],!(!t.isActive||t.isSensor)&&(u=t.collision,c=u.parentA,f=u.parentB,y=u.normal,t.separation=u.depth+y.x*(f.positionImpulse.x-c.positionImpulse.x)+y.y*(f.positionImpulse.y-c.positionImpulse.y));for(h=0;h<x;h++)t=d[h],!(!t.isActive||t.isSensor)&&(u=t.collision,c=u.parentA,f=u.parentB,y=u.normal,S=t.separation-t.slop*m,(c.isStatic||f.isStatic)&&(S*=2),c.isStatic||c.isSleeping||(E=T/c.totalContacts,c.positionImpulse.x+=y.x*S*E,c.positionImpulse.y+=y.y*S*E),f.isStatic||f.isSleeping||(E=T/f.totalContacts,f.positionImpulse.x-=y.x*S*E,f.positionImpulse.y-=y.y*S*E))},e.postSolvePosition=function(d){for(var l=e._positionWarming,g=d.length,h=s.translate,t=o.update,u=0;u<g;u++){var c=d[u],f=c.positionImpulse,y=f.x,E=f.y,S=c.velocity;if(c.totalContacts=0,y!==0||E!==0){for(var T=0;T<c.parts.length;T++){var m=c.parts[T];h(m.vertices,f),t(m.bounds,m.vertices,S),m.position.x+=y,m.position.y+=E}c.positionPrev.x+=y,c.positionPrev.y+=E,y*S.x+E*S.y<0?(f.x=0,f.y=0):(f.x*=l,f.y*=l)}}},e.preSolveVelocity=function(d){var l=d.length,g,h;for(g=0;g<l;g++){var t=d[g];if(!(!t.isActive||t.isSensor)){var u=t.contacts,c=t.contactCount,f=t.collision,y=f.parentA,E=f.parentB,S=f.normal,T=f.tangent;for(h=0;h<c;h++){var m=u[h],x=m.vertex,C=m.normalImpulse,v=m.tangentImpulse;if(C!==0||v!==0){var w=S.x*C+T.x*v,M=S.y*C+T.y*v;y.isStatic||y.isSleeping||(y.positionPrev.x+=w*y.inverseMass,y.positionPrev.y+=M*y.inverseMass,y.anglePrev+=y.inverseInertia*((x.x-y.position.x)*M-(x.y-y.position.y)*w)),E.isStatic||E.isSleeping||(E.positionPrev.x-=w*E.inverseMass,E.positionPrev.y-=M*E.inverseMass,E.anglePrev-=E.inverseInertia*((x.x-E.position.x)*M-(x.y-E.position.y)*w))}}}}},e.solveVelocity=function(d,l){var g=l/r._baseDelta,h=g*g,t=h*g,u=-e._restingThresh*g,c=e._restingThreshTangent,f=e._frictionNormalMultiplier*g,y=e._frictionMaxStatic,E=d.length,S,T,m,x;for(m=0;m<E;m++){var C=d[m];if(!(!C.isActive||C.isSensor)){var v=C.collision,w=v.parentA,M=v.parentB,L=v.normal.x,I=v.normal.y,k=v.tangent.x,b=v.tangent.y,P=C.inverseMass,D=C.friction*C.frictionStatic*f,B=C.contacts,O=C.contactCount,N=1/O,z=w.position.x-w.positionPrev.x,H=w.position.y-w.positionPrev.y,$=w.angle-w.anglePrev,W=M.position.x-M.positionPrev.x,q=M.position.y-M.positionPrev.y,K=M.angle-M.anglePrev;for(x=0;x<O;x++){var U=B[x],Y=U.vertex,Q=Y.x-w.position.x,_=Y.y-w.position.y,X=Y.x-M.position.x,Z=Y.y-M.position.y,G=z-_*$,Re=H+Q*$,Oe=W-Z*K,Ne=q+X*K,pe=G-Oe,me=Re-Ne,ce=L*pe+I*me,J=k*pe+b*me,ve=C.separation+ce,ue=Math.min(ve,1);ue=ve<0?0:ue;var ye=ue*D;J<-ye||J>ye?(T=J>0?J:-J,S=C.friction*(J>0?1:-1)*t,S<-T?S=-T:S>T&&(S=T)):(S=J,T=y);var xe=Q*I-_*L,Ce=X*I-Z*L,Me=N/(P+w.inverseInertia*xe*xe+M.inverseInertia*Ce*Ce),te=(1+C.restitution)*ce*Me;if(S*=Me,ce<u)U.normalImpulse=0;else{var Ue=U.normalImpulse;U.normalImpulse+=te,U.normalImpulse>0&&(U.normalImpulse=0),te=U.normalImpulse-Ue}if(J<-c||J>c)U.tangentImpulse=0;else{var ze=U.tangentImpulse;U.tangentImpulse+=S,U.tangentImpulse<-T&&(U.tangentImpulse=-T),U.tangentImpulse>T&&(U.tangentImpulse=T),S=U.tangentImpulse-ze}var ne=L*te+k*S,ie=I*te+b*S;w.isStatic||w.isSleeping||(w.positionPrev.x+=ne*w.inverseMass,w.positionPrev.y+=ie*w.inverseMass,w.anglePrev+=(Q*ie-_*ne)*w.inverseInertia),M.isStatic||M.isSleeping||(M.positionPrev.x-=ne*M.inverseMass,M.positionPrev.y-=ie*M.inverseMass,M.anglePrev-=(X*ie-Z*ne)*M.inverseInertia)}}}}})()},function(i,p,n){var e={};i.exports=e;var s=n(9),r=n(0);(function(){e.create=function(o){return r.extend({table:{},list:[],collisionStart:[],collisionActive:[],collisionEnd:[]},o)},e.update=function(o,d,l){var g=s.update,h=s.create,t=s.setActive,u=o.table,c=o.list,f=c.length,y=f,E=o.collisionStart,S=o.collisionEnd,T=o.collisionActive,m=d.length,x=0,C=0,v=0,w,M,L;for(L=0;L<m;L++)w=d[L],M=w.pair,M?(M.isActive&&(T[v++]=M),g(M,w,l)):(M=h(w,l),u[M.id]=M,E[x++]=M,c[y++]=M);for(y=0,f=c.length,L=0;L<f;L++)M=c[L],M.timeUpdated>=l?c[y++]=M:(t(M,!1,l),M.collision.bodyA.sleepCounter>0&&M.collision.bodyB.sleepCounter>0?c[y++]=M:(S[C++]=M,delete u[M.id]));c.length!==y&&(c.length=y),E.length!==x&&(E.length=x),S.length!==C&&(S.length=C),T.length!==v&&(T.length=v)},e.clear=function(o){return o.table={},o.list.length=0,o.collisionStart.length=0,o.collisionActive.length=0,o.collisionEnd.length=0,o}})()},function(i,p,n){var e=i.exports=n(21);e.Axes=n(11),e.Bodies=n(12),e.Body=n(4),e.Bounds=n(1),e.Collision=n(8),e.Common=n(0),e.Composite=n(6),e.Composites=n(22),e.Constraint=n(10),e.Contact=n(16),e.Detector=n(13),e.Engine=n(17),e.Events=n(5),e.Grid=n(23),e.Mouse=n(14),e.MouseConstraint=n(24),e.Pair=n(9),e.Pairs=n(19),e.Plugin=n(15),e.Query=n(25),e.Render=n(26),e.Resolver=n(18),e.Runner=n(27),e.SAT=n(28),e.Sleeping=n(7),e.Svg=n(29),e.Vector=n(2),e.Vertices=n(3),e.World=n(30),e.Engine.run=e.Runner.run,e.Common.deprecated(e.Engine,"run","Engine.run ➤ use Matter.Runner.run(engine) instead")},function(i,p,n){var e={};i.exports=e;var s=n(15),r=n(0);(function(){e.name="matter-js",e.version="0.20.0",e.uses=[],e.used=[],e.use=function(){s.use(e,Array.prototype.slice.call(arguments))},e.before=function(o,d){return o=o.replace(/^Matter./,""),r.chainPathBefore(e,o,d)},e.after=function(o,d){return o=o.replace(/^Matter./,""),r.chainPathAfter(e,o,d)}})()},function(i,p,n){var e={};i.exports=e;var s=n(6),r=n(10),o=n(0),d=n(4),l=n(12),g=o.deprecated;(function(){e.stack=function(h,t,u,c,f,y,E){for(var S=s.create({label:"Stack"}),T=h,m=t,x,C=0,v=0;v<c;v++){for(var w=0,M=0;M<u;M++){var L=E(T,m,M,v,x,C);if(L){var I=L.bounds.max.y-L.bounds.min.y,k=L.bounds.max.x-L.bounds.min.x;I>w&&(w=I),d.translate(L,{x:k*.5,y:I*.5}),T=L.bounds.max.x+f,s.addBody(S,L),x=L,C+=1}else T+=f}m+=w+y,T=h}return S},e.chain=function(h,t,u,c,f,y){for(var E=h.bodies,S=1;S<E.length;S++){var T=E[S-1],m=E[S],x=T.bounds.max.y-T.bounds.min.y,C=T.bounds.max.x-T.bounds.min.x,v=m.bounds.max.y-m.bounds.min.y,w=m.bounds.max.x-m.bounds.min.x,M={bodyA:T,pointA:{x:C*t,y:x*u},bodyB:m,pointB:{x:w*c,y:v*f}},L=o.extend(M,y);s.addConstraint(h,r.create(L))}return h.label+=" Chain",h},e.mesh=function(h,t,u,c,f){var y=h.bodies,E,S,T,m,x;for(E=0;E<u;E++){for(S=1;S<t;S++)T=y[S-1+E*t],m=y[S+E*t],s.addConstraint(h,r.create(o.extend({bodyA:T,bodyB:m},f)));if(E>0)for(S=0;S<t;S++)T=y[S+(E-1)*t],m=y[S+E*t],s.addConstraint(h,r.create(o.extend({bodyA:T,bodyB:m},f))),c&&S>0&&(x=y[S-1+(E-1)*t],s.addConstraint(h,r.create(o.extend({bodyA:x,bodyB:m},f)))),c&&S<t-1&&(x=y[S+1+(E-1)*t],s.addConstraint(h,r.create(o.extend({bodyA:x,bodyB:m},f))))}return h.label+=" Mesh",h},e.pyramid=function(h,t,u,c,f,y,E){return e.stack(h,t,u,c,f,y,function(S,T,m,x,C,v){var w=Math.min(c,Math.ceil(u/2)),M=C?C.bounds.max.x-C.bounds.min.x:0;if(!(x>w)){x=w-x;var L=x,I=u-1-x;if(!(m<L||m>I)){v===1&&d.translate(C,{x:(m+(u%2===1?1:-1))*M,y:0});var k=C?m*M:0;return E(h+k+m*f,T,m,x,C,v)}}})},e.newtonsCradle=function(h,t,u,c,f){for(var y=s.create({label:"Newtons Cradle"}),E=0;E<u;E++){var S=1.9,T=l.circle(h+E*(c*S),t+f,c,{inertia:1/0,restitution:1,friction:0,frictionAir:1e-4,slop:1}),m=r.create({pointA:{x:h+E*(c*S),y:t},bodyB:T});s.addBody(y,T),s.addConstraint(y,m)}return y},g(e,"newtonsCradle","Composites.newtonsCradle ➤ moved to newtonsCradle example"),e.car=function(h,t,u,c,f){var y=d.nextGroup(!0),E=20,S=-u*.5+E,T=u*.5-E,m=0,x=s.create({label:"Car"}),C=l.rectangle(h,t,u,c,{collisionFilter:{group:y},chamfer:{radius:c*.5},density:2e-4}),v=l.circle(h+S,t+m,f,{collisionFilter:{group:y},friction:.8}),w=l.circle(h+T,t+m,f,{collisionFilter:{group:y},friction:.8}),M=r.create({bodyB:C,pointB:{x:S,y:m},bodyA:v,stiffness:1,length:0}),L=r.create({bodyB:C,pointB:{x:T,y:m},bodyA:w,stiffness:1,length:0});return s.addBody(x,C),s.addBody(x,v),s.addBody(x,w),s.addConstraint(x,M),s.addConstraint(x,L),x},g(e,"car","Composites.car ➤ moved to car example"),e.softBody=function(h,t,u,c,f,y,E,S,T,m){T=o.extend({inertia:1/0},T),m=o.extend({stiffness:.2,render:{type:"line",anchors:!1}},m);var x=e.stack(h,t,u,c,f,y,function(C,v){return l.circle(C,v,S,T)});return e.mesh(x,u,c,E,m),x.label="Soft Body",x},g(e,"softBody","Composites.softBody ➤ moved to softBody and cloth examples")})()},function(i,p,n){var e={};i.exports=e;var s=n(9),r=n(0),o=r.deprecated;(function(){e.create=function(d){var l={buckets:{},pairs:{},pairsList:[],bucketWidth:48,bucketHeight:48};return r.extend(l,d)},e.update=function(d,l,g,h){var t,u,c,f=g.world,y=d.buckets,E,S,T=!1;for(t=0;t<l.length;t++){var m=l[t];if(!(m.isSleeping&&!h)&&!(f.bounds&&(m.bounds.max.x<f.bounds.min.x||m.bounds.min.x>f.bounds.max.x||m.bounds.max.y<f.bounds.min.y||m.bounds.min.y>f.bounds.max.y))){var x=e._getRegion(d,m);if(!m.region||x.id!==m.region.id||h){(!m.region||h)&&(m.region=x);var C=e._regionUnion(x,m.region);for(u=C.startCol;u<=C.endCol;u++)for(c=C.startRow;c<=C.endRow;c++){S=e._getBucketId(u,c),E=y[S];var v=u>=x.startCol&&u<=x.endCol&&c>=x.startRow&&c<=x.endRow,w=u>=m.region.startCol&&u<=m.region.endCol&&c>=m.region.startRow&&c<=m.region.endRow;!v&&w&&w&&E&&e._bucketRemoveBody(d,E,m),(m.region===x||v&&!w||h)&&(E||(E=e._createBucket(y,S)),e._bucketAddBody(d,E,m))}m.region=x,T=!0}}}T&&(d.pairsList=e._createActivePairsList(d))},o(e,"update","Grid.update ➤ replaced by Matter.Detector"),e.clear=function(d){d.buckets={},d.pairs={},d.pairsList=[]},o(e,"clear","Grid.clear ➤ replaced by Matter.Detector"),e._regionUnion=function(d,l){var g=Math.min(d.startCol,l.startCol),h=Math.max(d.endCol,l.endCol),t=Math.min(d.startRow,l.startRow),u=Math.max(d.endRow,l.endRow);return e._createRegion(g,h,t,u)},e._getRegion=function(d,l){var g=l.bounds,h=Math.floor(g.min.x/d.bucketWidth),t=Math.floor(g.max.x/d.bucketWidth),u=Math.floor(g.min.y/d.bucketHeight),c=Math.floor(g.max.y/d.bucketHeight);return e._createRegion(h,t,u,c)},e._createRegion=function(d,l,g,h){return{id:d+","+l+","+g+","+h,startCol:d,endCol:l,startRow:g,endRow:h}},e._getBucketId=function(d,l){return"C"+d+"R"+l},e._createBucket=function(d,l){var g=d[l]=[];return g},e._bucketAddBody=function(d,l,g){var h=d.pairs,t=s.id,u=l.length,c;for(c=0;c<u;c++){var f=l[c];if(!(g.id===f.id||g.isStatic&&f.isStatic)){var y=t(g,f),E=h[y];E?E[2]+=1:h[y]=[g,f,1]}}l.push(g)},e._bucketRemoveBody=function(d,l,g){var h=d.pairs,t=s.id,u;l.splice(r.indexOf(l,g),1);var c=l.length;for(u=0;u<c;u++){var f=h[t(g,l[u])];f&&(f[2]-=1)}},e._createActivePairsList=function(d){var l,g=d.pairs,h=r.keys(g),t=h.length,u=[],c;for(c=0;c<t;c++)l=g[h[c]],l[2]>0?u.push(l):delete g[h[c]];return u}})()},function(i,p,n){var e={};i.exports=e;var s=n(3),r=n(7),o=n(14),d=n(5),l=n(13),g=n(10),h=n(6),t=n(0),u=n(1);(function(){e.create=function(c,f){var y=(c?c.mouse:null)||(f?f.mouse:null);y||(c&&c.render&&c.render.canvas?y=o.create(c.render.canvas):f&&f.element?y=o.create(f.element):(y=o.create(),t.warn("MouseConstraint.create: options.mouse was undefined, options.element was undefined, may not function as expected")));var E=g.create({label:"Mouse Constraint",pointA:y.position,pointB:{x:0,y:0},length:.01,stiffness:.1,angularStiffness:1,render:{strokeStyle:"#90EE90",lineWidth:3}}),S={type:"mouseConstraint",mouse:y,element:null,body:null,constraint:E,collisionFilter:{category:1,mask:4294967295,group:0}},T=t.extend(S,f);return d.on(c,"beforeUpdate",function(){var m=h.allBodies(c.world);e.update(T,m),e._triggerEvents(T)}),T},e.update=function(c,f){var y=c.mouse,E=c.constraint,S=c.body;if(y.button===0){if(E.bodyB)r.set(E.bodyB,!1),E.pointA=y.position;else for(var T=0;T<f.length;T++)if(S=f[T],u.contains(S.bounds,y.position)&&l.canCollide(S.collisionFilter,c.collisionFilter))for(var m=S.parts.length>1?1:0;m<S.parts.length;m++){var x=S.parts[m];if(s.contains(x.vertices,y.position)){E.pointA=y.position,E.bodyB=c.body=S,E.pointB={x:y.position.x-S.position.x,y:y.position.y-S.position.y},E.angleB=S.angle,r.set(S,!1),d.trigger(c,"startdrag",{mouse:y,body:S});break}}}else E.bodyB=c.body=null,E.pointB=null,S&&d.trigger(c,"enddrag",{mouse:y,body:S})},e._triggerEvents=function(c){var f=c.mouse,y=f.sourceEvents;y.mousemove&&d.trigger(c,"mousemove",{mouse:f}),y.mousedown&&d.trigger(c,"mousedown",{mouse:f}),y.mouseup&&d.trigger(c,"mouseup",{mouse:f}),o.clearSourceEvents(f)}})()},function(i,p,n){var e={};i.exports=e;var s=n(2),r=n(8),o=n(1),d=n(12),l=n(3);(function(){e.collides=function(g,h){for(var t=[],u=h.length,c=g.bounds,f=r.collides,y=o.overlaps,E=0;E<u;E++){var S=h[E],T=S.parts.length,m=T===1?0:1;if(y(S.bounds,c))for(var x=m;x<T;x++){var C=S.parts[x];if(y(C.bounds,c)){var v=f(C,g);if(v){t.push(v);break}}}}return t},e.ray=function(g,h,t,u){u=u||1e-100;for(var c=s.angle(h,t),f=s.magnitude(s.sub(h,t)),y=(t.x+h.x)*.5,E=(t.y+h.y)*.5,S=d.rectangle(y,E,f,u,{angle:c}),T=e.collides(S,g),m=0;m<T.length;m+=1){var x=T[m];x.body=x.bodyB=x.bodyA}return T},e.region=function(g,h,t){for(var u=[],c=0;c<g.length;c++){var f=g[c],y=o.overlaps(f.bounds,h);(y&&!t||!y&&t)&&u.push(f)}return u},e.point=function(g,h){for(var t=[],u=0;u<g.length;u++){var c=g[u];if(o.contains(c.bounds,h))for(var f=c.parts.length===1?0:1;f<c.parts.length;f++){var y=c.parts[f];if(o.contains(y.bounds,h)&&l.contains(y.vertices,h)){t.push(c);break}}}return t}})()},function(i,p,n){var e={};i.exports=e;var s=n(4),r=n(0),o=n(6),d=n(1),l=n(5),g=n(2),h=n(14);(function(){var t,u;typeof window<"u"&&(t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(m){window.setTimeout(function(){m(r.now())},1e3/60)},u=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame),e._goodFps=30,e._goodDelta=1e3/60,e.create=function(m){var x={engine:null,element:null,canvas:null,mouse:null,frameRequestId:null,timing:{historySize:60,delta:0,deltaHistory:[],lastTime:0,lastTimestamp:0,lastElapsed:0,timestampElapsed:0,timestampElapsedHistory:[],engineDeltaHistory:[],engineElapsedHistory:[],engineUpdatesHistory:[],elapsedHistory:[]},options:{width:800,height:600,pixelRatio:1,background:"#14151f",wireframeBackground:"#14151f",wireframeStrokeStyle:"#bbb",hasBounds:!!m.bounds,enabled:!0,wireframes:!0,showSleeping:!0,showDebug:!1,showStats:!1,showPerformance:!1,showBounds:!1,showVelocity:!1,showCollisions:!1,showSeparations:!1,showAxes:!1,showPositions:!1,showAngleIndicator:!1,showIds:!1,showVertexNumbers:!1,showConvexHulls:!1,showInternalEdges:!1,showMousePosition:!1}},C=r.extend(x,m);return C.canvas&&(C.canvas.width=C.options.width||C.canvas.width,C.canvas.height=C.options.height||C.canvas.height),C.mouse=m.mouse,C.engine=m.engine,C.canvas=C.canvas||y(C.options.width,C.options.height),C.context=C.canvas.getContext("2d"),C.textures={},C.bounds=C.bounds||{min:{x:0,y:0},max:{x:C.canvas.width,y:C.canvas.height}},C.controller=e,C.options.showBroadphase=!1,C.options.pixelRatio!==1&&e.setPixelRatio(C,C.options.pixelRatio),r.isElement(C.element)&&C.element.appendChild(C.canvas),C},e.run=function(m){(function x(C){m.frameRequestId=t(x),c(m,C),e.world(m,C),m.context.setTransform(m.options.pixelRatio,0,0,m.options.pixelRatio,0,0),(m.options.showStats||m.options.showDebug)&&e.stats(m,m.context,C),(m.options.showPerformance||m.options.showDebug)&&e.performance(m,m.context,C),m.context.setTransform(1,0,0,1,0,0)})()},e.stop=function(m){u(m.frameRequestId)},e.setPixelRatio=function(m,x){var C=m.options,v=m.canvas;x==="auto"&&(x=E(v)),C.pixelRatio=x,v.setAttribute("data-pixel-ratio",x),v.width=C.width*x,v.height=C.height*x,v.style.width=C.width+"px",v.style.height=C.height+"px"},e.setSize=function(m,x,C){m.options.width=x,m.options.height=C,m.bounds.max.x=m.bounds.min.x+x,m.bounds.max.y=m.bounds.min.y+C,m.options.pixelRatio!==1?e.setPixelRatio(m,m.options.pixelRatio):(m.canvas.width=x,m.canvas.height=C)},e.lookAt=function(m,x,C,v){v=typeof v<"u"?v:!0,x=r.isArray(x)?x:[x],C=C||{x:0,y:0};for(var w={min:{x:1/0,y:1/0},max:{x:-1/0,y:-1/0}},M=0;M<x.length;M+=1){var L=x[M],I=L.bounds?L.bounds.min:L.min||L.position||L,k=L.bounds?L.bounds.max:L.max||L.position||L;I&&k&&(I.x<w.min.x&&(w.min.x=I.x),k.x>w.max.x&&(w.max.x=k.x),I.y<w.min.y&&(w.min.y=I.y),k.y>w.max.y&&(w.max.y=k.y))}var b=w.max.x-w.min.x+2*C.x,P=w.max.y-w.min.y+2*C.y,D=m.canvas.height,B=m.canvas.width,O=B/D,N=b/P,z=1,H=1;N>O?H=N/O:z=O/N,m.options.hasBounds=!0,m.bounds.min.x=w.min.x,m.bounds.max.x=w.min.x+b*z,m.bounds.min.y=w.min.y,m.bounds.max.y=w.min.y+P*H,v&&(m.bounds.min.x+=b*.5-b*z*.5,m.bounds.max.x+=b*.5-b*z*.5,m.bounds.min.y+=P*.5-P*H*.5,m.bounds.max.y+=P*.5-P*H*.5),m.bounds.min.x-=C.x,m.bounds.max.x-=C.x,m.bounds.min.y-=C.y,m.bounds.max.y-=C.y,m.mouse&&(h.setScale(m.mouse,{x:(m.bounds.max.x-m.bounds.min.x)/m.canvas.width,y:(m.bounds.max.y-m.bounds.min.y)/m.canvas.height}),h.setOffset(m.mouse,m.bounds.min))},e.startViewTransform=function(m){var x=m.bounds.max.x-m.bounds.min.x,C=m.bounds.max.y-m.bounds.min.y,v=x/m.options.width,w=C/m.options.height;m.context.setTransform(m.options.pixelRatio/v,0,0,m.options.pixelRatio/w,0,0),m.context.translate(-m.bounds.min.x,-m.bounds.min.y)},e.endViewTransform=function(m){m.context.setTransform(m.options.pixelRatio,0,0,m.options.pixelRatio,0,0)},e.world=function(m,x){var C=r.now(),v=m.engine,w=v.world,M=m.canvas,L=m.context,I=m.options,k=m.timing,b=o.allBodies(w),P=o.allConstraints(w),D=I.wireframes?I.wireframeBackground:I.background,B=[],O=[],N,z={timestamp:v.timing.timestamp};if(l.trigger(m,"beforeRender",z),m.currentBackground!==D&&T(m,D),L.globalCompositeOperation="source-in",L.fillStyle="transparent",L.fillRect(0,0,M.width,M.height),L.globalCompositeOperation="source-over",I.hasBounds){for(N=0;N<b.length;N++){var H=b[N];d.overlaps(H.bounds,m.bounds)&&B.push(H)}for(N=0;N<P.length;N++){var $=P[N],W=$.bodyA,q=$.bodyB,K=$.pointA,U=$.pointB;W&&(K=g.add(W.position,$.pointA)),q&&(U=g.add(q.position,$.pointB)),!(!K||!U)&&(d.contains(m.bounds,K)||d.contains(m.bounds,U))&&O.push($)}e.startViewTransform(m),m.mouse&&(h.setScale(m.mouse,{x:(m.bounds.max.x-m.bounds.min.x)/m.options.width,y:(m.bounds.max.y-m.bounds.min.y)/m.options.height}),h.setOffset(m.mouse,m.bounds.min))}else O=P,B=b,m.options.pixelRatio!==1&&m.context.setTransform(m.options.pixelRatio,0,0,m.options.pixelRatio,0,0);!I.wireframes||v.enableSleeping&&I.showSleeping?e.bodies(m,B,L):(I.showConvexHulls&&e.bodyConvexHulls(m,B,L),e.bodyWireframes(m,B,L)),I.showBounds&&e.bodyBounds(m,B,L),(I.showAxes||I.showAngleIndicator)&&e.bodyAxes(m,B,L),I.showPositions&&e.bodyPositions(m,B,L),I.showVelocity&&e.bodyVelocity(m,B,L),I.showIds&&e.bodyIds(m,B,L),I.showSeparations&&e.separations(m,v.pairs.list,L),I.showCollisions&&e.collisions(m,v.pairs.list,L),I.showVertexNumbers&&e.vertexNumbers(m,B,L),I.showMousePosition&&e.mousePosition(m,m.mouse,L),e.constraints(O,L),I.hasBounds&&e.endViewTransform(m),l.trigger(m,"afterRender",z),k.lastElapsed=r.now()-C},e.stats=function(m,x,C){for(var v=m.engine,w=v.world,M=o.allBodies(w),L=0,I=55,k=44,b=0,P=0,D=0;D<M.length;D+=1)L+=M[D].parts.length;var B={Part:L,Body:M.length,Cons:o.allConstraints(w).length,Comp:o.allComposites(w).length,Pair:v.pairs.list.length};x.fillStyle="#0e0f19",x.fillRect(b,P,I*5.5,k),x.font="12px Arial",x.textBaseline="top",x.textAlign="right";for(var O in B){var N=B[O];x.fillStyle="#aaa",x.fillText(O,b+I,P+8),x.fillStyle="#eee",x.fillText(N,b+I,P+26),b+=I}},e.performance=function(m,x){var C=m.engine,v=m.timing,w=v.deltaHistory,M=v.elapsedHistory,L=v.timestampElapsedHistory,I=v.engineDeltaHistory,k=v.engineUpdatesHistory,b=v.engineElapsedHistory,P=C.timing.lastUpdatesPerFrame,D=C.timing.lastDelta,B=f(w),O=f(M),N=f(I),z=f(k),H=f(b),$=f(L),W=$/B||0,q=Math.round(B/D),K=1e3/B||0,U=4,Y=12,Q=60,_=34,X=10,Z=69;x.fillStyle="#0e0f19",x.fillRect(0,50,Y*5+Q*6+22,_),e.status(x,X,Z,Q,U,w.length,Math.round(K)+" fps",K/e._goodFps,function(G){return w[G]/B-1}),e.status(x,X+Y+Q,Z,Q,U,I.length,D.toFixed(2)+" dt",e._goodDelta/D,function(G){return I[G]/N-1}),e.status(x,X+(Y+Q)*2,Z,Q,U,k.length,P+" upf",Math.pow(r.clamp(z/q||1,0,1),4),function(G){return k[G]/z-1}),e.status(x,X+(Y+Q)*3,Z,Q,U,b.length,H.toFixed(2)+" ut",1-P*H/e._goodFps,function(G){return b[G]/H-1}),e.status(x,X+(Y+Q)*4,Z,Q,U,M.length,O.toFixed(2)+" rt",1-O/e._goodFps,function(G){return M[G]/O-1}),e.status(x,X+(Y+Q)*5,Z,Q,U,L.length,W.toFixed(2)+" x",W*W*W,function(G){return(L[G]/w[G]/W||0)-1})},e.status=function(m,x,C,v,w,M,L,I,k){m.strokeStyle="#888",m.fillStyle="#444",m.lineWidth=1,m.fillRect(x,C+7,v,1),m.beginPath(),m.moveTo(x,C+7-w*r.clamp(.4*k(0),-2,2));for(var b=0;b<v;b+=1)m.lineTo(x+b,C+7-(b<M?w*r.clamp(.4*k(b),-2,2):0));m.stroke(),m.fillStyle="hsl("+r.clamp(25+95*I,0,120)+",100%,60%)",m.fillRect(x,C-7,4,4),m.font="12px Arial",m.textBaseline="middle",m.textAlign="right",m.fillStyle="#eee",m.fillText(L,x+v,C-5)},e.constraints=function(m,x){for(var C=x,v=0;v<m.length;v++){var w=m[v];if(!(!w.render.visible||!w.pointA||!w.pointB)){var M=w.bodyA,L=w.bodyB,I,k;if(M?I=g.add(M.position,w.pointA):I=w.pointA,w.render.type==="pin")C.beginPath(),C.arc(I.x,I.y,3,0,2*Math.PI),C.closePath();else{if(L?k=g.add(L.position,w.pointB):k=w.pointB,C.beginPath(),C.moveTo(I.x,I.y),w.render.type==="spring")for(var b=g.sub(k,I),P=g.perp(g.normalise(b)),D=Math.ceil(r.clamp(w.length/5,12,20)),B,O=1;O<D;O+=1)B=O%2===0?1:-1,C.lineTo(I.x+b.x*(O/D)+P.x*B*4,I.y+b.y*(O/D)+P.y*B*4);C.lineTo(k.x,k.y)}w.render.lineWidth&&(C.lineWidth=w.render.lineWidth,C.strokeStyle=w.render.strokeStyle,C.stroke()),w.render.anchors&&(C.fillStyle=w.render.strokeStyle,C.beginPath(),C.arc(I.x,I.y,3,0,2*Math.PI),C.arc(k.x,k.y,3,0,2*Math.PI),C.closePath(),C.fill())}}},e.bodies=function(m,x,C){var v=C;m.engine;var w=m.options,M=w.showInternalEdges||!w.wireframes,L,I,k,b;for(k=0;k<x.length;k++)if(L=x[k],!!L.render.visible){for(b=L.parts.length>1?1:0;b<L.parts.length;b++)if(I=L.parts[b],!!I.render.visible){if(w.showSleeping&&L.isSleeping?v.globalAlpha=.5*I.render.opacity:I.render.opacity!==1&&(v.globalAlpha=I.render.opacity),I.render.sprite&&I.render.sprite.texture&&!w.wireframes){var P=I.render.sprite,D=S(m,P.texture);v.translate(I.position.x,I.position.y),v.rotate(I.angle),v.drawImage(D,D.width*-P.xOffset*P.xScale,D.height*-P.yOffset*P.yScale,D.width*P.xScale,D.height*P.yScale),v.rotate(-I.angle),v.translate(-I.position.x,-I.position.y)}else{if(I.circleRadius)v.beginPath(),v.arc(I.position.x,I.position.y,I.circleRadius,0,2*Math.PI);else{v.beginPath(),v.moveTo(I.vertices[0].x,I.vertices[0].y);for(var B=1;B<I.vertices.length;B++)!I.vertices[B-1].isInternal||M?v.lineTo(I.vertices[B].x,I.vertices[B].y):v.moveTo(I.vertices[B].x,I.vertices[B].y),I.vertices[B].isInternal&&!M&&v.moveTo(I.vertices[(B+1)%I.vertices.length].x,I.vertices[(B+1)%I.vertices.length].y);v.lineTo(I.vertices[0].x,I.vertices[0].y),v.closePath()}w.wireframes?(v.lineWidth=1,v.strokeStyle=m.options.wireframeStrokeStyle,v.stroke()):(v.fillStyle=I.render.fillStyle,I.render.lineWidth&&(v.lineWidth=I.render.lineWidth,v.strokeStyle=I.render.strokeStyle,v.stroke()),v.fill())}v.globalAlpha=1}}},e.bodyWireframes=function(m,x,C){var v=C,w=m.options.showInternalEdges,M,L,I,k,b;for(v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.render.visible)for(b=M.parts.length>1?1:0;b<M.parts.length;b++){for(L=M.parts[b],v.moveTo(L.vertices[0].x,L.vertices[0].y),k=1;k<L.vertices.length;k++)!L.vertices[k-1].isInternal||w?v.lineTo(L.vertices[k].x,L.vertices[k].y):v.moveTo(L.vertices[k].x,L.vertices[k].y),L.vertices[k].isInternal&&!w&&v.moveTo(L.vertices[(k+1)%L.vertices.length].x,L.vertices[(k+1)%L.vertices.length].y);v.lineTo(L.vertices[0].x,L.vertices[0].y)}v.lineWidth=1,v.strokeStyle=m.options.wireframeStrokeStyle,v.stroke()},e.bodyConvexHulls=function(m,x,C){var v=C,w,M,L;for(v.beginPath(),M=0;M<x.length;M++)if(w=x[M],!(!w.render.visible||w.parts.length===1)){for(v.moveTo(w.vertices[0].x,w.vertices[0].y),L=1;L<w.vertices.length;L++)v.lineTo(w.vertices[L].x,w.vertices[L].y);v.lineTo(w.vertices[0].x,w.vertices[0].y)}v.lineWidth=1,v.strokeStyle="rgba(255,255,255,0.2)",v.stroke()},e.vertexNumbers=function(m,x,C){var v=C,w,M,L;for(w=0;w<x.length;w++){var I=x[w].parts;for(L=I.length>1?1:0;L<I.length;L++){var k=I[L];for(M=0;M<k.vertices.length;M++)v.fillStyle="rgba(255,255,255,0.2)",v.fillText(w+"_"+M,k.position.x+(k.vertices[M].x-k.position.x)*.8,k.position.y+(k.vertices[M].y-k.position.y)*.8)}}},e.mousePosition=function(m,x,C){var v=C;v.fillStyle="rgba(255,255,255,0.8)",v.fillText(x.position.x+"  "+x.position.y,x.position.x+5,x.position.y-5)},e.bodyBounds=function(m,x,C){var v=C;m.engine;var w=m.options;v.beginPath();for(var M=0;M<x.length;M++){var L=x[M];if(L.render.visible)for(var I=x[M].parts,k=I.length>1?1:0;k<I.length;k++){var b=I[k];v.rect(b.bounds.min.x,b.bounds.min.y,b.bounds.max.x-b.bounds.min.x,b.bounds.max.y-b.bounds.min.y)}}w.wireframes?v.strokeStyle="rgba(255,255,255,0.08)":v.strokeStyle="rgba(0,0,0,0.1)",v.lineWidth=1,v.stroke()},e.bodyAxes=function(m,x,C){var v=C;m.engine;var w=m.options,M,L,I,k;for(v.beginPath(),L=0;L<x.length;L++){var b=x[L],P=b.parts;if(b.render.visible)if(w.showAxes)for(I=P.length>1?1:0;I<P.length;I++)for(M=P[I],k=0;k<M.axes.length;k++){var D=M.axes[k];v.moveTo(M.position.x,M.position.y),v.lineTo(M.position.x+D.x*20,M.position.y+D.y*20)}else for(I=P.length>1?1:0;I<P.length;I++)for(M=P[I],k=0;k<M.axes.length;k++)v.moveTo(M.position.x,M.position.y),v.lineTo((M.vertices[0].x+M.vertices[M.vertices.length-1].x)/2,(M.vertices[0].y+M.vertices[M.vertices.length-1].y)/2)}w.wireframes?(v.strokeStyle="indianred",v.lineWidth=1):(v.strokeStyle="rgba(255, 255, 255, 0.4)",v.globalCompositeOperation="overlay",v.lineWidth=2),v.stroke(),v.globalCompositeOperation="source-over"},e.bodyPositions=function(m,x,C){var v=C;m.engine;var w=m.options,M,L,I,k;for(v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.render.visible)for(k=0;k<M.parts.length;k++)L=M.parts[k],v.arc(L.position.x,L.position.y,3,0,2*Math.PI,!1),v.closePath();for(w.wireframes?v.fillStyle="indianred":v.fillStyle="rgba(0,0,0,0.5)",v.fill(),v.beginPath(),I=0;I<x.length;I++)M=x[I],M.render.visible&&(v.arc(M.positionPrev.x,M.positionPrev.y,2,0,2*Math.PI,!1),v.closePath());v.fillStyle="rgba(255,165,0,0.8)",v.fill()},e.bodyVelocity=function(m,x,C){var v=C;v.beginPath();for(var w=0;w<x.length;w++){var M=x[w];if(M.render.visible){var L=s.getVelocity(M);v.moveTo(M.position.x,M.position.y),v.lineTo(M.position.x+L.x,M.position.y+L.y)}}v.lineWidth=3,v.strokeStyle="cornflowerblue",v.stroke()},e.bodyIds=function(m,x,C){var v=C,w,M;for(w=0;w<x.length;w++)if(x[w].render.visible){var L=x[w].parts;for(M=L.length>1?1:0;M<L.length;M++){var I=L[M];v.font="12px Arial",v.fillStyle="rgba(255,255,255,0.5)",v.fillText(I.id,I.position.x+10,I.position.y-10)}}},e.collisions=function(m,x,C){var v=C,w=m.options,M,L,I,k;for(v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.isActive)for(L=M.collision,k=0;k<M.contactCount;k++){var b=M.contacts[k],P=b.vertex;v.rect(P.x-1.5,P.y-1.5,3.5,3.5)}for(w.wireframes?v.fillStyle="rgba(255,255,255,0.7)":v.fillStyle="orange",v.fill(),v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.isActive&&(L=M.collision,M.contactCount>0)){var D=M.contacts[0].vertex.x,B=M.contacts[0].vertex.y;M.contactCount===2&&(D=(M.contacts[0].vertex.x+M.contacts[1].vertex.x)/2,B=(M.contacts[0].vertex.y+M.contacts[1].vertex.y)/2),L.bodyB===L.supports[0].body||L.bodyA.isStatic===!0?v.moveTo(D-L.normal.x*8,B-L.normal.y*8):v.moveTo(D+L.normal.x*8,B+L.normal.y*8),v.lineTo(D,B)}w.wireframes?v.strokeStyle="rgba(255,165,0,0.7)":v.strokeStyle="orange",v.lineWidth=1,v.stroke()},e.separations=function(m,x,C){var v=C,w=m.options,M,L,I,k,b;for(v.beginPath(),b=0;b<x.length;b++)if(M=x[b],!!M.isActive){L=M.collision,I=L.bodyA,k=L.bodyB;var P=1;!k.isStatic&&!I.isStatic&&(P=.5),k.isStatic&&(P=0),v.moveTo(k.position.x,k.position.y),v.lineTo(k.position.x-L.penetration.x*P,k.position.y-L.penetration.y*P),P=1,!k.isStatic&&!I.isStatic&&(P=.5),I.isStatic&&(P=0),v.moveTo(I.position.x,I.position.y),v.lineTo(I.position.x+L.penetration.x*P,I.position.y+L.penetration.y*P)}w.wireframes?v.strokeStyle="rgba(255,165,0,0.5)":v.strokeStyle="orange",v.stroke()},e.inspector=function(m,x){m.engine;var C=m.selected,v=m.render,w=v.options,M;if(w.hasBounds){var L=v.bounds.max.x-v.bounds.min.x,I=v.bounds.max.y-v.bounds.min.y,k=L/v.options.width,b=I/v.options.height;x.scale(1/k,1/b),x.translate(-v.bounds.min.x,-v.bounds.min.y)}for(var P=0;P<C.length;P++){var D=C[P].data;switch(x.translate(.5,.5),x.lineWidth=1,x.strokeStyle="rgba(255,165,0,0.9)",x.setLineDash([1,2]),D.type){case"body":M=D.bounds,x.beginPath(),x.rect(Math.floor(M.min.x-3),Math.floor(M.min.y-3),Math.floor(M.max.x-M.min.x+6),Math.floor(M.max.y-M.min.y+6)),x.closePath(),x.stroke();break;case"constraint":var B=D.pointA;D.bodyA&&(B=D.pointB),x.beginPath(),x.arc(B.x,B.y,10,0,2*Math.PI),x.closePath(),x.stroke();break}x.setLineDash([]),x.translate(-.5,-.5)}m.selectStart!==null&&(x.translate(.5,.5),x.lineWidth=1,x.strokeStyle="rgba(255,165,0,0.6)",x.fillStyle="rgba(255,165,0,0.1)",M=m.selectBounds,x.beginPath(),x.rect(Math.floor(M.min.x),Math.floor(M.min.y),Math.floor(M.max.x-M.min.x),Math.floor(M.max.y-M.min.y)),x.closePath(),x.stroke(),x.fill(),x.translate(-.5,-.5)),w.hasBounds&&x.setTransform(1,0,0,1,0,0)};var c=function(m,x){var C=m.engine,v=m.timing,w=v.historySize,M=C.timing.timestamp;v.delta=x-v.lastTime||e._goodDelta,v.lastTime=x,v.timestampElapsed=M-v.lastTimestamp||0,v.lastTimestamp=M,v.deltaHistory.unshift(v.delta),v.deltaHistory.length=Math.min(v.deltaHistory.length,w),v.engineDeltaHistory.unshift(C.timing.lastDelta),v.engineDeltaHistory.length=Math.min(v.engineDeltaHistory.length,w),v.timestampElapsedHistory.unshift(v.timestampElapsed),v.timestampElapsedHistory.length=Math.min(v.timestampElapsedHistory.length,w),v.engineUpdatesHistory.unshift(C.timing.lastUpdatesPerFrame),v.engineUpdatesHistory.length=Math.min(v.engineUpdatesHistory.length,w),v.engineElapsedHistory.unshift(C.timing.lastElapsed),v.engineElapsedHistory.length=Math.min(v.engineElapsedHistory.length,w),v.elapsedHistory.unshift(v.lastElapsed),v.elapsedHistory.length=Math.min(v.elapsedHistory.length,w)},f=function(m){for(var x=0,C=0;C<m.length;C+=1)x+=m[C];return x/m.length||0},y=function(m,x){var C=document.createElement("canvas");return C.width=m,C.height=x,C.oncontextmenu=function(){return!1},C.onselectstart=function(){return!1},C},E=function(m){var x=m.getContext("2d"),C=window.devicePixelRatio||1,v=x.webkitBackingStorePixelRatio||x.mozBackingStorePixelRatio||x.msBackingStorePixelRatio||x.oBackingStorePixelRatio||x.backingStorePixelRatio||1;return C/v},S=function(m,x){var C=m.textures[x];return C||(C=m.textures[x]=new Image,C.src=x,C)},T=function(m,x){var C=x;/(jpg|gif|png)$/.test(x)&&(C="url("+x+")"),m.canvas.style.background=C,m.canvas.style.backgroundSize="contain",m.currentBackground=x}})()},function(i,p,n){var e={};i.exports=e;var s=n(5),r=n(17),o=n(0);(function(){e._maxFrameDelta=1e3/15,e._frameDeltaFallback=1e3/60,e._timeBufferMargin=1.5,e._elapsedNextEstimate=1,e._smoothingLowerBound=.1,e._smoothingUpperBound=.9,e.create=function(l){var g={delta:16.666666666666668,frameDelta:null,frameDeltaSmoothing:!0,frameDeltaSnapping:!0,frameDeltaHistory:[],frameDeltaHistorySize:100,frameRequestId:null,timeBuffer:0,timeLastTick:null,maxUpdates:null,maxFrameTime:33.333333333333336,lastUpdatesDeferred:0,enabled:!0},h=o.extend(g,l);return h.fps=0,h},e.run=function(l,g){return l.timeBuffer=e._frameDeltaFallback,function h(t){l.frameRequestId=e._onNextFrame(l,h),t&&l.enabled&&e.tick(l,g,t)}(),l},e.tick=function(l,g,h){var t=o.now(),u=l.delta,c=0,f=h-l.timeLastTick;if((!f||!l.timeLastTick||f>Math.max(e._maxFrameDelta,l.maxFrameTime))&&(f=l.frameDelta||e._frameDeltaFallback),l.frameDeltaSmoothing){l.frameDeltaHistory.push(f),l.frameDeltaHistory=l.frameDeltaHistory.slice(-l.frameDeltaHistorySize);var y=l.frameDeltaHistory.slice(0).sort(),E=l.frameDeltaHistory.slice(y.length*e._smoothingLowerBound,y.length*e._smoothingUpperBound),S=d(E);f=S||f}l.frameDeltaSnapping&&(f=1e3/Math.round(1e3/f)),l.frameDelta=f,l.timeLastTick=h,l.timeBuffer+=l.frameDelta,l.timeBuffer=o.clamp(l.timeBuffer,0,l.frameDelta+u*e._timeBufferMargin),l.lastUpdatesDeferred=0;var T=l.maxUpdates||Math.ceil(l.maxFrameTime/u),m={timestamp:g.timing.timestamp};s.trigger(l,"beforeTick",m),s.trigger(l,"tick",m);for(var x=o.now();u>0&&l.timeBuffer>=u*e._timeBufferMargin;){s.trigger(l,"beforeUpdate",m),r.update(g,u),s.trigger(l,"afterUpdate",m),l.timeBuffer-=u,c+=1;var C=o.now()-t,v=o.now()-x,w=C+e._elapsedNextEstimate*v/c;if(c>=T||w>l.maxFrameTime){l.lastUpdatesDeferred=Math.round(Math.max(0,l.timeBuffer/u-e._timeBufferMargin));break}}g.timing.lastUpdatesPerFrame=c,s.trigger(l,"afterTick",m),l.frameDeltaHistory.length>=100&&(l.lastUpdatesDeferred&&Math.round(l.frameDelta/u)>T?o.warnOnce("Matter.Runner: runner reached runner.maxUpdates, see docs."):l.lastUpdatesDeferred&&o.warnOnce("Matter.Runner: runner reached runner.maxFrameTime, see docs."),typeof l.isFixed<"u"&&o.warnOnce("Matter.Runner: runner.isFixed is now redundant, see docs."),(l.deltaMin||l.deltaMax)&&o.warnOnce("Matter.Runner: runner.deltaMin and runner.deltaMax were removed, see docs."),l.fps!==0&&o.warnOnce("Matter.Runner: runner.fps was replaced by runner.delta, see docs."))},e.stop=function(l){e._cancelNextFrame(l)},e._onNextFrame=function(l,g){if(typeof window<"u"&&window.requestAnimationFrame)l.frameRequestId=window.requestAnimationFrame(g);else throw new Error("Matter.Runner: missing required global window.requestAnimationFrame.");return l.frameRequestId},e._cancelNextFrame=function(l){if(typeof window<"u"&&window.cancelAnimationFrame)window.cancelAnimationFrame(l.frameRequestId);else throw new Error("Matter.Runner: missing required global window.cancelAnimationFrame.")};var d=function(l){for(var g=0,h=l.length,t=0;t<h;t+=1)g+=l[t];return g/h||0}})()},function(i,p,n){var e={};i.exports=e;var s=n(8),r=n(0),o=r.deprecated;(function(){e.collides=function(d,l){return s.collides(d,l)},o(e,"collides","SAT.collides ➤ replaced by Collision.collides")})()},function(i,p,n){var e={};i.exports=e,n(1);var s=n(0);(function(){e.pathToVertices=function(r,o){typeof window<"u"&&!("SVGPathSeg"in window)&&s.warn("Svg.pathToVertices: SVGPathSeg not defined, a polyfill is required.");var d,l,g,h,t,u,c,f,y,E,S=[],T,m,x=0,C=0,v=0;o=o||15;var w=function(L,I,k){var b=k%2===1&&k>1;if(!y||L!=y.x||I!=y.y){y&&b?(T=y.x,m=y.y):(T=0,m=0);var P={x:T+L,y:m+I};(b||!y)&&(y=P),S.push(P),C=T+L,v=m+I}},M=function(L){var I=L.pathSegTypeAsLetter.toUpperCase();if(I!=="Z"){switch(I){case"M":case"L":case"T":case"C":case"S":case"Q":C=L.x,v=L.y;break;case"H":C=L.x;break;case"V":v=L.y;break}w(C,v,L.pathSegType)}};for(e._svgPathToAbsolute(r),g=r.getTotalLength(),u=[],d=0;d<r.pathSegList.numberOfItems;d+=1)u.push(r.pathSegList.getItem(d));for(c=u.concat();x<g;){if(E=r.getPathSegAtLength(x),t=u[E],t!=f){for(;c.length&&c[0]!=t;)M(c.shift());f=t}switch(t.pathSegTypeAsLetter.toUpperCase()){case"C":case"T":case"S":case"Q":case"A":h=r.getPointAtLength(x),w(h.x,h.y,0);break}x+=o}for(d=0,l=c.length;d<l;++d)M(c[d]);return S},e._svgPathToAbsolute=function(r){for(var o,d,l,g,h,t,u=r.pathSegList,c=0,f=0,y=u.numberOfItems,E=0;E<y;++E){var S=u.getItem(E),T=S.pathSegTypeAsLetter;if(/[MLHVCSQTA]/.test(T))"x"in S&&(c=S.x),"y"in S&&(f=S.y);else switch("x1"in S&&(l=c+S.x1),"x2"in S&&(h=c+S.x2),"y1"in S&&(g=f+S.y1),"y2"in S&&(t=f+S.y2),"x"in S&&(c+=S.x),"y"in S&&(f+=S.y),T){case"m":u.replaceItem(r.createSVGPathSegMovetoAbs(c,f),E);break;case"l":u.replaceItem(r.createSVGPathSegLinetoAbs(c,f),E);break;case"h":u.replaceItem(r.createSVGPathSegLinetoHorizontalAbs(c),E);break;case"v":u.replaceItem(r.createSVGPathSegLinetoVerticalAbs(f),E);break;case"c":u.replaceItem(r.createSVGPathSegCurvetoCubicAbs(c,f,l,g,h,t),E);break;case"s":u.replaceItem(r.createSVGPathSegCurvetoCubicSmoothAbs(c,f,h,t),E);break;case"q":u.replaceItem(r.createSVGPathSegCurvetoQuadraticAbs(c,f,l,g),E);break;case"t":u.replaceItem(r.createSVGPathSegCurvetoQuadraticSmoothAbs(c,f),E);break;case"a":u.replaceItem(r.createSVGPathSegArcAbs(c,f,S.r1,S.r2,S.angle,S.largeArcFlag,S.sweepFlag),E);break;case"z":case"Z":c=o,f=d;break}(T=="M"||T=="m")&&(o=c,d=f)}}})()},function(i,p,n){var e={};i.exports=e;var s=n(6);n(0),function(){e.create=s.create,e.add=s.add,e.remove=s.remove,e.clear=s.clear,e.addComposite=s.addComposite,e.addBody=s.addBody,e.addConstraint=s.addConstraint}()}])})}(le)),le.exports}var Ge=Qe();const F=He(Ge),ae=1,qe=2,V=60,we=70;class Ke{constructor(a,i){A(this,"engine");A(this,"world");A(this,"runner");A(this,"ground");A(this,"leftWall");A(this,"rightWall");A(this,"topWall");A(this,"resizeListener");A(this,"catManager");A(this,"catFoodManager");A(this,"mouseConstraint");A(this,"collisionHandler");A(this,"speedLimitHandler");console.log("PhysicsManager Creado"),this.catManager=a,this.catFoodManager=i,this.resizeListener=this.handleResize.bind(this),this.collisionHandler=this.handleCollisions.bind(this),this.speedLimitHandler=this.limitAllCatSpeeds.bind(this)}init(a){console.log("PhysicsManager: init"),this.engine=F.Engine.create(),this.world=this.engine.world,this.runner=F.Runner.create(),this.engine.gravity.y=.8,this.engine.gravity.x=0,this.engine.enableSleeping=!0,console.log("Matter.js Engine, World, Runner creados."),this.createWalls(),this.setupMouseConstraint(a),console.log("PhysicsManager: Añadiendo listeners..."),F.Events.on(this.engine,"collisionStart",this.collisionHandler),F.Events.on(this.engine,"beforeUpdate",this.speedLimitHandler),window.addEventListener("resize",this.resizeListener)}createWalls(){const a=window.innerWidth,i=window.innerHeight;this.ground=F.Bodies.rectangle(a/2,i+V/2,a,V,{isStatic:!0,label:"ground",collisionFilter:{category:ae}}),this.leftWall=F.Bodies.rectangle(-60/2,i/2,V,i,{isStatic:!0,label:"leftWall",collisionFilter:{category:ae}}),this.rightWall=F.Bodies.rectangle(a+V/2,i/2,V,i,{isStatic:!0,label:"rightWall",collisionFilter:{category:ae}}),this.topWall=F.Bodies.rectangle(a/2,-60/2,a,V,{isStatic:!0,label:"topWall",collisionFilter:{category:ae}}),F.World.add(this.world,[this.ground,this.leftWall,this.rightWall,this.topWall])}setupMouseConstraint(a){const i=F.Mouse.create(a);this.mouseConstraint=F.MouseConstraint.create(this.engine,{mouse:i,constraint:{stiffness:.1,render:{visible:!1}}}),this.mouseConstraint.collisionFilter.mask=qe,F.World.add(this.world,this.mouseConstraint),this.updateMouseConstraintOffset()}updateMouseConstraintOffset(){if(this.mouseConstraint&&this.mouseConstraint.mouse.element){const a=this.mouseConstraint.mouse.element.getBoundingClientRect();F.Mouse.setOffset(this.mouseConstraint.mouse,{x:-a.left,y:-a.top})}}handleCollisions(a){var p,n;const i=a.pairs;for(let e=0;e<i.length;e++){const s=i[e],r=s.bodyA,o=s.bodyB,d=r==null?void 0:r.label,l=o==null?void 0:o.label;if(d==="cat"&&l==="cat"){const g=((p=this.mouseConstraint)==null?void 0:p.body)===r,h=((n=this.mouseConstraint)==null?void 0:n.body)===o;if(g!==h)if(typeof r.id<"u"&&typeof o.id<"u"){const t=g?r.id:o.id;this.catManager.processPlayerInitiatedCollision(r.id,o.id,t)}else console.error("Error: IDs indefinidos en colisión gato-gato.")}else if(d==="cat"&&l==="foodPellet"||d==="foodPellet"&&l==="cat"){const g=d==="cat"?r:o,h=d==="foodPellet"?r:o;typeof g.id<"u"&&h?this.catFoodManager.processCatFoodCollision(g.id,h):console.warn("Colisión Gato-Comida detectada pero falta ID de gato o cuerpo de comida.")}}}limitAllCatSpeeds(){if(!this.world)return;const a=F.Composite.allBodies(this.world);for(let i=0;i<a.length;i++){const p=a[i];if(!p.isStatic&&p.label==="cat"&&F.Vector.magnitude(p.velocity)>we){const e=F.Vector.normalise(p.velocity),s=F.Vector.mult(e,we);F.Body.setVelocity(p,s)}}}handleResize(){if(!this.ground||!this.leftWall||!this.rightWall||!this.topWall)return;const a=window.innerWidth,i=window.innerHeight;try{const p=`L ${-a/2} ${-V/2} L ${a/2} ${-V/2} L ${a/2} ${V/2} L ${-a/2} ${V/2}`,n=`L ${-V/2} ${-i/2} L ${V/2} ${-i/2} L ${V/2} ${i/2} L ${-V/2} ${i/2}`,e=`L ${-a/2} ${-V/2} L ${a/2} ${-V/2} L ${a/2} ${V/2} L ${-a/2} ${V/2}`;F.Body.setPosition(this.ground,{x:a/2,y:i+V/2}),F.Body.setVertices(this.ground,F.Vertices.fromPath(p,this.ground)),F.Body.setPosition(this.leftWall,{x:-V/2,y:i/2}),F.Body.setVertices(this.leftWall,F.Vertices.fromPath(n,this.leftWall)),F.Body.setPosition(this.rightWall,{x:a+V/2,y:i/2}),F.Body.setVertices(this.rightWall,F.Vertices.fromPath(n,this.rightWall)),F.Body.setPosition(this.topWall,{x:a/2,y:-V/2}),F.Body.setVertices(this.topWall,F.Vertices.fromPath(e,this.topWall)),this.updateMouseConstraintOffset()}catch(p){console.error("PhysicsManager: Error actualizando límites en resize:",p)}}start(){if(!this.engine||!this.runner){console.error("PhysicsManager: init() debe ser llamado antes de start().");return}F.Runner.run(this.runner,this.engine)}stop(){if(!this.runner){console.warn("PhysicsManager: Runner no inicializado.");return}F.Runner.stop(this.runner)}shutdown(){console.log("PhysicsManager: shutdown"),this.stop(),this.engine?(F.Events.off(this.engine,"collisionStart",this.collisionHandler),F.Events.off(this.engine,"beforeUpdate",this.speedLimitHandler),console.log("PhysicsManager: Listeners de engine removidos.")):console.warn("PhysicsManager shutdown: Engine no encontrado."),window.removeEventListener("resize",this.resizeListener)}getEngine(){if(!this.engine)throw new Error("PhysicsManager no inicializado.");return this.engine}getWorld(){if(!this.world)throw new Error("PhysicsManager no inicializado.");return this.world}}class Ye{constructor(){A(this,"allQuestions",[]);A(this,"availableQuestions",[]);A(this,"currentQuestion",null);A(this,"isLoading",!1);A(this,"lastError",null)}async loadQuestionsData(a){if(this.isLoading)return console.warn("QuizSystem: Ya hay una carga en progreso."),!1;this.isLoading=!0,this.lastError=null,this.allQuestions=[];try{if(!Array.isArray(a))throw new Error("Los datos de preguntas proporcionados no son un array válido.");return this.allQuestions=a,this.resetAvailableQuestions(),console.log(`QuizSystem: ${this.allQuestions.length} preguntas procesadas exitosamente desde datos pre-cargados.`),this.isLoading=!1,!0}catch(i){return console.error("QuizSystem: Error al procesar los datos de preguntas:",i),this.lastError=i instanceof Error?i.message:String(i),this.isLoading=!1,this.allQuestions=[],this.availableQuestions=[],!1}}selectNextQuestion(a){if(this.allQuestions.length===0&&!this.isLoading)return console.error("QuizSystem: No hay preguntas cargadas o procesadas. Llama a loadQuestionsData() después de cargar los datos."),null;if(this.isLoading)return console.warn("QuizSystem: Las preguntas aún se están procesando."),null;let i=this.availableQuestions;if(a&&(i=i.filter(n=>String(n.difficulty)===String(a))),i.length===0&&(console.warn("QuizSystem: No quedan preguntas disponibles"+(a?` con dificultad '${a}'.`:".")+" Reseteando lista..."),this.resetAvailableQuestions(),i=this.availableQuestions,a&&(i=i.filter(n=>String(n.difficulty)===String(a))),i.length===0))return console.error(`QuizSystem: No se encontraron preguntas con dificultad '${a}' incluso después de resetear.`),null;const p=Math.floor(Math.random()*i.length);return this.currentQuestion=i[p],this.availableQuestions=this.availableQuestions.filter(n=>{var e;return n.id!==((e=this.currentQuestion)==null?void 0:e.id)}),this.currentQuestion}validateAnswer(a,i){const p=this.allQuestions.find(e=>e.id===a);return p?i===null?!1:p.correctAnswerKey===i:(console.error(`QuizSystem: No se encontró la pregunta con ID '${a}' para validar.`),null)}getCurrentQuestion(){return this.currentQuestion}resetAvailableQuestions(){this.availableQuestions=[...this.allQuestions],this.currentQuestion=null,console.log(`QuizSystem: Lista de preguntas disponibles reseteada (${this.availableQuestions.length} preguntas).`)}getLastError(){return this.lastError}isLoadingQuestions(){return this.isLoading}}class Xe{constructor(){A(this,"states",new Map);A(this,"currentState",null);A(this,"currentStateName",null)}addState(a,i){this.states.has(a)&&console.warn(`StateMachine: El estado '${a}' ya existe. Sobrescribiendo.`),this.states.set(a,i),console.log(`StateMachine: Estado '${a}' añadido.`)}changeState(a,i){var p,n;if(console.log(`StateMachine: Intentando cambiar a estado '${a}'...`),console.log(`StateMachine: Verificando estado '${a}'. Estados actuales registrados:`,Array.from(this.states.keys())),!this.states.has(a)){console.error(`StateMachine: El estado '${a}' no existe.`),console.error("StateMachine: Detalle del mapa de estados:",this.states);return}if((p=this.currentState)!=null&&p.exit){console.log(`StateMachine: Saliendo del estado '${this.currentStateName}'`);try{this.currentState.exit()}catch(e){console.error(`StateMachine: Error durante exit() del estado '${this.currentStateName}':`,e)}}if(this.currentStateName=a,this.currentState=this.states.get(a)??null,(n=this.currentState)!=null&&n.enter){console.log(`StateMachine: Entrando al estado '${this.currentStateName}'`);try{this.currentState.enter(i)}catch(e){console.error(`StateMachine: Error durante enter() del estado '${this.currentStateName}':`,e)}}}update(a){var i;if((i=this.currentState)!=null&&i.update)try{this.currentState.update(a)}catch(p){console.error(`StateMachine: Error durante update() del estado '${this.currentStateName}':`,p)}}getCurrentStateName(){return this.currentStateName}getCurrentState(){return this.currentState}}class Ze{constructor(){A(this,"audioCtx",null);A(this,"isInitialized",!1);A(this,"masterGainNode",null);console.log("AudioManager Creado (sin inicializar)")}init(){if(!this.isInitialized)try{this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.masterGainNode=this.audioCtx.createGain(),this.masterGainNode.connect(this.audioCtx.destination),this.audioCtx.state==="suspended"?this.audioCtx.resume().then(()=>{console.log("AudioManager: AudioContext reanudado exitosamente."),this.isInitialized=!0}).catch(a=>console.error("AudioManager: Error al reanudar AudioContext:",a)):this.isInitialized=!0}catch(a){console.error("AudioManager: Error al crear AudioContext:",a),this.audioCtx=null,this.masterGainNode=null,this.isInitialized=!1}}playSound(a){if(!((!this.isInitialized||!this.audioCtx||!this.masterGainNode)&&(this.isInitialized||this.init(),!this.isInitialized||!this.audioCtx||!this.masterGainNode))){if(this.audioCtx.state!=="running"){this.audioCtx.state==="suspended"&&this.audioCtx.resume().catch(i=>console.error("Error reanudando AudioContext en playSound:",i));return}try{const i=this.audioCtx.createOscillator(),p=this.audioCtx.createGain();i.connect(p),p.connect(this.masterGainNode);const n=this.audioCtx.currentTime,e=(s,r,o)=>{s.onended=()=>{try{s.numberOfOutputs>0&&s.disconnect(),o&&o.numberOfOutputs>0&&o.disconnect(),r.numberOfOutputs>0&&r.disconnect()}catch{}}};switch(a){case"correct":i.type="sine",i.frequency.setValueAtTime(440,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.4,n+.05),i.frequency.exponentialRampToValueAtTime(880,n+.15),p.gain.exponentialRampToValueAtTime(1e-4,n+.3),e(i,p),i.start(n),i.stop(n+.35);break;case"incorrect":i.type="square",i.frequency.setValueAtTime(110,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.3,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.2),e(i,p),i.start(n),i.stop(n+.25);break;case"eat":i.type="sawtooth",i.frequency.setValueAtTime(150,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.15,n+.03),i.frequency.exponentialRampToValueAtTime(50,n+.1),p.gain.exponentialRampToValueAtTime(1e-4,n+.15),e(i,p),i.start(n),i.stop(n+.2);break;case"draw_start":i.type="triangle",i.frequency.setValueAtTime(330,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.1,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.1),e(i,p),i.start(n),i.stop(n+.15);break;case"draw_end":i.type="sine",i.frequency.setValueAtTime(220,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.15,n+.03),p.gain.exponentialRampToValueAtTime(1e-4,n+.15),e(i,p),i.start(n),i.stop(n+.2);break;case"clear_ink":i.type="sawtooth",i.frequency.setValueAtTime(800,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.2,n+.05),i.frequency.exponentialRampToValueAtTime(200,n+.2),p.gain.exponentialRampToValueAtTime(1e-4,n+.3),e(i,p),i.start(n),i.stop(n+.35);break;case"game_over":i.type="square",i.frequency.setValueAtTime(220,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.3,n+.05),i.frequency.exponentialRampToValueAtTime(110,n+.15),p.gain.exponentialRampToValueAtTime(1e-4,n+.4),e(i,p),i.start(n),i.stop(n+.45);break;case"purchase":i.type="triangle",i.frequency.setValueAtTime(660,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.3,n+.03),i.frequency.exponentialRampToValueAtTime(1320,n+.1),p.gain.exponentialRampToValueAtTime(1e-4,n+.2),e(i,p),i.start(n),i.stop(n+.25);break;case"shield_break":i.type="sawtooth";const s=this.audioCtx.createBiquadFilter();s.type="bandpass",s.frequency.setValueAtTime(1500,n),s.Q.setValueAtTime(15,n),i.connect(s),s.connect(p),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.5,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.3),e(i,p,s),i.start(n),i.stop(n+.3);break;case"hint_used":i.type="sine",i.frequency.setValueAtTime(900,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.1,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.1),e(i,p),i.start(n),i.stop(n+.15);break;case"ui_confirm":i.type="sine",i.frequency.setValueAtTime(523.25,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.25,n+.02),i.frequency.linearRampToValueAtTime(659.25,n+.05),p.gain.exponentialRampToValueAtTime(1e-4,n+.15),e(i,p),i.start(n),i.stop(n+.2);break;default:console.warn(`AudioManager: Tipo de sonido desconocido: '${a}'`);return}}catch(i){console.error(`AudioManager: Error al reproducir sonido '${a}':`,i)}}}setVolume(a){if(!this.isInitialized||!this.audioCtx||!this.masterGainNode)return;const i=Math.max(0,Math.min(1,a));this.masterGainNode.gain.setValueAtTime(i,this.audioCtx.currentTime)}getVolume(){return!this.isInitialized||!this.masterGainNode?0:this.masterGainNode.gain.value}isReady(){return this.isInitialized&&this.audioCtx!==null&&this.audioCtx.state==="running"}}class Be{constructor(a){A(this,"type","PhysicsComponent");A(this,"body",null);this.body=a??null}}class De{constructor(a){A(this,"type","RenderComponent");A(this,"element",null);A(this,"isVisible",!0);this.element=a??null}}class Fe{constructor(a=0,i=0,p=0,n=0){A(this,"type","ValueComponent");A(this,"rarity",0);A(this,"scoreValue",0);A(this,"currentSize",0);A(this,"growthLevel",0);this.rarity=a,this.scoreValue=i,this.currentSize=p,this.growthLevel=n}}class Je{constructor(a,i,p,n){A(this,"id");A(this,"physics");A(this,"render");A(this,"value");this.id=a,this.physics=i,this.render=p,this.value=n}getComponent(a){if(a===this.physics.type&&this.physics instanceof Be)return this.physics;if(a===this.render.type&&this.render instanceof De)return this.render;if(a===this.value.type&&this.value instanceof Fe)return this.value}}const je=1,Ie=2,_e=4,et=8,tt=1.15,Le=300,nt=1.02,he={0:null,1:"glow-gray",2:"glow-green",3:"glow-blue",4:"glow-violet",5:"glow-orange"};class it{constructor(a,i){A(this,"cats",new Map);A(this,"physicsManager");A(this,"audioManager");A(this,"gameManager");A(this,"bodyIdToEntityIdMap",new Map);A(this,"nextCatIdCounter",0);A(this,"catContainerElement",null);A(this,"templates",new Map);this.audioManager=a,this.gameManager=i,this.catContainerElement=document.getElementById("cat-container"),this.catContainerElement||console.error("CatManager: Elemento '#cat-container' no encontrado!"),console.log("CatManager Creado (con ref a GameManager).")}setPhysicsManager(a){this.physicsManager=a}loadTemplates(a){if(this.templates.clear(),!Array.isArray(a)){console.error("CatManager: Formato inválido de plantillas.");return}a.forEach(i=>{i!=null&&i.id?((typeof i.spawnWeight!="number"||i.spawnWeight<=0)&&(i.spawnWeight=1),this.templates.set(i.id,i)):console.warn("CatManager: Plantilla inválida o sin ID.",i)})}getSpawnableTemplatesWeighted(){const a=[];return this.templates.forEach(i=>{const p=i.spawnWeight&&i.spawnWeight>0?i.spawnWeight:1;a.push({id:i.id,weight:p})}),a}addCat(a,i){if(!this.gameManager)return console.error("CatManager: GameManager no disponible."),null;const p=this.cats.size,n=this.gameManager.getPlayerData().getMaxCatsAllowed();if(p>=n)return null;if(!this.catContainerElement||!this.physicsManager)return console.error("CatManager: Falta #cat-container o PhysicsManager."),null;const e=this.templates.get(a);if(!e)return console.error(`CatManager: Plantilla '${a}' no encontrada.`),null;const s=`cat_entity_${this.nextCatIdCounter++}`,r=e.initialSize,o=e.rarity,d=e.scoreValue??0,l=(i==null?void 0:i.x)??Math.random()*(window.innerWidth-r)+r/2,g=(i==null?void 0:i.y)??r/2+10,t={...{restitution:.6,friction:.1,frictionAir:.01,density:.005,slop:.01},...e.physicsOptions??{},label:"cat",collisionFilter:{category:Ie,mask:je|Ie|_e|et},plugin:{entityId:s,rarity:o,currentSize:r}},u=F.Bodies.circle(l,g,r/2,t);F.Body.setAngularVelocity(u,(Math.random()-.5)*.2);const c=new Be(u);this.bodyIdToEntityIdMap.set(u.id,s);const f=document.createElement("div");f.id=s,f.classList.add("cat"),f.style.width=`${r}px`,f.style.height=`${r}px`;const y=e.renderOptions??{},E=y.glowClass??he[o];E&&f.classList.add(E);let S=y.imageUrl;const T=y.backgroundColor??"#cccccc";if(S||(S=`https://cataas.com/cat?${Date.now()}&width=${Math.round(r)}&height=${Math.round(r)}`),S){f.style.backgroundImage=`url('${S}')`,f.style.backgroundSize="cover",f.style.backgroundPosition="center";const v=new Image;v.onerror=()=>{console.warn(`Failed to load cat image: ${S}. Using fallback color.`),f.style.backgroundImage="none",f.style.backgroundColor=T},v.src=S}else f.style.backgroundColor=T;if(this.catContainerElement)this.catContainerElement.appendChild(f);else return console.error("Error Crítico: #cat-container no encontrado al añadir gato."),this.bodyIdToEntityIdMap.delete(u.id),null;const m=new De(f),x=new Fe(o,d,r,0),C=new Je(s,c,m,x);try{F.World.add(this.physicsManager.getWorld(),u)}catch(v){return console.error(`CatManager: Error añadiendo cuerpo físico ${s} al mundo:`,v),f.parentNode&&f.parentNode.removeChild(f),this.bodyIdToEntityIdMap.delete(u.id),null}return this.cats.set(s,C),C}removeCat(a){var n,e;const i=String(a),p=this.cats.get(i);if(p){const s=p.physics.body;if(s){this.bodyIdToEntityIdMap.delete(s.id);try{(n=this.physicsManager)!=null&&n.getWorld&&F.Composite.get(this.physicsManager.getWorld(),s.id,"body")&&F.World.remove(this.physicsManager.getWorld(),s)}catch(r){console.warn(`Error eliminando cuerpo físico gato ${i}:`,r)}}(e=p.render.element)!=null&&e.parentNode&&p.render.element.parentNode.removeChild(p.render.element),this.cats.delete(i)}}processPlayerInitiatedCollision(a,i,p){const n=this.bodyIdToEntityIdMap.get(a),e=this.bodyIdToEntityIdMap.get(i);if(n&&e){const s=this.cats.get(n),r=this.cats.get(e);if(s&&r){const o=a===p?s:r,d=a===p?r:s;o&&d?this.handleCatVsCatCollision(o,d):console.error("Error: No se pudo determinar dragger/target cat en colisión.")}}}handleCatVsCatCollision(a,i){if(!a.physics.body||!a.value||!i.physics.body||!i.value||!this.gameManager){console.warn("handleCatVsCatCollision: Faltan componentes necesarios en dragger o target.");return}if(a.id===i.id)return;const p=a.value.currentSize,n=a.value.rarity,e=i.value.currentSize,s=i.value.rarity,r=this.gameManager.getPlayerData().getCurrentMaxSizeLimit(),o=p>=r;let d=!1,l=!1,g=!1;p>e*nt&&(o?n<s&&(d=!0,g=!1,l=!0):(d=!0,g=!0,l=n<s)),d&&this.performEat(a,i,l,g)}performEat(a,i,p,n){if(!a.physics.body||!a.value||!a.render.element||!i.value||!this.gameManager){console.warn("performEat: Faltan componentes en eater o eaten.");return}const e=i.id,s=i.value.rarity,r=he[s];if(this.removeCat(e),n){const o=a.value.currentSize,d=this.gameManager.getPlayerData().getCurrentMaxSizeLimit();let l=Math.min(d,Le,o*tt);const g=l/o;if(g>1.001){a.value.currentSize=l;try{if(this.physicsManager.getWorld&&F.Composite.get(this.physicsManager.getWorld(),a.physics.body.id,"body"))F.Body.scale(a.physics.body,g,g),a.physics.body.plugin&&(a.physics.body.plugin.currentSize=l);else throw new Error("Body not found in world during scaling")}catch(h){console.error(`Error scaling body ${a.id}:`,h),a.value.currentSize=o,a.physics.body.plugin&&(a.physics.body.plugin.currentSize=o)}a.render.element.style.width=`${l}px`,a.render.element.style.height=`${l}px`}}if(p&&s>a.value.rarity){const o=he[a.value.rarity];o&&a.render.element&&a.render.element.classList.remove(o),a.value.rarity=s,a.physics.body.plugin&&(a.physics.body.plugin.rarity=s);const d=r;d&&a.render.element&&a.render.element.classList.add(d),console.log(` -> Cat ${a.id} stole rarity ${s} from ${e}`)}try{this.audioManager.playSound("eat")}catch(o){console.error("Error playing 'eat' sound:",o)}}updateCats(a){this.cats.forEach(i=>{const p=i.physics.body,n=i.render.element,e=i.value;if(!p||!n||!e){console.warn(`Skipping update for cat ${i.id}: Missing body, element, or value.`);return}const s=e.currentSize;if(i.render.isVisible){n.style.display==="none"&&(n.style.display="");const r=s/2;n.style.transform=`translate(${p.position.x-r}px, ${p.position.y-r}px) rotate(${p.angle}rad)`;const o=parseFloat(n.style.width);(isNaN(o)||Math.abs(o-s)>.1)&&(n.style.width=`${s}px`,n.style.height=`${s}px`)}else n.style.display!=="none"&&(n.style.display="none")})}getCat(a){return this.cats.get(a)}getAllCats(){return Array.from(this.cats.values())}removeAllCats(){console.log(`CatManager: Removing all ${this.cats.size} cats...`),Array.from(this.cats.keys()).forEach(i=>this.removeCat(i)),this.cats.size>0&&(console.warn(`CatManager: ${this.cats.size} cats remained after individual removal. Clearing map forcefully.`),this.cats.clear()),this.bodyIdToEntityIdMap.clear(),this.nextCatIdCounter=0,this.catContainerElement&&(this.catContainerElement.innerHTML=""),console.log("CatManager: All cats removed.")}growExistingCats(a,i){let p=0;this.cats.forEach(n=>{if(!(!n.value||!n.physics.body||!this.physicsManager||!this.gameManager||n.value.rarity!==0)&&n.value.growthLevel<i){const e=n.value.currentSize,s=this.gameManager.getPlayerData().getCurrentMaxSizeLimit();let r=Math.min(s,Le,e+a);const o=r/e;if(o>1.0001){n.value.growthLevel++,n.value.currentSize=r;try{const d=n.physics.body;if(this.physicsManager.getWorld&&F.Composite.get(this.physicsManager.getWorld(),d.id,"body"))F.Body.scale(d,o,o),d.plugin&&(d.plugin.currentSize=r),p++;else throw new Error("Body not found in world for growth scaling")}catch(d){console.error(` -> Error escalando gato común ${n.id} (crecimiento por acierto):`,d),n.value.growthLevel--,n.value.currentSize=e,n.physics.body.plugin&&(n.physics.body.plugin.currentSize=e)}}}})}}const at="shop-popup",st="shop-close-button",ot="shop-player-score",rt="shop-items-container",lt="shop-tooltip",ct="tooltip-name",ut="tooltip-level",ht="tooltip-effect",dt="tooltip-cost",ft="tooltip-status";class gt{constructor(a,i){A(this,"items",new Map);A(this,"playerData");A(this,"gameManager");A(this,"itemListeners",new Map);A(this,"itemElements",new Map);A(this,"shopPopupElement",null);A(this,"shopCloseButtonElement",null);A(this,"shopPlayerScoreElement",null);A(this,"shopItemsContainerElement",null);A(this,"tooltipElement",null);A(this,"tooltipNameElement",null);A(this,"tooltipLevelElement",null);A(this,"tooltipEffectElement",null);A(this,"tooltipCostElement",null);A(this,"tooltipStatusElement",null);A(this,"closeButtonListeners",null);A(this,"backdropClickListeners",null);console.log("ShopManager: Constructor iniciado."),this.playerData=a,this.gameManager=i,this.shopPopupElement=document.getElementById(at),this.shopCloseButtonElement=document.getElementById(st),this.shopPlayerScoreElement=document.getElementById(ot),this.shopItemsContainerElement=document.getElementById(rt),this.tooltipElement=document.getElementById(lt),this.tooltipElement&&(this.tooltipNameElement=this.tooltipElement.querySelector(`#${ct}`),this.tooltipLevelElement=this.tooltipElement.querySelector(`#${ut}`),this.tooltipEffectElement=this.tooltipElement.querySelector(`#${ht}`),this.tooltipCostElement=this.tooltipElement.querySelector(`#${dt}`),this.tooltipStatusElement=this.tooltipElement.querySelector(`#${ft}`)),(!this.shopPopupElement||!this.shopCloseButtonElement||!this.shopItemsContainerElement||!this.tooltipElement)&&console.error("ShopManager: No se encontraron elementos HTML esenciales para la tienda!"),console.log("ShopManager: Constructor finalizado.")}init(a){if(console.log("ShopManager: init - Procesando datos JSON de ítems..."),this.items.clear(),!Array.isArray(a)){console.error("ShopManager: Datos de ítems de tienda inválidos.");return}a.forEach(i=>{i!=null&&i.id&&typeof i.id=="string"?this.items.set(i.id,i):console.warn("ShopManager: Ítem inválido o sin ID.",i)}),console.log(`ShopManager: ${this.items.size} ítems procesados.`),this.createShopItemElements(),this.addCloseListeners(),console.log("ShopManager: Listeners de ítems y cierre añadidos.")}openShop(){if(console.log("ShopManager: Abriendo tienda..."),!this.shopPopupElement)return;this.updateShopUI(),this.shopPopupElement.style.display="flex",this.shopPopupElement.offsetHeight,this.shopPopupElement.classList.add("visible");const a=document.getElementById("blur-backdrop");a&&(a.style.display="block",a.offsetHeight,a.classList.add("visible"))}closeShop(){if(console.log("ShopManager: Cerrando tienda..."),!this.shopPopupElement)return;this.hideTooltip(),this.shopPopupElement.classList.remove("visible");const a=document.getElementById("blur-backdrop"),i=document.getElementById("explanation-overlay");a&&(!i||!i.classList.contains("visible"))&&a.classList.remove("visible"),setTimeout(()=>{this.shopPopupElement&&!this.shopPopupElement.classList.contains("visible")&&(this.shopPopupElement.style.display="none",a&&!a.classList.contains("visible")&&(a.style.display="none"))},300)}updateShopUI(){var i,p;if(!this.playerData)return;this.shopPlayerScoreElement&&(this.shopPlayerScoreElement.textContent=`Puntos: ${this.playerData.score}`),this.itemElements.forEach((n,e)=>{const s=this.items.get(e);if(!s)return;const r=this.calculateItemCost(s),o=this.playerData.score>=r,d=this.checkItemIsPurchased(s),l=this.checkItemCanPurchase(s),g=this.getItemLevel(s),h=s.isLeveled&&typeof s.maxLevel=="number"&&g>=s.maxLevel;n.classList.remove("disabled","purchased","max-level"),h?n.classList.add("max-level","disabled"):d&&!s.isLeveled?n.classList.add("purchased","disabled"):(!l||!o)&&n.classList.add("disabled")});const a=(i=this.shopItemsContainerElement)==null?void 0:i.querySelector(".shop-item:hover");a&&((p=this.tooltipElement)!=null&&p.classList.contains("visible"))&&this.showTooltipForItem(a.dataset.itemId||"")}handleItemInteraction(a){const i=a.currentTarget,p=i==null?void 0:i.dataset.itemId;if(a.type==="touchstart"&&a.preventDefault(),!p||!this.items.has(p)){console.error("Interacción en ítem inválido o sin ID.");return}if(i.classList.contains("disabled")){console.log(`Intento de compra de ítem deshabilitado: ${p}`),this.showTooltipForItem(p);return}console.log(`Intentando comprar ítem: ${p}`);const n=this.executePurchaseAction(p);console.log(n?`Compra exitosa de ${p}`:`Compra fallida de ${p}`)}handleItemMouseOver(a){const i=a.currentTarget,p=i==null?void 0:i.dataset.itemId;p&&this.showTooltipForItem(p)}hideTooltip(){this.tooltipElement&&this.tooltipElement.classList.remove("visible")}showTooltipForItem(a){const i=this.items.get(a);if(!i||!this.tooltipElement||!this.playerData||!this.tooltipNameElement||!this.tooltipEffectElement||!this.tooltipLevelElement||!this.tooltipCostElement||!this.tooltipStatusElement){this.hideTooltip();return}const p=this.calculateItemCost(i),n=this.playerData.score>=p,e=this.checkItemIsPurchased(i),s=this.checkItemCanPurchase(i),r=this.getItemLevel(i),o=i.isLeveled&&typeof i.maxLevel=="number"&&r>=i.maxLevel,d=this.formatEffectText(i);this.tooltipNameElement.textContent=i.name,this.tooltipEffectElement.textContent=d,i.isLeveled&&r>=0?(this.tooltipLevelElement.textContent=`Nivel: ${r}`,this.tooltipLevelElement.classList.remove("hidden")):this.tooltipLevelElement.classList.add("hidden"),this.tooltipCostElement.textContent=o?"Nivel Máximo":`Costo: ${p}`;let l="";o?l="Nivel Máximo Alcanzado":e&&!i.isLeveled?l="Ya comprado / Activo":!s&&!o?l="No disponible":n||(l="Puntos insuficientes"),l?(this.tooltipStatusElement.textContent=l,this.tooltipStatusElement.classList.remove("hidden")):this.tooltipStatusElement.classList.add("hidden"),this.tooltipElement.classList.add("visible")}createShopItemElements(){if(!this.shopItemsContainerElement)return;this.shopItemsContainerElement.innerHTML="",this.itemElements.clear(),this.itemListeners.clear();const a={};this.items.forEach(p=>{const n=p.category||"general";a[n]||(a[n]=[]),a[n].push(p)}),["consumable","unlockable","upgradeable","general"].forEach(p=>{if(a[p]){const n=document.createElement("h3");n.className="shop-section-title",n.textContent=this.formatCategoryTitle(p),this.shopItemsContainerElement.appendChild(n);const e=document.createElement("div");e.className="shop-section-items",this.shopItemsContainerElement.appendChild(e),a[p].sort((s,r)=>s.name.localeCompare(r.name)),a[p].forEach(s=>{const r=document.createElement("div");r.className="shop-item",r.dataset.itemId=s.id;const o=document.createElement("span");o.className="shop-item-icon",o.textContent=s.icon||"❓",r.appendChild(o);const d=g=>this.handleItemInteraction(g),l={click:d,touchstart:d};r.addEventListener("click",l.click),r.addEventListener("touchstart",l.touchstart,{passive:!1}),r.addEventListener("mouseover",g=>this.handleItemMouseOver(g)),r.addEventListener("mouseout",()=>this.hideTooltip()),e.appendChild(r),this.itemElements.set(s.id,r),this.itemListeners.set(r,l)})}}),this.updateShopUI()}formatCategoryTitle(a){return a==="consumable"?"Consumibles":a==="unlockable"?"Desbloqueables":a==="upgradeable"?"Mejorables":"General"}addCloseListeners(){const a=i=>{i.type==="touchstart"&&i.target===this.shopPopupElement&&i.preventDefault(),(i.target===this.shopPopupElement||i.currentTarget===this.shopCloseButtonElement)&&this.closeShop()};this.shopCloseButtonElement?(this.closeButtonListeners={click:a,touchstart:a},this.shopCloseButtonElement.addEventListener("click",this.closeButtonListeners.click),this.shopCloseButtonElement.addEventListener("touchstart",this.closeButtonListeners.touchstart,{passive:!1})):console.warn("ShopManager: Botón de cierre no encontrado."),this.shopPopupElement&&(this.backdropClickListeners={click:a,touchstart:a},this.shopPopupElement.addEventListener("click",this.backdropClickListeners.click),this.shopPopupElement.addEventListener("touchstart",this.backdropClickListeners.touchstart,{passive:!1}))}destroy(){console.log("ShopManager: Destruyendo..."),this.closeButtonListeners&&this.shopCloseButtonElement&&(this.shopCloseButtonElement.removeEventListener("click",this.closeButtonListeners.click),this.closeButtonListeners.touchstart&&this.shopCloseButtonElement.removeEventListener("touchstart",this.closeButtonListeners.touchstart),this.closeButtonListeners=null),this.backdropClickListeners&&this.shopPopupElement&&(this.shopPopupElement.removeEventListener("click",this.backdropClickListeners.click),this.backdropClickListeners.touchstart&&this.shopPopupElement.removeEventListener("touchstart",this.backdropClickListeners.touchstart),this.backdropClickListeners=null),this.itemListeners.forEach((a,i)=>{i&&i.isConnected&&(i.removeEventListener("click",a.click),a.touchstart&&i.removeEventListener("touchstart",a.touchstart),i.removeEventListener("mouseover",this.handleItemMouseOver),i.removeEventListener("mouseout",this.hideTooltip))}),this.itemListeners.clear(),this.itemElements.clear(),console.log("ShopManager: Listeners limpiados.")}calculateItemCost(a){const i=a.cost;let p=i.base;if(a.isLeveled){const n=a.levelRef,e=n?this.playerData[n]??0:0;i.type==="exponential"&&typeof i.multiplier=="number"?p=i.base*Math.pow(i.multiplier,e):p=i.base+(i.perLevel??0)*e}else if(i.levelRef&&typeof i.perLevel=="number"){const n=this.playerData[i.levelRef]??0;p=i.base+i.perLevel*n}return Math.round(p)}formatEffectText(a){var p,n,e;let i=a.effectTemplate;if(i=i.replace("{lives}",this.playerData.lives.toString()),i.includes("{isActive}")){const s=(p=a.isPurchasedCheck)==null?void 0:p.valueRef,r=s?!!this.playerData[s]:!1;i=i.replace("{isActive}",r?"(Activo)":"")}if(i.includes("{isUnlocked}")){const s=(n=a.isPurchasedCheck)==null?void 0:n.valueRef,r=s?!!this.playerData[s]:!1;i=i.replace("{isUnlocked}",r?"(Desbloqueado)":"")}if(i.includes("{charges}")){const s=(e=a.isPurchasedCheck)==null?void 0:e.valueRef,r=s?this.playerData[s]??0:0;i=i.replace("{charges}",r>0?`(Cargas: ${r})`:"")}if(i.includes("{currentValue}")){let s="?";a.id==="comboMultiplier"?s=this.playerData.getCurrentComboMultiplier().toFixed(1):a.id==="inkCostReduction"?s=this.playerData.getCurrentInkCostPerPixel().toFixed(2):a.id==="extraCat"?s=this.playerData.getCatsPerCorrectAnswer():a.id==="maxCats"?s=this.playerData.getMaxCatsAllowed():a.id==="maxCatSize"?s=this.playerData.getCurrentMaxSizeLimit():a.id==="refillCatFood"&&(s=this.playerData.currentCatFood),i=i.replace("{currentValue}",s.toString())}return i}checkItemIsPurchased(a){if(!a.isPurchasedCheck)return!1;const i=a.isPurchasedCheck,p=i.valueRef,n=this.playerData[p];if(typeof n>"u")return!1;switch(i.condition){case"isTrue":return n===!0;case"isFalse":return n===!1;case"greaterThan":return typeof n=="number"&&typeof i.limit=="number"&&n>i.limit;default:return!1}}checkItemCanPurchase(a){if(!a.purchaseCheck)return!0;const i=a.purchaseCheck,p=i.valueRef,n=this.playerData[p];if(typeof n>"u")return console.warn(`Purchase check failed for ${a.id}: valueRef '${p}' not found.`),!1;switch(i.condition){case"lessThan":return typeof n=="number"&&typeof i.limit=="number"&&n<i.limit;case"lessThanOrEqual":return typeof n=="number"&&typeof i.limit=="number"&&n<=i.limit;case"isFalse":return n===!1;case"isTrue":return n===!0;case"greaterThan":return typeof n=="number"&&typeof i.limit=="number"&&n>i.limit;case"greaterThanOrEqual":return typeof n=="number"&&typeof i.limit=="number"&&n>=i.limit;default:return!1}}getItemLevel(a){return!a.isLeveled||!a.levelRef?-1:this.playerData[a.levelRef]??0}executePurchaseAction(a){const i=this.items.get(a);if(!i)return console.error(`ShopManager: No itemData for ID '${a}'`),!1;const p=this.calculateItemCost(i),n=this.playerData.score>=p,e=this.checkItemCanPurchase(i),s=this.getItemLevel(i),r=i.isLeveled&&typeof i.maxLevel=="number"&&s>=i.maxLevel;if(!n||!e||r)return this.showTooltipForItem(a),!1;this.playerData.score-=p,console.log(`ShopManager: Deduced ${p}. Remaining: ${this.playerData.score}`),this.gameManager.updateExternalScoreUI();let o=!1;const d=i.actionId;console.log(`ShopManager: Executing '${d}' for item '${a}'...`);try{switch(d){case"purchaseLife":o=this.purchaseLifeAction();break;case"purchaseShield":o=this.purchaseShieldAction();break;case"purchaseHint":o=this.purchaseHintAction();break;case"purchaseUnlockDrawing":o=this.purchaseUnlockDrawingAction();break;case"purchaseUnlockCatFood":o=this.purchaseUnlockCatFoodAction();break;case"purchaseRefillCatFood":o=this.purchaseRefillCatFoodAction();break;case"purchaseComboMultiplier":o=this.purchaseComboMultiplierAction();break;case"purchaseInkCostReduction":o=this.purchaseInkCostReductionAction();break;case"purchaseExtraCatSpawn":o=this.purchaseExtraCatSpawnAction();break;case"purchaseMaxCatsIncrease":o=this.purchaseMaxCatsIncreaseAction();break;case"purchaseMaxCatSize":o=this.purchaseMaxCatSizeAction();break;default:console.error(`ShopManager: Unknown action: ${d}`),o=!1}}catch(l){console.error(`ShopManager: Error executing ${d}:`,l),o=!1}return o?(console.log(`ShopManager: Action ${d} successful.`),this.gameManager.getAudioManager().playSound("purchase")):(console.warn(`ShopManager: Action ${d} failed. Reverting cost.`),this.playerData.score+=p,this.gameManager.updateExternalScoreUI()),this.updateShopUI(),this.showTooltipForItem(a),this.shopPlayerScoreElement&&(this.shopPlayerScoreElement.textContent=`Puntos: ${this.playerData.score}`),o}purchaseLifeAction(){return this.playerData.lives++,this.gameManager.updateExternalLivesUI(),console.log(` -> Life purchased. Current: ${this.playerData.lives}`),!0}purchaseShieldAction(){return this.playerData.hasShield=!0,this.gameManager.updateExternalShieldUI(!0),console.log(` -> Shield purchased. Status: ${this.playerData.hasShield}`),!0}purchaseHintAction(){return this.playerData.hintCharges++,this.gameManager.updateExternalHintUI(this.playerData.hintCharges),console.log(` -> Hint purchased. Charges: ${this.playerData.hintCharges}`),!0}purchaseUnlockDrawingAction(){if(console.log("ShopManager: Executing purchaseUnlockDrawingAction..."),this.playerData.isDrawingUnlocked)return console.log(" -> Drawing already unlocked."),!1;this.playerData.isDrawingUnlocked=!0;let a=!1;try{a=this.gameManager.enableDrawingFeature(),console.log(` -> enableDrawingFeature returned: ${a}`)}catch(i){console.error(" -> Error calling enableDrawingFeature:",i),a=!1}return a?(console.log(" -> Activation successful."),!0):(console.error(" -> Activation FAILED. Reverting."),this.playerData.isDrawingUnlocked=!1,!1)}purchaseComboMultiplierAction(){return this.playerData.comboMultiplierLevel++,console.log(` -> Combo Multiplier Lvl: ${this.playerData.comboMultiplierLevel}`),!0}purchaseInkCostReductionAction(){return this.playerData.inkCostReductionLevel++,console.log(` -> Ink Cost Reduction Lvl: ${this.playerData.inkCostReductionLevel}`),this.gameManager.updateInkUI(),!0}purchaseExtraCatSpawnAction(){return this.playerData.extraCatSpawnLevel++,console.log(` -> Extra Cat Spawn Lvl: ${this.playerData.extraCatSpawnLevel}`),!0}purchaseMaxCatsIncreaseAction(){return this.playerData.maxCatsLevel++,console.log(` -> Max Cats Lvl: ${this.playerData.maxCatsLevel}`),!0}purchaseMaxCatSizeAction(){return this.playerData.maxCatSizeLevel++,console.log(` -> Max Cat Size Lvl: ${this.playerData.maxCatSizeLevel}`),!0}purchaseUnlockCatFoodAction(){return console.log("ShopManager: Executing purchaseUnlockCatFoodAction..."),this.playerData.isCatFoodUnlocked?!1:(this.playerData.isCatFoodUnlocked=!0,this.playerData.refillCatFood(),this.gameManager.enableCatFoodFeature(),console.log(" -> Cat Food unlocked and refilled."),!0)}purchaseRefillCatFoodAction(){return console.log("ShopManager: Executing purchaseRefillCatFoodAction..."),this.playerData.currentCatFood>=this.playerData.getMaxCatFood()?(console.log(" -> Cat food already full."),!1):(this.playerData.refillCatFood(),this.gameManager.updateCatFoodUI(),!0)}}class pt{constructor(){A(this,"score",0);A(this,"lives",3);A(this,"isDrawingUnlocked",!1);A(this,"isCatFoodUnlocked",!1);A(this,"hasShield",!1);A(this,"hintCharges",0);A(this,"currentInk",0);A(this,"INK_BAR_CAPACITY",1e3);A(this,"inkSpentSinceLastClear",0);A(this,"currentCatFood",0);A(this,"MAX_CAT_FOOD",25);A(this,"comboMultiplierLevel",0);A(this,"inkCostReductionLevel",0);A(this,"extraCatSpawnLevel",0);A(this,"maxCatsLevel",0);A(this,"maxCatSizeLevel",0);A(this,"BASE_MAX_CAT_SIZE_LIMIT",150);A(this,"MAX_CAT_SIZE_INCREMENT_PER_LEVEL",25);console.log("PlayerData Instanciado.")}getCurrentComboMultiplier(){return 1+this.comboMultiplierLevel*.15}getCurrentInkCostPerPixel(){return .4*Math.pow(.9,this.inkCostReductionLevel)}getCatsPerCorrectAnswer(){return 1+this.extraCatSpawnLevel*1}getMaxCatsAllowed(){return 50+this.maxCatsLevel*25}getCurrentMaxSizeLimit(){return this.BASE_MAX_CAT_SIZE_LIMIT+this.maxCatSizeLevel*this.MAX_CAT_SIZE_INCREMENT_PER_LEVEL}spendInk(a){return this.currentInk>=a?(this.currentInk-=a,this.inkSpentSinceLastClear+=a,!0):!1}gainInk(a){this.currentInk+=a}recoverSpentInk(){console.log(`[PlayerData] Recovering ${this.inkSpentSinceLastClear.toFixed(0)} ink.`),this.gainInk(this.inkSpentSinceLastClear),this.inkSpentSinceLastClear=0}getMaxCatFood(){return this.MAX_CAT_FOOD}spendCatFoodUnit(){return this.isCatFoodUnlocked&&this.currentCatFood>0?(this.currentCatFood--,!0):!1}refillCatFood(){this.isCatFoodUnlocked&&(this.currentCatFood=this.getMaxCatFood())}reset(){console.log("PlayerData: Reseteando datos..."),this.score=0,this.lives=3,this.isDrawingUnlocked=!1,this.isCatFoodUnlocked=!1,this.hasShield=!1,this.hintCharges=0,this.currentInk=0,this.inkSpentSinceLastClear=0,this.currentCatFood=0,this.comboMultiplierLevel=0,this.inkCostReductionLevel=0,this.extraCatSpawnLevel=0,this.maxCatsLevel=0,this.maxCatSizeLevel=0}}const Te=25,Ae=8,mt="#E5E7EB",vt=150,yt=4,xt=2,Ct=xt;class Mt{constructor(a){A(this,"gameManager");A(this,"physicsManager");A(this,"playerData");A(this,"drawingCanvas",null);A(this,"drawingCtx",null);A(this,"gameContainer",null);A(this,"isBrushActive",!1);A(this,"isDrawing",!1);A(this,"currentPath",[]);A(this,"lastPoint",null);A(this,"drawnPaths",[]);A(this,"isInitialized",!1);A(this,"buttonListeners",new Map);A(this,"generalListeners",[]);A(this,"lastInteractionTime",0);A(this,"DEBOUNCE_THRESHOLD",300);console.log("InkManager: Constructor iniciado."),this.gameManager=a;try{this.playerData=a.getPlayerData(),this.drawingCanvas=document.getElementById("drawing-canvas")}catch(i){console.error("InkManager: Error crítico en constructor.",i)}}setPhysicsManager(a){this.physicsManager=a}init(){var a;if(this.isInitialized){this.updateInkUI();return}console.log("InkManager: init (llamado al desbloquear dibujo)");try{if(!this.physicsManager&&(this.physicsManager=this.gameManager.getPhysicsManager(),!this.physicsManager))throw new Error("PhysicsManager no asignado.");if(this.playerData=this.gameManager.getPlayerData(),this.drawingCanvas||(this.drawingCanvas=document.getElementById("drawing-canvas")),this.gameContainer=((a=this.gameManager.getContainerElement())==null?void 0:a.querySelector(".game-container"))??this.gameManager.getContainerElement(),!this.playerData)throw new Error("PlayerData no encontrado.");if(!this.drawingCanvas)throw new Error("#drawing-canvas no encontrado.");this.setupDrawingCanvas(),this.initUIAndListeners(),this.isInitialized=!0,this.updateInkUI(),console.log("InkManager: Inicialización completa.")}catch(i){console.error("InkManager: Error CRÍTICO durante la inicialización:",i),this.isInitialized=!1}}initUIAndListeners(){this.removeListeners();const a=document.getElementById("toggle-brush-button"),i=document.getElementById("clear-ink-button");if(a){const p=e=>{const s=Date.now();s-this.lastInteractionTime<this.DEBOUNCE_THRESHOLD||(this.lastInteractionTime=s,e.type==="touchstart"&&e.preventDefault(),this.gameManager.activateBrush())},n={click:p,touchstart:p};this.addListener(a,"click",n.click),this.addListener(a,"touchstart",n.touchstart,{passive:!1}),this.buttonListeners.set(a,n)}else console.warn("InkManager: toggleBrushButton no encontrado.");if(i){const p=e=>{const s=Date.now();s-this.lastInteractionTime<this.DEBOUNCE_THRESHOLD||(this.lastInteractionTime=s,e.type==="touchstart"&&e.preventDefault(),this.clearInkLines())},n={click:p,touchstart:p};this.addListener(i,"click",n.click),this.addListener(i,"touchstart",n.touchstart,{passive:!1}),this.buttonListeners.set(i,n)}else console.warn("InkManager: clearInkButton no encontrado.");if(this.drawingCanvas){const p=this.startDrawing.bind(this),n=this.draw.bind(this),e=this.stopDrawing.bind(this);this.addListener(this.drawingCanvas,"mousedown",p),this.addListener(this.drawingCanvas,"mousemove",n),this.addListener(this.drawingCanvas,"mouseup",e),this.addListener(this.drawingCanvas,"mouseleave",e),this.addListener(this.drawingCanvas,"touchstart",p,{passive:!1}),this.addListener(this.drawingCanvas,"touchmove",n,{passive:!1}),this.addListener(this.drawingCanvas,"touchend",e),this.addListener(this.drawingCanvas,"touchcancel",e)}else console.error("InkManager: No se pudieron añadir listeners de dibujo (canvas no encontrado).");this.addListener(window,"resize",this.handleResize.bind(this))}addListener(a,i,p,n){a.addEventListener(i,p,n),this.generalListeners.push({element:a,type:i,handler:p,options:n})}removeListeners(){this.generalListeners.forEach(({element:a,type:i,handler:p,options:n})=>{try{a.removeEventListener(i,p,n)}catch{}}),this.generalListeners=[],this.buttonListeners.clear()}setupDrawingCanvas(){this.drawingCanvas&&(this.drawingCtx=this.drawingCanvas.getContext("2d"),this.drawingCtx?(this.resizeCanvas(),this.applyContextStyles(),this.clearCanvas(),this.redrawPaths()):console.error("InkManager: No se pudo obtener el contexto 2D."))}applyContextStyles(){this.drawingCtx&&(this.drawingCtx.strokeStyle=mt,this.drawingCtx.lineWidth=Ae,this.drawingCtx.lineCap="round",this.drawingCtx.lineJoin="round")}resizeCanvas(){this.drawingCanvas&&(this.drawingCanvas.width=window.innerWidth,this.drawingCanvas.height=window.innerHeight,this.applyContextStyles())}handleResize(){this.resizeCanvas(),this.redrawPaths()}clearCanvas(){this.drawingCtx&&this.drawingCanvas&&this.drawingCtx.clearRect(0,0,this.drawingCanvas.width,this.drawingCanvas.height)}redrawPaths(){this.clearCanvas(),this.drawingCtx&&this.drawnPaths.forEach(a=>{this.drawPathPoints(a.points)})}drawPathPoints(a){if(!(!this.drawingCtx||a.length<2)){this.drawingCtx.beginPath(),this.drawingCtx.moveTo(a[0].x,a[0].y);for(let i=1;i<a.length;i++)this.drawingCtx.lineTo(a[i].x,a[i].y);this.drawingCtx.stroke()}}updateInkUI(){if(!this.isInitialized||!this.playerData)return;const a=this.playerData.isDrawingUnlocked,i=document.getElementById("toggle-brush-button"),p=document.getElementById("clear-ink-button"),n=document.getElementById("score-area");n&&n.classList.toggle("ink-visible",a),this.gameManager.getUIManager().updateInkBar();const e=a&&this.playerData.currentInk>0,s=a&&this.playerData.inkSpentSinceLastClear>0;i&&(i.disabled=!a||!e&&!this.isBrushActive,i.classList.toggle("active",this.isBrushActive)),p&&(p.disabled=!s),a&&this.playerData.currentInk<=0&&this.isBrushActive&&this.toggleBrush(!1),this.updateBrushVisuals()}toggleBrush(a){if(!this.isInitialized)return;const i=a!==void 0?a:!this.isBrushActive;if(i===!0&&(!this.playerData.isDrawingUnlocked||this.playerData.currentInk<=0)){this.isBrushActive&&(this.isBrushActive=!1,this.updateBrushVisuals());return}i!==this.isBrushActive&&(this.isBrushActive=i,!this.isBrushActive&&this.isDrawing&&this.stopDrawing(null),this.updateBrushVisuals(),this.updateInkUI())}updateBrushVisuals(){this.drawingCanvas&&this.drawingCanvas.classList.toggle("active",this.isBrushActive);const a=document.getElementById("toggle-brush-button");a&&a.classList.toggle("active",this.isBrushActive);const i=this.gameContainer??document.getElementById("app");i&&i.classList.toggle("ui-faded",this.isBrushActive)}clearInkLines(){if(!this.isInitialized||!this.playerData.isDrawingUnlocked||this.playerData.inkSpentSinceLastClear<=0)return;console.log(`InkManager: Clearing ${this.drawnPaths.length} strokes...`);const a=this.drawnPaths.flatMap(i=>i.bodies);if(this.physicsManager&&a.length>0)try{const i=this.physicsManager.getWorld(),p=a.filter(n=>F.Composite.get(i,n.id,"body"));p.length>0&&F.World.remove(i,p)}catch(i){console.error("InkManager: Error removiendo cuerpos:",i)}this.drawnPaths=[],this.clearCanvas(),this.playerData.recoverSpentInk(),this.updateInkUI(),this.gameManager.getAudioManager().playSound("clear_ink")}gainInkOnCorrectAnswer(){!this.isInitialized||!this.playerData.isDrawingUnlocked||(this.playerData.gainInk(vt),this.updateInkUI())}destroy(){console.log("InkManager: Destruyendo..."),this.removeListeners(),this.isInitialized=!1,this.isBrushActive=!1,this.isDrawing=!1,this.currentPath=[],this.drawnPaths=[],this.drawingCtx=null,this.buttonListeners.clear()}startDrawing(a){if(!this.isInitialized||!this.isBrushActive||this.playerData.currentInk<=0)return;a.preventDefault(),this.isDrawing=!0;const i=this.getMousePos(a);this.currentPath=[i],this.lastPoint=i,this.drawingCtx&&(this.drawingCtx.beginPath(),this.drawingCtx.moveTo(i.x,i.y)),this.gameManager.getAudioManager().playSound("draw_start")}draw(a){if(!this.isDrawing||!this.isBrushActive)return;a.preventDefault();const i=this.getMousePos(a),p=this.lastPoint?this.distanceSq(this.lastPoint,i):Te;if(p>=Te){const e=Math.sqrt(p)*this.playerData.getCurrentInkCostPerPixel();this.playerData.spendInk(e)?(this.currentPath.push(i),this.drawingCtx&&(this.drawingCtx.lineTo(i.x,i.y),this.drawingCtx.stroke(),this.drawingCtx.beginPath(),this.drawingCtx.moveTo(i.x,i.y)),this.lastPoint=i,this.updateInkUI()):this.stopDrawing(a)}}stopDrawing(a){if(this.isDrawing){if(a==null||a.preventDefault(),this.isDrawing=!1,this.gameManager.getAudioManager().playSound("draw_end"),this.currentPath.length>1){const i=this.createInkBodySegments(this.currentPath);if(i.length>0&&this.physicsManager)try{F.World.add(this.physicsManager.getWorld(),i),this.drawnPaths.push({points:[...this.currentPath],bodies:i}),this.updateInkUI()}catch(p){console.error("InkManager: Error añadiendo cuerpos:",p)}else this.physicsManager||console.error("InkManager: PhysicsManager no disponible.")}this.currentPath=[],this.lastPoint=null}}getMousePos(a){if(!this.drawingCanvas)return{x:0,y:0};const i=this.drawingCanvas.getBoundingClientRect();let p=0,n=0;return a instanceof MouseEvent?(p=a.clientX,n=a.clientY):a.touches&&a.touches[0]?(p=a.touches[0].clientX,n=a.touches[0].clientY):a.changedTouches&&a.changedTouches[0]&&(p=a.changedTouches[0].clientX,n=a.changedTouches[0].clientY),{x:p-i.left,y:n-i.top}}distanceSq(a,i){const p=a.x-i.x,n=a.y-i.y;return p*p+n*n}createInkBodySegments(a){const i=[];if(a.length<2||!this.physicsManager)return i;for(let p=1;p<a.length;p++){const n=a[p-1],e=a[p],s=e.x-n.x,r=e.y-n.y,o=s*s+r*r;if(o<1)continue;const d=Math.sqrt(o),l=Math.atan2(r,s),g=n.x+s/2,h=n.y+r/2;try{const t=F.Bodies.rectangle(g,h,d,Ae,{isStatic:!0,angle:l,label:"inkLine",friction:.5,restitution:.1,collisionFilter:{category:yt,mask:Ct},render:{visible:!1}});t&&i.push(t)}catch(t){console.error("InkManager: Error creando cuerpo:",t)}}return i}}const Et=1,St=4;class ee{constructor(a){A(this,"gameManager");A(this,"uiManager");A(this,"currentQuestion",null);A(this,"nextQuestionTimeoutId",null);A(this,"consecutiveCorrectAnswers",0);A(this,"hintAppliedToQuestionId",null);A(this,"isWaitingForExplanationConfirm",!1);A(this,"BASE_POINTS_PER_CORRECT",15);A(this,"DIFFICULTY_BONUS",{easy:10,1:10,2:20,medium:30,3:30,hard:45,4:45,5:65});this.gameManager=a;try{this.uiManager=a.getUIManager()}catch(i){throw console.error("QuizGameplayState: Error crítico obteniendo UIManager.",i),i}}selectRandomCatTemplateId(){var s,r;const i=this.gameManager.getCatManager().getSpawnableTemplatesWeighted();if(i.length===0)return"common_cat";const p=i.reduce((o,d)=>o+d.weight,0);if(p<=0)return((s=i[0])==null?void 0:s.id)??"common_cat";const n=Math.random()*p;let e=0;for(const o of i)if(e+=o.weight,n<e)return o.id;return((r=i[i.length-1])==null?void 0:r.id)??"common_cat"}enter(a){console.log("QuizGameplayState: enter",a);const i=this.gameManager.getContainerElement();i.innerHTML="",i.classList.remove("state-fade-in","state-fade-out"),i.style.opacity="0",this.gameManager.setBodyStateClass("quizgameplay"),this.gameManager.getPlayerData().reset(),console.log("PlayerData reseteado para nueva partida."),this.consecutiveCorrectAnswers=0,this.hintAppliedToQuestionId=null,this.isWaitingForExplanationConfirm=!1,this.displayNextQuestion(),requestAnimationFrame(()=>{i.classList.add("state-fade-in"),i.style.opacity=""})}exit(){console.log("QuizGameplayState: exit");const a=this.gameManager.getContainerElement();this.uiManager.clearQuizInterface(a),this.nextQuestionTimeoutId&&(clearTimeout(this.nextQuestionTimeoutId),this.nextQuestionTimeoutId=null),this.uiManager.updateComboVisuals(0),document.body.style.backgroundColor="#111827";const i=document.documentElement;i.style.setProperty("--element-glow-intensity","0"),i.style.setProperty("--flare-intensity","0"),i.style.setProperty("--difficulty-glow-color","transparent"),i.style.setProperty("--difficulty-glow-blur","0px"),this.isWaitingForExplanationConfirm=!1,this.hintAppliedToQuestionId=null,this.currentQuestion=null}update(a){}calculateScore(a,i){const p=i+1,n=this.BASE_POINTS_PER_CORRECT*p,e=this.DIFFICULTY_BONUS[a]??this.DIFFICULTY_BONUS[1]??0,s=this.gameManager.getPlayerData().getCurrentComboMultiplier(),r=Math.max(0,(n+e)*(s-1));return{totalPoints:Math.round(n+e+r),basePoints:n,difficultyBonus:e,comboBonus:Math.round(r)}}handleCorrectAnswer(a){const i=this.calculateScore(a,this.consecutiveCorrectAnswers);this.consecutiveCorrectAnswers++,this.gameManager.getPlayerData().score+=i.totalPoints,this.gameManager.getInkManager().gainInkOnCorrectAnswer(),this.uiManager.updateScoreDisplay(this.gameManager.getPlayerData().score),this.uiManager.updateComboVisuals(this.consecutiveCorrectAnswers),this.uiManager.updateInkBar();let p=`¡Correcto! +${i.totalPoints} Pts`,n=`(Base: ${i.basePoints}, Dif: +${i.difficultyBonus}`;const e=this.gameManager.getPlayerData().getCurrentComboMultiplier();i.comboBonus>0&&(n+=`, Combo x${e.toFixed(1)}: +${i.comboBonus}`),n+=")",p+=` ${n}`,this.uiManager.updateFeedback(p,"correct");try{this.gameManager.getAudioManager().playSound("correct")}catch(o){console.error("Error sonido 'correct':",o)}try{this.gameManager.getCatManager().growExistingCats(Et,St)}catch(o){console.error("Error llamando a catManager.growExistingCats:",o)}const s=this.gameManager.getPlayerData().getCatsPerCorrectAnswer(),r=this.selectRandomCatTemplateId();if(r)for(let o=0;o<s;o++)try{this.gameManager.getCatManager().addCat(r)}catch(d){console.error(`Error al llamar a catManager.addCat (iteración ${o+1}/${s}):`,d)}this.proceedToNextStep()}handleIncorrectAnswer(){const a=this.gameManager.getPlayerData();let i=!1;a.hasShield?(a.hasShield=!1,this.uiManager.updateFeedback("¡Escudo Roto!","shield"),this.uiManager.updateShieldIcon(!1),this.gameManager.getAudioManager().playSound("shield_break")):(this.consecutiveCorrectAnswers=0,this.gameManager.decrementLives(),this.uiManager.updateComboVisuals(this.consecutiveCorrectAnswers),this.uiManager.updateFeedback("Incorrecto.","incorrect"),this.gameManager.getAudioManager().playSound("incorrect"),a.hintCharges>0&&(console.log("Incorrect answer (no shield), resetting hint charges."),a.hintCharges=0,this.uiManager.updateHintIcon(0)),this.gameManager.getLives()<=0&&(i=!0)),this.hintAppliedToQuestionId=null,i?(this.uiManager.updateFeedback("¡Has perdido!","incorrect"),this.nextQuestionTimeoutId&&(clearTimeout(this.nextQuestionTimeoutId),this.nextQuestionTimeoutId=null),setTimeout(()=>{this.gameManager.getStateMachine().getCurrentStateName()==="QuizGameplay"&&this.gameManager.getStateMachine().changeState("GameOver",{finalScore:a.score})},1500)):this.proceedToNextStep()}proceedToNextStep(){var i;const a=(i=this.currentQuestion)==null?void 0:i.explanation;a&&!this.isWaitingForExplanationConfirm?(this.isWaitingForExplanationConfirm=!0,this.uiManager.showExplanation(a,()=>{this.isWaitingForExplanationConfirm=!1,this.scheduleNextQuestion(500)})):this.isWaitingForExplanationConfirm||this.scheduleNextQuestion(1500)}scheduleNextQuestion(a){this.nextQuestionTimeoutId&&clearTimeout(this.nextQuestionTimeoutId),this.gameManager.getStateMachine().getCurrentStateName()==="QuizGameplay"&&(this.nextQuestionTimeoutId=window.setTimeout(()=>{this.nextQuestionTimeoutId=null,this.gameManager.getStateMachine().getCurrentStateName()==="QuizGameplay"&&requestAnimationFrame(()=>this.displayNextQuestion())},a))}displayNextQuestion(){const a=this.gameManager.getQuizSystem();try{this.currentQuestion=a.selectNextQuestion()}catch(p){console.error("Error seleccionando la siguiente pregunta:",p),this.uiManager.updateFeedback("Error al cargar la siguiente pregunta.","info");return}if(!this.currentQuestion){console.log("No quedan más preguntas disponibles."),this.uiManager.updateFeedback("¡Has completado todas las preguntas!","correct");return}this.hintAppliedToQuestionId=null;const i=this.gameManager.getContainerElement();if(!i){console.error("QuizGameplayState: Contenedor #app no encontrado.");return}try{this.uiManager.buildQuizInterface(this.currentQuestion,i,this.handleOptionClick.bind(this),this.consecutiveCorrectAnswers),this.gameManager.getPlayerData().hintCharges>0&&this.currentQuestion&&(this.uiManager.applyHintVisuals(this.currentQuestion.correctAnswerKey),this.hintAppliedToQuestionId=this.currentQuestion.id)}catch(p){console.error("Error construyendo la interfaz del quiz:",p),this.uiManager.updateFeedback("Error al mostrar la pregunta.","info")}}handleOptionClick(a){if(this.isWaitingForExplanationConfirm||!this.currentQuestion||this.nextQuestionTimeoutId!==null)return;this.uiManager.disableOptions();const p=this.gameManager.getQuizSystem().validateAnswer(this.currentQuestion.id,a),n=this.gameManager.getPlayerData();this.hintAppliedToQuestionId===this.currentQuestion.id&&(n.hintCharges>0&&(n.hintCharges--,this.uiManager.updateHintIcon(n.hintCharges)),this.hintAppliedToQuestionId=null),p===!0?this.handleCorrectAnswer(this.currentQuestion.difficulty):p===!1?this.handleIncorrectAnswer():(this.uiManager.updateFeedback("Error al validar la respuesta.","info"),this.hintAppliedToQuestionId=null,this.proceedToNextStep())}rebuildInterface(){const a=this.gameManager.getContainerElement();this.currentQuestion&&a?(this.uiManager.buildQuizInterface(this.currentQuestion,a,this.handleOptionClick.bind(this),this.consecutiveCorrectAnswers),this.hintAppliedToQuestionId===this.currentQuestion.id&&this.uiManager.applyHintVisuals(this.currentQuestion.correctAnswerKey)):console.warn("QuizGameplayState: No se puede reconstruir, falta pregunta actual o contenedor.")}}const de=1,wt=10,fe=2,It=10,ke=1,Lt=20,Pe=3,Tt=.5,At=35,j=["#a78bfa","#7c3aed","#2563eb","#34d399","#facc15","#f97316","#ef4444"],be="#374151",se={1:{name:"COMÚN",class:"difficulty-1"},2:{name:"POCO COMÚN",class:"difficulty-2"},3:{name:"RARA",class:"difficulty-3"},4:{name:"ÉPICA",class:"difficulty-4",glowColor:"rgba(167, 139, 250, 0.7)",glowBlur:"8px"},5:{name:"LEGENDARIA",class:"difficulty-5",glowColor:"rgba(245, 158, 11, 0.7)",glowBlur:"10px",pulse:!0},easy:{name:"FÁCIL",class:"difficulty-2",glowColor:"rgba(52, 211, 153, 0.6)",glowBlur:"6px"},medium:{name:"MEDIO",class:"difficulty-3",glowColor:"rgba(96, 165, 250, 0.7)",glowBlur:"8px"},hard:{name:"DIFÍCIL",class:"difficulty-4",glowColor:"rgba(248, 113, 113, 0.7)",glowBlur:"10px",pulse:!0}};class kt{constructor(a){A(this,"gameManager");A(this,"currentUIElements",{});A(this,"optionClickCallback",null);A(this,"optionListeners",new Map);A(this,"explanationConfirmListener",null);A(this,"explanationListenerAdded",!1);this.gameManager=a,console.log("UIManager Creado.")}buildQuizInterface(a,i,p,n){if(!a){console.error("UIManager: No se proporcionó pregunta para construir la interfaz."),i.innerHTML='<p class="text-red-500">Error: No hay pregunta para mostrar.</p>';return}this.clearQuizInterface(i),this.optionClickCallback=p;const e={optionButtons:[]},s=this.gameManager.getPlayerData();try{const r=document.createElement("div");r.className="game-container text-center quiz-wrapper",i.appendChild(r),e.quizWrapper=r;const o=document.createElement("div");o.className="quiz-content-container",r.appendChild(o),e.quizContentContainer=o;const d=document.createElement("div");d.id="score-area",d.className="top-ui-container flex flex-col items-center w-full mb-4 gap-1",o.appendChild(d),e.topUIContainer=d;const l=document.createElement("div");l.id="status-wrapper",l.className="status-row flex justify-center items-center w-auto gap-6 mb-1",d.appendChild(l),e.statusRow=l;const g=document.createElement("div");g.id="lives-container",g.className="quiz-lives flex items-center gap-1.5 text-lg";const h=document.createElement("span");h.className="life-emoji",h.textContent="❤️";const t=document.createElement("span");t.id="lives-count",t.textContent="0";const u=document.createElement("span");u.id="shield-icon",u.textContent="🛡️",u.style.display="none";const c=document.createElement("span");c.id="hint-icon",c.textContent="💡",c.style.display="none",g.append(h,t,u,c),l.appendChild(g),e.livesDisplay=g,e.livesDisplayCount=t,e.shieldIcon=u,e.hintIcon=c;const f=document.createElement("div");f.id="score-display-wrapper",f.className="quiz-score relative flex items-center";const y=document.createElement("span");y.className="score-emoji",y.textContent="⭐";const E=document.createElement("span");E.id="score",E.textContent="0";const S=document.createElement("div");S.id="score-pulse",f.append(y,E,S),l.appendChild(f),e.scoreDisplay=f,e.scoreDisplayText=E,e.scorePulse=S;const T=document.createElement("div");T.id="ink-area",T.className="ink-area flex flex-col items-center mt-1",d.appendChild(T),e.inkArea=T;const m=document.createElement("div");m.id="ink-label",m.className="ink-label-base",m.textContent="Tinta",s.isDrawingUnlocked||m.classList.add("hidden"),T.appendChild(m),e.inkLabel=m;const x=document.createElement("div");x.id="ink-bar-container",x.className="ink-bar-container-base relative",s.isDrawingUnlocked||x.classList.add("hidden");const C=s.currentInk,v=s.INK_BAR_CAPACITY,w=Math.floor(C/v);let M=be;if(w>0){const N=(w-1)%j.length;M=j[N]}x.style.backgroundColor=M,T.appendChild(x),e.inkBarContainer=x;const L=document.createElement("span");L.id="combo-counter",L.className="combo-counter-base",L.style.display="none",document.body.appendChild(L),e.comboDisplay=L;const I=document.createElement("div");I.id="question-box",I.className="question-box-base card mb-4 w-full",o.appendChild(I),e.questionBox=I;const k=document.createElement("div");k.className="card__content flex flex-col items-center gap-2",I.appendChild(k),e.questionBoxContent=k;const b=document.createElement("span");b.id="difficulty-label",b.className="difficulty-label-base",k.appendChild(b),e.difficultyLabel=b;const P=document.createElement("p");P.id="question",P.className="question-text-base",P.textContent=a.text,k.appendChild(P),e.questionText=P;const D=document.createElement("div");D.className="card__backdrop",I.insertBefore(D,k),e.questionBoxBackdrop=D;const B=document.createElement("div");B.id="options",B.className="options-container-base flex flex-col gap-3 mb-3 w-full",o.appendChild(B),e.optionsContainer=B,a.options.forEach(N=>{var W;if(!(N!=null&&N.key)||typeof N.text>"u"){console.warn("Opción inválida encontrada:",N);return}const z=document.createElement("button");z.className="option-button",z.dataset.key=N.key,z.textContent=N.text;const H=q=>{q.type==="touchstart"&&q.preventDefault(),this.optionClickCallback&&this.optionClickCallback(N.key)},$={click:H,touchstart:H};this.optionListeners.set(z,$),z.addEventListener("click",$.click),z.addEventListener("touchstart",$.touchstart,{passive:!1}),B.appendChild(z),(W=e.optionButtons)==null||W.push(z)});const O=document.createElement("div");O.id="feedback",O.className="feedback-area-base mt-4 text-lg h-8",o.appendChild(O),e.feedbackArea=O,e.explanationOverlay=document.getElementById("explanation-overlay"),e.explanationText=document.getElementById("explanation-text-content"),e.blurBackdrop=document.getElementById("blur-backdrop"),e.catFoodUiContainer=document.getElementById("cat-food-ui-container"),e.catFoodButton=document.getElementById("cat-food-button"),e.catFoodBarContainer=document.getElementById("cat-food-bar-container"),e.catFoodBarFill=document.getElementById("cat-food-bar-fill")}catch(r){console.error("UIManager: Error fatal creando elementos de la interfaz:",r),this.clearQuizInterface(i),i.innerHTML='<p class="text-red-500">Error al construir la interfaz del quiz. Revisa la consola.</p>';return}this.currentUIElements=e,this.updateScoreDisplay(s.score),this.updateLivesDisplay(this.gameManager.getLives()),this.updateShieldIcon(s.hasShield),this.updateHintIcon(s.hintCharges),this.updateInkBar(),this.updateInkVisibility(s.isDrawingUnlocked),this.updateDifficultyLabel(a.difficulty),this.updateComboVisuals(n),this.updateCatFoodBar(s.currentCatFood,s.getMaxCatFood()),this.toggleCatFoodUIVisibility(s.isCatFoodUnlocked)}clearQuizInterface(a){this.optionListeners.forEach((p,n)=>{n&&n.isConnected&&(n.removeEventListener("click",p.click),p.touchstart&&n.removeEventListener("touchstart",p.touchstart))}),this.optionListeners.clear();const i=document.getElementById("combo-counter");i&&i.parentNode&&i.parentNode.removeChild(i),this.removeExplanationListener(),this.currentUIElements={},this.optionClickCallback=null,a.innerHTML=""}showExplanation(a,i){var s,r,o;const p=((s=this.currentUIElements)==null?void 0:s.explanationOverlay)??document.getElementById("explanation-overlay"),n=((r=this.currentUIElements)==null?void 0:r.explanationText)??document.getElementById("explanation-text-content"),e=((o=this.currentUIElements)==null?void 0:o.blurBackdrop)??document.getElementById("blur-backdrop");p&&n&&e&&!this.explanationListenerAdded?(n.textContent=a,this.removeExplanationListener(),e.style.display="block",p.style.display="flex",p.offsetHeight,e.offsetHeight,e.classList.add("visible"),p.classList.add("visible"),this.explanationConfirmListener=d=>{d.type==="touchstart"&&d.preventDefault(),this.explanationConfirmListener&&(this.hideExplanation(),i())},setTimeout(()=>{this.explanationConfirmListener&&(p.addEventListener("click",this.explanationConfirmListener,{capture:!0,once:!0}),p.addEventListener("touchstart",this.explanationConfirmListener,{passive:!1,capture:!0,once:!0}),window.addEventListener("keydown",this.explanationConfirmListener,{capture:!0,once:!0}),this.explanationListenerAdded=!0,console.log("UIManager: Listeners para confirmar explicación añadidos (click, touchstart, keydown)."))},50)):!p||!n||!e?(console.error("UIManager: Elementos del overlay de explicación no encontrados."),i()):this.explanationListenerAdded&&console.warn("UIManager: Intento de mostrar explicación mientras los listeners ya están activos.")}hideExplanation(){var p,n;const a=((p=this.currentUIElements)==null?void 0:p.explanationOverlay)??document.getElementById("explanation-overlay"),i=((n=this.currentUIElements)==null?void 0:n.blurBackdrop)??document.getElementById("blur-backdrop");if(this.removeExplanationListener(),a&&i){a.classList.remove("visible");const e=document.getElementById("shop-popup");(!e||!e.classList.contains("visible"))&&i.classList.remove("visible");const s=r=>{r&&(r.target!==a||r.propertyName!=="opacity")||(a&&(a.style.display="none"),(!e||!e.classList.contains("visible"))&&i&&(i.style.display="none"),a&&a.removeEventListener("transitionend",s))};a.addEventListener("transitionend",s),setTimeout(()=>{a!=null&&a.classList.contains("visible")&&(console.warn("UIManager: transitionend no se disparó para explicación, forzando ocultación."),s())},450)}}removeExplanationListener(){var i;const a=((i=this.currentUIElements)==null?void 0:i.explanationOverlay)??document.getElementById("explanation-overlay");this.explanationConfirmListener&&(a&&(a.removeEventListener("click",this.explanationConfirmListener,{capture:!0}),a.removeEventListener("touchstart",this.explanationConfirmListener,{capture:!0})),window.removeEventListener("keydown",this.explanationConfirmListener,{capture:!0}),this.explanationConfirmListener=null,this.explanationListenerAdded=!1)}updateScoreDisplay(a){var n,e;const i=(n=this.currentUIElements)==null?void 0:n.scoreDisplayText;i&&(i.textContent=a.toString());const p=(e=this.currentUIElements)==null?void 0:e.scorePulse;p&&(p.classList.remove("pulsing"),p.offsetWidth,p.classList.add("pulsing"))}updateLivesDisplay(a){var p;const i=(p=this.currentUIElements)==null?void 0:p.livesDisplayCount;i&&(i.textContent=a.toString())}updateShieldIcon(a){var p;const i=(p=this.currentUIElements)==null?void 0:p.shieldIcon;i&&(i.style.display=a?"inline":"none")}updateHintIcon(a){var p;const i=(p=this.currentUIElements)==null?void 0:p.hintIcon;i&&(i.style.display=a>0?"inline":"none")}updateFeedback(a,i){var n;const p=(n=this.currentUIElements)==null?void 0:n.feedbackArea;if(p){p.textContent=a,p.className="feedback-area-base mt-4 h-8 text-center font-bold";const e=i==="correct"?"text-green-400 feedback-correct":i==="incorrect"?"text-red-400 feedback-incorrect":i==="shield"?"text-blue-400 feedback-shield":"text-gray-400 feedback-info";p.classList.add(...e.split(" "))}}updateInkBar(){var g;const a=((g=this.currentUIElements)==null?void 0:g.inkBarContainer)??document.getElementById("ink-bar-container");if(!a)return;const i=this.gameManager.getPlayerData(),p=i.currentInk,n=i.INK_BAR_CAPACITY;a.innerHTML="";const e=Math.floor(p/n),s=p%n,r=p===0&&e===0?0:s===0&&e>0?100:s/n*100;let o=be;if(e>0){const h=(e-1)%j.length;o=j[h]}a.style.backgroundColor=o;const d=e%j.length,l=j[d];if(r>=0){const h=document.createElement("div");h.className="ink-bar-segment",h.style.backgroundColor=l,h.style.width=`${r}%`,a.appendChild(h)}}updateInkVisibility(a){var e,s,r;const i=((e=this.currentUIElements)==null?void 0:e.topUIContainer)??document.getElementById("score-area"),p=((s=this.currentUIElements)==null?void 0:s.inkLabel)??document.getElementById("ink-label"),n=((r=this.currentUIElements)==null?void 0:r.inkBarContainer)??document.getElementById("ink-bar-container");p&&p.classList.toggle("hidden",!a),n&&n.classList.toggle("hidden",!a),i&&i.classList.toggle("ink-visible",a)}updateDifficultyLabel(a){var e;const i=(e=this.currentUIElements)==null?void 0:e.difficultyLabel;if(!i)return;let p=se[Number(a)]||se[a]||se[1];i.textContent=`Pregunta: ${p.name}`,Object.values(se).forEach(s=>{s.class&&i.classList.remove(s.class)}),p.class&&i.classList.add(p.class);const n=document.documentElement;n.style.setProperty("--difficulty-glow-color",p.glowColor||"transparent"),n.style.setProperty("--difficulty-glow-blur",p.glowBlur||"0px"),i.classList.toggle("difficulty-pulse",!!p.pulse)}updateComboVisuals(a){var t,u;const i=document.documentElement,p=(t=this.currentUIElements)==null?void 0:t.comboDisplay,n=(u=this.currentUIElements)==null?void 0:u.scoreDisplayText;if(!i){console.error("[updateComboVisuals] Error: document.documentElement no encontrado.");return}const e=a<de?0:Math.min((a-de+1)/(wt-de+1),1);i.style.setProperty("--flare-intensity",e.toFixed(3));const s=a<fe?0:Math.min((a-fe+1)/(It-fe+1),1);if(i.style.setProperty("--element-glow-intensity",s.toFixed(3)),p)if(a>0){const c=Math.min(Math.max(0,a-1),10),f=Pe+c*Tt;i.style.setProperty("--combo-font-size",`${f.toFixed(2)}rem`),p.textContent=`x${a}`,p.style.display="block";const y=a*At%360;p.style.color=`hsl(${y}, 100%, 65%)`,p.style.backgroundImage="none",p.style.backgroundClip="unset",p.style.webkitBackgroundClip="unset"}else p.textContent="",p.style.display="none",i.style.setProperty("--combo-font-size",`${Pe}rem`),p.style.color="inherit",p.style.backgroundImage="none",p.style.backgroundClip="unset",p.style.webkitBackgroundClip="unset";const r=Math.min(Math.max(0,a-ke)/(Lt-ke),1),o=r*r,l=(220+a*10)%360,g=30+o*50,h=10+o*15;if(document.body.style.backgroundColor=`hsl(${l.toFixed(0)}, ${g.toFixed(0)}%, ${h.toFixed(0)}%)`,n){const c=e>.3;n.classList.toggle("score-pulsing",c),c||(n.style.textShadow="var(--flare-shadow)");const f=Math.min(a/10,1),y=90+f*10,E=700+Math.floor(f*2)*100,S=(l+180)%360,T=a<2?"#f3f4f6":`hsl(${S}, 80%, ${y}%)`;n.style.color=T,n.style.fontWeight=`${E}`}else console.warn("[updateComboVisuals] Elemento scoreDisplayText (#score) no encontrado.")}disableOptions(){var a,i;(i=(a=this.currentUIElements)==null?void 0:a.optionButtons)==null||i.forEach(p=>{p&&(p.disabled=!0)})}enableOptions(){var a,i;(i=(a=this.currentUIElements)==null?void 0:a.optionButtons)==null||i.forEach(p=>{p&&!p.classList.contains("option-hint-disabled")&&(p.disabled=!1)})}applyHintVisuals(a){var s;let i=0;const p=1,n=(s=this.currentUIElements)==null?void 0:s.optionButtons;if(!n||n.length<=1)return;[...n].sort(()=>.5-Math.random()).forEach(r=>{i>=p||r&&r.dataset.key!==a&&!r.classList.contains("option-hint-disabled")&&(r.classList.add("option-hint-disabled"),i++)})}toggleCatFoodUIVisibility(a){var p;const i=((p=this.currentUIElements)==null?void 0:p.catFoodUiContainer)??document.getElementById("cat-food-ui-container");i?i.classList.toggle("hidden",!a):a&&console.warn("UIManager: Contenedor UI comida (#cat-food-ui-container) no encontrado.")}showCatFoodUI(){this.toggleCatFoodUIVisibility(!0),this.currentUIElements.catFoodButton||(this.currentUIElements.catFoodButton=document.getElementById("cat-food-button"))}updateCatFoodBar(a,i){console.log(`[UIManager.updateCatFoodBar] Llamado con: current=${a}, max=${i}`);const p=document.getElementById("cat-food-bar-fill");if(p){const n=i>0?Math.max(0,Math.min(100,a/i*100)):0;console.log(` -> Calculando porcentaje: ${n.toFixed(1)}%`),p.style.width=`${n}%`}else console.warn("[UIManager.updateCatFoodBar] Elemento #cat-food-bar-fill NO encontrado.")}rebuildInterface(){const a=this.gameManager.getCurrentState();if(a instanceof ee&&a.currentQuestion){const i=this.gameManager.getContainerElement();i?(this.buildQuizInterface(a.currentQuestion,i,a.handleOptionClick.bind(a),a.consecutiveCorrectAnswers),a.hintAppliedToQuestionId===a.currentQuestion.id&&this.gameManager.getPlayerData().hintCharges>0&&this.applyHintVisuals(a.currentQuestion.correctAnswerKey)):console.error("UIManager: Contenedor #app no encontrado al intentar reconstruir.")}}}class Pt{constructor(a="body"){A(this,"themes",[]);A(this,"activeThemeIndex",0);A(this,"defaultThemeId","retro");A(this,"isLoading",!1);A(this,"lastError",null);A(this,"rootElement",document.body);console.log("ThemeManager Creado.");const i=document.querySelector(a);i instanceof HTMLElement?this.rootElement=i:(console.warn(`ThemeManager: Elemento raíz '${a}' no encontrado, usando document.body.`),this.rootElement=document.body)}async loadThemesData(a){if(this.isLoading)return console.warn("ThemeManager: Ya hay una carga en progreso."),!1;console.log("ThemeManager: Procesando datos de temas pre-cargados..."),this.isLoading=!0,this.lastError=null,this.themes=[];try{if(!Array.isArray(a))throw new Error("Los datos de temas proporcionados no son un array válido.");return this.themes=a,console.log(`ThemeManager: ${this.themes.length} temas procesados exitosamente.`),this.activeThemeIndex=Math.max(0,this.themes.findIndex(i=>i.id===this.defaultThemeId)),this.isLoading=!1,this.applyActiveThemeClass(),!0}catch(i){return console.error("ThemeManager: Error al procesar los datos de temas:",i),this.lastError=i instanceof Error?i.message:String(i),this.isLoading=!1,this.themes=[],this.activeThemeIndex=0,!1}}applyActiveThemeClass(){var i,p;if(!this.rootElement)return;this.themes.forEach(n=>{var e,s;(s=(e=n.elements)==null?void 0:e.quizWrapper)!=null&&s.themeClass&&this.rootElement.classList.remove(n.elements.quizWrapper.themeClass)});const a=this.getActiveTheme();if((p=(i=a==null?void 0:a.elements)==null?void 0:i.quizWrapper)!=null&&p.themeClass){const n=a.elements.quizWrapper.themeClass;this.rootElement.classList.add(n),console.log(`ThemeManager: Clase de tema '${n}' aplicada a ${this.rootElement.tagName}.`)}else console.warn("ThemeManager: Tema activo o su themeClass no definidos.")}getActiveTheme(){return this.themes.length===0?null:this.themes[this.activeThemeIndex]??null}getActiveThemeId(){var a;return((a=this.getActiveTheme())==null?void 0:a.id)??null}cycleTheme(){if(this.themes.length<=1)return;this.activeThemeIndex=(this.activeThemeIndex+1)%this.themes.length,this.applyActiveThemeClass();const a=this.getActiveTheme();console.log(`ThemeManager: Tema ciclado a '${(a==null?void 0:a.name)??"N/A"}' (ID: ${(a==null?void 0:a.id)??"N/A"})`)}setActiveTheme(a){var p;const i=this.themes.findIndex(n=>n.id===a);return i!==-1?(this.activeThemeIndex=i,this.applyActiveThemeClass(),console.log(`ThemeManager: Tema establecido a '${(p=this.getActiveTheme())==null?void 0:p.name}' (ID: ${a})`),!0):(console.warn(`ThemeManager: No se encontró el tema con ID '${a}'.`),!1)}getThemes(){return[...this.themes]}getLastError(){return this.lastError}isLoadingThemes(){return this.isLoading}}const oe=8,bt=3500,Bt=8,Dt=2,Ft=4e-4,Rt=500*500,Ot=1;class Nt{constructor(a){A(this,"gameManager");A(this,"physicsManager",null);A(this,"playerData",null);A(this,"catManager",null);A(this,"audioManager",null);A(this,"isInitializedSuccessfully",!1);A(this,"isEnabled",!1);A(this,"isActive",!1);A(this,"activePellets",new Map);A(this,"nextPelletId",0);A(this,"catFoodButton",null);A(this,"catFoodContainer",null);A(this,"catContainerElement",null);A(this,"clickListener",null);A(this,"buttonListenerInfo",null);A(this,"lastInteractionTime",0);A(this,"DEBOUNCE_THRESHOLD",300);console.log("CatFoodManager: Constructor iniciado."),this.gameManager=a}init(){this.isInitializedSuccessfully=!1,console.log("CatFoodManager: init");try{if(this.physicsManager=this.gameManager.getPhysicsManager(),this.playerData=this.gameManager.getPlayerData(),this.catManager=this.gameManager.getCatManager(),this.audioManager=this.gameManager.getAudioManager(),this.catContainerElement=document.getElementById("cat-container"),this.catFoodButton=document.getElementById("cat-food-button"),this.catFoodContainer=document.getElementById("cat-food-ui-container"),!this.physicsManager)throw new Error("PhysicsManager no disponible.");if(!this.playerData)throw new Error("PlayerData no disponible.");if(!this.catManager)throw new Error("CatManager no disponible.");if(!this.audioManager)throw new Error("AudioManager no disponible.");if(!this.catContainerElement)throw new Error("Elemento #cat-container no encontrado.");if(!this.catFoodButton)throw new Error("Elemento #cat-food-button no encontrado.");if(!this.catFoodContainer)throw new Error("Elemento #cat-food-ui-container no encontrado.");console.log("CatFoodManager: Inicialización exitosa."),this.isInitializedSuccessfully=!0}catch(a){console.error("CatFoodManager: Error CRÍTICO durante la inicialización:",a),this.isEnabled=!1}}enable(){if(!this.isInitializedSuccessfully){console.error("CatFoodManager: No se puede habilitar, inicialización falló.");return}if(!this.isEnabled)if(console.log("CatFoodManager: Habilitando..."),this.isEnabled=!0,this.catFoodButton||(this.catFoodButton=document.getElementById("cat-food-button")),this.catFoodContainer||(this.catFoodContainer=document.getElementById("cat-food-ui-container")),this.catFoodButton){this.removeButtonListener();const a=i=>{const p=Date.now();p-this.lastInteractionTime<this.DEBOUNCE_THRESHOLD||(this.lastInteractionTime=p,i.type==="touchstart"&&i.preventDefault(),this.gameManager.activateCatFood())};this.buttonListenerInfo={click:a,touchstart:a},this.catFoodButton.addEventListener("click",this.buttonListenerInfo.click),this.catFoodButton.addEventListener("touchstart",this.buttonListenerInfo.touchstart,{passive:!1}),console.log(" -> Listeners (click, touchstart) con debounce añadidos al botón de comida.")}else console.warn("CatFoodManager: Botón de comida no encontrado al habilitar, listener no añadido.")}removeButtonListener(){this.buttonListenerInfo&&this.catFoodButton&&(this.catFoodButton.removeEventListener("click",this.buttonListenerInfo.click),this.buttonListenerInfo.touchstart&&this.catFoodButton.removeEventListener("touchstart",this.buttonListenerInfo.touchstart)),this.buttonListenerInfo=null}toggleActive(a){if(!this.isEnabled||!this.isInitializedSuccessfully)return;const i=a!==void 0?a:!this.isActive;if(i===!0&&(!this.isEnabled||this.playerData&&this.playerData.currentCatFood<=0)){this.isActive&&(this.isActive=!1,this.updateActiveVisuals(),this.removeClickListener());return}i!==this.isActive&&(this.isActive=i,this.updateActiveVisuals(),this.isActive?this.addClickListener():this.removeClickListener())}updateActiveVisuals(){this.catFoodButton&&this.catFoodButton.classList.toggle("active",this.isActive)}addClickListener(){if(this.clickListener||!this.isInitializedSuccessfully)return;const a=document.body;a&&(this.clickListener=i=>{if(!i.target.closest(".control-button")&&!(!this.isActive||!this.isEnabled)){if(i.preventDefault(),!this.playerData){console.error("ClickListener: PlayerData no disponible.");return}if(this.playerData.currentCatFood>0){const n=this.getClickPosition(i);this.spawnFoodPellet(n),this.applyAttractionForce(n),this.playerData.spendCatFoodUnit()?this.gameManager.updateCatFoodUI():(console.warn("[CatFood Interaction Listener] spendCatFoodUnit falló."),this.toggleActive(!1))}else this.toggleActive(!1)}},a.addEventListener("mousedown",this.clickListener,{capture:!0}),a.addEventListener("touchstart",this.clickListener,{passive:!1,capture:!0}))}removeClickListener(){if(!this.clickListener)return;const a=document.body;a.removeEventListener("mousedown",this.clickListener,{capture:!0}),a.removeEventListener("touchstart",this.clickListener,{capture:!0}),this.clickListener=null}getClickPosition(a){let i=0,p=0;return a instanceof MouseEvent?(i=a.clientX,p=a.clientY):a.touches&&a.touches[0]?(i=a.touches[0].clientX,p=a.touches[0].clientY):a.changedTouches&&a.changedTouches[0]&&(i=a.changedTouches[0].clientX,p=a.changedTouches[0].clientY),{x:i,y:p}}applyAttractionForce(a){if(!this.catManager||!this.physicsManager)return;const i=this.catManager.getAllCats(),p=this.physicsManager.getWorld();i.forEach(n=>{if(n.physics.body&&!n.physics.body.isStatic&&F.Composite.get(p,n.physics.body.id,"body")){const e=n.physics.body,s=F.Vector.sub(a,e.position),r=F.Vector.magnitudeSquared(s);if(r>1&&r<Rt){const o=Math.sqrt(r),d=Ft*o,l=F.Vector.mult(F.Vector.normalise(s),d);try{F.Body.applyForce(e,e.position,l)}catch{}}}})}spawnFoodPellet(a){if(!this.isInitializedSuccessfully||!this.physicsManager||!this.catContainerElement)return;const i=`food_${this.nextPelletId++}`,p=F.Bodies.circle(a.x,a.y,oe/2,{label:"foodPellet",isSensor:!0,density:1e-4,frictionAir:.02,collisionFilter:{category:Bt,mask:Dt},plugin:{pelletId:i}});try{F.World.add(this.physicsManager.getWorld(),p)}catch{return}const n=document.createElement("div");n.id=i,n.classList.add("food-pellet"),n.style.width=`${oe}px`,n.style.height=`${oe}px`,n.style.left="-9999px",n.style.top="-9999px";try{this.catContainerElement.appendChild(n)}catch{try{F.World.remove(this.physicsManager.getWorld(),p)}catch{}return}const e={body:p,element:n,creationTime:performance.now(),id:i};this.activePellets.set(i,e)}update(a){if(!this.isEnabled||!this.isInitializedSuccessfully||this.activePellets.size===0)return;const i=performance.now(),p=[];this.activePellets.forEach(n=>{if(i-n.creationTime>bt)p.push(n.id);else if(n.element&&n.body){const e=oe/2;n.element.style.transform=`translate(${n.body.position.x-e}px, ${n.body.position.y-e}px)`,n.element.style.left!==""&&(n.element.style.left="",n.element.style.top="")}}),p.forEach(n=>this.removeFoodPellet(n))}removeFoodPellet(a,i=!1){var n;const p=this.activePellets.get(a);if(p){if(this.physicsManager&&p.body)try{F.Composite.get(this.physicsManager.getWorld(),p.body.id,"body")&&F.World.remove(this.physicsManager.getWorld(),p.body)}catch{}(n=p.element)==null||n.remove(),this.activePellets.delete(a)}}processCatFoodCollision(a,i){var l,g;const p=(l=i.plugin)==null?void 0:l.pelletId;if(!p||!this.activePellets.has(p)||!this.catManager||!this.playerData||!this.audioManager||!this.physicsManager)return;const n=this.catManager.bodyIdToEntityIdMap.get(a);if(!n)return;const e=this.catManager.getCat(n);if(!e||!e.value||!e.physics.body||!((g=e.render)!=null&&g.element))return;const s=e.value.currentSize,r=this.playerData.getCurrentMaxSizeLimit();let o=Math.min(r,s+Ot);const d=o/s;if(d>1.0001){e.value.currentSize=o;try{if(F.Composite.get(this.physicsManager.getWorld(),e.physics.body.id,"body"))F.Body.scale(e.physics.body,d,d);else throw new Error("Body not found")}catch{e.value.currentSize=s}}this.audioManager.playSound("eat"),this.removeFoodPellet(p,!0)}destroy(){console.log("CatFoodManager: destroy"),this.removeClickListener(),this.removeButtonListener(),Array.from(this.activePellets.keys()).forEach(i=>this.removeFoodPellet(i)),this.activePellets.clear(),this.isEnabled=!1,this.isActive=!1}}class Ut{constructor(a){A(this,"gameManager");this.gameManager=a}enter(a){console.log("LoadingState: enter",a),this.gameManager.setBodyStateClass("loading")}exit(){console.log("LoadingState: exit")}update(a){}}class zt{constructor(a){A(this,"gameManager");A(this,"startListener",null);A(this,"containerElement",null);A(this,"sparkleIntervalId",null);A(this,"hasStarted",!1);this.gameManager=a}enter(a){if(console.log("MainMenuState: enter (Whiskers & Wisdom Style)",a),this.gameManager.setBodyStateClass("mainmenu-whiskers"),this.containerElement=this.gameManager.getContainerElement(),this.hasStarted=!1,!this.containerElement){console.error("MainMenuState: Contenedor principal #app no encontrado.");return}this.containerElement.innerHTML="";const i=document.createElement("div");i.className="paw-wrapper";const p=document.createElement("div");p.className="rainbow-circle";const n=document.createElement("div");n.className="circle-content",p.appendChild(n);const e=document.createElement("span");e.className="title-ampersand font-pacifico",e.textContent="&";const s=document.createElement("div");s.className="container-invisible";const r=document.createElement("div");r.className="title-container";const o=document.createElement("h1");o.className="font-pacifico title-shadow",o.textContent="Whiskers";const d=document.createElement("h1");d.className="font-pacifico title-shadow",d.textContent="Wisdom";const l=document.createElement("span");l.className="animate-paw-wiggle paw-1",l.textContent="🐾";const g=document.createElement("span");g.className="animate-paw-wiggle paw-2",g.textContent="🐾",r.append(o,d,l,g);const h=document.createElement("div");h.id="click-text",h.className="fading-click-text font-poppins",h.textContent="<HAZ CLICK O TOCA>";const t=document.createElement("div");t.id="loading-message",t.className="mt-10 flex flex-col items-center",t.style.display="none";const u=document.createElement("div");u.className="yarn-spinner mb-4";const c=document.createElement("span");c.className="font-semibold font-geist",c.textContent="Desenredando la diversión...",t.append(u,c),s.append(r,h,t),i.append(p,s);const f=document.createElement("div");f.id="sparkle-container",f.style.position="absolute",f.style.top="0",f.style.left="0",f.style.width="100%",f.style.height="100%",f.style.pointerEvents="none",f.style.zIndex="2",this.containerElement.append(i,e,f),this.containerElement.insertAdjacentHTML("beforeend",`
        <svg id="sparkle-svg-template" style="display: none;" width="50px" height="50px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <defs><style>.cls-sparkle{fill:none;stroke-miterlimit:10; stroke: #fff845; stroke-width: 2px;}</style></defs>
          <line class="cls-sparkle" x1="12" y1="0.5" x2="12" y2="5.29"/><line class="cls-sparkle" x1="12" y1="18.71" x2="12" y2="23.5"/><line class="cls-sparkle" x1="23.5" y1="12" x2="18.71" y2="12"/><line class="cls-sparkle" x1="5.29" y1="12" x2="0.5" y2="12"/><line class="cls-sparkle" x1="20.13" y1="3.87" x2="16.74" y2="7.26"/><line class="cls-sparkle" x1="7.26" y1="16.74" x2="3.87" y2="20.13"/><line class="cls-sparkle" x1="20.13" y1="20.13" x2="16.74" y2="16.74"/><line class="cls-sparkle" x1="7.26" y1="7.26" x2="3.87" y2="3.87"/>
        </svg>
    `);const y=E=>{this.hasStarted||(this.hasStarted=!0,console.log("Starting Whiskers & Wisdom - Meow!"),this.gameManager.getAudioManager().playSound("ui_confirm"),r&&(r.style.display="none"),p&&(p.style.display="none"),h&&(h.style.display="none"),e&&(e.style.display="none"),l&&(l.style.display="none"),g&&(g.style.display="none"),t&&(t.style.display="flex"),this.sparkleIntervalId&&(clearTimeout(this.sparkleIntervalId),this.sparkleIntervalId=null),this.removeStartListeners(),this.gameManager.getStateMachine().changeState("QuizGameplay"))};this.startListener=y,this.containerElement.style.cursor="pointer",this.containerElement.addEventListener("click",this.startListener,{once:!0,passive:!1}),this.containerElement.addEventListener("touchstart",this.startListener,{once:!0,passive:!1}),console.log("MainMenuState: Listeners 'click' y 'touchstart' añadidos a #app."),this.startSparkleEffect(),this.ensureFontsLoaded()}removeStartListeners(){this.containerElement&&this.startListener&&(this.containerElement.removeEventListener("click",this.startListener),this.containerElement.removeEventListener("touchstart",this.startListener),console.log("MainMenuState: Listeners 'click' y 'touchstart' removidos.")),this.startListener=null}exit(){console.log("MainMenuState: exit (Whiskers & Wisdom Style)"),this.sparkleIntervalId&&(clearTimeout(this.sparkleIntervalId),this.sparkleIntervalId=null),this.removeStartListeners(),this.containerElement&&(this.containerElement.innerHTML="",this.containerElement.style.cursor=""),this.containerElement=null}update(a){}startSparkleEffect(){const a=()=>{const p=document.getElementById("sparkle-svg-template"),n=document.getElementById("sparkle-container");if(!p||!n)return;const e=p.cloneNode(!0);e.removeAttribute("id"),e.style.display="block",e.classList.add("sparkle-instance");const s=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),r=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),o=parseFloat(e.style.width||"50"),d=parseFloat(e.style.height||"50"),l=Math.random()*(r-d),g=Math.random()*(s-o);e.style.position="absolute",e.style.top=`${l}px`,e.style.left=`${g}px`,n.appendChild(e),setTimeout(()=>{e.parentNode===n&&n.removeChild(e)},500)},i=()=>{a();const p=Math.random()*150+50;this.sparkleIntervalId=window.setTimeout(i,p)};this.sparkleIntervalId&&clearTimeout(this.sparkleIntervalId),i()}ensureFontsLoaded(){document.fonts&&Promise.all([document.fonts.load("1em Pacifico"),document.fonts.load("1em Geist"),document.fonts.load("1em Poppins")]).then(()=>{}).catch(a=>{console.warn("Error esperando fuentes:",a)})}}class Vt{constructor(a){A(this,"gameManager");this.gameManager=a}enter(a){console.log("ResultsState: enter",a),this.gameManager.setBodyStateClass("results")}exit(){console.log("ResultsState: exit")}update(a){}}class $t{constructor(a){A(this,"gameManager");A(this,"gameOverContainer",null);A(this,"restartListener",null);A(this,"keydownListener",null);this.gameManager=a}enter(a){console.log("GameOverState: enter",a),this.gameManager.setBodyStateClass("gameover");const i=(a==null?void 0:a.finalScore)??0;try{console.log("GameOverState: Limpiando gatos de la partida anterior..."),this.gameManager.getCatManager().removeAllCats()}catch(r){console.error("GameOverState: Error al limpiar gatos:",r)}const p=this.gameManager.getContainerElement();p.innerHTML="",this.gameOverContainer=document.createElement("div"),this.gameOverContainer.className="game-over-container flex flex-col items-center justify-center h-full text-center p-4 bg-gray-900 bg-opacity-90 text-white rounded-lg",this.gameOverContainer.tabIndex=-1;const n=document.createElement("p");n.textContent="A ESTUDIAR!!",n.className="game-over-text text-5xl md:text-6xl font-black text-red-500 mb-4 animate-pulse";const e=document.createElement("p");e.textContent=`Puntaje Final: ${i}`,e.className="final-score text-2xl text-yellow-400 mb-8";const s=document.createElement("p");s.textContent="CLICK O TECLA PARA REINICIAR",s.className="restart-prompt text-lg text-gray-300",this.gameOverContainer.appendChild(n),this.gameOverContainer.appendChild(e),this.gameOverContainer.appendChild(s),p.appendChild(this.gameOverContainer),this.gameOverContainer.focus(),this.gameManager.getAudioManager().playSound("game_over"),this.restartListener=()=>this.triggerRestart(),this.keydownListener=r=>{this.triggerRestart()},this.gameOverContainer.addEventListener("click",this.restartListener),this.gameOverContainer.addEventListener("keydown",this.keydownListener)}triggerRestart(){console.log("Restarting game from GameOver..."),this.gameManager.getStateMachine().changeState("MainMenu")}exit(){console.log("GameOverState: exit"),this.gameOverContainer&&(this.restartListener&&(this.gameOverContainer.removeEventListener("click",this.restartListener),this.restartListener=null),this.keydownListener&&(this.gameOverContainer.removeEventListener("keydown",this.keydownListener),this.keydownListener=null),this.gameOverContainer.parentNode&&this.gameOverContainer.parentNode.removeChild(this.gameOverContainer),this.gameOverContainer=null)}update(a){}}const Ht="shop-popup";class Wt{constructor(a){A(this,"physicsManager");A(this,"quizSystem");A(this,"stateMachine");A(this,"audioManager");A(this,"catManager");A(this,"playerData");A(this,"shopManager");A(this,"inkManager");A(this,"uiManager");A(this,"themeManager");A(this,"catFoodManager");A(this,"lastTimestamp",0);A(this,"isRunning",!1);A(this,"gameLoopRequestId");A(this,"containerElement");A(this,"keydownListener",null);A(this,"controlElements");this.containerElement=a,console.log("GameManager: Constructor iniciado."),this.audioManager=new Ze,this.quizSystem=new Ye,this.playerData=new pt,this.themeManager=new Pt("body"),this.catManager=new it(this.audioManager,this),this.uiManager=new kt(this),this.shopManager=new gt(this.playerData,this),this.inkManager=new Mt(this),this.catFoodManager=new Nt(this),this.physicsManager=new Ke(this.catManager,this.catFoodManager),this.stateMachine=new Xe,this.catManager.setPhysicsManager(this.physicsManager),this.inkManager.setPhysicsManager(this.physicsManager),this.controlElements={controlsContainer:document.getElementById("right-controls"),shopButton:document.getElementById("shop-button"),drawingButtonsContainer:document.getElementById("drawing-buttons-container"),catFoodUiContainer:document.getElementById("cat-food-ui-container")},this.controlElements.controlsContainer||console.warn("GameManager: #right-controls no encontrado."),this.controlElements.shopButton||console.warn("GameManager: #shop-button no encontrado."),this.setupStates(),console.log("GameManager: Constructor finalizado.")}showGameControls(){this.controlElements.controlsContainer&&(this.controlElements.controlsContainer.style.display="flex"),this.controlElements.shopButton&&(this.controlElements.shopButton.style.display="flex"),this.updateControlVisibilityBasedOnUnlocks()}hideGameControls(){this.controlElements.controlsContainer&&(this.controlElements.controlsContainer.style.display="none"),this.controlElements.shopButton&&(this.controlElements.shopButton.style.display="none")}updateControlVisibilityBasedOnUnlocks(){const a=this.playerData.isDrawingUnlocked,i=this.playerData.isCatFoodUnlocked;console.log(`[GM.updateVis] Status: DrawingUnlocked=${a}, CatFoodUnlocked=${i}`);const p=this.controlElements.drawingButtonsContainer;if(p){console.log(`[GM.updateVis] #drawing-buttons-container ENCONTRADO. ¿Tiene clase 'hidden' ANTES? ${p.classList.contains("hidden")}`);const e=!a;p.classList.toggle("hidden",e),console.log(`[GM.updateVis] -> ¿Debería estar oculto? ${e}. ¿Tiene clase 'hidden' DESPUÉS? ${p.classList.contains("hidden")}`)}else console.error("[GM.updateVis] #drawing-buttons-container NO ENCONTRADO.");const n=this.controlElements.catFoodUiContainer;if(n){const e=!i;n.classList.toggle("hidden",e)}else console.warn("[GM.updateVis] #cat-food-ui-container NO ENCONTRADO.")}async init(){console.log("GameManager: init"),this.playerData.reset(),this.physicsManager.init(document.body),this.catFoodManager.init(),this.addKeyboardListener(),this.hideGameControls(),await this.preload(),console.log("GameManager init completado.")}async preload(){console.log("GameManager: preload - Cargando assets...");const a="/GatoQuiz/",i=a.replace(/\/$/,""),p=`${i}/data/questions.json`,n=`${i}/data/cat_templates.json`,e=`${i}/data/shop_items.json`,s=`${i}/data/themes.json`;console.log("Base URL:",a),console.log("Loading from:",p,n,e,s);try{const[r,o,d,l]=await Promise.all([fetch(p),fetch(n),fetch(e),fetch(s)]);if(!r.ok)throw new Error(`HTTP ${r.status} loading ${p}`);if(!o.ok)throw new Error(`HTTP ${o.status} loading ${n}`);if(!d.ok)throw new Error(`HTTP ${d.status} loading ${e}`);if(!l.ok)throw new Error(`HTTP ${l.status} loading ${s}`);const g=await r.json(),h=await o.json(),t=await d.json(),u=await l.json();if(!Array.isArray(g))throw new Error("Invalid questions format.");if(!Array.isArray(h))throw new Error("Invalid templates format.");if(!Array.isArray(t))throw new Error("Invalid shop items format.");if(!Array.isArray(u))throw new Error("Invalid themes format.");if(!await this.quizSystem.loadQuestionsData(g))throw new Error("Failed to process questions.");if(this.catManager.loadTemplates(h),this.shopManager.init(t),!await this.themeManager.loadThemesData(u))throw new Error("Failed to process themes.");console.log("GameManager: Preload completo.")}catch(r){throw console.error("GameManager: Error durante preload:",r),this.containerElement.innerHTML=`Error loading assets: ${r.message}. Check console and asset URLs.`,r}}create(){console.log("GameManager: create"),this.quizSystem.resetAvailableQuestions(),this.catManager.removeAllCats(),this.hideGameControls(),this.stateMachine.changeState("MainMenu")}setupStates(){const a=new Ut(this),i=new zt(this),p=new ee(this),n=new Vt(this),e=new $t(this),s=(o,d)=>{const l=o.enter.bind(o);return g=>{console.log(`Entering state: ${o.constructor.name}, Controls should be: ${d?"Shown":"Hidden"}`),d?this.showGameControls():this.hideGameControls();try{l(g)}catch(h){console.error(`Error in original enter for ${o.constructor.name}:`,h)}d&&o instanceof ee&&this.updateCatFoodUI(),d&&o instanceof ee&&this.updateControlVisibilityBasedOnUnlocks()}},r=(o,d=!0)=>{const l=o.exit.bind(o);return()=>{console.log(`Exiting state: ${o.constructor.name}, Hiding controls: ${d}`);try{l()}catch(g){console.error(`Error in original exit for ${o.constructor.name}:`,g)}d&&this.hideGameControls()}};a.enter=s(a,!1),a.exit=r(a),i.enter=s(i,!1),i.exit=r(i),p.enter=s(p,!0),p.exit=r(p,!0),n.enter=s(n,!1),n.exit=r(n),e.enter=s(e,!1),e.exit=r(e),this.stateMachine.addState("Loading",a),this.stateMachine.addState("MainMenu",i),this.stateMachine.addState("QuizGameplay",p),this.stateMachine.addState("Results",n),this.stateMachine.addState("GameOver",e),this.stateMachine.addState("__shutdown__",{enter:()=>{this.hideGameControls()},exit:()=>{},update:()=>{}})}setBodyStateClass(a){const i=document.body;if(i.className.split(" ").forEach(p=>{p.startsWith("state-")&&i.classList.remove(p)}),a){const p=`state-${a.toLowerCase()}`;i.classList.add(p)}else console.log("Body state class cleared.")}start(){this.isRunning||(console.log("GameManager: Starting game loop..."),this.isRunning=!0,this.lastTimestamp=performance.now(),this.physicsManager.start(),this.gameLoopRequestId=requestAnimationFrame(this.gameLoop.bind(this)))}stop(){this.isRunning&&(console.log("GameManager: Stopping game loop..."),this.isRunning=!1,this.gameLoopRequestId&&cancelAnimationFrame(this.gameLoopRequestId),this.gameLoopRequestId=void 0,this.physicsManager.stop())}gameLoop(a){if(!this.isRunning)return;const i=(a-this.lastTimestamp)/1e3;this.lastTimestamp=a;const p=Math.min(i,.1);this.update(p),this.gameLoopRequestId=requestAnimationFrame(this.gameLoop.bind(this))}update(a){try{this.stateMachine.update(a),this.catManager.updateCats(a),this.catFoodManager.update(a)}catch(i){console.error("Error during game update loop:",i),this.stop()}}shutdown(){console.log("GameManager: shutdown"),this.stop(),this.hideGameControls(),this.removeKeyboardListener(),this.physicsManager.shutdown();const a=this.stateMachine.getCurrentStateName();if(a&&a!=="__shutdown__")try{const i=this.stateMachine.getCurrentState();i==null||i.exit()}catch(i){console.warn("Error in state exit() during shutdown:",i)}this.stateMachine.changeState("__shutdown__"),this.catManager.removeAllCats(),this.inkManager.destroy(),this.shopManager.destroy(),this.catFoodManager.destroy(),this.containerElement.innerHTML="",this.setBodyStateClass(null),console.log("GameManager: Shutdown complete.")}addKeyboardListener(){this.keydownListener||(this.keydownListener=a=>{var e,s;if(a.target instanceof HTMLInputElement||a.target instanceof HTMLTextAreaElement)return;const i=this.stateMachine.getCurrentStateName(),p=(e=document.getElementById(Ht))==null?void 0:e.classList.contains("visible"),n=(s=document.getElementById("explanation-overlay"))==null?void 0:s.classList.contains("visible");if(a.key==="Escape"){if(p){this.closeShop();return}if(n)return}if(i==="QuizGameplay")if(a.key.toLowerCase()==="p"){this.themeManager.cycleTheme();const r=this.stateMachine.getCurrentState();r instanceof ee&&r.rebuildInterface()}else a.key.toLowerCase()==="b"?!p&&!n&&this.playerData.isDrawingUnlocked&&this.activateBrush():a.key.toLowerCase()==="f"?!p&&!n&&this.playerData.isCatFoodUnlocked&&this.activateCatFood():a.key.toLowerCase()==="c"?!p&&!n&&this.playerData.isDrawingUnlocked&&this.playerData.inkSpentSinceLastClear>0&&this.inkManager.clearInkLines():a.key.toLowerCase()==="s"&&(n||(p?this.closeShop():this.openShop()))},window.addEventListener("keydown",this.keydownListener),console.log("GameManager: Keyboard listener added."))}removeKeyboardListener(){this.keydownListener&&(window.removeEventListener("keydown",this.keydownListener),this.keydownListener=null,console.log("GameManager: Keyboard listener removed."))}getLives(){return this.playerData.lives}decrementLives(){this.playerData.lives>0&&(this.playerData.lives--,this.updateExternalLivesUI())}incrementLives(){this.playerData.lives++,this.updateExternalLivesUI()}openShop(){console.log("[GameManager] openShop llamado"),this.shopManager.openShop()}closeShop(){console.log("[GameManager] closeShop llamado"),this.shopManager.closeShop()}enableDrawingFeature(){console.log("[GameManager] LLAMANDO a enableDrawingFeature (para inicializar InkManager)...");try{return console.log(" -> Llamando a inkManager.init()..."),this.inkManager.init(),this.updateInkUI(),this.updateControlVisibilityBasedOnUnlocks(),console.log(" -> InkManager inicializado via enableDrawingFeature."),!0}catch(a){return console.error(" -> Error durante inkManager.init() llamado desde enableDrawingFeature:",a),!1}}enableCatFoodFeature(){console.log("[GameManager] LLAMANDO a enableCatFoodFeature (para habilitar CatFoodManager)...");try{console.log(" -> Llamando a catFoodManager.enable()..."),this.catFoodManager.enable(),this.updateCatFoodUI(),this.updateControlVisibilityBasedOnUnlocks(),console.log(" -> CatFoodManager habilitado via enableCatFoodFeature.")}catch(a){console.error(" -> Error durante catFoodManager.enable() llamado desde enableCatFoodFeature:",a)}}updateInkUI(){this.inkManager.updateInkUI()}updateExternalLivesUI(){this.uiManager.updateLivesDisplay(this.playerData.lives)}updateExternalShieldUI(a){this.uiManager.updateShieldIcon(a)}updateExternalHintUI(a){this.uiManager.updateHintIcon(a)}updateExternalScoreUI(){this.uiManager.updateScoreDisplay(this.playerData.score)}updateCatFoodUI(){this.uiManager.updateCatFoodBar(this.playerData.currentCatFood,this.playerData.getMaxCatFood())}activateBrush(){if(console.log("[GameManager] INTENTO activateBrush"),!this.playerData.isDrawingUnlocked){console.log(" -> Bloqueado: Dibujo no desbloqueado.");return}console.log(` -> Estado ANTES: CatFood Active = ${this.catFoodManager.isActive}, InkBrush Active = ${this.inkManager.isBrushActive}`),this.catFoodManager.isActive&&(console.log(" -> Desactivando CatFood (porque Brush se activará)..."),this.catFoodManager.toggleActive(!1)),console.log(" -> Llamando a inkManager.toggleBrush()..."),this.inkManager.toggleBrush(),console.log(` -> Estado DESPUÉS: CatFood Active = ${this.catFoodManager.isActive}, InkBrush Active = ${this.inkManager.isBrushActive}`)}activateCatFood(){if(console.log("[GameManager] INTENTO activateCatFood"),!this.playerData.isCatFoodUnlocked){console.log(" -> Bloqueado: Comida no desbloqueada.");return}console.log(` -> Estado ANTES: CatFood Active = ${this.catFoodManager.isActive}, InkBrush Active = ${this.inkManager.isBrushActive}`),this.inkManager.isBrushActive&&(console.log(" -> Desactivando InkBrush (porque CatFood se activará)..."),this.inkManager.toggleBrush(!1)),console.log(" -> Llamando a catFoodManager.toggleActive()..."),this.catFoodManager.toggleActive(),console.log(` -> Estado DESPUÉS: CatFood Active = ${this.catFoodManager.isActive}, InkBrush Active = ${this.inkManager.isBrushActive}`)}getQuizSystem(){return this.quizSystem}getPhysicsManager(){return this.physicsManager}getStateMachine(){return this.stateMachine}getAudioManager(){return this.audioManager}getCatManager(){return this.catManager}getShopManager(){return this.shopManager}getPlayerData(){return this.playerData}getInkManager(){return this.inkManager}getUIManager(){if(!this.uiManager)throw new Error("UIManager no inicializado.");return this.uiManager}getThemeManager(){return this.themeManager}getCatFoodManager(){return this.catFoodManager}getContainerElement(){return this.containerElement}getCurrentState(){return this.stateMachine.getCurrentState()}}console.log("DOM Cargado. Iniciando Quiz Felino...");const re=document.getElementById("app"),ge=document.getElementById("shop-button");if(!re)console.error("Error: Elemento #app no encontrado en el DOM.");else{re.innerHTML="",console.log("Preparado para inicializar GameManager.");const R=new Wt(re);window.gameManager=R,console.log("GameManager expuesto como window.gameManager para depuración.");const a=()=>{const i=R.getAudioManager();i.isReady()||(console.log("User interaction detected, attempting to initialize audio..."),i.init()),document.body.removeEventListener("click",a,{capture:!0}),document.body.removeEventListener("touchstart",a,{capture:!0}),console.log("One-time audio init listeners removed.")};if(console.log("Adding one-time listeners for audio initialization..."),document.body.addEventListener("click",a,{once:!0,capture:!0}),document.body.addEventListener("touchstart",a,{once:!0,capture:!0,passive:!1}),ge){console.log("[main.ts] Botón Tienda (#shop-button) ENCONTRADO. Añadiendo listeners...");let i=0;const p=300,n=e=>{console.log(`[main.ts] INTERACCIÓN con Botón Tienda detectada! Tipo: ${e.type}`);const s=Date.now();if(s-i<p){console.log("[main.ts] Interacción tienda debounced.");return}i=s,console.log(`[main.ts] Procesando interacción botón tienda (Tipo: ${e.type}).`),e.type==="touchstart"&&e.preventDefault(),R.getAudioManager().isReady()||(console.log("[main.ts] Inicializando audio desde listener tienda..."),R.getAudioManager().init()),R.openShop()};ge.addEventListener("click",n),ge.addEventListener("touchstart",n,{passive:!1})}else console.error("[main.ts] Botón Tienda (#shop-button) NO ENCONTRADO. Listeners no añadidos.");R.init().then(()=>{R.create(),R.start(),console.log("GameManager inicializado y arrancado.")}).catch(i=>{console.error("Error durante la inicialización del juego:",i),re.innerHTML=`Error al cargar el juego: ${i.message}. Revisa la consola.`})}
