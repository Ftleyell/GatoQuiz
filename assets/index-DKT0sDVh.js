var $e=Object.defineProperty;var Ve=(R,a,i)=>a in R?$e(R,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):R[a]=i;var T=(R,a,i)=>Ve(R,typeof a!="symbol"?a+"":a,i);(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))p(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const o of e.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&p(o)}).observe(document,{childList:!0,subtree:!0});function i(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function p(n){if(n.ep)return;n.ep=!0;const e=i(n);fetch(n.href,e)}})();var Me=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function We(R){return R&&R.__esModule&&Object.prototype.hasOwnProperty.call(R,"default")?R.default:R}var re={exports:{}};/*!
 * matter-js 0.20.0 by @liabru
 * http://brm.io/matter-js/
 * License MIT
 * 
 * The MIT License (MIT)
 * 
 * Copyright (c) Liam Brummitt and contributors.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */var He=re.exports,Se;function Qe(){return Se||(Se=1,function(R,a){(function(p,n){R.exports=n()})(He,function(){return function(i){var p={};function n(e){if(p[e])return p[e].exports;var o=p[e]={i:e,l:!1,exports:{}};return i[e].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=i,n.c=p,n.d=function(e,o,r){n.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:r})},n.r=function(e){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,o){if(o&1&&(e=n(e)),o&8||o&4&&typeof e=="object"&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),o&2&&typeof e!="string")for(var s in e)n.d(r,s,(function(h){return e[h]}).bind(null,s));return r},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},n.p="",n(n.s=20)}([function(i,p){var n={};i.exports=n,function(){n._baseDelta=1e3/60,n._nextId=0,n._seed=0,n._nowStartTime=+new Date,n._warnedOnce={},n._decomp=null,n.extend=function(o,r){var s,h;typeof r=="boolean"?(s=2,h=r):(s=1,h=!0);for(var l=s;l<arguments.length;l++){var g=arguments[l];if(g)for(var d in g)h&&g[d]&&g[d].constructor===Object&&(!o[d]||o[d].constructor===Object)?(o[d]=o[d]||{},n.extend(o[d],h,g[d])):o[d]=g[d]}return o},n.clone=function(o,r){return n.extend({},r,o)},n.keys=function(o){if(Object.keys)return Object.keys(o);var r=[];for(var s in o)r.push(s);return r},n.values=function(o){var r=[];if(Object.keys){for(var s=Object.keys(o),h=0;h<s.length;h++)r.push(o[s[h]]);return r}for(var l in o)r.push(o[l]);return r},n.get=function(o,r,s,h){r=r.split(".").slice(s,h);for(var l=0;l<r.length;l+=1)o=o[r[l]];return o},n.set=function(o,r,s,h,l){var g=r.split(".").slice(h,l);return n.get(o,r,0,-1)[g[g.length-1]]=s,s},n.shuffle=function(o){for(var r=o.length-1;r>0;r--){var s=Math.floor(n.random()*(r+1)),h=o[r];o[r]=o[s],o[s]=h}return o},n.choose=function(o){return o[Math.floor(n.random()*o.length)]},n.isElement=function(o){return typeof HTMLElement<"u"?o instanceof HTMLElement:!!(o&&o.nodeType&&o.nodeName)},n.isArray=function(o){return Object.prototype.toString.call(o)==="[object Array]"},n.isFunction=function(o){return typeof o=="function"},n.isPlainObject=function(o){return typeof o=="object"&&o.constructor===Object},n.isString=function(o){return toString.call(o)==="[object String]"},n.clamp=function(o,r,s){return o<r?r:o>s?s:o},n.sign=function(o){return o<0?-1:1},n.now=function(){if(typeof window<"u"&&window.performance){if(window.performance.now)return window.performance.now();if(window.performance.webkitNow)return window.performance.webkitNow()}return Date.now?Date.now():new Date-n._nowStartTime},n.random=function(o,r){return o=typeof o<"u"?o:0,r=typeof r<"u"?r:1,o+e()*(r-o)};var e=function(){return n._seed=(n._seed*9301+49297)%233280,n._seed/233280};n.colorToNumber=function(o){return o=o.replace("#",""),o.length==3&&(o=o.charAt(0)+o.charAt(0)+o.charAt(1)+o.charAt(1)+o.charAt(2)+o.charAt(2)),parseInt(o,16)},n.logLevel=1,n.log=function(){console&&n.logLevel>0&&n.logLevel<=3&&console.log.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},n.info=function(){console&&n.logLevel>0&&n.logLevel<=2&&console.info.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},n.warn=function(){console&&n.logLevel>0&&n.logLevel<=3&&console.warn.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},n.warnOnce=function(){var o=Array.prototype.slice.call(arguments).join(" ");n._warnedOnce[o]||(n.warn(o),n._warnedOnce[o]=!0)},n.deprecated=function(o,r,s){o[r]=n.chain(function(){n.warnOnce("🔅 deprecated 🔅",s)},o[r])},n.nextId=function(){return n._nextId++},n.indexOf=function(o,r){if(o.indexOf)return o.indexOf(r);for(var s=0;s<o.length;s++)if(o[s]===r)return s;return-1},n.map=function(o,r){if(o.map)return o.map(r);for(var s=[],h=0;h<o.length;h+=1)s.push(r(o[h]));return s},n.topologicalSort=function(o){var r=[],s=[],h=[];for(var l in o)!s[l]&&!h[l]&&n._topologicalSort(l,s,h,o,r);return r},n._topologicalSort=function(o,r,s,h,l){var g=h[o]||[];s[o]=!0;for(var d=0;d<g.length;d+=1){var t=g[d];s[t]||r[t]||n._topologicalSort(t,r,s,h,l)}s[o]=!1,r[o]=!0,l.push(o)},n.chain=function(){for(var o=[],r=0;r<arguments.length;r+=1){var s=arguments[r];s._chained?o.push.apply(o,s._chained):o.push(s)}var h=function(){for(var l,g=new Array(arguments.length),d=0,t=arguments.length;d<t;d++)g[d]=arguments[d];for(d=0;d<o.length;d+=1){var u=o[d].apply(l,g);typeof u<"u"&&(l=u)}return l};return h._chained=o,h},n.chainPathBefore=function(o,r,s){return n.set(o,r,n.chain(s,n.get(o,r)))},n.chainPathAfter=function(o,r,s){return n.set(o,r,n.chain(n.get(o,r),s))},n.setDecomp=function(o){n._decomp=o},n.getDecomp=function(){var o=n._decomp;try{!o&&typeof window<"u"&&(o=window.decomp),!o&&typeof Me<"u"&&(o=Me.decomp)}catch{o=null}return o}}()},function(i,p){var n={};i.exports=n,function(){n.create=function(e){var o={min:{x:0,y:0},max:{x:0,y:0}};return e&&n.update(o,e),o},n.update=function(e,o,r){e.min.x=1/0,e.max.x=-1/0,e.min.y=1/0,e.max.y=-1/0;for(var s=0;s<o.length;s++){var h=o[s];h.x>e.max.x&&(e.max.x=h.x),h.x<e.min.x&&(e.min.x=h.x),h.y>e.max.y&&(e.max.y=h.y),h.y<e.min.y&&(e.min.y=h.y)}r&&(r.x>0?e.max.x+=r.x:e.min.x+=r.x,r.y>0?e.max.y+=r.y:e.min.y+=r.y)},n.contains=function(e,o){return o.x>=e.min.x&&o.x<=e.max.x&&o.y>=e.min.y&&o.y<=e.max.y},n.overlaps=function(e,o){return e.min.x<=o.max.x&&e.max.x>=o.min.x&&e.max.y>=o.min.y&&e.min.y<=o.max.y},n.translate=function(e,o){e.min.x+=o.x,e.max.x+=o.x,e.min.y+=o.y,e.max.y+=o.y},n.shift=function(e,o){var r=e.max.x-e.min.x,s=e.max.y-e.min.y;e.min.x=o.x,e.max.x=o.x+r,e.min.y=o.y,e.max.y=o.y+s}}()},function(i,p){var n={};i.exports=n,function(){n.create=function(e,o){return{x:e||0,y:o||0}},n.clone=function(e){return{x:e.x,y:e.y}},n.magnitude=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},n.magnitudeSquared=function(e){return e.x*e.x+e.y*e.y},n.rotate=function(e,o,r){var s=Math.cos(o),h=Math.sin(o);r||(r={});var l=e.x*s-e.y*h;return r.y=e.x*h+e.y*s,r.x=l,r},n.rotateAbout=function(e,o,r,s){var h=Math.cos(o),l=Math.sin(o);s||(s={});var g=r.x+((e.x-r.x)*h-(e.y-r.y)*l);return s.y=r.y+((e.x-r.x)*l+(e.y-r.y)*h),s.x=g,s},n.normalise=function(e){var o=n.magnitude(e);return o===0?{x:0,y:0}:{x:e.x/o,y:e.y/o}},n.dot=function(e,o){return e.x*o.x+e.y*o.y},n.cross=function(e,o){return e.x*o.y-e.y*o.x},n.cross3=function(e,o,r){return(o.x-e.x)*(r.y-e.y)-(o.y-e.y)*(r.x-e.x)},n.add=function(e,o,r){return r||(r={}),r.x=e.x+o.x,r.y=e.y+o.y,r},n.sub=function(e,o,r){return r||(r={}),r.x=e.x-o.x,r.y=e.y-o.y,r},n.mult=function(e,o){return{x:e.x*o,y:e.y*o}},n.div=function(e,o){return{x:e.x/o,y:e.y/o}},n.perp=function(e,o){return o=o===!0?-1:1,{x:o*-e.y,y:o*e.x}},n.neg=function(e){return{x:-e.x,y:-e.y}},n.angle=function(e,o){return Math.atan2(o.y-e.y,o.x-e.x)},n._temp=[n.create(),n.create(),n.create(),n.create(),n.create(),n.create()]}()},function(i,p,n){var e={};i.exports=e;var o=n(2),r=n(0);(function(){e.create=function(s,h){for(var l=[],g=0;g<s.length;g++){var d=s[g],t={x:d.x,y:d.y,index:g,body:h,isInternal:!1};l.push(t)}return l},e.fromPath=function(s,h){var l=/L?\s*([-\d.e]+)[\s,]*([-\d.e]+)*/ig,g=[];return s.replace(l,function(d,t,u){g.push({x:parseFloat(t),y:parseFloat(u)})}),e.create(g,h)},e.centre=function(s){for(var h=e.area(s,!0),l={x:0,y:0},g,d,t,u=0;u<s.length;u++)t=(u+1)%s.length,g=o.cross(s[u],s[t]),d=o.mult(o.add(s[u],s[t]),g),l=o.add(l,d);return o.div(l,6*h)},e.mean=function(s){for(var h={x:0,y:0},l=0;l<s.length;l++)h.x+=s[l].x,h.y+=s[l].y;return o.div(h,s.length)},e.area=function(s,h){for(var l=0,g=s.length-1,d=0;d<s.length;d++)l+=(s[g].x-s[d].x)*(s[g].y+s[d].y),g=d;return h?l/2:Math.abs(l)/2},e.inertia=function(s,h){for(var l=0,g=0,d=s,t,u,c=0;c<d.length;c++)u=(c+1)%d.length,t=Math.abs(o.cross(d[u],d[c])),l+=t*(o.dot(d[u],d[u])+o.dot(d[u],d[c])+o.dot(d[c],d[c])),g+=t;return h/6*(l/g)},e.translate=function(s,h,l){l=typeof l<"u"?l:1;var g=s.length,d=h.x*l,t=h.y*l,u;for(u=0;u<g;u++)s[u].x+=d,s[u].y+=t;return s},e.rotate=function(s,h,l){if(h!==0){var g=Math.cos(h),d=Math.sin(h),t=l.x,u=l.y,c=s.length,f,y,S,E;for(E=0;E<c;E++)f=s[E],y=f.x-t,S=f.y-u,f.x=t+(y*g-S*d),f.y=u+(y*d+S*g);return s}},e.contains=function(s,h){for(var l=h.x,g=h.y,d=s.length,t=s[d-1],u,c=0;c<d;c++){if(u=s[c],(l-t.x)*(u.y-t.y)+(g-t.y)*(t.x-u.x)>0)return!1;t=u}return!0},e.scale=function(s,h,l,g){if(h===1&&l===1)return s;g=g||e.centre(s);for(var d,t,u=0;u<s.length;u++)d=s[u],t=o.sub(d,g),s[u].x=g.x+t.x*h,s[u].y=g.y+t.y*l;return s},e.chamfer=function(s,h,l,g,d){typeof h=="number"?h=[h]:h=h||[8],l=typeof l<"u"?l:-1,g=g||2,d=d||14;for(var t=[],u=0;u<s.length;u++){var c=s[u-1>=0?u-1:s.length-1],f=s[u],y=s[(u+1)%s.length],S=h[u<h.length?u:h.length-1];if(S===0){t.push(f);continue}var E=o.normalise({x:f.y-c.y,y:c.x-f.x}),A=o.normalise({x:y.y-f.y,y:f.x-y.x}),m=Math.sqrt(2*Math.pow(S,2)),x=o.mult(r.clone(E),S),C=o.normalise(o.mult(o.add(E,A),.5)),v=o.sub(f,o.mult(C,m)),w=l;l===-1&&(w=Math.pow(S,.32)*1.75),w=r.clamp(w,g,d),w%2===1&&(w+=1);for(var M=Math.acos(o.dot(E,A)),L=M/w,I=0;I<w;I++)t.push(o.add(o.rotate(x,L*I),v))}return t},e.clockwiseSort=function(s){var h=e.mean(s);return s.sort(function(l,g){return o.angle(h,l)-o.angle(h,g)}),s},e.isConvex=function(s){var h=0,l=s.length,g,d,t,u;if(l<3)return null;for(g=0;g<l;g++)if(d=(g+1)%l,t=(g+2)%l,u=(s[d].x-s[g].x)*(s[t].y-s[d].y),u-=(s[d].y-s[g].y)*(s[t].x-s[d].x),u<0?h|=1:u>0&&(h|=2),h===3)return!1;return h!==0?!0:null},e.hull=function(s){var h=[],l=[],g,d;for(s=s.slice(0),s.sort(function(t,u){var c=t.x-u.x;return c!==0?c:t.y-u.y}),d=0;d<s.length;d+=1){for(g=s[d];l.length>=2&&o.cross3(l[l.length-2],l[l.length-1],g)<=0;)l.pop();l.push(g)}for(d=s.length-1;d>=0;d-=1){for(g=s[d];h.length>=2&&o.cross3(h[h.length-2],h[h.length-1],g)<=0;)h.pop();h.push(g)}return h.pop(),l.pop(),h.concat(l)}})()},function(i,p,n){var e={};i.exports=e;var o=n(3),r=n(2),s=n(7),h=n(0),l=n(1),g=n(11);(function(){e._timeCorrection=!0,e._inertiaScale=4,e._nextCollidingGroupId=1,e._nextNonCollidingGroupId=-1,e._nextCategory=1,e._baseDelta=1e3/60,e.create=function(t){var u={id:h.nextId(),type:"body",label:"Body",parts:[],plugin:{},angle:0,vertices:o.fromPath("L 0 0 L 40 0 L 40 40 L 0 40"),position:{x:0,y:0},force:{x:0,y:0},torque:0,positionImpulse:{x:0,y:0},constraintImpulse:{x:0,y:0,angle:0},totalContacts:0,speed:0,angularSpeed:0,velocity:{x:0,y:0},angularVelocity:0,isSensor:!1,isStatic:!1,isSleeping:!1,motion:0,sleepThreshold:60,density:.001,restitution:0,friction:.1,frictionStatic:.5,frictionAir:.01,collisionFilter:{category:1,mask:4294967295,group:0},slop:.05,timeScale:1,render:{visible:!0,opacity:1,strokeStyle:null,fillStyle:null,lineWidth:null,sprite:{xScale:1,yScale:1,xOffset:0,yOffset:0}},events:null,bounds:null,chamfer:null,circleRadius:0,positionPrev:null,anglePrev:0,parent:null,axes:null,area:0,mass:0,inertia:0,deltaTime:16.666666666666668,_original:null},c=h.extend(u,t);return d(c,t),c},e.nextGroup=function(t){return t?e._nextNonCollidingGroupId--:e._nextCollidingGroupId++},e.nextCategory=function(){return e._nextCategory=e._nextCategory<<1,e._nextCategory};var d=function(t,u){u=u||{},e.set(t,{bounds:t.bounds||l.create(t.vertices),positionPrev:t.positionPrev||r.clone(t.position),anglePrev:t.anglePrev||t.angle,vertices:t.vertices,parts:t.parts||[t],isStatic:t.isStatic,isSleeping:t.isSleeping,parent:t.parent||t}),o.rotate(t.vertices,t.angle,t.position),g.rotate(t.axes,t.angle),l.update(t.bounds,t.vertices,t.velocity),e.set(t,{axes:u.axes||t.axes,area:u.area||t.area,mass:u.mass||t.mass,inertia:u.inertia||t.inertia});var c=t.isStatic?"#14151f":h.choose(["#f19648","#f5d259","#f55a3c","#063e7b","#ececd1"]),f=t.isStatic?"#555":"#ccc",y=t.isStatic&&t.render.fillStyle===null?1:0;t.render.fillStyle=t.render.fillStyle||c,t.render.strokeStyle=t.render.strokeStyle||f,t.render.lineWidth=t.render.lineWidth||y,t.render.sprite.xOffset+=-(t.bounds.min.x-t.position.x)/(t.bounds.max.x-t.bounds.min.x),t.render.sprite.yOffset+=-(t.bounds.min.y-t.position.y)/(t.bounds.max.y-t.bounds.min.y)};e.set=function(t,u,c){var f;typeof u=="string"&&(f=u,u={},u[f]=c);for(f in u)if(Object.prototype.hasOwnProperty.call(u,f))switch(c=u[f],f){case"isStatic":e.setStatic(t,c);break;case"isSleeping":s.set(t,c);break;case"mass":e.setMass(t,c);break;case"density":e.setDensity(t,c);break;case"inertia":e.setInertia(t,c);break;case"vertices":e.setVertices(t,c);break;case"position":e.setPosition(t,c);break;case"angle":e.setAngle(t,c);break;case"velocity":e.setVelocity(t,c);break;case"angularVelocity":e.setAngularVelocity(t,c);break;case"speed":e.setSpeed(t,c);break;case"angularSpeed":e.setAngularSpeed(t,c);break;case"parts":e.setParts(t,c);break;case"centre":e.setCentre(t,c);break;default:t[f]=c}},e.setStatic=function(t,u){for(var c=0;c<t.parts.length;c++){var f=t.parts[c];u?(f.isStatic||(f._original={restitution:f.restitution,friction:f.friction,mass:f.mass,inertia:f.inertia,density:f.density,inverseMass:f.inverseMass,inverseInertia:f.inverseInertia}),f.restitution=0,f.friction=1,f.mass=f.inertia=f.density=1/0,f.inverseMass=f.inverseInertia=0,f.positionPrev.x=f.position.x,f.positionPrev.y=f.position.y,f.anglePrev=f.angle,f.angularVelocity=0,f.speed=0,f.angularSpeed=0,f.motion=0):f._original&&(f.restitution=f._original.restitution,f.friction=f._original.friction,f.mass=f._original.mass,f.inertia=f._original.inertia,f.density=f._original.density,f.inverseMass=f._original.inverseMass,f.inverseInertia=f._original.inverseInertia,f._original=null),f.isStatic=u}},e.setMass=function(t,u){var c=t.inertia/(t.mass/6);t.inertia=c*(u/6),t.inverseInertia=1/t.inertia,t.mass=u,t.inverseMass=1/t.mass,t.density=t.mass/t.area},e.setDensity=function(t,u){e.setMass(t,u*t.area),t.density=u},e.setInertia=function(t,u){t.inertia=u,t.inverseInertia=1/t.inertia},e.setVertices=function(t,u){u[0].body===t?t.vertices=u:t.vertices=o.create(u,t),t.axes=g.fromVertices(t.vertices),t.area=o.area(t.vertices),e.setMass(t,t.density*t.area);var c=o.centre(t.vertices);o.translate(t.vertices,c,-1),e.setInertia(t,e._inertiaScale*o.inertia(t.vertices,t.mass)),o.translate(t.vertices,t.position),l.update(t.bounds,t.vertices,t.velocity)},e.setParts=function(t,u,c){var f;for(u=u.slice(0),t.parts.length=0,t.parts.push(t),t.parent=t,f=0;f<u.length;f++){var y=u[f];y!==t&&(y.parent=t,t.parts.push(y))}if(t.parts.length!==1){if(c=typeof c<"u"?c:!0,c){var S=[];for(f=0;f<u.length;f++)S=S.concat(u[f].vertices);o.clockwiseSort(S);var E=o.hull(S),A=o.centre(E);e.setVertices(t,E),o.translate(t.vertices,A)}var m=e._totalProperties(t);t.area=m.area,t.parent=t,t.position.x=m.centre.x,t.position.y=m.centre.y,t.positionPrev.x=m.centre.x,t.positionPrev.y=m.centre.y,e.setMass(t,m.mass),e.setInertia(t,m.inertia),e.setPosition(t,m.centre)}},e.setCentre=function(t,u,c){c?(t.positionPrev.x+=u.x,t.positionPrev.y+=u.y,t.position.x+=u.x,t.position.y+=u.y):(t.positionPrev.x=u.x-(t.position.x-t.positionPrev.x),t.positionPrev.y=u.y-(t.position.y-t.positionPrev.y),t.position.x=u.x,t.position.y=u.y)},e.setPosition=function(t,u,c){var f=r.sub(u,t.position);c?(t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.velocity.x=f.x,t.velocity.y=f.y,t.speed=r.magnitude(f)):(t.positionPrev.x+=f.x,t.positionPrev.y+=f.y);for(var y=0;y<t.parts.length;y++){var S=t.parts[y];S.position.x+=f.x,S.position.y+=f.y,o.translate(S.vertices,f),l.update(S.bounds,S.vertices,t.velocity)}},e.setAngle=function(t,u,c){var f=u-t.angle;c?(t.anglePrev=t.angle,t.angularVelocity=f,t.angularSpeed=Math.abs(f)):t.anglePrev+=f;for(var y=0;y<t.parts.length;y++){var S=t.parts[y];S.angle+=f,o.rotate(S.vertices,f,t.position),g.rotate(S.axes,f),l.update(S.bounds,S.vertices,t.velocity),y>0&&r.rotateAbout(S.position,f,t.position,S.position)}},e.setVelocity=function(t,u){var c=t.deltaTime/e._baseDelta;t.positionPrev.x=t.position.x-u.x*c,t.positionPrev.y=t.position.y-u.y*c,t.velocity.x=(t.position.x-t.positionPrev.x)/c,t.velocity.y=(t.position.y-t.positionPrev.y)/c,t.speed=r.magnitude(t.velocity)},e.getVelocity=function(t){var u=e._baseDelta/t.deltaTime;return{x:(t.position.x-t.positionPrev.x)*u,y:(t.position.y-t.positionPrev.y)*u}},e.getSpeed=function(t){return r.magnitude(e.getVelocity(t))},e.setSpeed=function(t,u){e.setVelocity(t,r.mult(r.normalise(e.getVelocity(t)),u))},e.setAngularVelocity=function(t,u){var c=t.deltaTime/e._baseDelta;t.anglePrev=t.angle-u*c,t.angularVelocity=(t.angle-t.anglePrev)/c,t.angularSpeed=Math.abs(t.angularVelocity)},e.getAngularVelocity=function(t){return(t.angle-t.anglePrev)*e._baseDelta/t.deltaTime},e.getAngularSpeed=function(t){return Math.abs(e.getAngularVelocity(t))},e.setAngularSpeed=function(t,u){e.setAngularVelocity(t,h.sign(e.getAngularVelocity(t))*u)},e.translate=function(t,u,c){e.setPosition(t,r.add(t.position,u),c)},e.rotate=function(t,u,c,f){if(!c)e.setAngle(t,t.angle+u,f);else{var y=Math.cos(u),S=Math.sin(u),E=t.position.x-c.x,A=t.position.y-c.y;e.setPosition(t,{x:c.x+(E*y-A*S),y:c.y+(E*S+A*y)},f),e.setAngle(t,t.angle+u,f)}},e.scale=function(t,u,c,f){var y=0,S=0;f=f||t.position;for(var E=0;E<t.parts.length;E++){var A=t.parts[E];o.scale(A.vertices,u,c,f),A.axes=g.fromVertices(A.vertices),A.area=o.area(A.vertices),e.setMass(A,t.density*A.area),o.translate(A.vertices,{x:-A.position.x,y:-A.position.y}),e.setInertia(A,e._inertiaScale*o.inertia(A.vertices,A.mass)),o.translate(A.vertices,{x:A.position.x,y:A.position.y}),E>0&&(y+=A.area,S+=A.inertia),A.position.x=f.x+(A.position.x-f.x)*u,A.position.y=f.y+(A.position.y-f.y)*c,l.update(A.bounds,A.vertices,t.velocity)}t.parts.length>1&&(t.area=y,t.isStatic||(e.setMass(t,t.density*y),e.setInertia(t,S))),t.circleRadius&&(u===c?t.circleRadius*=u:t.circleRadius=null)},e.update=function(t,u){u=(typeof u<"u"?u:1e3/60)*t.timeScale;var c=u*u,f=e._timeCorrection?u/(t.deltaTime||u):1,y=1-t.frictionAir*(u/h._baseDelta),S=(t.position.x-t.positionPrev.x)*f,E=(t.position.y-t.positionPrev.y)*f;t.velocity.x=S*y+t.force.x/t.mass*c,t.velocity.y=E*y+t.force.y/t.mass*c,t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.position.x+=t.velocity.x,t.position.y+=t.velocity.y,t.deltaTime=u,t.angularVelocity=(t.angle-t.anglePrev)*y*f+t.torque/t.inertia*c,t.anglePrev=t.angle,t.angle+=t.angularVelocity;for(var A=0;A<t.parts.length;A++){var m=t.parts[A];o.translate(m.vertices,t.velocity),A>0&&(m.position.x+=t.velocity.x,m.position.y+=t.velocity.y),t.angularVelocity!==0&&(o.rotate(m.vertices,t.angularVelocity,t.position),g.rotate(m.axes,t.angularVelocity),A>0&&r.rotateAbout(m.position,t.angularVelocity,t.position,m.position)),l.update(m.bounds,m.vertices,t.velocity)}},e.updateVelocities=function(t){var u=e._baseDelta/t.deltaTime,c=t.velocity;c.x=(t.position.x-t.positionPrev.x)*u,c.y=(t.position.y-t.positionPrev.y)*u,t.speed=Math.sqrt(c.x*c.x+c.y*c.y),t.angularVelocity=(t.angle-t.anglePrev)*u,t.angularSpeed=Math.abs(t.angularVelocity)},e.applyForce=function(t,u,c){var f={x:u.x-t.position.x,y:u.y-t.position.y};t.force.x+=c.x,t.force.y+=c.y,t.torque+=f.x*c.y-f.y*c.x},e._totalProperties=function(t){for(var u={mass:0,area:0,inertia:0,centre:{x:0,y:0}},c=t.parts.length===1?0:1;c<t.parts.length;c++){var f=t.parts[c],y=f.mass!==1/0?f.mass:1;u.mass+=y,u.area+=f.area,u.inertia+=f.inertia,u.centre=r.add(u.centre,r.mult(f.position,y))}return u.centre=r.div(u.centre,u.mass),u}})()},function(i,p,n){var e={};i.exports=e;var o=n(0);(function(){e.on=function(r,s,h){for(var l=s.split(" "),g,d=0;d<l.length;d++)g=l[d],r.events=r.events||{},r.events[g]=r.events[g]||[],r.events[g].push(h);return h},e.off=function(r,s,h){if(!s){r.events={};return}typeof s=="function"&&(h=s,s=o.keys(r.events).join(" "));for(var l=s.split(" "),g=0;g<l.length;g++){var d=r.events[l[g]],t=[];if(h&&d)for(var u=0;u<d.length;u++)d[u]!==h&&t.push(d[u]);r.events[l[g]]=t}},e.trigger=function(r,s,h){var l,g,d,t,u=r.events;if(u&&o.keys(u).length>0){h||(h={}),l=s.split(" ");for(var c=0;c<l.length;c++)if(g=l[c],d=u[g],d){t=o.clone(h,!1),t.name=g,t.source=r;for(var f=0;f<d.length;f++)d[f].apply(r,[t])}}}})()},function(i,p,n){var e={};i.exports=e;var o=n(5),r=n(0),s=n(1),h=n(4);(function(){e.create=function(l){return r.extend({id:r.nextId(),type:"composite",parent:null,isModified:!1,bodies:[],constraints:[],composites:[],label:"Composite",plugin:{},cache:{allBodies:null,allConstraints:null,allComposites:null}},l)},e.setModified=function(l,g,d,t){if(l.isModified=g,g&&l.cache&&(l.cache.allBodies=null,l.cache.allConstraints=null,l.cache.allComposites=null),d&&l.parent&&e.setModified(l.parent,g,d,t),t)for(var u=0;u<l.composites.length;u++){var c=l.composites[u];e.setModified(c,g,d,t)}},e.add=function(l,g){var d=[].concat(g);o.trigger(l,"beforeAdd",{object:g});for(var t=0;t<d.length;t++){var u=d[t];switch(u.type){case"body":if(u.parent!==u){r.warn("Composite.add: skipped adding a compound body part (you must add its parent instead)");break}e.addBody(l,u);break;case"constraint":e.addConstraint(l,u);break;case"composite":e.addComposite(l,u);break;case"mouseConstraint":e.addConstraint(l,u.constraint);break}}return o.trigger(l,"afterAdd",{object:g}),l},e.remove=function(l,g,d){var t=[].concat(g);o.trigger(l,"beforeRemove",{object:g});for(var u=0;u<t.length;u++){var c=t[u];switch(c.type){case"body":e.removeBody(l,c,d);break;case"constraint":e.removeConstraint(l,c,d);break;case"composite":e.removeComposite(l,c,d);break;case"mouseConstraint":e.removeConstraint(l,c.constraint);break}}return o.trigger(l,"afterRemove",{object:g}),l},e.addComposite=function(l,g){return l.composites.push(g),g.parent=l,e.setModified(l,!0,!0,!1),l},e.removeComposite=function(l,g,d){var t=r.indexOf(l.composites,g);if(t!==-1){var u=e.allBodies(g);e.removeCompositeAt(l,t);for(var c=0;c<u.length;c++)u[c].sleepCounter=0}if(d)for(var c=0;c<l.composites.length;c++)e.removeComposite(l.composites[c],g,!0);return l},e.removeCompositeAt=function(l,g){return l.composites.splice(g,1),e.setModified(l,!0,!0,!1),l},e.addBody=function(l,g){return l.bodies.push(g),e.setModified(l,!0,!0,!1),l},e.removeBody=function(l,g,d){var t=r.indexOf(l.bodies,g);if(t!==-1&&(e.removeBodyAt(l,t),g.sleepCounter=0),d)for(var u=0;u<l.composites.length;u++)e.removeBody(l.composites[u],g,!0);return l},e.removeBodyAt=function(l,g){return l.bodies.splice(g,1),e.setModified(l,!0,!0,!1),l},e.addConstraint=function(l,g){return l.constraints.push(g),e.setModified(l,!0,!0,!1),l},e.removeConstraint=function(l,g,d){var t=r.indexOf(l.constraints,g);if(t!==-1&&e.removeConstraintAt(l,t),d)for(var u=0;u<l.composites.length;u++)e.removeConstraint(l.composites[u],g,!0);return l},e.removeConstraintAt=function(l,g){return l.constraints.splice(g,1),e.setModified(l,!0,!0,!1),l},e.clear=function(l,g,d){if(d)for(var t=0;t<l.composites.length;t++)e.clear(l.composites[t],g,!0);return g?l.bodies=l.bodies.filter(function(u){return u.isStatic}):l.bodies.length=0,l.constraints.length=0,l.composites.length=0,e.setModified(l,!0,!0,!1),l},e.allBodies=function(l){if(l.cache&&l.cache.allBodies)return l.cache.allBodies;for(var g=[].concat(l.bodies),d=0;d<l.composites.length;d++)g=g.concat(e.allBodies(l.composites[d]));return l.cache&&(l.cache.allBodies=g),g},e.allConstraints=function(l){if(l.cache&&l.cache.allConstraints)return l.cache.allConstraints;for(var g=[].concat(l.constraints),d=0;d<l.composites.length;d++)g=g.concat(e.allConstraints(l.composites[d]));return l.cache&&(l.cache.allConstraints=g),g},e.allComposites=function(l){if(l.cache&&l.cache.allComposites)return l.cache.allComposites;for(var g=[].concat(l.composites),d=0;d<l.composites.length;d++)g=g.concat(e.allComposites(l.composites[d]));return l.cache&&(l.cache.allComposites=g),g},e.get=function(l,g,d){var t,u;switch(d){case"body":t=e.allBodies(l);break;case"constraint":t=e.allConstraints(l);break;case"composite":t=e.allComposites(l).concat(l);break}return t?(u=t.filter(function(c){return c.id.toString()===g.toString()}),u.length===0?null:u[0]):null},e.move=function(l,g,d){return e.remove(l,g),e.add(d,g),l},e.rebase=function(l){for(var g=e.allBodies(l).concat(e.allConstraints(l)).concat(e.allComposites(l)),d=0;d<g.length;d++)g[d].id=r.nextId();return l},e.translate=function(l,g,d){for(var t=d?e.allBodies(l):l.bodies,u=0;u<t.length;u++)h.translate(t[u],g);return l},e.rotate=function(l,g,d,t){for(var u=Math.cos(g),c=Math.sin(g),f=t?e.allBodies(l):l.bodies,y=0;y<f.length;y++){var S=f[y],E=S.position.x-d.x,A=S.position.y-d.y;h.setPosition(S,{x:d.x+(E*u-A*c),y:d.y+(E*c+A*u)}),h.rotate(S,g)}return l},e.scale=function(l,g,d,t,u){for(var c=u?e.allBodies(l):l.bodies,f=0;f<c.length;f++){var y=c[f],S=y.position.x-t.x,E=y.position.y-t.y;h.setPosition(y,{x:t.x+S*g,y:t.y+E*d}),h.scale(y,g,d)}return l},e.bounds=function(l){for(var g=e.allBodies(l),d=[],t=0;t<g.length;t+=1){var u=g[t];d.push(u.bounds.min,u.bounds.max)}return s.create(d)}})()},function(i,p,n){var e={};i.exports=e;var o=n(4),r=n(5),s=n(0);(function(){e._motionWakeThreshold=.18,e._motionSleepThreshold=.08,e._minBias=.9,e.update=function(h,l){for(var g=l/s._baseDelta,d=e._motionSleepThreshold,t=0;t<h.length;t++){var u=h[t],c=o.getSpeed(u),f=o.getAngularSpeed(u),y=c*c+f*f;if(u.force.x!==0||u.force.y!==0){e.set(u,!1);continue}var S=Math.min(u.motion,y),E=Math.max(u.motion,y);u.motion=e._minBias*S+(1-e._minBias)*E,u.sleepThreshold>0&&u.motion<d?(u.sleepCounter+=1,u.sleepCounter>=u.sleepThreshold/g&&e.set(u,!0)):u.sleepCounter>0&&(u.sleepCounter-=1)}},e.afterCollisions=function(h){for(var l=e._motionSleepThreshold,g=0;g<h.length;g++){var d=h[g];if(d.isActive){var t=d.collision,u=t.bodyA.parent,c=t.bodyB.parent;if(!(u.isSleeping&&c.isSleeping||u.isStatic||c.isStatic)&&(u.isSleeping||c.isSleeping)){var f=u.isSleeping&&!u.isStatic?u:c,y=f===u?c:u;!f.isStatic&&y.motion>l&&e.set(f,!1)}}}},e.set=function(h,l){var g=h.isSleeping;l?(h.isSleeping=!0,h.sleepCounter=h.sleepThreshold,h.positionImpulse.x=0,h.positionImpulse.y=0,h.positionPrev.x=h.position.x,h.positionPrev.y=h.position.y,h.anglePrev=h.angle,h.speed=0,h.angularSpeed=0,h.motion=0,g||r.trigger(h,"sleepStart")):(h.isSleeping=!1,h.sleepCounter=0,g&&r.trigger(h,"sleepEnd"))}})()},function(i,p,n){var e={};i.exports=e;var o=n(3),r=n(9);(function(){var s=[],h={overlap:0,axis:null},l={overlap:0,axis:null};e.create=function(g,d){return{pair:null,collided:!1,bodyA:g,bodyB:d,parentA:g.parent,parentB:d.parent,depth:0,normal:{x:0,y:0},tangent:{x:0,y:0},penetration:{x:0,y:0},supports:[null,null],supportCount:0}},e.collides=function(g,d,t){if(e._overlapAxes(h,g.vertices,d.vertices,g.axes),h.overlap<=0||(e._overlapAxes(l,d.vertices,g.vertices,d.axes),l.overlap<=0))return null;var u=t&&t.table[r.id(g,d)],c;u?c=u.collision:(c=e.create(g,d),c.collided=!0,c.bodyA=g.id<d.id?g:d,c.bodyB=g.id<d.id?d:g,c.parentA=c.bodyA.parent,c.parentB=c.bodyB.parent),g=c.bodyA,d=c.bodyB;var f;h.overlap<l.overlap?f=h:f=l;var y=c.normal,S=c.tangent,E=c.penetration,A=c.supports,m=f.overlap,x=f.axis,C=x.x,v=x.y,w=d.position.x-g.position.x,M=d.position.y-g.position.y;C*w+v*M>=0&&(C=-C,v=-v),y.x=C,y.y=v,S.x=-v,S.y=C,E.x=C*m,E.y=v*m,c.depth=m;var L=e._findSupports(g,d,y,1),I=0;if(o.contains(g.vertices,L[0])&&(A[I++]=L[0]),o.contains(g.vertices,L[1])&&(A[I++]=L[1]),I<2){var k=e._findSupports(d,g,y,-1);o.contains(d.vertices,k[0])&&(A[I++]=k[0]),I<2&&o.contains(d.vertices,k[1])&&(A[I++]=k[1])}return I===0&&(A[I++]=L[0]),c.supportCount=I,c},e._overlapAxes=function(g,d,t,u){var c=d.length,f=t.length,y=d[0].x,S=d[0].y,E=t[0].x,A=t[0].y,m=u.length,x=Number.MAX_VALUE,C=0,v,w,M,L,I,k;for(I=0;I<m;I++){var b=u[I],P=b.x,D=b.y,B=y*P+S*D,O=E*P+A*D,N=B,U=O;for(k=1;k<c;k+=1)L=d[k].x*P+d[k].y*D,L>N?N=L:L<B&&(B=L);for(k=1;k<f;k+=1)L=t[k].x*P+t[k].y*D,L>U?U=L:L<O&&(O=L);if(w=N-O,M=U-B,v=w<M?w:M,v<x&&(x=v,C=I,v<=0))break}g.axis=u[C],g.overlap=x},e._findSupports=function(g,d,t,u){var c=d.vertices,f=c.length,y=g.position.x,S=g.position.y,E=t.x*u,A=t.y*u,m=c[0],x=m,C=E*(y-x.x)+A*(S-x.y),v,w,M;for(M=1;M<f;M+=1)x=c[M],w=E*(y-x.x)+A*(S-x.y),w<C&&(C=w,m=x);return v=c[(f+m.index-1)%f],C=E*(y-v.x)+A*(S-v.y),x=c[(m.index+1)%f],E*(y-x.x)+A*(S-x.y)<C?(s[0]=m,s[1]=x,s):(s[0]=m,s[1]=v,s)}})()},function(i,p,n){var e={};i.exports=e;var o=n(16);(function(){e.create=function(r,s){var h=r.bodyA,l=r.bodyB,g={id:e.id(h,l),bodyA:h,bodyB:l,collision:r,contacts:[o.create(),o.create()],contactCount:0,separation:0,isActive:!0,isSensor:h.isSensor||l.isSensor,timeCreated:s,timeUpdated:s,inverseMass:0,friction:0,frictionStatic:0,restitution:0,slop:0};return e.update(g,r,s),g},e.update=function(r,s,h){var l=s.supports,g=s.supportCount,d=r.contacts,t=s.parentA,u=s.parentB;r.isActive=!0,r.timeUpdated=h,r.collision=s,r.separation=s.depth,r.inverseMass=t.inverseMass+u.inverseMass,r.friction=t.friction<u.friction?t.friction:u.friction,r.frictionStatic=t.frictionStatic>u.frictionStatic?t.frictionStatic:u.frictionStatic,r.restitution=t.restitution>u.restitution?t.restitution:u.restitution,r.slop=t.slop>u.slop?t.slop:u.slop,r.contactCount=g,s.pair=r;var c=l[0],f=d[0],y=l[1],S=d[1];(S.vertex===c||f.vertex===y)&&(d[1]=f,d[0]=f=S,S=d[1]),f.vertex=c,S.vertex=y},e.setActive=function(r,s,h){s?(r.isActive=!0,r.timeUpdated=h):(r.isActive=!1,r.contactCount=0)},e.id=function(r,s){return r.id<s.id?r.id.toString(36)+":"+s.id.toString(36):s.id.toString(36)+":"+r.id.toString(36)}})()},function(i,p,n){var e={};i.exports=e;var o=n(3),r=n(2),s=n(7),h=n(1),l=n(11),g=n(0);(function(){e._warming=.4,e._torqueDampen=1,e._minLength=1e-6,e.create=function(d){var t=d;t.bodyA&&!t.pointA&&(t.pointA={x:0,y:0}),t.bodyB&&!t.pointB&&(t.pointB={x:0,y:0});var u=t.bodyA?r.add(t.bodyA.position,t.pointA):t.pointA,c=t.bodyB?r.add(t.bodyB.position,t.pointB):t.pointB,f=r.magnitude(r.sub(u,c));t.length=typeof t.length<"u"?t.length:f,t.id=t.id||g.nextId(),t.label=t.label||"Constraint",t.type="constraint",t.stiffness=t.stiffness||(t.length>0?1:.7),t.damping=t.damping||0,t.angularStiffness=t.angularStiffness||0,t.angleA=t.bodyA?t.bodyA.angle:t.angleA,t.angleB=t.bodyB?t.bodyB.angle:t.angleB,t.plugin={};var y={visible:!0,lineWidth:2,strokeStyle:"#ffffff",type:"line",anchors:!0};return t.length===0&&t.stiffness>.1?(y.type="pin",y.anchors=!1):t.stiffness<.9&&(y.type="spring"),t.render=g.extend(y,t.render),t},e.preSolveAll=function(d){for(var t=0;t<d.length;t+=1){var u=d[t],c=u.constraintImpulse;u.isStatic||c.x===0&&c.y===0&&c.angle===0||(u.position.x+=c.x,u.position.y+=c.y,u.angle+=c.angle)}},e.solveAll=function(d,t){for(var u=g.clamp(t/g._baseDelta,0,1),c=0;c<d.length;c+=1){var f=d[c],y=!f.bodyA||f.bodyA&&f.bodyA.isStatic,S=!f.bodyB||f.bodyB&&f.bodyB.isStatic;(y||S)&&e.solve(d[c],u)}for(c=0;c<d.length;c+=1)f=d[c],y=!f.bodyA||f.bodyA&&f.bodyA.isStatic,S=!f.bodyB||f.bodyB&&f.bodyB.isStatic,!y&&!S&&e.solve(d[c],u)},e.solve=function(d,t){var u=d.bodyA,c=d.bodyB,f=d.pointA,y=d.pointB;if(!(!u&&!c)){u&&!u.isStatic&&(r.rotate(f,u.angle-d.angleA,f),d.angleA=u.angle),c&&!c.isStatic&&(r.rotate(y,c.angle-d.angleB,y),d.angleB=c.angle);var S=f,E=y;if(u&&(S=r.add(u.position,f)),c&&(E=r.add(c.position,y)),!(!S||!E)){var A=r.sub(S,E),m=r.magnitude(A);m<e._minLength&&(m=e._minLength);var x=(m-d.length)/m,C=d.stiffness>=1||d.length===0,v=C?d.stiffness*t:d.stiffness*t*t,w=d.damping*t,M=r.mult(A,x*v),L=(u?u.inverseMass:0)+(c?c.inverseMass:0),I=(u?u.inverseInertia:0)+(c?c.inverseInertia:0),k=L+I,b,P,D,B,O;if(w>0){var N=r.create();D=r.div(A,m),O=r.sub(c&&r.sub(c.position,c.positionPrev)||N,u&&r.sub(u.position,u.positionPrev)||N),B=r.dot(D,O)}u&&!u.isStatic&&(P=u.inverseMass/L,u.constraintImpulse.x-=M.x*P,u.constraintImpulse.y-=M.y*P,u.position.x-=M.x*P,u.position.y-=M.y*P,w>0&&(u.positionPrev.x-=w*D.x*B*P,u.positionPrev.y-=w*D.y*B*P),b=r.cross(f,M)/k*e._torqueDampen*u.inverseInertia*(1-d.angularStiffness),u.constraintImpulse.angle-=b,u.angle-=b),c&&!c.isStatic&&(P=c.inverseMass/L,c.constraintImpulse.x+=M.x*P,c.constraintImpulse.y+=M.y*P,c.position.x+=M.x*P,c.position.y+=M.y*P,w>0&&(c.positionPrev.x+=w*D.x*B*P,c.positionPrev.y+=w*D.y*B*P),b=r.cross(y,M)/k*e._torqueDampen*c.inverseInertia*(1-d.angularStiffness),c.constraintImpulse.angle+=b,c.angle+=b)}}},e.postSolveAll=function(d){for(var t=0;t<d.length;t++){var u=d[t],c=u.constraintImpulse;if(!(u.isStatic||c.x===0&&c.y===0&&c.angle===0)){s.set(u,!1);for(var f=0;f<u.parts.length;f++){var y=u.parts[f];o.translate(y.vertices,c),f>0&&(y.position.x+=c.x,y.position.y+=c.y),c.angle!==0&&(o.rotate(y.vertices,c.angle,u.position),l.rotate(y.axes,c.angle),f>0&&r.rotateAbout(y.position,c.angle,u.position,y.position)),h.update(y.bounds,y.vertices,u.velocity)}c.angle*=e._warming,c.x*=e._warming,c.y*=e._warming}}},e.pointAWorld=function(d){return{x:(d.bodyA?d.bodyA.position.x:0)+(d.pointA?d.pointA.x:0),y:(d.bodyA?d.bodyA.position.y:0)+(d.pointA?d.pointA.y:0)}},e.pointBWorld=function(d){return{x:(d.bodyB?d.bodyB.position.x:0)+(d.pointB?d.pointB.x:0),y:(d.bodyB?d.bodyB.position.y:0)+(d.pointB?d.pointB.y:0)}},e.currentLength=function(d){var t=(d.bodyA?d.bodyA.position.x:0)+(d.pointA?d.pointA.x:0),u=(d.bodyA?d.bodyA.position.y:0)+(d.pointA?d.pointA.y:0),c=(d.bodyB?d.bodyB.position.x:0)+(d.pointB?d.pointB.x:0),f=(d.bodyB?d.bodyB.position.y:0)+(d.pointB?d.pointB.y:0),y=t-c,S=u-f;return Math.sqrt(y*y+S*S)}})()},function(i,p,n){var e={};i.exports=e;var o=n(2),r=n(0);(function(){e.fromVertices=function(s){for(var h={},l=0;l<s.length;l++){var g=(l+1)%s.length,d=o.normalise({x:s[g].y-s[l].y,y:s[l].x-s[g].x}),t=d.y===0?1/0:d.x/d.y;t=t.toFixed(3).toString(),h[t]=d}return r.values(h)},e.rotate=function(s,h){if(h!==0)for(var l=Math.cos(h),g=Math.sin(h),d=0;d<s.length;d++){var t=s[d],u;u=t.x*l-t.y*g,t.y=t.x*g+t.y*l,t.x=u}}})()},function(i,p,n){var e={};i.exports=e;var o=n(3),r=n(0),s=n(4),h=n(1),l=n(2);(function(){e.rectangle=function(g,d,t,u,c){c=c||{};var f={label:"Rectangle Body",position:{x:g,y:d},vertices:o.fromPath("L 0 0 L "+t+" 0 L "+t+" "+u+" L 0 "+u)};if(c.chamfer){var y=c.chamfer;f.vertices=o.chamfer(f.vertices,y.radius,y.quality,y.qualityMin,y.qualityMax),delete c.chamfer}return s.create(r.extend({},f,c))},e.trapezoid=function(g,d,t,u,c,f){f=f||{},c>=1&&r.warn("Bodies.trapezoid: slope parameter must be < 1."),c*=.5;var y=(1-c*2)*t,S=t*c,E=S+y,A=E+S,m;c<.5?m="L 0 0 L "+S+" "+-u+" L "+E+" "+-u+" L "+A+" 0":m="L 0 0 L "+E+" "+-u+" L "+A+" 0";var x={label:"Trapezoid Body",position:{x:g,y:d},vertices:o.fromPath(m)};if(f.chamfer){var C=f.chamfer;x.vertices=o.chamfer(x.vertices,C.radius,C.quality,C.qualityMin,C.qualityMax),delete f.chamfer}return s.create(r.extend({},x,f))},e.circle=function(g,d,t,u,c){u=u||{};var f={label:"Circle Body",circleRadius:t};c=c||25;var y=Math.ceil(Math.max(10,Math.min(c,t)));return y%2===1&&(y+=1),e.polygon(g,d,y,t,r.extend({},f,u))},e.polygon=function(g,d,t,u,c){if(c=c||{},t<3)return e.circle(g,d,u,c);for(var f=2*Math.PI/t,y="",S=f*.5,E=0;E<t;E+=1){var A=S+E*f,m=Math.cos(A)*u,x=Math.sin(A)*u;y+="L "+m.toFixed(3)+" "+x.toFixed(3)+" "}var C={label:"Polygon Body",position:{x:g,y:d},vertices:o.fromPath(y)};if(c.chamfer){var v=c.chamfer;C.vertices=o.chamfer(C.vertices,v.radius,v.quality,v.qualityMin,v.qualityMax),delete c.chamfer}return s.create(r.extend({},C,c))},e.fromVertices=function(g,d,t,u,c,f,y,S){var E=r.getDecomp(),A,m,x,C,v,w,M,L,I,k,b;for(A=!!(E&&E.quickDecomp),u=u||{},x=[],c=typeof c<"u"?c:!1,f=typeof f<"u"?f:.01,y=typeof y<"u"?y:10,S=typeof S<"u"?S:.01,r.isArray(t[0])||(t=[t]),k=0;k<t.length;k+=1)if(w=t[k],C=o.isConvex(w),v=!C,v&&!A&&r.warnOnce("Bodies.fromVertices: Install the 'poly-decomp' library and use Common.setDecomp or provide 'decomp' as a global to decompose concave vertices."),C||!A)C?w=o.clockwiseSort(w):w=o.hull(w),x.push({position:{x:g,y:d},vertices:w});else{var P=w.map(function(z){return[z.x,z.y]});E.makeCCW(P),f!==!1&&E.removeCollinearPoints(P,f),S!==!1&&E.removeDuplicatePoints&&E.removeDuplicatePoints(P,S);var D=E.quickDecomp(P);for(M=0;M<D.length;M++){var B=D[M],O=B.map(function(z){return{x:z[0],y:z[1]}});y>0&&o.area(O)<y||x.push({position:o.centre(O),vertices:O})}}for(M=0;M<x.length;M++)x[M]=s.create(r.extend(x[M],u));if(c){var N=5;for(M=0;M<x.length;M++){var U=x[M];for(L=M+1;L<x.length;L++){var V=x[L];if(h.overlaps(U.bounds,V.bounds)){var W=U.vertices,Q=V.vertices;for(I=0;I<U.vertices.length;I++)for(b=0;b<V.vertices.length;b++){var J=l.magnitudeSquared(l.sub(W[(I+1)%W.length],Q[b])),q=l.magnitudeSquared(l.sub(W[I],Q[(b+1)%Q.length]));J<N&&q<N&&(W[I].isInternal=!0,Q[b].isInternal=!0)}}}}}return x.length>1?(m=s.create(r.extend({parts:x.slice(0)},u)),s.setPosition(m,{x:g,y:d}),m):x[0]}})()},function(i,p,n){var e={};i.exports=e;var o=n(0),r=n(8);(function(){e.create=function(s){var h={bodies:[],collisions:[],pairs:null};return o.extend(h,s)},e.setBodies=function(s,h){s.bodies=h.slice(0)},e.clear=function(s){s.bodies=[],s.collisions=[]},e.collisions=function(s){var h=s.pairs,l=s.bodies,g=l.length,d=e.canCollide,t=r.collides,u=s.collisions,c=0,f,y;for(l.sort(e._compareBoundsX),f=0;f<g;f++){var S=l[f],E=S.bounds,A=S.bounds.max.x,m=S.bounds.max.y,x=S.bounds.min.y,C=S.isStatic||S.isSleeping,v=S.parts.length,w=v===1;for(y=f+1;y<g;y++){var M=l[y],L=M.bounds;if(L.min.x>A)break;if(!(m<L.min.y||x>L.max.y)&&!(C&&(M.isStatic||M.isSleeping))&&d(S.collisionFilter,M.collisionFilter)){var I=M.parts.length;if(w&&I===1){var k=t(S,M,h);k&&(u[c++]=k)}else for(var b=v>1?1:0,P=I>1?1:0,D=b;D<v;D++)for(var B=S.parts[D],E=B.bounds,O=P;O<I;O++){var N=M.parts[O],L=N.bounds;if(!(E.min.x>L.max.x||E.max.x<L.min.x||E.max.y<L.min.y||E.min.y>L.max.y)){var k=t(B,N,h);k&&(u[c++]=k)}}}}}return u.length!==c&&(u.length=c),u},e.canCollide=function(s,h){return s.group===h.group&&s.group!==0?s.group>0:(s.mask&h.category)!==0&&(h.mask&s.category)!==0},e._compareBoundsX=function(s,h){return s.bounds.min.x-h.bounds.min.x}})()},function(i,p,n){var e={};i.exports=e;var o=n(0);(function(){e.create=function(r){var s={};return r||o.log("Mouse.create: element was undefined, defaulting to document.body","warn"),s.element=r||document.body,s.absolute={x:0,y:0},s.position={x:0,y:0},s.mousedownPosition={x:0,y:0},s.mouseupPosition={x:0,y:0},s.offset={x:0,y:0},s.scale={x:1,y:1},s.wheelDelta=0,s.button=-1,s.pixelRatio=parseInt(s.element.getAttribute("data-pixel-ratio"),10)||1,s.sourceEvents={mousemove:null,mousedown:null,mouseup:null,mousewheel:null},s.mousemove=function(h){var l=e._getRelativeMousePosition(h,s.element,s.pixelRatio),g=h.changedTouches;g&&(s.button=0,h.preventDefault()),s.absolute.x=l.x,s.absolute.y=l.y,s.position.x=s.absolute.x*s.scale.x+s.offset.x,s.position.y=s.absolute.y*s.scale.y+s.offset.y,s.sourceEvents.mousemove=h},s.mousedown=function(h){var l=e._getRelativeMousePosition(h,s.element,s.pixelRatio),g=h.changedTouches;g?(s.button=0,h.preventDefault()):s.button=h.button,s.absolute.x=l.x,s.absolute.y=l.y,s.position.x=s.absolute.x*s.scale.x+s.offset.x,s.position.y=s.absolute.y*s.scale.y+s.offset.y,s.mousedownPosition.x=s.position.x,s.mousedownPosition.y=s.position.y,s.sourceEvents.mousedown=h},s.mouseup=function(h){var l=e._getRelativeMousePosition(h,s.element,s.pixelRatio),g=h.changedTouches;g&&h.preventDefault(),s.button=-1,s.absolute.x=l.x,s.absolute.y=l.y,s.position.x=s.absolute.x*s.scale.x+s.offset.x,s.position.y=s.absolute.y*s.scale.y+s.offset.y,s.mouseupPosition.x=s.position.x,s.mouseupPosition.y=s.position.y,s.sourceEvents.mouseup=h},s.mousewheel=function(h){s.wheelDelta=Math.max(-1,Math.min(1,h.wheelDelta||-h.detail)),h.preventDefault(),s.sourceEvents.mousewheel=h},e.setElement(s,s.element),s},e.setElement=function(r,s){r.element=s,s.addEventListener("mousemove",r.mousemove,{passive:!0}),s.addEventListener("mousedown",r.mousedown,{passive:!0}),s.addEventListener("mouseup",r.mouseup,{passive:!0}),s.addEventListener("wheel",r.mousewheel,{passive:!1}),s.addEventListener("touchmove",r.mousemove,{passive:!1}),s.addEventListener("touchstart",r.mousedown,{passive:!1}),s.addEventListener("touchend",r.mouseup,{passive:!1})},e.clearSourceEvents=function(r){r.sourceEvents.mousemove=null,r.sourceEvents.mousedown=null,r.sourceEvents.mouseup=null,r.sourceEvents.mousewheel=null,r.wheelDelta=0},e.setOffset=function(r,s){r.offset.x=s.x,r.offset.y=s.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e.setScale=function(r,s){r.scale.x=s.x,r.scale.y=s.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e._getRelativeMousePosition=function(r,s,h){var l=s.getBoundingClientRect(),g=document.documentElement||document.body.parentNode||document.body,d=window.pageXOffset!==void 0?window.pageXOffset:g.scrollLeft,t=window.pageYOffset!==void 0?window.pageYOffset:g.scrollTop,u=r.changedTouches,c,f;return u?(c=u[0].pageX-l.left-d,f=u[0].pageY-l.top-t):(c=r.pageX-l.left-d,f=r.pageY-l.top-t),{x:c/(s.clientWidth/(s.width||s.clientWidth)*h),y:f/(s.clientHeight/(s.height||s.clientHeight)*h)}}})()},function(i,p,n){var e={};i.exports=e;var o=n(0);(function(){e._registry={},e.register=function(r){if(e.isPlugin(r)||o.warn("Plugin.register:",e.toString(r),"does not implement all required fields."),r.name in e._registry){var s=e._registry[r.name],h=e.versionParse(r.version).number,l=e.versionParse(s.version).number;h>l?(o.warn("Plugin.register:",e.toString(s),"was upgraded to",e.toString(r)),e._registry[r.name]=r):h<l?o.warn("Plugin.register:",e.toString(s),"can not be downgraded to",e.toString(r)):r!==s&&o.warn("Plugin.register:",e.toString(r),"is already registered to different plugin object")}else e._registry[r.name]=r;return r},e.resolve=function(r){return e._registry[e.dependencyParse(r).name]},e.toString=function(r){return typeof r=="string"?r:(r.name||"anonymous")+"@"+(r.version||r.range||"0.0.0")},e.isPlugin=function(r){return r&&r.name&&r.version&&r.install},e.isUsed=function(r,s){return r.used.indexOf(s)>-1},e.isFor=function(r,s){var h=r.for&&e.dependencyParse(r.for);return!r.for||s.name===h.name&&e.versionSatisfies(s.version,h.range)},e.use=function(r,s){if(r.uses=(r.uses||[]).concat(s||[]),r.uses.length===0){o.warn("Plugin.use:",e.toString(r),"does not specify any dependencies to install.");return}for(var h=e.dependencies(r),l=o.topologicalSort(h),g=[],d=0;d<l.length;d+=1)if(l[d]!==r.name){var t=e.resolve(l[d]);if(!t){g.push("❌ "+l[d]);continue}e.isUsed(r,t.name)||(e.isFor(t,r)||(o.warn("Plugin.use:",e.toString(t),"is for",t.for,"but installed on",e.toString(r)+"."),t._warned=!0),t.install?t.install(r):(o.warn("Plugin.use:",e.toString(t),"does not specify an install function."),t._warned=!0),t._warned?(g.push("🔶 "+e.toString(t)),delete t._warned):g.push("✅ "+e.toString(t)),r.used.push(t.name))}g.length>0&&o.info(g.join("  "))},e.dependencies=function(r,s){var h=e.dependencyParse(r),l=h.name;if(s=s||{},!(l in s)){r=e.resolve(r)||r,s[l]=o.map(r.uses||[],function(d){e.isPlugin(d)&&e.register(d);var t=e.dependencyParse(d),u=e.resolve(d);return u&&!e.versionSatisfies(u.version,t.range)?(o.warn("Plugin.dependencies:",e.toString(u),"does not satisfy",e.toString(t),"used by",e.toString(h)+"."),u._warned=!0,r._warned=!0):u||(o.warn("Plugin.dependencies:",e.toString(d),"used by",e.toString(h),"could not be resolved."),r._warned=!0),t.name});for(var g=0;g<s[l].length;g+=1)e.dependencies(s[l][g],s);return s}},e.dependencyParse=function(r){if(o.isString(r)){var s=/^[\w-]+(@(\*|[\^~]?\d+\.\d+\.\d+(-[0-9A-Za-z-+]+)?))?$/;return s.test(r)||o.warn("Plugin.dependencyParse:",r,"is not a valid dependency string."),{name:r.split("@")[0],range:r.split("@")[1]||"*"}}return{name:r.name,range:r.range||r.version}},e.versionParse=function(r){var s=/^(\*)|(\^|~|>=|>)?\s*((\d+)\.(\d+)\.(\d+))(-[0-9A-Za-z-+]+)?$/;s.test(r)||o.warn("Plugin.versionParse:",r,"is not a valid version or range.");var h=s.exec(r),l=Number(h[4]),g=Number(h[5]),d=Number(h[6]);return{isRange:!!(h[1]||h[2]),version:h[3],range:r,operator:h[1]||h[2]||"",major:l,minor:g,patch:d,parts:[l,g,d],prerelease:h[7],number:l*1e8+g*1e4+d}},e.versionSatisfies=function(r,s){s=s||"*";var h=e.versionParse(s),l=e.versionParse(r);if(h.isRange){if(h.operator==="*"||r==="*")return!0;if(h.operator===">")return l.number>h.number;if(h.operator===">=")return l.number>=h.number;if(h.operator==="~")return l.major===h.major&&l.minor===h.minor&&l.patch>=h.patch;if(h.operator==="^")return h.major>0?l.major===h.major&&l.number>=h.number:h.minor>0?l.minor===h.minor&&l.patch>=h.patch:l.patch===h.patch}return r===s||r==="*"}})()},function(i,p){var n={};i.exports=n,function(){n.create=function(e){return{vertex:e,normalImpulse:0,tangentImpulse:0}}}()},function(i,p,n){var e={};i.exports=e;var o=n(7),r=n(18),s=n(13),h=n(19),l=n(5),g=n(6),d=n(10),t=n(0),u=n(4);(function(){e._deltaMax=1e3/60,e.create=function(c){c=c||{};var f={positionIterations:6,velocityIterations:4,constraintIterations:2,enableSleeping:!1,events:[],plugin:{},gravity:{x:0,y:1,scale:.001},timing:{timestamp:0,timeScale:1,lastDelta:0,lastElapsed:0,lastUpdatesPerFrame:0}},y=t.extend(f,c);return y.world=c.world||g.create({label:"World"}),y.pairs=c.pairs||h.create(),y.detector=c.detector||s.create(),y.detector.pairs=y.pairs,y.grid={buckets:[]},y.world.gravity=y.gravity,y.broadphase=y.grid,y.metrics={},y},e.update=function(c,f){var y=t.now(),S=c.world,E=c.detector,A=c.pairs,m=c.timing,x=m.timestamp,C;f>e._deltaMax&&t.warnOnce("Matter.Engine.update: delta argument is recommended to be less than or equal to",e._deltaMax.toFixed(3),"ms."),f=typeof f<"u"?f:t._baseDelta,f*=m.timeScale,m.timestamp+=f,m.lastDelta=f;var v={timestamp:m.timestamp,delta:f};l.trigger(c,"beforeUpdate",v);var w=g.allBodies(S),M=g.allConstraints(S);for(S.isModified&&(s.setBodies(E,w),g.setModified(S,!1,!1,!0)),c.enableSleeping&&o.update(w,f),e._bodiesApplyGravity(w,c.gravity),f>0&&e._bodiesUpdate(w,f),l.trigger(c,"beforeSolve",v),d.preSolveAll(w),C=0;C<c.constraintIterations;C++)d.solveAll(M,f);d.postSolveAll(w);var L=s.collisions(E);h.update(A,L,x),c.enableSleeping&&o.afterCollisions(A.list),A.collisionStart.length>0&&l.trigger(c,"collisionStart",{pairs:A.collisionStart,timestamp:m.timestamp,delta:f});var I=t.clamp(20/c.positionIterations,0,1);for(r.preSolvePosition(A.list),C=0;C<c.positionIterations;C++)r.solvePosition(A.list,f,I);for(r.postSolvePosition(w),d.preSolveAll(w),C=0;C<c.constraintIterations;C++)d.solveAll(M,f);for(d.postSolveAll(w),r.preSolveVelocity(A.list),C=0;C<c.velocityIterations;C++)r.solveVelocity(A.list,f);return e._bodiesUpdateVelocities(w),A.collisionActive.length>0&&l.trigger(c,"collisionActive",{pairs:A.collisionActive,timestamp:m.timestamp,delta:f}),A.collisionEnd.length>0&&l.trigger(c,"collisionEnd",{pairs:A.collisionEnd,timestamp:m.timestamp,delta:f}),e._bodiesClearForces(w),l.trigger(c,"afterUpdate",v),c.timing.lastElapsed=t.now()-y,c},e.merge=function(c,f){if(t.extend(c,f),f.world){c.world=f.world,e.clear(c);for(var y=g.allBodies(c.world),S=0;S<y.length;S++){var E=y[S];o.set(E,!1),E.id=t.nextId()}}},e.clear=function(c){h.clear(c.pairs),s.clear(c.detector)},e._bodiesClearForces=function(c){for(var f=c.length,y=0;y<f;y++){var S=c[y];S.force.x=0,S.force.y=0,S.torque=0}},e._bodiesApplyGravity=function(c,f){var y=typeof f.scale<"u"?f.scale:.001,S=c.length;if(!(f.x===0&&f.y===0||y===0))for(var E=0;E<S;E++){var A=c[E];A.isStatic||A.isSleeping||(A.force.y+=A.mass*f.y*y,A.force.x+=A.mass*f.x*y)}},e._bodiesUpdate=function(c,f){for(var y=c.length,S=0;S<y;S++){var E=c[S];E.isStatic||E.isSleeping||u.update(E,f)}},e._bodiesUpdateVelocities=function(c){for(var f=c.length,y=0;y<f;y++)u.updateVelocities(c[y])}})()},function(i,p,n){var e={};i.exports=e;var o=n(3),r=n(0),s=n(1);(function(){e._restingThresh=2,e._restingThreshTangent=Math.sqrt(6),e._positionDampen=.9,e._positionWarming=.8,e._frictionNormalMultiplier=5,e._frictionMaxStatic=Number.MAX_VALUE,e.preSolvePosition=function(h){var l,g,d,t=h.length;for(l=0;l<t;l++)g=h[l],g.isActive&&(d=g.contactCount,g.collision.parentA.totalContacts+=d,g.collision.parentB.totalContacts+=d)},e.solvePosition=function(h,l,g){var d,t,u,c,f,y,S,E,A=e._positionDampen*(g||1),m=r.clamp(l/r._baseDelta,0,1),x=h.length;for(d=0;d<x;d++)t=h[d],!(!t.isActive||t.isSensor)&&(u=t.collision,c=u.parentA,f=u.parentB,y=u.normal,t.separation=u.depth+y.x*(f.positionImpulse.x-c.positionImpulse.x)+y.y*(f.positionImpulse.y-c.positionImpulse.y));for(d=0;d<x;d++)t=h[d],!(!t.isActive||t.isSensor)&&(u=t.collision,c=u.parentA,f=u.parentB,y=u.normal,E=t.separation-t.slop*m,(c.isStatic||f.isStatic)&&(E*=2),c.isStatic||c.isSleeping||(S=A/c.totalContacts,c.positionImpulse.x+=y.x*E*S,c.positionImpulse.y+=y.y*E*S),f.isStatic||f.isSleeping||(S=A/f.totalContacts,f.positionImpulse.x-=y.x*E*S,f.positionImpulse.y-=y.y*E*S))},e.postSolvePosition=function(h){for(var l=e._positionWarming,g=h.length,d=o.translate,t=s.update,u=0;u<g;u++){var c=h[u],f=c.positionImpulse,y=f.x,S=f.y,E=c.velocity;if(c.totalContacts=0,y!==0||S!==0){for(var A=0;A<c.parts.length;A++){var m=c.parts[A];d(m.vertices,f),t(m.bounds,m.vertices,E),m.position.x+=y,m.position.y+=S}c.positionPrev.x+=y,c.positionPrev.y+=S,y*E.x+S*E.y<0?(f.x=0,f.y=0):(f.x*=l,f.y*=l)}}},e.preSolveVelocity=function(h){var l=h.length,g,d;for(g=0;g<l;g++){var t=h[g];if(!(!t.isActive||t.isSensor)){var u=t.contacts,c=t.contactCount,f=t.collision,y=f.parentA,S=f.parentB,E=f.normal,A=f.tangent;for(d=0;d<c;d++){var m=u[d],x=m.vertex,C=m.normalImpulse,v=m.tangentImpulse;if(C!==0||v!==0){var w=E.x*C+A.x*v,M=E.y*C+A.y*v;y.isStatic||y.isSleeping||(y.positionPrev.x+=w*y.inverseMass,y.positionPrev.y+=M*y.inverseMass,y.anglePrev+=y.inverseInertia*((x.x-y.position.x)*M-(x.y-y.position.y)*w)),S.isStatic||S.isSleeping||(S.positionPrev.x-=w*S.inverseMass,S.positionPrev.y-=M*S.inverseMass,S.anglePrev-=S.inverseInertia*((x.x-S.position.x)*M-(x.y-S.position.y)*w))}}}}},e.solveVelocity=function(h,l){var g=l/r._baseDelta,d=g*g,t=d*g,u=-e._restingThresh*g,c=e._restingThreshTangent,f=e._frictionNormalMultiplier*g,y=e._frictionMaxStatic,S=h.length,E,A,m,x;for(m=0;m<S;m++){var C=h[m];if(!(!C.isActive||C.isSensor)){var v=C.collision,w=v.parentA,M=v.parentB,L=v.normal.x,I=v.normal.y,k=v.tangent.x,b=v.tangent.y,P=C.inverseMass,D=C.friction*C.frictionStatic*f,B=C.contacts,O=C.contactCount,N=1/O,U=w.position.x-w.positionPrev.x,V=w.position.y-w.positionPrev.y,W=w.angle-w.anglePrev,Q=M.position.x-M.positionPrev.x,J=M.position.y-M.positionPrev.y,q=M.angle-M.anglePrev;for(x=0;x<O;x++){var z=B[x],K=z.vertex,H=K.x-w.position.x,_=K.y-w.position.y,Y=K.x-M.position.x,X=K.y-M.position.y,G=U-_*W,Re=V+H*W,Oe=Q-X*q,Ne=J+Y*q,ge=G-Oe,pe=Re-Ne,le=L*ge+I*pe,Z=k*ge+b*pe,me=C.separation+le,ce=Math.min(me,1);ce=me<0?0:ce;var ve=ce*D;Z<-ve||Z>ve?(A=Z>0?Z:-Z,E=C.friction*(Z>0?1:-1)*t,E<-A?E=-A:E>A&&(E=A)):(E=Z,A=y);var ye=H*I-_*L,xe=Y*I-X*L,Ce=N/(P+w.inverseInertia*ye*ye+M.inverseInertia*xe*xe),ee=(1+C.restitution)*le*Ce;if(E*=Ce,le<u)z.normalImpulse=0;else{var ze=z.normalImpulse;z.normalImpulse+=ee,z.normalImpulse>0&&(z.normalImpulse=0),ee=z.normalImpulse-ze}if(Z<-c||Z>c)z.tangentImpulse=0;else{var Ue=z.tangentImpulse;z.tangentImpulse+=E,z.tangentImpulse<-A&&(z.tangentImpulse=-A),z.tangentImpulse>A&&(z.tangentImpulse=A),E=z.tangentImpulse-Ue}var te=L*ee+k*E,ne=I*ee+b*E;w.isStatic||w.isSleeping||(w.positionPrev.x+=te*w.inverseMass,w.positionPrev.y+=ne*w.inverseMass,w.anglePrev+=(H*ne-_*te)*w.inverseInertia),M.isStatic||M.isSleeping||(M.positionPrev.x-=te*M.inverseMass,M.positionPrev.y-=ne*M.inverseMass,M.anglePrev-=(Y*ne-X*te)*M.inverseInertia)}}}}})()},function(i,p,n){var e={};i.exports=e;var o=n(9),r=n(0);(function(){e.create=function(s){return r.extend({table:{},list:[],collisionStart:[],collisionActive:[],collisionEnd:[]},s)},e.update=function(s,h,l){var g=o.update,d=o.create,t=o.setActive,u=s.table,c=s.list,f=c.length,y=f,S=s.collisionStart,E=s.collisionEnd,A=s.collisionActive,m=h.length,x=0,C=0,v=0,w,M,L;for(L=0;L<m;L++)w=h[L],M=w.pair,M?(M.isActive&&(A[v++]=M),g(M,w,l)):(M=d(w,l),u[M.id]=M,S[x++]=M,c[y++]=M);for(y=0,f=c.length,L=0;L<f;L++)M=c[L],M.timeUpdated>=l?c[y++]=M:(t(M,!1,l),M.collision.bodyA.sleepCounter>0&&M.collision.bodyB.sleepCounter>0?c[y++]=M:(E[C++]=M,delete u[M.id]));c.length!==y&&(c.length=y),S.length!==x&&(S.length=x),E.length!==C&&(E.length=C),A.length!==v&&(A.length=v)},e.clear=function(s){return s.table={},s.list.length=0,s.collisionStart.length=0,s.collisionActive.length=0,s.collisionEnd.length=0,s}})()},function(i,p,n){var e=i.exports=n(21);e.Axes=n(11),e.Bodies=n(12),e.Body=n(4),e.Bounds=n(1),e.Collision=n(8),e.Common=n(0),e.Composite=n(6),e.Composites=n(22),e.Constraint=n(10),e.Contact=n(16),e.Detector=n(13),e.Engine=n(17),e.Events=n(5),e.Grid=n(23),e.Mouse=n(14),e.MouseConstraint=n(24),e.Pair=n(9),e.Pairs=n(19),e.Plugin=n(15),e.Query=n(25),e.Render=n(26),e.Resolver=n(18),e.Runner=n(27),e.SAT=n(28),e.Sleeping=n(7),e.Svg=n(29),e.Vector=n(2),e.Vertices=n(3),e.World=n(30),e.Engine.run=e.Runner.run,e.Common.deprecated(e.Engine,"run","Engine.run ➤ use Matter.Runner.run(engine) instead")},function(i,p,n){var e={};i.exports=e;var o=n(15),r=n(0);(function(){e.name="matter-js",e.version="0.20.0",e.uses=[],e.used=[],e.use=function(){o.use(e,Array.prototype.slice.call(arguments))},e.before=function(s,h){return s=s.replace(/^Matter./,""),r.chainPathBefore(e,s,h)},e.after=function(s,h){return s=s.replace(/^Matter./,""),r.chainPathAfter(e,s,h)}})()},function(i,p,n){var e={};i.exports=e;var o=n(6),r=n(10),s=n(0),h=n(4),l=n(12),g=s.deprecated;(function(){e.stack=function(d,t,u,c,f,y,S){for(var E=o.create({label:"Stack"}),A=d,m=t,x,C=0,v=0;v<c;v++){for(var w=0,M=0;M<u;M++){var L=S(A,m,M,v,x,C);if(L){var I=L.bounds.max.y-L.bounds.min.y,k=L.bounds.max.x-L.bounds.min.x;I>w&&(w=I),h.translate(L,{x:k*.5,y:I*.5}),A=L.bounds.max.x+f,o.addBody(E,L),x=L,C+=1}else A+=f}m+=w+y,A=d}return E},e.chain=function(d,t,u,c,f,y){for(var S=d.bodies,E=1;E<S.length;E++){var A=S[E-1],m=S[E],x=A.bounds.max.y-A.bounds.min.y,C=A.bounds.max.x-A.bounds.min.x,v=m.bounds.max.y-m.bounds.min.y,w=m.bounds.max.x-m.bounds.min.x,M={bodyA:A,pointA:{x:C*t,y:x*u},bodyB:m,pointB:{x:w*c,y:v*f}},L=s.extend(M,y);o.addConstraint(d,r.create(L))}return d.label+=" Chain",d},e.mesh=function(d,t,u,c,f){var y=d.bodies,S,E,A,m,x;for(S=0;S<u;S++){for(E=1;E<t;E++)A=y[E-1+S*t],m=y[E+S*t],o.addConstraint(d,r.create(s.extend({bodyA:A,bodyB:m},f)));if(S>0)for(E=0;E<t;E++)A=y[E+(S-1)*t],m=y[E+S*t],o.addConstraint(d,r.create(s.extend({bodyA:A,bodyB:m},f))),c&&E>0&&(x=y[E-1+(S-1)*t],o.addConstraint(d,r.create(s.extend({bodyA:x,bodyB:m},f)))),c&&E<t-1&&(x=y[E+1+(S-1)*t],o.addConstraint(d,r.create(s.extend({bodyA:x,bodyB:m},f))))}return d.label+=" Mesh",d},e.pyramid=function(d,t,u,c,f,y,S){return e.stack(d,t,u,c,f,y,function(E,A,m,x,C,v){var w=Math.min(c,Math.ceil(u/2)),M=C?C.bounds.max.x-C.bounds.min.x:0;if(!(x>w)){x=w-x;var L=x,I=u-1-x;if(!(m<L||m>I)){v===1&&h.translate(C,{x:(m+(u%2===1?1:-1))*M,y:0});var k=C?m*M:0;return S(d+k+m*f,A,m,x,C,v)}}})},e.newtonsCradle=function(d,t,u,c,f){for(var y=o.create({label:"Newtons Cradle"}),S=0;S<u;S++){var E=1.9,A=l.circle(d+S*(c*E),t+f,c,{inertia:1/0,restitution:1,friction:0,frictionAir:1e-4,slop:1}),m=r.create({pointA:{x:d+S*(c*E),y:t},bodyB:A});o.addBody(y,A),o.addConstraint(y,m)}return y},g(e,"newtonsCradle","Composites.newtonsCradle ➤ moved to newtonsCradle example"),e.car=function(d,t,u,c,f){var y=h.nextGroup(!0),S=20,E=-u*.5+S,A=u*.5-S,m=0,x=o.create({label:"Car"}),C=l.rectangle(d,t,u,c,{collisionFilter:{group:y},chamfer:{radius:c*.5},density:2e-4}),v=l.circle(d+E,t+m,f,{collisionFilter:{group:y},friction:.8}),w=l.circle(d+A,t+m,f,{collisionFilter:{group:y},friction:.8}),M=r.create({bodyB:C,pointB:{x:E,y:m},bodyA:v,stiffness:1,length:0}),L=r.create({bodyB:C,pointB:{x:A,y:m},bodyA:w,stiffness:1,length:0});return o.addBody(x,C),o.addBody(x,v),o.addBody(x,w),o.addConstraint(x,M),o.addConstraint(x,L),x},g(e,"car","Composites.car ➤ moved to car example"),e.softBody=function(d,t,u,c,f,y,S,E,A,m){A=s.extend({inertia:1/0},A),m=s.extend({stiffness:.2,render:{type:"line",anchors:!1}},m);var x=e.stack(d,t,u,c,f,y,function(C,v){return l.circle(C,v,E,A)});return e.mesh(x,u,c,S,m),x.label="Soft Body",x},g(e,"softBody","Composites.softBody ➤ moved to softBody and cloth examples")})()},function(i,p,n){var e={};i.exports=e;var o=n(9),r=n(0),s=r.deprecated;(function(){e.create=function(h){var l={buckets:{},pairs:{},pairsList:[],bucketWidth:48,bucketHeight:48};return r.extend(l,h)},e.update=function(h,l,g,d){var t,u,c,f=g.world,y=h.buckets,S,E,A=!1;for(t=0;t<l.length;t++){var m=l[t];if(!(m.isSleeping&&!d)&&!(f.bounds&&(m.bounds.max.x<f.bounds.min.x||m.bounds.min.x>f.bounds.max.x||m.bounds.max.y<f.bounds.min.y||m.bounds.min.y>f.bounds.max.y))){var x=e._getRegion(h,m);if(!m.region||x.id!==m.region.id||d){(!m.region||d)&&(m.region=x);var C=e._regionUnion(x,m.region);for(u=C.startCol;u<=C.endCol;u++)for(c=C.startRow;c<=C.endRow;c++){E=e._getBucketId(u,c),S=y[E];var v=u>=x.startCol&&u<=x.endCol&&c>=x.startRow&&c<=x.endRow,w=u>=m.region.startCol&&u<=m.region.endCol&&c>=m.region.startRow&&c<=m.region.endRow;!v&&w&&w&&S&&e._bucketRemoveBody(h,S,m),(m.region===x||v&&!w||d)&&(S||(S=e._createBucket(y,E)),e._bucketAddBody(h,S,m))}m.region=x,A=!0}}}A&&(h.pairsList=e._createActivePairsList(h))},s(e,"update","Grid.update ➤ replaced by Matter.Detector"),e.clear=function(h){h.buckets={},h.pairs={},h.pairsList=[]},s(e,"clear","Grid.clear ➤ replaced by Matter.Detector"),e._regionUnion=function(h,l){var g=Math.min(h.startCol,l.startCol),d=Math.max(h.endCol,l.endCol),t=Math.min(h.startRow,l.startRow),u=Math.max(h.endRow,l.endRow);return e._createRegion(g,d,t,u)},e._getRegion=function(h,l){var g=l.bounds,d=Math.floor(g.min.x/h.bucketWidth),t=Math.floor(g.max.x/h.bucketWidth),u=Math.floor(g.min.y/h.bucketHeight),c=Math.floor(g.max.y/h.bucketHeight);return e._createRegion(d,t,u,c)},e._createRegion=function(h,l,g,d){return{id:h+","+l+","+g+","+d,startCol:h,endCol:l,startRow:g,endRow:d}},e._getBucketId=function(h,l){return"C"+h+"R"+l},e._createBucket=function(h,l){var g=h[l]=[];return g},e._bucketAddBody=function(h,l,g){var d=h.pairs,t=o.id,u=l.length,c;for(c=0;c<u;c++){var f=l[c];if(!(g.id===f.id||g.isStatic&&f.isStatic)){var y=t(g,f),S=d[y];S?S[2]+=1:d[y]=[g,f,1]}}l.push(g)},e._bucketRemoveBody=function(h,l,g){var d=h.pairs,t=o.id,u;l.splice(r.indexOf(l,g),1);var c=l.length;for(u=0;u<c;u++){var f=d[t(g,l[u])];f&&(f[2]-=1)}},e._createActivePairsList=function(h){var l,g=h.pairs,d=r.keys(g),t=d.length,u=[],c;for(c=0;c<t;c++)l=g[d[c]],l[2]>0?u.push(l):delete g[d[c]];return u}})()},function(i,p,n){var e={};i.exports=e;var o=n(3),r=n(7),s=n(14),h=n(5),l=n(13),g=n(10),d=n(6),t=n(0),u=n(1);(function(){e.create=function(c,f){var y=(c?c.mouse:null)||(f?f.mouse:null);y||(c&&c.render&&c.render.canvas?y=s.create(c.render.canvas):f&&f.element?y=s.create(f.element):(y=s.create(),t.warn("MouseConstraint.create: options.mouse was undefined, options.element was undefined, may not function as expected")));var S=g.create({label:"Mouse Constraint",pointA:y.position,pointB:{x:0,y:0},length:.01,stiffness:.1,angularStiffness:1,render:{strokeStyle:"#90EE90",lineWidth:3}}),E={type:"mouseConstraint",mouse:y,element:null,body:null,constraint:S,collisionFilter:{category:1,mask:4294967295,group:0}},A=t.extend(E,f);return h.on(c,"beforeUpdate",function(){var m=d.allBodies(c.world);e.update(A,m),e._triggerEvents(A)}),A},e.update=function(c,f){var y=c.mouse,S=c.constraint,E=c.body;if(y.button===0){if(S.bodyB)r.set(S.bodyB,!1),S.pointA=y.position;else for(var A=0;A<f.length;A++)if(E=f[A],u.contains(E.bounds,y.position)&&l.canCollide(E.collisionFilter,c.collisionFilter))for(var m=E.parts.length>1?1:0;m<E.parts.length;m++){var x=E.parts[m];if(o.contains(x.vertices,y.position)){S.pointA=y.position,S.bodyB=c.body=E,S.pointB={x:y.position.x-E.position.x,y:y.position.y-E.position.y},S.angleB=E.angle,r.set(E,!1),h.trigger(c,"startdrag",{mouse:y,body:E});break}}}else S.bodyB=c.body=null,S.pointB=null,E&&h.trigger(c,"enddrag",{mouse:y,body:E})},e._triggerEvents=function(c){var f=c.mouse,y=f.sourceEvents;y.mousemove&&h.trigger(c,"mousemove",{mouse:f}),y.mousedown&&h.trigger(c,"mousedown",{mouse:f}),y.mouseup&&h.trigger(c,"mouseup",{mouse:f}),s.clearSourceEvents(f)}})()},function(i,p,n){var e={};i.exports=e;var o=n(2),r=n(8),s=n(1),h=n(12),l=n(3);(function(){e.collides=function(g,d){for(var t=[],u=d.length,c=g.bounds,f=r.collides,y=s.overlaps,S=0;S<u;S++){var E=d[S],A=E.parts.length,m=A===1?0:1;if(y(E.bounds,c))for(var x=m;x<A;x++){var C=E.parts[x];if(y(C.bounds,c)){var v=f(C,g);if(v){t.push(v);break}}}}return t},e.ray=function(g,d,t,u){u=u||1e-100;for(var c=o.angle(d,t),f=o.magnitude(o.sub(d,t)),y=(t.x+d.x)*.5,S=(t.y+d.y)*.5,E=h.rectangle(y,S,f,u,{angle:c}),A=e.collides(E,g),m=0;m<A.length;m+=1){var x=A[m];x.body=x.bodyB=x.bodyA}return A},e.region=function(g,d,t){for(var u=[],c=0;c<g.length;c++){var f=g[c],y=s.overlaps(f.bounds,d);(y&&!t||!y&&t)&&u.push(f)}return u},e.point=function(g,d){for(var t=[],u=0;u<g.length;u++){var c=g[u];if(s.contains(c.bounds,d))for(var f=c.parts.length===1?0:1;f<c.parts.length;f++){var y=c.parts[f];if(s.contains(y.bounds,d)&&l.contains(y.vertices,d)){t.push(c);break}}}return t}})()},function(i,p,n){var e={};i.exports=e;var o=n(4),r=n(0),s=n(6),h=n(1),l=n(5),g=n(2),d=n(14);(function(){var t,u;typeof window<"u"&&(t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(m){window.setTimeout(function(){m(r.now())},1e3/60)},u=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame),e._goodFps=30,e._goodDelta=1e3/60,e.create=function(m){var x={engine:null,element:null,canvas:null,mouse:null,frameRequestId:null,timing:{historySize:60,delta:0,deltaHistory:[],lastTime:0,lastTimestamp:0,lastElapsed:0,timestampElapsed:0,timestampElapsedHistory:[],engineDeltaHistory:[],engineElapsedHistory:[],engineUpdatesHistory:[],elapsedHistory:[]},options:{width:800,height:600,pixelRatio:1,background:"#14151f",wireframeBackground:"#14151f",wireframeStrokeStyle:"#bbb",hasBounds:!!m.bounds,enabled:!0,wireframes:!0,showSleeping:!0,showDebug:!1,showStats:!1,showPerformance:!1,showBounds:!1,showVelocity:!1,showCollisions:!1,showSeparations:!1,showAxes:!1,showPositions:!1,showAngleIndicator:!1,showIds:!1,showVertexNumbers:!1,showConvexHulls:!1,showInternalEdges:!1,showMousePosition:!1}},C=r.extend(x,m);return C.canvas&&(C.canvas.width=C.options.width||C.canvas.width,C.canvas.height=C.options.height||C.canvas.height),C.mouse=m.mouse,C.engine=m.engine,C.canvas=C.canvas||y(C.options.width,C.options.height),C.context=C.canvas.getContext("2d"),C.textures={},C.bounds=C.bounds||{min:{x:0,y:0},max:{x:C.canvas.width,y:C.canvas.height}},C.controller=e,C.options.showBroadphase=!1,C.options.pixelRatio!==1&&e.setPixelRatio(C,C.options.pixelRatio),r.isElement(C.element)&&C.element.appendChild(C.canvas),C},e.run=function(m){(function x(C){m.frameRequestId=t(x),c(m,C),e.world(m,C),m.context.setTransform(m.options.pixelRatio,0,0,m.options.pixelRatio,0,0),(m.options.showStats||m.options.showDebug)&&e.stats(m,m.context,C),(m.options.showPerformance||m.options.showDebug)&&e.performance(m,m.context,C),m.context.setTransform(1,0,0,1,0,0)})()},e.stop=function(m){u(m.frameRequestId)},e.setPixelRatio=function(m,x){var C=m.options,v=m.canvas;x==="auto"&&(x=S(v)),C.pixelRatio=x,v.setAttribute("data-pixel-ratio",x),v.width=C.width*x,v.height=C.height*x,v.style.width=C.width+"px",v.style.height=C.height+"px"},e.setSize=function(m,x,C){m.options.width=x,m.options.height=C,m.bounds.max.x=m.bounds.min.x+x,m.bounds.max.y=m.bounds.min.y+C,m.options.pixelRatio!==1?e.setPixelRatio(m,m.options.pixelRatio):(m.canvas.width=x,m.canvas.height=C)},e.lookAt=function(m,x,C,v){v=typeof v<"u"?v:!0,x=r.isArray(x)?x:[x],C=C||{x:0,y:0};for(var w={min:{x:1/0,y:1/0},max:{x:-1/0,y:-1/0}},M=0;M<x.length;M+=1){var L=x[M],I=L.bounds?L.bounds.min:L.min||L.position||L,k=L.bounds?L.bounds.max:L.max||L.position||L;I&&k&&(I.x<w.min.x&&(w.min.x=I.x),k.x>w.max.x&&(w.max.x=k.x),I.y<w.min.y&&(w.min.y=I.y),k.y>w.max.y&&(w.max.y=k.y))}var b=w.max.x-w.min.x+2*C.x,P=w.max.y-w.min.y+2*C.y,D=m.canvas.height,B=m.canvas.width,O=B/D,N=b/P,U=1,V=1;N>O?V=N/O:U=O/N,m.options.hasBounds=!0,m.bounds.min.x=w.min.x,m.bounds.max.x=w.min.x+b*U,m.bounds.min.y=w.min.y,m.bounds.max.y=w.min.y+P*V,v&&(m.bounds.min.x+=b*.5-b*U*.5,m.bounds.max.x+=b*.5-b*U*.5,m.bounds.min.y+=P*.5-P*V*.5,m.bounds.max.y+=P*.5-P*V*.5),m.bounds.min.x-=C.x,m.bounds.max.x-=C.x,m.bounds.min.y-=C.y,m.bounds.max.y-=C.y,m.mouse&&(d.setScale(m.mouse,{x:(m.bounds.max.x-m.bounds.min.x)/m.canvas.width,y:(m.bounds.max.y-m.bounds.min.y)/m.canvas.height}),d.setOffset(m.mouse,m.bounds.min))},e.startViewTransform=function(m){var x=m.bounds.max.x-m.bounds.min.x,C=m.bounds.max.y-m.bounds.min.y,v=x/m.options.width,w=C/m.options.height;m.context.setTransform(m.options.pixelRatio/v,0,0,m.options.pixelRatio/w,0,0),m.context.translate(-m.bounds.min.x,-m.bounds.min.y)},e.endViewTransform=function(m){m.context.setTransform(m.options.pixelRatio,0,0,m.options.pixelRatio,0,0)},e.world=function(m,x){var C=r.now(),v=m.engine,w=v.world,M=m.canvas,L=m.context,I=m.options,k=m.timing,b=s.allBodies(w),P=s.allConstraints(w),D=I.wireframes?I.wireframeBackground:I.background,B=[],O=[],N,U={timestamp:v.timing.timestamp};if(l.trigger(m,"beforeRender",U),m.currentBackground!==D&&A(m,D),L.globalCompositeOperation="source-in",L.fillStyle="transparent",L.fillRect(0,0,M.width,M.height),L.globalCompositeOperation="source-over",I.hasBounds){for(N=0;N<b.length;N++){var V=b[N];h.overlaps(V.bounds,m.bounds)&&B.push(V)}for(N=0;N<P.length;N++){var W=P[N],Q=W.bodyA,J=W.bodyB,q=W.pointA,z=W.pointB;Q&&(q=g.add(Q.position,W.pointA)),J&&(z=g.add(J.position,W.pointB)),!(!q||!z)&&(h.contains(m.bounds,q)||h.contains(m.bounds,z))&&O.push(W)}e.startViewTransform(m),m.mouse&&(d.setScale(m.mouse,{x:(m.bounds.max.x-m.bounds.min.x)/m.options.width,y:(m.bounds.max.y-m.bounds.min.y)/m.options.height}),d.setOffset(m.mouse,m.bounds.min))}else O=P,B=b,m.options.pixelRatio!==1&&m.context.setTransform(m.options.pixelRatio,0,0,m.options.pixelRatio,0,0);!I.wireframes||v.enableSleeping&&I.showSleeping?e.bodies(m,B,L):(I.showConvexHulls&&e.bodyConvexHulls(m,B,L),e.bodyWireframes(m,B,L)),I.showBounds&&e.bodyBounds(m,B,L),(I.showAxes||I.showAngleIndicator)&&e.bodyAxes(m,B,L),I.showPositions&&e.bodyPositions(m,B,L),I.showVelocity&&e.bodyVelocity(m,B,L),I.showIds&&e.bodyIds(m,B,L),I.showSeparations&&e.separations(m,v.pairs.list,L),I.showCollisions&&e.collisions(m,v.pairs.list,L),I.showVertexNumbers&&e.vertexNumbers(m,B,L),I.showMousePosition&&e.mousePosition(m,m.mouse,L),e.constraints(O,L),I.hasBounds&&e.endViewTransform(m),l.trigger(m,"afterRender",U),k.lastElapsed=r.now()-C},e.stats=function(m,x,C){for(var v=m.engine,w=v.world,M=s.allBodies(w),L=0,I=55,k=44,b=0,P=0,D=0;D<M.length;D+=1)L+=M[D].parts.length;var B={Part:L,Body:M.length,Cons:s.allConstraints(w).length,Comp:s.allComposites(w).length,Pair:v.pairs.list.length};x.fillStyle="#0e0f19",x.fillRect(b,P,I*5.5,k),x.font="12px Arial",x.textBaseline="top",x.textAlign="right";for(var O in B){var N=B[O];x.fillStyle="#aaa",x.fillText(O,b+I,P+8),x.fillStyle="#eee",x.fillText(N,b+I,P+26),b+=I}},e.performance=function(m,x){var C=m.engine,v=m.timing,w=v.deltaHistory,M=v.elapsedHistory,L=v.timestampElapsedHistory,I=v.engineDeltaHistory,k=v.engineUpdatesHistory,b=v.engineElapsedHistory,P=C.timing.lastUpdatesPerFrame,D=C.timing.lastDelta,B=f(w),O=f(M),N=f(I),U=f(k),V=f(b),W=f(L),Q=W/B||0,J=Math.round(B/D),q=1e3/B||0,z=4,K=12,H=60,_=34,Y=10,X=69;x.fillStyle="#0e0f19",x.fillRect(0,50,K*5+H*6+22,_),e.status(x,Y,X,H,z,w.length,Math.round(q)+" fps",q/e._goodFps,function(G){return w[G]/B-1}),e.status(x,Y+K+H,X,H,z,I.length,D.toFixed(2)+" dt",e._goodDelta/D,function(G){return I[G]/N-1}),e.status(x,Y+(K+H)*2,X,H,z,k.length,P+" upf",Math.pow(r.clamp(U/J||1,0,1),4),function(G){return k[G]/U-1}),e.status(x,Y+(K+H)*3,X,H,z,b.length,V.toFixed(2)+" ut",1-P*V/e._goodFps,function(G){return b[G]/V-1}),e.status(x,Y+(K+H)*4,X,H,z,M.length,O.toFixed(2)+" rt",1-O/e._goodFps,function(G){return M[G]/O-1}),e.status(x,Y+(K+H)*5,X,H,z,L.length,Q.toFixed(2)+" x",Q*Q*Q,function(G){return(L[G]/w[G]/Q||0)-1})},e.status=function(m,x,C,v,w,M,L,I,k){m.strokeStyle="#888",m.fillStyle="#444",m.lineWidth=1,m.fillRect(x,C+7,v,1),m.beginPath(),m.moveTo(x,C+7-w*r.clamp(.4*k(0),-2,2));for(var b=0;b<v;b+=1)m.lineTo(x+b,C+7-(b<M?w*r.clamp(.4*k(b),-2,2):0));m.stroke(),m.fillStyle="hsl("+r.clamp(25+95*I,0,120)+",100%,60%)",m.fillRect(x,C-7,4,4),m.font="12px Arial",m.textBaseline="middle",m.textAlign="right",m.fillStyle="#eee",m.fillText(L,x+v,C-5)},e.constraints=function(m,x){for(var C=x,v=0;v<m.length;v++){var w=m[v];if(!(!w.render.visible||!w.pointA||!w.pointB)){var M=w.bodyA,L=w.bodyB,I,k;if(M?I=g.add(M.position,w.pointA):I=w.pointA,w.render.type==="pin")C.beginPath(),C.arc(I.x,I.y,3,0,2*Math.PI),C.closePath();else{if(L?k=g.add(L.position,w.pointB):k=w.pointB,C.beginPath(),C.moveTo(I.x,I.y),w.render.type==="spring")for(var b=g.sub(k,I),P=g.perp(g.normalise(b)),D=Math.ceil(r.clamp(w.length/5,12,20)),B,O=1;O<D;O+=1)B=O%2===0?1:-1,C.lineTo(I.x+b.x*(O/D)+P.x*B*4,I.y+b.y*(O/D)+P.y*B*4);C.lineTo(k.x,k.y)}w.render.lineWidth&&(C.lineWidth=w.render.lineWidth,C.strokeStyle=w.render.strokeStyle,C.stroke()),w.render.anchors&&(C.fillStyle=w.render.strokeStyle,C.beginPath(),C.arc(I.x,I.y,3,0,2*Math.PI),C.arc(k.x,k.y,3,0,2*Math.PI),C.closePath(),C.fill())}}},e.bodies=function(m,x,C){var v=C;m.engine;var w=m.options,M=w.showInternalEdges||!w.wireframes,L,I,k,b;for(k=0;k<x.length;k++)if(L=x[k],!!L.render.visible){for(b=L.parts.length>1?1:0;b<L.parts.length;b++)if(I=L.parts[b],!!I.render.visible){if(w.showSleeping&&L.isSleeping?v.globalAlpha=.5*I.render.opacity:I.render.opacity!==1&&(v.globalAlpha=I.render.opacity),I.render.sprite&&I.render.sprite.texture&&!w.wireframes){var P=I.render.sprite,D=E(m,P.texture);v.translate(I.position.x,I.position.y),v.rotate(I.angle),v.drawImage(D,D.width*-P.xOffset*P.xScale,D.height*-P.yOffset*P.yScale,D.width*P.xScale,D.height*P.yScale),v.rotate(-I.angle),v.translate(-I.position.x,-I.position.y)}else{if(I.circleRadius)v.beginPath(),v.arc(I.position.x,I.position.y,I.circleRadius,0,2*Math.PI);else{v.beginPath(),v.moveTo(I.vertices[0].x,I.vertices[0].y);for(var B=1;B<I.vertices.length;B++)!I.vertices[B-1].isInternal||M?v.lineTo(I.vertices[B].x,I.vertices[B].y):v.moveTo(I.vertices[B].x,I.vertices[B].y),I.vertices[B].isInternal&&!M&&v.moveTo(I.vertices[(B+1)%I.vertices.length].x,I.vertices[(B+1)%I.vertices.length].y);v.lineTo(I.vertices[0].x,I.vertices[0].y),v.closePath()}w.wireframes?(v.lineWidth=1,v.strokeStyle=m.options.wireframeStrokeStyle,v.stroke()):(v.fillStyle=I.render.fillStyle,I.render.lineWidth&&(v.lineWidth=I.render.lineWidth,v.strokeStyle=I.render.strokeStyle,v.stroke()),v.fill())}v.globalAlpha=1}}},e.bodyWireframes=function(m,x,C){var v=C,w=m.options.showInternalEdges,M,L,I,k,b;for(v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.render.visible)for(b=M.parts.length>1?1:0;b<M.parts.length;b++){for(L=M.parts[b],v.moveTo(L.vertices[0].x,L.vertices[0].y),k=1;k<L.vertices.length;k++)!L.vertices[k-1].isInternal||w?v.lineTo(L.vertices[k].x,L.vertices[k].y):v.moveTo(L.vertices[k].x,L.vertices[k].y),L.vertices[k].isInternal&&!w&&v.moveTo(L.vertices[(k+1)%L.vertices.length].x,L.vertices[(k+1)%L.vertices.length].y);v.lineTo(L.vertices[0].x,L.vertices[0].y)}v.lineWidth=1,v.strokeStyle=m.options.wireframeStrokeStyle,v.stroke()},e.bodyConvexHulls=function(m,x,C){var v=C,w,M,L;for(v.beginPath(),M=0;M<x.length;M++)if(w=x[M],!(!w.render.visible||w.parts.length===1)){for(v.moveTo(w.vertices[0].x,w.vertices[0].y),L=1;L<w.vertices.length;L++)v.lineTo(w.vertices[L].x,w.vertices[L].y);v.lineTo(w.vertices[0].x,w.vertices[0].y)}v.lineWidth=1,v.strokeStyle="rgba(255,255,255,0.2)",v.stroke()},e.vertexNumbers=function(m,x,C){var v=C,w,M,L;for(w=0;w<x.length;w++){var I=x[w].parts;for(L=I.length>1?1:0;L<I.length;L++){var k=I[L];for(M=0;M<k.vertices.length;M++)v.fillStyle="rgba(255,255,255,0.2)",v.fillText(w+"_"+M,k.position.x+(k.vertices[M].x-k.position.x)*.8,k.position.y+(k.vertices[M].y-k.position.y)*.8)}}},e.mousePosition=function(m,x,C){var v=C;v.fillStyle="rgba(255,255,255,0.8)",v.fillText(x.position.x+"  "+x.position.y,x.position.x+5,x.position.y-5)},e.bodyBounds=function(m,x,C){var v=C;m.engine;var w=m.options;v.beginPath();for(var M=0;M<x.length;M++){var L=x[M];if(L.render.visible)for(var I=x[M].parts,k=I.length>1?1:0;k<I.length;k++){var b=I[k];v.rect(b.bounds.min.x,b.bounds.min.y,b.bounds.max.x-b.bounds.min.x,b.bounds.max.y-b.bounds.min.y)}}w.wireframes?v.strokeStyle="rgba(255,255,255,0.08)":v.strokeStyle="rgba(0,0,0,0.1)",v.lineWidth=1,v.stroke()},e.bodyAxes=function(m,x,C){var v=C;m.engine;var w=m.options,M,L,I,k;for(v.beginPath(),L=0;L<x.length;L++){var b=x[L],P=b.parts;if(b.render.visible)if(w.showAxes)for(I=P.length>1?1:0;I<P.length;I++)for(M=P[I],k=0;k<M.axes.length;k++){var D=M.axes[k];v.moveTo(M.position.x,M.position.y),v.lineTo(M.position.x+D.x*20,M.position.y+D.y*20)}else for(I=P.length>1?1:0;I<P.length;I++)for(M=P[I],k=0;k<M.axes.length;k++)v.moveTo(M.position.x,M.position.y),v.lineTo((M.vertices[0].x+M.vertices[M.vertices.length-1].x)/2,(M.vertices[0].y+M.vertices[M.vertices.length-1].y)/2)}w.wireframes?(v.strokeStyle="indianred",v.lineWidth=1):(v.strokeStyle="rgba(255, 255, 255, 0.4)",v.globalCompositeOperation="overlay",v.lineWidth=2),v.stroke(),v.globalCompositeOperation="source-over"},e.bodyPositions=function(m,x,C){var v=C;m.engine;var w=m.options,M,L,I,k;for(v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.render.visible)for(k=0;k<M.parts.length;k++)L=M.parts[k],v.arc(L.position.x,L.position.y,3,0,2*Math.PI,!1),v.closePath();for(w.wireframes?v.fillStyle="indianred":v.fillStyle="rgba(0,0,0,0.5)",v.fill(),v.beginPath(),I=0;I<x.length;I++)M=x[I],M.render.visible&&(v.arc(M.positionPrev.x,M.positionPrev.y,2,0,2*Math.PI,!1),v.closePath());v.fillStyle="rgba(255,165,0,0.8)",v.fill()},e.bodyVelocity=function(m,x,C){var v=C;v.beginPath();for(var w=0;w<x.length;w++){var M=x[w];if(M.render.visible){var L=o.getVelocity(M);v.moveTo(M.position.x,M.position.y),v.lineTo(M.position.x+L.x,M.position.y+L.y)}}v.lineWidth=3,v.strokeStyle="cornflowerblue",v.stroke()},e.bodyIds=function(m,x,C){var v=C,w,M;for(w=0;w<x.length;w++)if(x[w].render.visible){var L=x[w].parts;for(M=L.length>1?1:0;M<L.length;M++){var I=L[M];v.font="12px Arial",v.fillStyle="rgba(255,255,255,0.5)",v.fillText(I.id,I.position.x+10,I.position.y-10)}}},e.collisions=function(m,x,C){var v=C,w=m.options,M,L,I,k;for(v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.isActive)for(L=M.collision,k=0;k<M.contactCount;k++){var b=M.contacts[k],P=b.vertex;v.rect(P.x-1.5,P.y-1.5,3.5,3.5)}for(w.wireframes?v.fillStyle="rgba(255,255,255,0.7)":v.fillStyle="orange",v.fill(),v.beginPath(),I=0;I<x.length;I++)if(M=x[I],!!M.isActive&&(L=M.collision,M.contactCount>0)){var D=M.contacts[0].vertex.x,B=M.contacts[0].vertex.y;M.contactCount===2&&(D=(M.contacts[0].vertex.x+M.contacts[1].vertex.x)/2,B=(M.contacts[0].vertex.y+M.contacts[1].vertex.y)/2),L.bodyB===L.supports[0].body||L.bodyA.isStatic===!0?v.moveTo(D-L.normal.x*8,B-L.normal.y*8):v.moveTo(D+L.normal.x*8,B+L.normal.y*8),v.lineTo(D,B)}w.wireframes?v.strokeStyle="rgba(255,165,0,0.7)":v.strokeStyle="orange",v.lineWidth=1,v.stroke()},e.separations=function(m,x,C){var v=C,w=m.options,M,L,I,k,b;for(v.beginPath(),b=0;b<x.length;b++)if(M=x[b],!!M.isActive){L=M.collision,I=L.bodyA,k=L.bodyB;var P=1;!k.isStatic&&!I.isStatic&&(P=.5),k.isStatic&&(P=0),v.moveTo(k.position.x,k.position.y),v.lineTo(k.position.x-L.penetration.x*P,k.position.y-L.penetration.y*P),P=1,!k.isStatic&&!I.isStatic&&(P=.5),I.isStatic&&(P=0),v.moveTo(I.position.x,I.position.y),v.lineTo(I.position.x+L.penetration.x*P,I.position.y+L.penetration.y*P)}w.wireframes?v.strokeStyle="rgba(255,165,0,0.5)":v.strokeStyle="orange",v.stroke()},e.inspector=function(m,x){m.engine;var C=m.selected,v=m.render,w=v.options,M;if(w.hasBounds){var L=v.bounds.max.x-v.bounds.min.x,I=v.bounds.max.y-v.bounds.min.y,k=L/v.options.width,b=I/v.options.height;x.scale(1/k,1/b),x.translate(-v.bounds.min.x,-v.bounds.min.y)}for(var P=0;P<C.length;P++){var D=C[P].data;switch(x.translate(.5,.5),x.lineWidth=1,x.strokeStyle="rgba(255,165,0,0.9)",x.setLineDash([1,2]),D.type){case"body":M=D.bounds,x.beginPath(),x.rect(Math.floor(M.min.x-3),Math.floor(M.min.y-3),Math.floor(M.max.x-M.min.x+6),Math.floor(M.max.y-M.min.y+6)),x.closePath(),x.stroke();break;case"constraint":var B=D.pointA;D.bodyA&&(B=D.pointB),x.beginPath(),x.arc(B.x,B.y,10,0,2*Math.PI),x.closePath(),x.stroke();break}x.setLineDash([]),x.translate(-.5,-.5)}m.selectStart!==null&&(x.translate(.5,.5),x.lineWidth=1,x.strokeStyle="rgba(255,165,0,0.6)",x.fillStyle="rgba(255,165,0,0.1)",M=m.selectBounds,x.beginPath(),x.rect(Math.floor(M.min.x),Math.floor(M.min.y),Math.floor(M.max.x-M.min.x),Math.floor(M.max.y-M.min.y)),x.closePath(),x.stroke(),x.fill(),x.translate(-.5,-.5)),w.hasBounds&&x.setTransform(1,0,0,1,0,0)};var c=function(m,x){var C=m.engine,v=m.timing,w=v.historySize,M=C.timing.timestamp;v.delta=x-v.lastTime||e._goodDelta,v.lastTime=x,v.timestampElapsed=M-v.lastTimestamp||0,v.lastTimestamp=M,v.deltaHistory.unshift(v.delta),v.deltaHistory.length=Math.min(v.deltaHistory.length,w),v.engineDeltaHistory.unshift(C.timing.lastDelta),v.engineDeltaHistory.length=Math.min(v.engineDeltaHistory.length,w),v.timestampElapsedHistory.unshift(v.timestampElapsed),v.timestampElapsedHistory.length=Math.min(v.timestampElapsedHistory.length,w),v.engineUpdatesHistory.unshift(C.timing.lastUpdatesPerFrame),v.engineUpdatesHistory.length=Math.min(v.engineUpdatesHistory.length,w),v.engineElapsedHistory.unshift(C.timing.lastElapsed),v.engineElapsedHistory.length=Math.min(v.engineElapsedHistory.length,w),v.elapsedHistory.unshift(v.lastElapsed),v.elapsedHistory.length=Math.min(v.elapsedHistory.length,w)},f=function(m){for(var x=0,C=0;C<m.length;C+=1)x+=m[C];return x/m.length||0},y=function(m,x){var C=document.createElement("canvas");return C.width=m,C.height=x,C.oncontextmenu=function(){return!1},C.onselectstart=function(){return!1},C},S=function(m){var x=m.getContext("2d"),C=window.devicePixelRatio||1,v=x.webkitBackingStorePixelRatio||x.mozBackingStorePixelRatio||x.msBackingStorePixelRatio||x.oBackingStorePixelRatio||x.backingStorePixelRatio||1;return C/v},E=function(m,x){var C=m.textures[x];return C||(C=m.textures[x]=new Image,C.src=x,C)},A=function(m,x){var C=x;/(jpg|gif|png)$/.test(x)&&(C="url("+x+")"),m.canvas.style.background=C,m.canvas.style.backgroundSize="contain",m.currentBackground=x}})()},function(i,p,n){var e={};i.exports=e;var o=n(5),r=n(17),s=n(0);(function(){e._maxFrameDelta=1e3/15,e._frameDeltaFallback=1e3/60,e._timeBufferMargin=1.5,e._elapsedNextEstimate=1,e._smoothingLowerBound=.1,e._smoothingUpperBound=.9,e.create=function(l){var g={delta:16.666666666666668,frameDelta:null,frameDeltaSmoothing:!0,frameDeltaSnapping:!0,frameDeltaHistory:[],frameDeltaHistorySize:100,frameRequestId:null,timeBuffer:0,timeLastTick:null,maxUpdates:null,maxFrameTime:33.333333333333336,lastUpdatesDeferred:0,enabled:!0},d=s.extend(g,l);return d.fps=0,d},e.run=function(l,g){return l.timeBuffer=e._frameDeltaFallback,function d(t){l.frameRequestId=e._onNextFrame(l,d),t&&l.enabled&&e.tick(l,g,t)}(),l},e.tick=function(l,g,d){var t=s.now(),u=l.delta,c=0,f=d-l.timeLastTick;if((!f||!l.timeLastTick||f>Math.max(e._maxFrameDelta,l.maxFrameTime))&&(f=l.frameDelta||e._frameDeltaFallback),l.frameDeltaSmoothing){l.frameDeltaHistory.push(f),l.frameDeltaHistory=l.frameDeltaHistory.slice(-l.frameDeltaHistorySize);var y=l.frameDeltaHistory.slice(0).sort(),S=l.frameDeltaHistory.slice(y.length*e._smoothingLowerBound,y.length*e._smoothingUpperBound),E=h(S);f=E||f}l.frameDeltaSnapping&&(f=1e3/Math.round(1e3/f)),l.frameDelta=f,l.timeLastTick=d,l.timeBuffer+=l.frameDelta,l.timeBuffer=s.clamp(l.timeBuffer,0,l.frameDelta+u*e._timeBufferMargin),l.lastUpdatesDeferred=0;var A=l.maxUpdates||Math.ceil(l.maxFrameTime/u),m={timestamp:g.timing.timestamp};o.trigger(l,"beforeTick",m),o.trigger(l,"tick",m);for(var x=s.now();u>0&&l.timeBuffer>=u*e._timeBufferMargin;){o.trigger(l,"beforeUpdate",m),r.update(g,u),o.trigger(l,"afterUpdate",m),l.timeBuffer-=u,c+=1;var C=s.now()-t,v=s.now()-x,w=C+e._elapsedNextEstimate*v/c;if(c>=A||w>l.maxFrameTime){l.lastUpdatesDeferred=Math.round(Math.max(0,l.timeBuffer/u-e._timeBufferMargin));break}}g.timing.lastUpdatesPerFrame=c,o.trigger(l,"afterTick",m),l.frameDeltaHistory.length>=100&&(l.lastUpdatesDeferred&&Math.round(l.frameDelta/u)>A?s.warnOnce("Matter.Runner: runner reached runner.maxUpdates, see docs."):l.lastUpdatesDeferred&&s.warnOnce("Matter.Runner: runner reached runner.maxFrameTime, see docs."),typeof l.isFixed<"u"&&s.warnOnce("Matter.Runner: runner.isFixed is now redundant, see docs."),(l.deltaMin||l.deltaMax)&&s.warnOnce("Matter.Runner: runner.deltaMin and runner.deltaMax were removed, see docs."),l.fps!==0&&s.warnOnce("Matter.Runner: runner.fps was replaced by runner.delta, see docs."))},e.stop=function(l){e._cancelNextFrame(l)},e._onNextFrame=function(l,g){if(typeof window<"u"&&window.requestAnimationFrame)l.frameRequestId=window.requestAnimationFrame(g);else throw new Error("Matter.Runner: missing required global window.requestAnimationFrame.");return l.frameRequestId},e._cancelNextFrame=function(l){if(typeof window<"u"&&window.cancelAnimationFrame)window.cancelAnimationFrame(l.frameRequestId);else throw new Error("Matter.Runner: missing required global window.cancelAnimationFrame.")};var h=function(l){for(var g=0,d=l.length,t=0;t<d;t+=1)g+=l[t];return g/d||0}})()},function(i,p,n){var e={};i.exports=e;var o=n(8),r=n(0),s=r.deprecated;(function(){e.collides=function(h,l){return o.collides(h,l)},s(e,"collides","SAT.collides ➤ replaced by Collision.collides")})()},function(i,p,n){var e={};i.exports=e,n(1);var o=n(0);(function(){e.pathToVertices=function(r,s){typeof window<"u"&&!("SVGPathSeg"in window)&&o.warn("Svg.pathToVertices: SVGPathSeg not defined, a polyfill is required.");var h,l,g,d,t,u,c,f,y,S,E=[],A,m,x=0,C=0,v=0;s=s||15;var w=function(L,I,k){var b=k%2===1&&k>1;if(!y||L!=y.x||I!=y.y){y&&b?(A=y.x,m=y.y):(A=0,m=0);var P={x:A+L,y:m+I};(b||!y)&&(y=P),E.push(P),C=A+L,v=m+I}},M=function(L){var I=L.pathSegTypeAsLetter.toUpperCase();if(I!=="Z"){switch(I){case"M":case"L":case"T":case"C":case"S":case"Q":C=L.x,v=L.y;break;case"H":C=L.x;break;case"V":v=L.y;break}w(C,v,L.pathSegType)}};for(e._svgPathToAbsolute(r),g=r.getTotalLength(),u=[],h=0;h<r.pathSegList.numberOfItems;h+=1)u.push(r.pathSegList.getItem(h));for(c=u.concat();x<g;){if(S=r.getPathSegAtLength(x),t=u[S],t!=f){for(;c.length&&c[0]!=t;)M(c.shift());f=t}switch(t.pathSegTypeAsLetter.toUpperCase()){case"C":case"T":case"S":case"Q":case"A":d=r.getPointAtLength(x),w(d.x,d.y,0);break}x+=s}for(h=0,l=c.length;h<l;++h)M(c[h]);return E},e._svgPathToAbsolute=function(r){for(var s,h,l,g,d,t,u=r.pathSegList,c=0,f=0,y=u.numberOfItems,S=0;S<y;++S){var E=u.getItem(S),A=E.pathSegTypeAsLetter;if(/[MLHVCSQTA]/.test(A))"x"in E&&(c=E.x),"y"in E&&(f=E.y);else switch("x1"in E&&(l=c+E.x1),"x2"in E&&(d=c+E.x2),"y1"in E&&(g=f+E.y1),"y2"in E&&(t=f+E.y2),"x"in E&&(c+=E.x),"y"in E&&(f+=E.y),A){case"m":u.replaceItem(r.createSVGPathSegMovetoAbs(c,f),S);break;case"l":u.replaceItem(r.createSVGPathSegLinetoAbs(c,f),S);break;case"h":u.replaceItem(r.createSVGPathSegLinetoHorizontalAbs(c),S);break;case"v":u.replaceItem(r.createSVGPathSegLinetoVerticalAbs(f),S);break;case"c":u.replaceItem(r.createSVGPathSegCurvetoCubicAbs(c,f,l,g,d,t),S);break;case"s":u.replaceItem(r.createSVGPathSegCurvetoCubicSmoothAbs(c,f,d,t),S);break;case"q":u.replaceItem(r.createSVGPathSegCurvetoQuadraticAbs(c,f,l,g),S);break;case"t":u.replaceItem(r.createSVGPathSegCurvetoQuadraticSmoothAbs(c,f),S);break;case"a":u.replaceItem(r.createSVGPathSegArcAbs(c,f,E.r1,E.r2,E.angle,E.largeArcFlag,E.sweepFlag),S);break;case"z":case"Z":c=s,f=h;break}(A=="M"||A=="m")&&(s=c,h=f)}}})()},function(i,p,n){var e={};i.exports=e;var o=n(6);n(0),function(){e.create=o.create,e.add=o.add,e.remove=o.remove,e.clear=o.clear,e.addComposite=o.addComposite,e.addBody=o.addBody,e.addConstraint=o.addConstraint}()}])})}(re)),re.exports}var Ge=Qe();const F=We(Ge),ie=1,qe=2,$=60,Ee=70;class Ke{constructor(a,i){T(this,"engine");T(this,"world");T(this,"runner");T(this,"ground");T(this,"leftWall");T(this,"rightWall");T(this,"topWall");T(this,"resizeListener");T(this,"catManager");T(this,"catFoodManager");T(this,"mouseConstraint");T(this,"collisionHandler");T(this,"speedLimitHandler");console.log("PhysicsManager Creado"),this.catManager=a,this.catFoodManager=i,this.resizeListener=this.handleResize.bind(this),this.collisionHandler=this.handleCollisions.bind(this),this.speedLimitHandler=this.limitAllCatSpeeds.bind(this)}init(a){console.log("PhysicsManager: init"),this.engine=F.Engine.create(),this.world=this.engine.world,this.runner=F.Runner.create(),this.engine.gravity.y=.8,this.engine.gravity.x=0,this.engine.enableSleeping=!0,console.log("Matter.js Engine, World, Runner creados."),this.createWalls(),this.setupMouseConstraint(a),console.log("PhysicsManager: Añadiendo listeners..."),F.Events.on(this.engine,"collisionStart",this.collisionHandler),F.Events.on(this.engine,"beforeUpdate",this.speedLimitHandler),window.addEventListener("resize",this.resizeListener)}createWalls(){const a=window.innerWidth,i=window.innerHeight;this.ground=F.Bodies.rectangle(a/2,i+$/2,a,$,{isStatic:!0,label:"ground",collisionFilter:{category:ie}}),this.leftWall=F.Bodies.rectangle(-60/2,i/2,$,i,{isStatic:!0,label:"leftWall",collisionFilter:{category:ie}}),this.rightWall=F.Bodies.rectangle(a+$/2,i/2,$,i,{isStatic:!0,label:"rightWall",collisionFilter:{category:ie}}),this.topWall=F.Bodies.rectangle(a/2,-60/2,a,$,{isStatic:!0,label:"topWall",collisionFilter:{category:ie}}),F.World.add(this.world,[this.ground,this.leftWall,this.rightWall,this.topWall])}setupMouseConstraint(a){const i=F.Mouse.create(a);this.mouseConstraint=F.MouseConstraint.create(this.engine,{mouse:i,constraint:{stiffness:.1,render:{visible:!1}}}),this.mouseConstraint.collisionFilter.mask=qe,F.World.add(this.world,this.mouseConstraint),this.updateMouseConstraintOffset()}updateMouseConstraintOffset(){if(this.mouseConstraint&&this.mouseConstraint.mouse.element){const a=this.mouseConstraint.mouse.element.getBoundingClientRect();F.Mouse.setOffset(this.mouseConstraint.mouse,{x:-a.left,y:-a.top})}}handleCollisions(a){var p,n;const i=a.pairs;for(let e=0;e<i.length;e++){const o=i[e],r=o.bodyA,s=o.bodyB,h=r==null?void 0:r.label,l=s==null?void 0:s.label;if(h==="cat"&&l==="cat"){const g=((p=this.mouseConstraint)==null?void 0:p.body)===r,d=((n=this.mouseConstraint)==null?void 0:n.body)===s;if(g!==d)if(typeof r.id<"u"&&typeof s.id<"u"){const t=g?r.id:s.id;this.catManager.processPlayerInitiatedCollision(r.id,s.id,t)}else console.error("Error: IDs indefinidos en colisión gato-gato.")}else if(h==="cat"&&l==="foodPellet"||h==="foodPellet"&&l==="cat"){const g=h==="cat"?r:s,d=h==="foodPellet"?r:s;typeof g.id<"u"&&d?this.catFoodManager.processCatFoodCollision(g.id,d):console.warn("Colisión Gato-Comida detectada pero falta ID de gato o cuerpo de comida.")}}}limitAllCatSpeeds(){if(!this.world)return;const a=F.Composite.allBodies(this.world);for(let i=0;i<a.length;i++){const p=a[i];if(!p.isStatic&&p.label==="cat"&&F.Vector.magnitude(p.velocity)>Ee){const e=F.Vector.normalise(p.velocity),o=F.Vector.mult(e,Ee);F.Body.setVelocity(p,o)}}}handleResize(){if(!this.ground||!this.leftWall||!this.rightWall||!this.topWall)return;const a=window.innerWidth,i=window.innerHeight;try{const p=`L ${-a/2} ${-$/2} L ${a/2} ${-$/2} L ${a/2} ${$/2} L ${-a/2} ${$/2}`,n=`L ${-$/2} ${-i/2} L ${$/2} ${-i/2} L ${$/2} ${i/2} L ${-$/2} ${i/2}`,e=`L ${-a/2} ${-$/2} L ${a/2} ${-$/2} L ${a/2} ${$/2} L ${-a/2} ${$/2}`;F.Body.setPosition(this.ground,{x:a/2,y:i+$/2}),F.Body.setVertices(this.ground,F.Vertices.fromPath(p,this.ground)),F.Body.setPosition(this.leftWall,{x:-$/2,y:i/2}),F.Body.setVertices(this.leftWall,F.Vertices.fromPath(n,this.leftWall)),F.Body.setPosition(this.rightWall,{x:a+$/2,y:i/2}),F.Body.setVertices(this.rightWall,F.Vertices.fromPath(n,this.rightWall)),F.Body.setPosition(this.topWall,{x:a/2,y:-$/2}),F.Body.setVertices(this.topWall,F.Vertices.fromPath(e,this.topWall)),this.updateMouseConstraintOffset()}catch(p){console.error("PhysicsManager: Error actualizando límites en resize:",p)}}start(){if(!this.engine||!this.runner){console.error("PhysicsManager: init() debe ser llamado antes de start().");return}F.Runner.run(this.runner,this.engine)}stop(){if(!this.runner){console.warn("PhysicsManager: Runner no inicializado.");return}F.Runner.stop(this.runner)}shutdown(){console.log("PhysicsManager: shutdown"),this.stop(),this.engine?(F.Events.off(this.engine,"collisionStart",this.collisionHandler),F.Events.off(this.engine,"beforeUpdate",this.speedLimitHandler),console.log("PhysicsManager: Listeners de engine removidos.")):console.warn("PhysicsManager shutdown: Engine no encontrado."),window.removeEventListener("resize",this.resizeListener)}getEngine(){if(!this.engine)throw new Error("PhysicsManager no inicializado.");return this.engine}getWorld(){if(!this.world)throw new Error("PhysicsManager no inicializado.");return this.world}}class Ye{constructor(){T(this,"allQuestions",[]);T(this,"availableQuestions",[]);T(this,"currentQuestion",null);T(this,"isLoading",!1);T(this,"lastError",null)}async loadQuestionsData(a){if(this.isLoading)return console.warn("QuizSystem: Ya hay una carga en progreso."),!1;this.isLoading=!0,this.lastError=null,this.allQuestions=[];try{if(!Array.isArray(a))throw new Error("Los datos de preguntas proporcionados no son un array válido.");return this.allQuestions=a,this.resetAvailableQuestions(),console.log(`QuizSystem: ${this.allQuestions.length} preguntas procesadas exitosamente desde datos pre-cargados.`),this.isLoading=!1,!0}catch(i){return console.error("QuizSystem: Error al procesar los datos de preguntas:",i),this.lastError=i instanceof Error?i.message:String(i),this.isLoading=!1,this.allQuestions=[],this.availableQuestions=[],!1}}selectNextQuestion(a){if(this.allQuestions.length===0&&!this.isLoading)return console.error("QuizSystem: No hay preguntas cargadas o procesadas. Llama a loadQuestionsData() después de cargar los datos."),null;if(this.isLoading)return console.warn("QuizSystem: Las preguntas aún se están procesando."),null;let i=this.availableQuestions;if(a&&(i=i.filter(n=>String(n.difficulty)===String(a))),i.length===0&&(console.warn("QuizSystem: No quedan preguntas disponibles"+(a?` con dificultad '${a}'.`:".")+" Reseteando lista..."),this.resetAvailableQuestions(),i=this.availableQuestions,a&&(i=i.filter(n=>String(n.difficulty)===String(a))),i.length===0))return console.error(`QuizSystem: No se encontraron preguntas con dificultad '${a}' incluso después de resetear.`),null;const p=Math.floor(Math.random()*i.length);return this.currentQuestion=i[p],this.availableQuestions=this.availableQuestions.filter(n=>{var e;return n.id!==((e=this.currentQuestion)==null?void 0:e.id)}),this.currentQuestion}validateAnswer(a,i){const p=this.allQuestions.find(e=>e.id===a);return p?i===null?!1:p.correctAnswerKey===i:(console.error(`QuizSystem: No se encontró la pregunta con ID '${a}' para validar.`),null)}getCurrentQuestion(){return this.currentQuestion}resetAvailableQuestions(){this.availableQuestions=[...this.allQuestions],this.currentQuestion=null,console.log(`QuizSystem: Lista de preguntas disponibles reseteada (${this.availableQuestions.length} preguntas).`)}getLastError(){return this.lastError}isLoadingQuestions(){return this.isLoading}}class Xe{constructor(){T(this,"states",new Map);T(this,"currentState",null);T(this,"currentStateName",null)}addState(a,i){this.states.has(a)&&console.warn(`StateMachine: El estado '${a}' ya existe. Sobrescribiendo.`),this.states.set(a,i),console.log(`StateMachine: Estado '${a}' añadido.`)}changeState(a,i){var p,n;if(console.log(`StateMachine: Intentando cambiar a estado '${a}'...`),console.log(`StateMachine: Verificando estado '${a}'. Estados actuales registrados:`,Array.from(this.states.keys())),!this.states.has(a)){console.error(`StateMachine: El estado '${a}' no existe.`),console.error("StateMachine: Detalle del mapa de estados:",this.states);return}if((p=this.currentState)!=null&&p.exit){console.log(`StateMachine: Saliendo del estado '${this.currentStateName}'`);try{this.currentState.exit()}catch(e){console.error(`StateMachine: Error durante exit() del estado '${this.currentStateName}':`,e)}}if(this.currentStateName=a,this.currentState=this.states.get(a)??null,(n=this.currentState)!=null&&n.enter){console.log(`StateMachine: Entrando al estado '${this.currentStateName}'`);try{this.currentState.enter(i)}catch(e){console.error(`StateMachine: Error durante enter() del estado '${this.currentStateName}':`,e)}}}update(a){var i;if((i=this.currentState)!=null&&i.update)try{this.currentState.update(a)}catch(p){console.error(`StateMachine: Error durante update() del estado '${this.currentStateName}':`,p)}}getCurrentStateName(){return this.currentStateName}getCurrentState(){return this.currentState}}class Ze{constructor(){T(this,"audioCtx",null);T(this,"isInitialized",!1);T(this,"masterGainNode",null);console.log("AudioManager Creado (sin inicializar)")}init(){if(!this.isInitialized)try{this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.masterGainNode=this.audioCtx.createGain(),this.masterGainNode.connect(this.audioCtx.destination),this.audioCtx.state==="suspended"?this.audioCtx.resume().then(()=>{console.log("AudioManager: AudioContext reanudado exitosamente."),this.isInitialized=!0}).catch(a=>console.error("AudioManager: Error al reanudar AudioContext:",a)):this.isInitialized=!0}catch(a){console.error("AudioManager: Error al crear AudioContext:",a),this.audioCtx=null,this.masterGainNode=null,this.isInitialized=!1}}playSound(a){if(!((!this.isInitialized||!this.audioCtx||!this.masterGainNode)&&(this.isInitialized||this.init(),!this.isInitialized||!this.audioCtx||!this.masterGainNode))){if(this.audioCtx.state!=="running"){this.audioCtx.state==="suspended"&&this.audioCtx.resume().catch(i=>console.error("Error reanudando AudioContext en playSound:",i));return}try{const i=this.audioCtx.createOscillator(),p=this.audioCtx.createGain();i.connect(p),p.connect(this.masterGainNode);const n=this.audioCtx.currentTime,e=(o,r,s)=>{o.onended=()=>{try{o.numberOfOutputs>0&&o.disconnect(),s&&s.numberOfOutputs>0&&s.disconnect(),r.numberOfOutputs>0&&r.disconnect()}catch{}}};switch(a){case"correct":i.type="sine",i.frequency.setValueAtTime(440,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.4,n+.05),i.frequency.exponentialRampToValueAtTime(880,n+.15),p.gain.exponentialRampToValueAtTime(1e-4,n+.3),e(i,p),i.start(n),i.stop(n+.35);break;case"incorrect":i.type="square",i.frequency.setValueAtTime(110,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.3,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.2),e(i,p),i.start(n),i.stop(n+.25);break;case"eat":i.type="sawtooth",i.frequency.setValueAtTime(150,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.15,n+.03),i.frequency.exponentialRampToValueAtTime(50,n+.1),p.gain.exponentialRampToValueAtTime(1e-4,n+.15),e(i,p),i.start(n),i.stop(n+.2);break;case"draw_start":i.type="triangle",i.frequency.setValueAtTime(330,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.1,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.1),e(i,p),i.start(n),i.stop(n+.15);break;case"draw_end":i.type="sine",i.frequency.setValueAtTime(220,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.15,n+.03),p.gain.exponentialRampToValueAtTime(1e-4,n+.15),e(i,p),i.start(n),i.stop(n+.2);break;case"clear_ink":i.type="sawtooth",i.frequency.setValueAtTime(800,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.2,n+.05),i.frequency.exponentialRampToValueAtTime(200,n+.2),p.gain.exponentialRampToValueAtTime(1e-4,n+.3),e(i,p),i.start(n),i.stop(n+.35);break;case"game_over":i.type="square",i.frequency.setValueAtTime(220,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.3,n+.05),i.frequency.exponentialRampToValueAtTime(110,n+.15),p.gain.exponentialRampToValueAtTime(1e-4,n+.4),e(i,p),i.start(n),i.stop(n+.45);break;case"purchase":i.type="triangle",i.frequency.setValueAtTime(660,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.3,n+.03),i.frequency.exponentialRampToValueAtTime(1320,n+.1),p.gain.exponentialRampToValueAtTime(1e-4,n+.2),e(i,p),i.start(n),i.stop(n+.25);break;case"shield_break":i.type="sawtooth";const o=this.audioCtx.createBiquadFilter();o.type="bandpass",o.frequency.setValueAtTime(1500,n),o.Q.setValueAtTime(15,n),i.connect(o),o.connect(p),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.5,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.3),e(i,p,o),i.start(n),i.stop(n+.3);break;case"hint_used":i.type="sine",i.frequency.setValueAtTime(900,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.1,n+.02),p.gain.exponentialRampToValueAtTime(1e-4,n+.1),e(i,p),i.start(n),i.stop(n+.15);break;case"ui_confirm":i.type="sine",i.frequency.setValueAtTime(523.25,n),p.gain.setValueAtTime(.001,n),p.gain.exponentialRampToValueAtTime(.25,n+.02),i.frequency.linearRampToValueAtTime(659.25,n+.05),p.gain.exponentialRampToValueAtTime(1e-4,n+.15),e(i,p),i.start(n),i.stop(n+.2);break;default:console.warn(`AudioManager: Tipo de sonido desconocido: '${a}'`);return}}catch(i){console.error(`AudioManager: Error al reproducir sonido '${a}':`,i)}}}setVolume(a){if(!this.isInitialized||!this.audioCtx||!this.masterGainNode)return;const i=Math.max(0,Math.min(1,a));this.masterGainNode.gain.setValueAtTime(i,this.audioCtx.currentTime)}getVolume(){return!this.isInitialized||!this.masterGainNode?0:this.masterGainNode.gain.value}isReady(){return this.isInitialized&&this.audioCtx!==null&&this.audioCtx.state==="running"}}class Be{constructor(a){T(this,"type","PhysicsComponent");T(this,"body",null);this.body=a??null}}class De{constructor(a){T(this,"type","RenderComponent");T(this,"element",null);T(this,"isVisible",!0);this.element=a??null}}class Fe{constructor(a=0,i=0,p=0,n=0){T(this,"type","ValueComponent");T(this,"rarity",0);T(this,"scoreValue",0);T(this,"currentSize",0);T(this,"growthLevel",0);this.rarity=a,this.scoreValue=i,this.currentSize=p,this.growthLevel=n}}class Je{constructor(a,i,p,n){T(this,"id");T(this,"physics");T(this,"render");T(this,"value");this.id=a,this.physics=i,this.render=p,this.value=n}getComponent(a){if(a===this.physics.type&&this.physics instanceof Be)return this.physics;if(a===this.render.type&&this.render instanceof De)return this.render;if(a===this.value.type&&this.value instanceof Fe)return this.value}}const je=1,we=2,_e=4,et=8,tt=1.15,Ie=300,nt=1.02,ue={0:null,1:"glow-gray",2:"glow-green",3:"glow-blue",4:"glow-violet",5:"glow-orange"};class it{constructor(a,i){T(this,"cats",new Map);T(this,"physicsManager");T(this,"audioManager");T(this,"gameManager");T(this,"bodyIdToEntityIdMap",new Map);T(this,"nextCatIdCounter",0);T(this,"catContainerElement",null);T(this,"templates",new Map);this.audioManager=a,this.gameManager=i,this.catContainerElement=document.getElementById("cat-container"),this.catContainerElement||console.error("CatManager: Elemento '#cat-container' no encontrado!"),console.log("CatManager Creado (con ref a GameManager).")}setPhysicsManager(a){this.physicsManager=a}loadTemplates(a){if(this.templates.clear(),!Array.isArray(a)){console.error("CatManager: Formato inválido de plantillas.");return}a.forEach(i=>{i!=null&&i.id?((typeof i.spawnWeight!="number"||i.spawnWeight<=0)&&(i.spawnWeight=1),this.templates.set(i.id,i)):console.warn("CatManager: Plantilla inválida o sin ID.",i)})}getSpawnableTemplatesWeighted(){const a=[];return this.templates.forEach(i=>{const p=i.spawnWeight&&i.spawnWeight>0?i.spawnWeight:1;a.push({id:i.id,weight:p})}),a}addCat(a,i){if(!this.gameManager)return console.error("CatManager: GameManager no disponible."),null;const p=this.cats.size,n=this.gameManager.getPlayerData().getMaxCatsAllowed();if(p>=n)return null;if(!this.catContainerElement||!this.physicsManager)return console.error("CatManager: Falta #cat-container o PhysicsManager."),null;const e=this.templates.get(a);if(!e)return console.error(`CatManager: Plantilla '${a}' no encontrada.`),null;const o=`cat_entity_${this.nextCatIdCounter++}`,r=e.initialSize,s=e.rarity,h=e.scoreValue??0,l=(i==null?void 0:i.x)??Math.random()*(window.innerWidth-r)+r/2,g=(i==null?void 0:i.y)??r/2+10,t={...{restitution:.6,friction:.1,frictionAir:.01,density:.005,slop:.01},...e.physicsOptions??{},label:"cat",collisionFilter:{category:we,mask:je|we|_e|et},plugin:{entityId:o,rarity:s,currentSize:r}},u=F.Bodies.circle(l,g,r/2,t);F.Body.setAngularVelocity(u,(Math.random()-.5)*.2);const c=new Be(u);this.bodyIdToEntityIdMap.set(u.id,o);const f=document.createElement("div");f.id=o,f.classList.add("cat"),f.style.width=`${r}px`,f.style.height=`${r}px`;const y=e.renderOptions??{},S=y.glowClass??ue[s];S&&f.classList.add(S);let E=y.imageUrl;const A=y.backgroundColor??"#cccccc";if(E||(E=`https://cataas.com/cat?${Date.now()}&width=${Math.round(r)}&height=${Math.round(r)}`),E){f.style.backgroundImage=`url('${E}')`,f.style.backgroundSize="cover",f.style.backgroundPosition="center";const v=new Image;v.onerror=()=>{console.warn(`Failed to load cat image: ${E}. Using fallback color.`),f.style.backgroundImage="none",f.style.backgroundColor=A},v.src=E}else f.style.backgroundColor=A;if(this.catContainerElement)this.catContainerElement.appendChild(f);else return console.error("Error Crítico: #cat-container no encontrado al añadir gato."),this.bodyIdToEntityIdMap.delete(u.id),null;const m=new De(f),x=new Fe(s,h,r,0),C=new Je(o,c,m,x);try{F.World.add(this.physicsManager.getWorld(),u)}catch(v){return console.error(`CatManager: Error añadiendo cuerpo físico ${o} al mundo:`,v),f.parentNode&&f.parentNode.removeChild(f),this.bodyIdToEntityIdMap.delete(u.id),null}return this.cats.set(o,C),C}removeCat(a){var n,e;const i=String(a),p=this.cats.get(i);if(p){const o=p.physics.body;if(o){this.bodyIdToEntityIdMap.delete(o.id);try{(n=this.physicsManager)!=null&&n.getWorld&&F.Composite.get(this.physicsManager.getWorld(),o.id,"body")&&F.World.remove(this.physicsManager.getWorld(),o)}catch(r){console.warn(`Error eliminando cuerpo físico gato ${i}:`,r)}}(e=p.render.element)!=null&&e.parentNode&&p.render.element.parentNode.removeChild(p.render.element),this.cats.delete(i)}}processPlayerInitiatedCollision(a,i,p){const n=this.bodyIdToEntityIdMap.get(a),e=this.bodyIdToEntityIdMap.get(i);if(n&&e){const o=this.cats.get(n),r=this.cats.get(e);if(o&&r){const s=a===p?o:r,h=a===p?r:o;s&&h?this.handleCatVsCatCollision(s,h):console.error("Error: No se pudo determinar dragger/target cat en colisión.")}}}handleCatVsCatCollision(a,i){if(!a.physics.body||!a.value||!i.physics.body||!i.value||!this.gameManager){console.warn("handleCatVsCatCollision: Faltan componentes necesarios en dragger o target.");return}if(a.id===i.id)return;const p=a.value.currentSize,n=a.value.rarity,e=i.value.currentSize,o=i.value.rarity,r=this.gameManager.getPlayerData().getCurrentMaxSizeLimit(),s=p>=r;let h=!1,l=!1,g=!1;p>e*nt&&(s?n<o&&(h=!0,g=!1,l=!0):(h=!0,g=!0,l=n<o)),h&&this.performEat(a,i,l,g)}performEat(a,i,p,n){if(!a.physics.body||!a.value||!a.render.element||!i.value||!this.gameManager){console.warn("performEat: Faltan componentes en eater o eaten.");return}const e=i.id,o=i.value.rarity,r=ue[o];if(this.removeCat(e),n){const s=a.value.currentSize,h=this.gameManager.getPlayerData().getCurrentMaxSizeLimit();let l=Math.min(h,Ie,s*tt);const g=l/s;if(g>1.001){a.value.currentSize=l;try{if(this.physicsManager.getWorld&&F.Composite.get(this.physicsManager.getWorld(),a.physics.body.id,"body"))F.Body.scale(a.physics.body,g,g),a.physics.body.plugin&&(a.physics.body.plugin.currentSize=l);else throw new Error("Body not found in world during scaling")}catch(d){console.error(`Error scaling body ${a.id}:`,d),a.value.currentSize=s,a.physics.body.plugin&&(a.physics.body.plugin.currentSize=s)}a.render.element.style.width=`${l}px`,a.render.element.style.height=`${l}px`}}if(p&&o>a.value.rarity){const s=ue[a.value.rarity];s&&a.render.element&&a.render.element.classList.remove(s),a.value.rarity=o,a.physics.body.plugin&&(a.physics.body.plugin.rarity=o);const h=r;h&&a.render.element&&a.render.element.classList.add(h),console.log(` -> Cat ${a.id} stole rarity ${o} from ${e}`)}try{this.audioManager.playSound("eat")}catch(s){console.error("Error playing 'eat' sound:",s)}}updateCats(a){this.cats.forEach(i=>{const p=i.physics.body,n=i.render.element,e=i.value;if(!p||!n||!e){console.warn(`Skipping update for cat ${i.id}: Missing body, element, or value.`);return}const o=e.currentSize;if(i.render.isVisible){n.style.display==="none"&&(n.style.display="");const r=o/2;n.style.transform=`translate(${p.position.x-r}px, ${p.position.y-r}px) rotate(${p.angle}rad)`;const s=parseFloat(n.style.width);(isNaN(s)||Math.abs(s-o)>.1)&&(n.style.width=`${o}px`,n.style.height=`${o}px`)}else n.style.display!=="none"&&(n.style.display="none")})}getCat(a){return this.cats.get(a)}getAllCats(){return Array.from(this.cats.values())}removeAllCats(){console.log(`CatManager: Removing all ${this.cats.size} cats...`),Array.from(this.cats.keys()).forEach(i=>this.removeCat(i)),this.cats.size>0&&(console.warn(`CatManager: ${this.cats.size} cats remained after individual removal. Clearing map forcefully.`),this.cats.clear()),this.bodyIdToEntityIdMap.clear(),this.nextCatIdCounter=0,this.catContainerElement&&(this.catContainerElement.innerHTML=""),console.log("CatManager: All cats removed.")}growExistingCats(a,i){let p=0;this.cats.forEach(n=>{if(!(!n.value||!n.physics.body||!this.physicsManager||!this.gameManager||n.value.rarity!==0)&&n.value.growthLevel<i){const e=n.value.currentSize,o=this.gameManager.getPlayerData().getCurrentMaxSizeLimit();let r=Math.min(o,Ie,e+a);const s=r/e;if(s>1.0001){n.value.growthLevel++,n.value.currentSize=r;try{const h=n.physics.body;if(this.physicsManager.getWorld&&F.Composite.get(this.physicsManager.getWorld(),h.id,"body"))F.Body.scale(h,s,s),h.plugin&&(h.plugin.currentSize=r),p++;else throw new Error("Body not found in world for growth scaling")}catch(h){console.error(` -> Error escalando gato común ${n.id} (crecimiento por acierto):`,h),n.value.growthLevel--,n.value.currentSize=e,n.physics.body.plugin&&(n.physics.body.plugin.currentSize=e)}}}})}}const at="shop-popup",st="shop-close-button",ot="shop-player-score",rt="shop-items-container",lt="shop-tooltip",ct="tooltip-name",ut="tooltip-level",dt="tooltip-effect",ht="tooltip-cost",ft="tooltip-status";class gt{constructor(a,i){T(this,"items",new Map);T(this,"playerData");T(this,"gameManager");T(this,"itemElements",new Map);T(this,"shopPopupElement",null);T(this,"shopCloseButtonElement",null);T(this,"shopPlayerScoreElement",null);T(this,"shopItemsContainerElement",null);T(this,"tooltipElement",null);T(this,"tooltipNameElement",null);T(this,"tooltipLevelElement",null);T(this,"tooltipEffectElement",null);T(this,"tooltipCostElement",null);T(this,"tooltipStatusElement",null);T(this,"closeButtonListener",null);T(this,"backdropClickListener",null);console.log("ShopManager: Constructor iniciado."),this.playerData=a,this.gameManager=i,this.shopPopupElement=document.getElementById(at),this.shopCloseButtonElement=document.getElementById(st),this.shopPlayerScoreElement=document.getElementById(ot),this.shopItemsContainerElement=document.getElementById(rt),this.tooltipElement=document.getElementById(lt),this.tooltipElement&&(this.tooltipNameElement=this.tooltipElement.querySelector(`#${ct}`),this.tooltipLevelElement=this.tooltipElement.querySelector(`#${ut}`),this.tooltipEffectElement=this.tooltipElement.querySelector(`#${dt}`),this.tooltipCostElement=this.tooltipElement.querySelector(`#${ht}`),this.tooltipStatusElement=this.tooltipElement.querySelector(`#${ft}`)),(!this.shopPopupElement||!this.shopCloseButtonElement||!this.shopItemsContainerElement||!this.tooltipElement)&&console.error("ShopManager: No se encontraron elementos HTML esenciales para la tienda! Verifica los IDs en index.html."),console.log("ShopManager: Constructor finalizado.")}init(a){if(console.log("ShopManager: init - Procesando datos JSON de ítems..."),this.items.clear(),!Array.isArray(a)){console.error("ShopManager: Datos de ítems de tienda inválidos (no es un array).");return}a.forEach(i=>{i!=null&&i.id&&typeof i.id=="string"?this.items.set(i.id,i):console.warn("ShopManager: Ítem inválido o sin ID en JSON.",i)}),console.log(`ShopManager: ${this.items.size} definiciones de ítems procesadas desde JSON.`),this.createShopItemElements(),this.addCloseListeners(),console.log("ShopManager: Listeners de cierre añadidos.")}openShop(){if(console.log("ShopManager: Abriendo tienda..."),!this.shopPopupElement){console.error("ShopManager: No se puede abrir la tienda, elemento popup no encontrado.");return}this.updateShopUI(),this.shopPopupElement.style.display="flex",this.shopPopupElement.offsetHeight,this.shopPopupElement.classList.add("visible")}closeShop(){if(console.log("ShopManager: Cerrando tienda..."),!this.shopPopupElement)return;this.hideTooltip(),this.shopPopupElement.classList.remove("visible"),setTimeout(()=>{this.shopPopupElement&&!this.shopPopupElement.classList.contains("visible")&&(this.shopPopupElement.style.display="none")},300)}updateShopUI(){var i,p;if(!this.playerData)return;this.shopPlayerScoreElement&&(this.shopPlayerScoreElement.textContent=`Puntos: ${this.playerData.score}`),this.itemElements.forEach((n,e)=>{const o=this.items.get(e);if(!o)return;const r=this.calculateItemCost(o),s=this.playerData.score>=r,h=this.checkItemIsPurchased(o),l=this.checkItemCanPurchase(o),g=this.getItemLevel(o),d=o.isLeveled&&typeof o.maxLevel=="number"&&g>=o.maxLevel;n.classList.remove("disabled","purchased","max-level"),d?n.classList.add("max-level","disabled"):h&&!o.isLeveled?n.classList.add("purchased","disabled"):(!l||!s)&&n.classList.add("disabled")});const a=(i=this.shopItemsContainerElement)==null?void 0:i.querySelector(".shop-item:hover");a&&((p=this.tooltipElement)!=null&&p.classList.contains("visible"))&&this.showTooltipForItem(a.dataset.itemId||"")}handleItemClick(a){const i=a.currentTarget,p=i==null?void 0:i.dataset.itemId;if(!p||!this.items.has(p)){console.error("Click en ítem inválido o sin ID.");return}if(i.classList.contains("disabled")){console.log(`Intento de compra de ítem deshabilitado: ${p}`),this.showTooltipForItem(p);return}console.log(`Intentando comprar ítem: ${p}`),this.executePurchaseAction(p)?(console.log(`Compra exitosa de ${p}`),this.gameManager.getAudioManager().playSound("purchase")):console.log(`Compra fallida de ${p}`)}handleItemMouseOver(a){const i=a.currentTarget,p=i==null?void 0:i.dataset.itemId;p&&this.showTooltipForItem(p)}hideTooltip(){this.tooltipElement&&this.tooltipElement.classList.remove("visible")}showTooltipForItem(a){const i=this.items.get(a);if(!i||!this.tooltipElement||!this.playerData||!this.tooltipNameElement||!this.tooltipEffectElement||!this.tooltipLevelElement||!this.tooltipCostElement||!this.tooltipStatusElement){this.hideTooltip();return}const p=this.calculateItemCost(i),n=this.playerData.score>=p,e=this.checkItemIsPurchased(i),o=this.checkItemCanPurchase(i),r=this.getItemLevel(i),s=i.isLeveled&&typeof i.maxLevel=="number"&&r>=i.maxLevel,h=this.formatEffectText(i);this.tooltipNameElement.textContent=i.name,this.tooltipEffectElement.textContent=h,i.isLeveled&&r>=0?(this.tooltipLevelElement.textContent=`Nivel: ${r}`,this.tooltipLevelElement.classList.remove("hidden")):this.tooltipLevelElement.classList.add("hidden"),this.tooltipCostElement.textContent=s?"Nivel Máximo":`Costo: ${p}`;let l="";s?l="Nivel Máximo Alcanzado":e&&!i.isLeveled?l="Ya comprado / Activo":!o&&!s?l="No disponible":n||(l="Puntos insuficientes"),l?(this.tooltipStatusElement.textContent=l,this.tooltipStatusElement.classList.remove("hidden")):this.tooltipStatusElement.classList.add("hidden"),this.tooltipElement.classList.add("visible")}createShopItemElements(){if(!this.shopItemsContainerElement){console.error("ShopManager: Contenedor #shop-items-container no encontrado.");return}this.shopItemsContainerElement.innerHTML="",this.itemElements.clear();const a={};this.items.forEach(p=>{const n=p.category||"general";a[n]||(a[n]=[]),a[n].push(p)}),["consumable","unlockable","upgradeable","general"].forEach(p=>{if(a[p]){const n=document.createElement("h3");n.className="shop-section-title",n.textContent=this.formatCategoryTitle(p),this.shopItemsContainerElement.appendChild(n);const e=document.createElement("div");e.className="shop-section-items",this.shopItemsContainerElement.appendChild(e),a[p].sort((o,r)=>o.name.localeCompare(r.name)),a[p].forEach(o=>{const r=document.createElement("div");r.className="shop-item",r.dataset.itemId=o.id;const s=document.createElement("span");s.className="shop-item-icon",s.textContent=o.icon||"❓",r.appendChild(s),r.addEventListener("click",h=>this.handleItemClick(h)),r.addEventListener("mouseover",h=>this.handleItemMouseOver(h)),r.addEventListener("mouseout",()=>this.hideTooltip()),e.appendChild(r),this.itemElements.set(o.id,r)})}}),this.updateShopUI()}formatCategoryTitle(a){return a==="consumable"?"Consumibles":a==="unlockable"?"Desbloqueables":a==="upgradeable"?"Mejorables":"General"}addCloseListeners(){this.shopCloseButtonElement?(this.closeButtonListener=()=>this.closeShop(),this.shopCloseButtonElement.addEventListener("click",this.closeButtonListener)):console.warn("ShopManager: Botón de cierre no encontrado."),this.shopPopupElement&&(this.backdropClickListener=a=>{a.target===this.shopPopupElement&&this.closeShop()},this.shopPopupElement.addEventListener("click",this.backdropClickListener))}destroy(){console.log("ShopManager: Destruyendo..."),this.closeButtonListener&&this.shopCloseButtonElement&&(this.shopCloseButtonElement.removeEventListener("click",this.closeButtonListener),this.closeButtonListener=null),this.backdropClickListener&&this.shopPopupElement&&(this.shopPopupElement.removeEventListener("click",this.backdropClickListener),this.backdropClickListener=null),this.itemElements.forEach(a=>{var p;const i=a.cloneNode(!0);(p=a.parentNode)==null||p.replaceChild(i,a)}),this.itemElements.clear(),console.log("ShopManager: Listeners limpiados.")}calculateItemCost(a){const i=a.cost;let p=i.base;if(a.isLeveled){const n=a.levelRef,e=n?this.playerData[n]??0:0;i.type==="exponential"&&typeof i.multiplier=="number"?p=i.base*Math.pow(i.multiplier,e):p=i.base+(i.perLevel??0)*e}else if(i.levelRef&&typeof i.perLevel=="number"){const n=this.playerData[i.levelRef]??0;p=i.base+i.perLevel*n}return Math.round(p)}formatEffectText(a){var p,n,e;let i=a.effectTemplate;if(i=i.replace("{lives}",this.playerData.lives.toString()),i.includes("{isActive}")){const o=(p=a.isPurchasedCheck)==null?void 0:p.valueRef,r=o?!!this.playerData[o]:!1;i=i.replace("{isActive}",r?"(Activo)":"")}if(i.includes("{isUnlocked}")){const o=(n=a.isPurchasedCheck)==null?void 0:n.valueRef,r=o?!!this.playerData[o]:!1;i=i.replace("{isUnlocked}",r?"(Desbloqueado)":"")}if(i.includes("{charges}")){const o=(e=a.isPurchasedCheck)==null?void 0:e.valueRef,r=o?this.playerData[o]??0:0;i=i.replace("{charges}",r>0?`(Cargas: ${r})`:"")}if(i.includes("{currentValue}")){let o="?";a.id==="comboMultiplier"?o=this.playerData.getCurrentComboMultiplier().toFixed(1):a.id==="inkCostReduction"?o=this.playerData.getCurrentInkCostPerPixel().toFixed(2):a.id==="extraCat"?o=this.playerData.getCatsPerCorrectAnswer():a.id==="maxCats"?o=this.playerData.getMaxCatsAllowed():a.id==="maxCatSize"?o=this.playerData.getCurrentMaxSizeLimit():a.id==="refillCatFood"&&(o=this.playerData.currentCatFood),i=i.replace("{currentValue}",o.toString())}return i}checkItemIsPurchased(a){if(!a.isPurchasedCheck)return!1;const i=a.isPurchasedCheck,p=i.valueRef,n=this.playerData[p];if(typeof n>"u")return!1;switch(i.condition){case"isTrue":return n===!0;case"isFalse":return n===!1;case"greaterThan":return typeof n=="number"&&typeof i.limit=="number"&&n>i.limit;default:return!1}}checkItemCanPurchase(a){if(!a.purchaseCheck)return!0;const i=a.purchaseCheck,p=i.valueRef,n=this.playerData[p];if(typeof n>"u")return console.warn(`Purchase check failed for ${a.id}: valueRef '${p}' not found.`),!1;switch(i.condition){case"lessThan":return typeof n=="number"&&typeof i.limit=="number"&&n<i.limit;case"lessThanOrEqual":return typeof n=="number"&&typeof i.limit=="number"&&n<=i.limit;case"isFalse":return n===!1;case"isTrue":return n===!0;case"greaterThan":return typeof n=="number"&&typeof i.limit=="number"&&n>i.limit;case"greaterThanOrEqual":return typeof n=="number"&&typeof i.limit=="number"&&n>=i.limit;default:return!1}}getItemLevel(a){return!a.isLeveled||!a.levelRef?-1:this.playerData[a.levelRef]??0}executePurchaseAction(a){const i=this.items.get(a);if(!i)return console.error(`ShopManager: No se encontró itemData para el ID '${a}'`),!1;const p=this.calculateItemCost(i),n=this.playerData.score>=p,e=this.checkItemCanPurchase(i),o=this.getItemLevel(i),r=i.isLeveled&&typeof i.maxLevel=="number"&&o>=i.maxLevel;if(!n||!e||r)return console.log(`ShopManager executePurchaseAction(${a}): Pre-check fallido (Afford:${n}, Check:${e}, MaxLevel:${r})`),this.showTooltipForItem(a),!1;this.playerData.score-=p,console.log(`ShopManager: Puntos deducidos (${p}). Puntos restantes: ${this.playerData.score}`),this.gameManager.updateExternalScoreUI();let s=!1;const h=i.actionId;console.log(`ShopManager: Ejecutando acción '${h}' para item '${a}'...`);try{switch(h){case"purchaseLife":s=this.purchaseLifeAction();break;case"purchaseShield":s=this.purchaseShieldAction();break;case"purchaseHint":s=this.purchaseHintAction();break;case"purchaseUnlockDrawing":s=this.purchaseUnlockDrawingAction();break;case"purchaseUnlockCatFood":s=this.purchaseUnlockCatFoodAction();break;case"purchaseRefillCatFood":s=this.purchaseRefillCatFoodAction();break;case"purchaseComboMultiplier":s=this.purchaseComboMultiplierAction();break;case"purchaseInkCostReduction":s=this.purchaseInkCostReductionAction();break;case"purchaseExtraCatSpawn":s=this.purchaseExtraCatSpawnAction();break;case"purchaseMaxCatsIncrease":s=this.purchaseMaxCatsIncreaseAction();break;case"purchaseMaxCatSize":s=this.purchaseMaxCatSizeAction();break;default:console.error(`ShopManager: Acción de compra desconocida: ${h} para item ${a}`),s=!1}}catch(l){console.error(`ShopManager: Error ejecutando la acción ${h} para ${a}:`,l),s=!1}return s?(console.log(`ShopManager: Acción ${h} para ${a} completada exitosamente.`),this.gameManager.getAudioManager().playSound("purchase"),this.updateShopUI(),this.showTooltipForItem(a)):(console.warn(`ShopManager: La acción ${h} para ${a} falló. Revirtiendo costo.`),this.playerData.score+=p,this.gameManager.updateExternalScoreUI(),this.updateShopUI(),this.showTooltipForItem(a)),this.shopPlayerScoreElement&&(this.shopPlayerScoreElement.textContent=`Puntos: ${this.playerData.score}`),s}purchaseLifeAction(){return this.playerData.lives++,this.gameManager.updateExternalLivesUI(),console.log(` -> Vida comprada. Vidas actuales: ${this.playerData.lives}`),!0}purchaseShieldAction(){return this.playerData.hasShield=!0,this.gameManager.updateExternalShieldUI(!0),console.log(` -> Escudo comprado. Estado: ${this.playerData.hasShield}`),!0}purchaseHintAction(){return this.playerData.hintCharges++,this.gameManager.updateExternalHintUI(this.playerData.hintCharges),console.log(` -> Pista comprada. Cargas: ${this.playerData.hintCharges}`),!0}purchaseUnlockDrawingAction(){if(console.log("ShopManager: Executing purchaseUnlockDrawingAction..."),this.playerData.isDrawingUnlocked)return console.log(" -> Drawing ya desbloqueado. Acción abortada."),!1;this.playerData.isDrawingUnlocked=!0,console.log(`[ShopManager] Bandera isDrawingUnlocked establecida a: ${this.playerData.isDrawingUnlocked}`);let a=!1;try{a=this.gameManager.enableDrawingFeature(),console.log(` -> gameManager.enableDrawingFeature() returned: ${a}`)}catch(i){console.error(" -> Error caught calling gameManager.enableDrawingFeature():",i),a=!1}return a?(console.log(` -> Activation successful. isDrawingUnlocked permanece: ${this.playerData.isDrawingUnlocked}`),!0):(console.error(" -> Activation FAILED. Reverting playerData.isDrawingUnlocked a false."),this.playerData.isDrawingUnlocked=!1,!1)}purchaseComboMultiplierAction(){return this.playerData.comboMultiplierLevel++,console.log(` -> Nivel Multiplicador Combo incrementado a: ${this.playerData.comboMultiplierLevel}`),!0}purchaseInkCostReductionAction(){return this.playerData.inkCostReductionLevel++,console.log(` -> Nivel Reducción Costo Tinta incrementado a: ${this.playerData.inkCostReductionLevel}`),this.gameManager.updateInkUI(),!0}purchaseExtraCatSpawnAction(){return this.playerData.extraCatSpawnLevel++,console.log(` -> Nivel Gato Extra por Acierto incrementado a: ${this.playerData.extraCatSpawnLevel}`),!0}purchaseMaxCatsIncreaseAction(){return this.playerData.maxCatsLevel++,console.log(` -> Nivel Límite Máximo Gatos incrementado a: ${this.playerData.maxCatsLevel}`),!0}purchaseMaxCatSizeAction(){return this.playerData.maxCatSizeLevel++,console.log(` -> Nivel Tamaño Máximo Gato incrementado a: ${this.playerData.maxCatSizeLevel}`),!0}purchaseUnlockCatFoodAction(){return console.log("ShopManager: Executing purchaseUnlockCatFoodAction..."),this.playerData.isCatFoodUnlocked?!1:(this.playerData.isCatFoodUnlocked=!0,this.playerData.refillCatFood(),this.gameManager.enableCatFoodFeature(),console.log(" -> Cat Food feature unlocked and refilled."),!0)}purchaseRefillCatFoodAction(){return console.log("ShopManager: Executing purchaseRefillCatFoodAction..."),this.playerData.currentCatFood>=this.playerData.getMaxCatFood()?(console.log(" -> Cat food is already full."),!1):(this.playerData.refillCatFood(),this.gameManager.updateCatFoodUI(),!0)}}class pt{constructor(){T(this,"score",0);T(this,"lives",3);T(this,"isDrawingUnlocked",!1);T(this,"isCatFoodUnlocked",!1);T(this,"hasShield",!1);T(this,"hintCharges",0);T(this,"currentInk",0);T(this,"INK_BAR_CAPACITY",1e3);T(this,"inkSpentSinceLastClear",0);T(this,"currentCatFood",0);T(this,"MAX_CAT_FOOD",25);T(this,"comboMultiplierLevel",0);T(this,"inkCostReductionLevel",0);T(this,"extraCatSpawnLevel",0);T(this,"maxCatsLevel",0);T(this,"maxCatSizeLevel",0);T(this,"BASE_MAX_CAT_SIZE_LIMIT",150);T(this,"MAX_CAT_SIZE_INCREMENT_PER_LEVEL",25);console.log("PlayerData Instanciado.")}getCurrentComboMultiplier(){return 1+this.comboMultiplierLevel*.15}getCurrentInkCostPerPixel(){return .4*Math.pow(.9,this.inkCostReductionLevel)}getCatsPerCorrectAnswer(){return 1+this.extraCatSpawnLevel*1}getMaxCatsAllowed(){return 50+this.maxCatsLevel*25}getCurrentMaxSizeLimit(){return this.BASE_MAX_CAT_SIZE_LIMIT+this.maxCatSizeLevel*this.MAX_CAT_SIZE_INCREMENT_PER_LEVEL}spendInk(a){return this.currentInk>=a?(this.currentInk-=a,this.inkSpentSinceLastClear+=a,!0):!1}gainInk(a){this.currentInk+=a}recoverSpentInk(){console.log(`[PlayerData] Recovering ${this.inkSpentSinceLastClear.toFixed(0)} ink.`),this.gainInk(this.inkSpentSinceLastClear),this.inkSpentSinceLastClear=0}getMaxCatFood(){return this.MAX_CAT_FOOD}spendCatFoodUnit(){return this.isCatFoodUnlocked&&this.currentCatFood>0?(this.currentCatFood--,!0):!1}refillCatFood(){this.isCatFoodUnlocked&&(this.currentCatFood=this.getMaxCatFood())}reset(){console.log("PlayerData: Reseteando datos..."),this.score=0,this.lives=3,this.isDrawingUnlocked=!1,this.isCatFoodUnlocked=!1,this.hasShield=!1,this.hintCharges=0,this.currentInk=0,this.inkSpentSinceLastClear=0,this.currentCatFood=0,this.comboMultiplierLevel=0,this.inkCostReductionLevel=0,this.extraCatSpawnLevel=0,this.maxCatsLevel=0,this.maxCatSizeLevel=0}}const Le=25,Ae=8,mt="#E5E7EB",vt=150,yt=4,xt=2,Ct=xt;class Mt{constructor(a){T(this,"gameManager");T(this,"physicsManager");T(this,"playerData");T(this,"drawingCanvas",null);T(this,"drawingCtx",null);T(this,"gameContainer",null);T(this,"isBrushActive",!1);T(this,"isDrawing",!1);T(this,"currentPath",[]);T(this,"lastPoint",null);T(this,"drawnPaths",[]);T(this,"isInitialized",!1);T(this,"listeners",[]);T(this,"clearInkListener",null);console.log("InkManager: Constructor iniciado."),this.gameManager=a;try{this.playerData=a.getPlayerData(),this.drawingCanvas=document.getElementById("drawing-canvas")}catch(i){console.error("InkManager: Error crítico en constructor (PlayerData o Canvas inicial).",i)}}setPhysicsManager(a){this.physicsManager=a}init(){var a;if(this.isInitialized){this.updateInkUI();return}console.log("InkManager: init (llamado al desbloquear dibujo)");try{if(!this.physicsManager&&(this.physicsManager=this.gameManager.getPhysicsManager(),!this.physicsManager))throw new Error("PhysicsManager no ha sido asignado y no se pudo obtener de GameManager.");if(this.playerData=this.gameManager.getPlayerData(),this.drawingCanvas||(this.drawingCanvas=document.getElementById("drawing-canvas")),this.gameContainer=((a=this.gameManager.getContainerElement())==null?void 0:a.querySelector(".game-container"))??this.gameManager.getContainerElement(),!this.playerData)throw new Error("PlayerData no encontrado.");if(!this.drawingCanvas)throw new Error("#drawing-canvas no encontrado.");this.setupDrawingCanvas(),this.initUIAndListeners(),this.isInitialized=!0,this.updateInkUI(),console.log("InkManager: Inicialización completa.")}catch(i){console.error("InkManager: Error CRÍTICO durante la inicialización:",i),this.isInitialized=!1}}initUIAndListeners(){this.removeListeners();const a=document.getElementById("toggle-brush-button"),i=document.getElementById("clear-ink-button");if(a){const p=()=>this.gameManager.activateBrush();this.addListener(a,"click",p)}else console.warn("InkManager: toggleBrushButton no encontrado.");if(i?(this.clearInkListener=this.clearInkLines.bind(this),this.addListener(i,"click",this.clearInkListener)):console.warn("InkManager: clearInkButton no encontrado."),this.drawingCanvas){const p=this.startDrawing.bind(this),n=this.draw.bind(this),e=this.stopDrawing.bind(this);this.addListener(this.drawingCanvas,"mousedown",p),this.addListener(this.drawingCanvas,"mousemove",n),this.addListener(this.drawingCanvas,"mouseup",e),this.addListener(this.drawingCanvas,"mouseleave",e),this.addListener(this.drawingCanvas,"touchstart",p,{passive:!1}),this.addListener(this.drawingCanvas,"touchmove",n,{passive:!1}),this.addListener(this.drawingCanvas,"touchend",e),this.addListener(this.drawingCanvas,"touchcancel",e)}else console.error("InkManager: No se pudieron añadir listeners de dibujo (canvas no encontrado).");this.addListener(window,"resize",this.handleResize.bind(this))}addListener(a,i,p,n){a.addEventListener(i,p,n),this.listeners.push({element:a,type:i,handler:p})}removeListeners(){this.listeners.forEach(({element:a,type:i,handler:p})=>{try{a.removeEventListener(i,p)}catch{}}),this.listeners=[],this.clearInkListener=null}setupDrawingCanvas(){this.drawingCanvas&&(this.drawingCtx=this.drawingCanvas.getContext("2d"),this.drawingCtx?(this.resizeCanvas(),this.applyContextStyles(),this.clearCanvas(),this.redrawPaths()):console.error("InkManager: No se pudo obtener el contexto 2D."))}applyContextStyles(){this.drawingCtx&&(this.drawingCtx.strokeStyle=mt,this.drawingCtx.lineWidth=Ae,this.drawingCtx.lineCap="round",this.drawingCtx.lineJoin="round")}resizeCanvas(){this.drawingCanvas&&(this.drawingCanvas.width=window.innerWidth,this.drawingCanvas.height=window.innerHeight,this.applyContextStyles())}handleResize(){this.resizeCanvas(),this.redrawPaths()}clearCanvas(){this.drawingCtx&&this.drawingCanvas&&this.drawingCtx.clearRect(0,0,this.drawingCanvas.width,this.drawingCanvas.height)}redrawPaths(){this.clearCanvas(),this.drawingCtx&&this.drawnPaths.forEach(a=>{this.drawPathPoints(a.points)})}drawPathPoints(a){if(!(!this.drawingCtx||a.length<2)){this.drawingCtx.beginPath(),this.drawingCtx.moveTo(a[0].x,a[0].y);for(let i=1;i<a.length;i++)this.drawingCtx.lineTo(a[i].x,a[i].y);this.drawingCtx.stroke()}}updateInkUI(){if(!this.isInitialized)return;if(!this.playerData){console.error("InkManager: PlayerData no disponible en updateInkUI.");return}const a=this.playerData.isDrawingUnlocked,i=document.getElementById("toggle-brush-button"),p=document.getElementById("clear-ink-button"),n=document.getElementById("score-area");n&&n.classList.toggle("ink-visible",a),this.gameManager.getUIManager().updateInkBar();const e=a&&this.playerData.currentInk>0,o=a&&this.playerData.inkSpentSinceLastClear>0;i&&(i.disabled=!a||!e&&!this.isBrushActive,i.classList.toggle("active",this.isBrushActive)),p&&(p.disabled=!o),a&&this.playerData.currentInk<=0&&this.isBrushActive&&this.toggleBrush(!1),this.updateBrushVisuals()}toggleBrush(a){if(!this.isInitialized)return;const i=a!==void 0?a:!this.isBrushActive;if(i===!0&&(!this.playerData.isDrawingUnlocked||this.playerData.currentInk<=0)){this.isBrushActive&&(this.isBrushActive=!1,this.updateBrushVisuals());return}i!==this.isBrushActive&&(this.isBrushActive=i,!this.isBrushActive&&this.isDrawing&&this.stopDrawing(null),this.updateBrushVisuals(),this.updateInkUI())}updateBrushVisuals(){this.drawingCanvas&&this.drawingCanvas.classList.toggle("active",this.isBrushActive);const a=document.getElementById("toggle-brush-button");a&&a.classList.toggle("active",this.isBrushActive);const i=this.gameContainer??document.getElementById("app");i&&i.classList.toggle("ui-faded",this.isBrushActive)}clearInkLines(){if(!this.isInitialized||!this.playerData.isDrawingUnlocked||this.playerData.inkSpentSinceLastClear<=0){console.log("[InkManager.clearInkLines] No ink spent or drawing not unlocked.");return}console.log(`InkManager: Clearing ${this.drawnPaths.length} strokes and recovering ink...`);const a=this.drawnPaths.flatMap(i=>i.bodies);if(this.physicsManager&&a.length>0)try{const i=this.physicsManager.getWorld(),p=a.filter(n=>F.Composite.get(i,n.id,"body"));p.length>0&&F.World.remove(i,p)}catch(i){console.error("InkManager: Error removiendo cuerpos de tinta:",i)}this.drawnPaths=[],this.clearCanvas(),this.playerData.recoverSpentInk(),this.updateInkUI(),this.gameManager.getAudioManager().playSound("clear_ink")}gainInkOnCorrectAnswer(){!this.isInitialized||!this.playerData.isDrawingUnlocked||(this.playerData.gainInk(vt),this.updateInkUI())}destroy(){console.log("InkManager: Destruyendo..."),this.removeListeners(),this.isInitialized=!1,this.isBrushActive=!1,this.isDrawing=!1,this.currentPath=[],this.drawnPaths=[],this.drawingCtx=null}startDrawing(a){if(!this.isInitialized||!this.isBrushActive||this.playerData.currentInk<=0)return;a.preventDefault(),this.isDrawing=!0;const i=this.getMousePos(a);this.currentPath=[i],this.lastPoint=i,this.drawingCtx&&(this.drawingCtx.beginPath(),this.drawingCtx.moveTo(i.x,i.y)),this.gameManager.getAudioManager().playSound("draw_start")}draw(a){if(!this.isDrawing||!this.isBrushActive)return;a.preventDefault();const i=this.getMousePos(a),p=this.lastPoint?this.distanceSq(this.lastPoint,i):Le;if(p>=Le){const e=Math.sqrt(p)*this.playerData.getCurrentInkCostPerPixel();this.playerData.spendInk(e)?(this.currentPath.push(i),this.drawingCtx&&(this.drawingCtx.lineTo(i.x,i.y),this.drawingCtx.stroke(),this.drawingCtx.beginPath(),this.drawingCtx.moveTo(i.x,i.y)),this.lastPoint=i,this.updateInkUI()):this.stopDrawing(a)}}stopDrawing(a){if(this.isDrawing){if(a==null||a.preventDefault(),this.isDrawing=!1,this.gameManager.getAudioManager().playSound("draw_end"),this.currentPath.length>1){const i=this.createInkBodySegments(this.currentPath);if(i.length>0&&this.physicsManager)try{F.World.add(this.physicsManager.getWorld(),i),this.drawnPaths.push({points:[...this.currentPath],bodies:i}),this.updateInkUI()}catch(p){console.error("InkManager: Error añadiendo cuerpos al mundo:",p)}else this.physicsManager||console.error("InkManager: PhysicsManager no disponible al finalizar trazo.")}this.currentPath=[],this.lastPoint=null}}getMousePos(a){if(!this.drawingCanvas)return{x:0,y:0};const i=this.drawingCanvas.getBoundingClientRect();let p=0,n=0;return a instanceof MouseEvent?(p=a.clientX,n=a.clientY):a.touches&&a.touches[0]?(p=a.touches[0].clientX,n=a.touches[0].clientY):a.changedTouches&&a.changedTouches[0]&&(p=a.changedTouches[0].clientX,n=a.changedTouches[0].clientY),{x:p-i.left,y:n-i.top}}distanceSq(a,i){const p=a.x-i.x,n=a.y-i.y;return p*p+n*n}createInkBodySegments(a){const i=[];if(a.length<2||!this.physicsManager)return i;for(let p=1;p<a.length;p++){const n=a[p-1],e=a[p],o=e.x-n.x,r=e.y-n.y,s=o*o+r*r;if(s<1)continue;const h=Math.sqrt(s),l=Math.atan2(r,o),g=n.x+o/2,d=n.y+r/2;try{const t=F.Bodies.rectangle(g,d,h,Ae,{isStatic:!0,angle:l,label:"inkLine",friction:.5,restitution:.1,collisionFilter:{category:yt,mask:Ct},render:{visible:!1}});t&&i.push(t)}catch(t){console.error("InkManager: Error creando cuerpo de tinta:",t)}}return i}}const St=1,Et=4;class fe{constructor(a){T(this,"gameManager");T(this,"uiManager");T(this,"currentQuestion",null);T(this,"nextQuestionTimeoutId",null);T(this,"consecutiveCorrectAnswers",0);T(this,"hintAppliedToQuestionId",null);T(this,"isWaitingForExplanationConfirm",!1);T(this,"BASE_POINTS_PER_CORRECT",15);T(this,"DIFFICULTY_BONUS",{easy:10,1:10,2:20,medium:30,3:30,hard:45,4:45,5:65});this.gameManager=a;try{this.uiManager=a.getUIManager()}catch(i){throw console.error("QuizGameplayState: Error crítico obteniendo UIManager.",i),i}}selectRandomCatTemplateId(){var o,r;const i=this.gameManager.getCatManager().getSpawnableTemplatesWeighted();if(i.length===0)return"common_cat";const p=i.reduce((s,h)=>s+h.weight,0);if(p<=0)return((o=i[0])==null?void 0:o.id)??"common_cat";const n=Math.random()*p;let e=0;for(const s of i)if(e+=s.weight,n<e)return s.id;return((r=i[i.length-1])==null?void 0:r.id)??"common_cat"}enter(a){console.log("QuizGameplayState: enter",a);const i=this.gameManager.getContainerElement();i.innerHTML="",i.classList.remove("state-fade-in","state-fade-out"),i.style.opacity="0",this.gameManager.setBodyStateClass("quizgameplay"),this.gameManager.getPlayerData().reset(),console.log("PlayerData reseteado para nueva partida."),this.consecutiveCorrectAnswers=0,this.hintAppliedToQuestionId=null,this.isWaitingForExplanationConfirm=!1,this.displayNextQuestion(),requestAnimationFrame(()=>{i.classList.add("state-fade-in"),i.style.opacity=""})}exit(){console.log("QuizGameplayState: exit");const a=this.gameManager.getContainerElement();this.uiManager.clearQuizInterface(a),this.nextQuestionTimeoutId&&(clearTimeout(this.nextQuestionTimeoutId),this.nextQuestionTimeoutId=null),this.uiManager.updateComboVisuals(0),document.body.style.backgroundColor="#111827";const i=document.documentElement;i.style.setProperty("--element-glow-intensity","0"),i.style.setProperty("--flare-intensity","0"),i.style.setProperty("--difficulty-glow-color","transparent"),i.style.setProperty("--difficulty-glow-blur","0px"),this.isWaitingForExplanationConfirm=!1,this.hintAppliedToQuestionId=null,this.currentQuestion=null}update(a){}calculateScore(a,i){const p=i+1,n=this.BASE_POINTS_PER_CORRECT*p,e=this.DIFFICULTY_BONUS[a]??this.DIFFICULTY_BONUS[1]??0,o=this.gameManager.getPlayerData().getCurrentComboMultiplier(),r=Math.max(0,(n+e)*(o-1));return{totalPoints:Math.round(n+e+r),basePoints:n,difficultyBonus:e,comboBonus:Math.round(r)}}handleCorrectAnswer(a){const i=this.calculateScore(a,this.consecutiveCorrectAnswers);this.consecutiveCorrectAnswers++,this.gameManager.getPlayerData().score+=i.totalPoints,this.gameManager.getInkManager().gainInkOnCorrectAnswer(),this.uiManager.updateScoreDisplay(this.gameManager.getPlayerData().score),this.uiManager.updateComboVisuals(this.consecutiveCorrectAnswers),this.uiManager.updateInkBar();let p=`¡Correcto! +${i.totalPoints} Pts`,n=`(Base: ${i.basePoints}, Dif: +${i.difficultyBonus}`;const e=this.gameManager.getPlayerData().getCurrentComboMultiplier();i.comboBonus>0&&(n+=`, Combo x${e.toFixed(1)}: +${i.comboBonus}`),n+=")",p+=` ${n}`,this.uiManager.updateFeedback(p,"correct");try{this.gameManager.getAudioManager().playSound("correct")}catch(s){console.error("Error sonido 'correct':",s)}try{this.gameManager.getCatManager().growExistingCats(St,Et)}catch(s){console.error("Error llamando a catManager.growExistingCats:",s)}const o=this.gameManager.getPlayerData().getCatsPerCorrectAnswer(),r=this.selectRandomCatTemplateId();if(r)for(let s=0;s<o;s++)try{this.gameManager.getCatManager().addCat(r)}catch(h){console.error(`Error al llamar a catManager.addCat (iteración ${s+1}/${o}):`,h)}this.proceedToNextStep()}handleIncorrectAnswer(){const a=this.gameManager.getPlayerData();let i=!1;a.hasShield?(a.hasShield=!1,this.uiManager.updateFeedback("¡Escudo Roto!","shield"),this.uiManager.updateShieldIcon(!1),this.gameManager.getAudioManager().playSound("shield_break")):(this.consecutiveCorrectAnswers=0,this.gameManager.decrementLives(),this.uiManager.updateComboVisuals(this.consecutiveCorrectAnswers),this.uiManager.updateFeedback("Incorrecto.","incorrect"),this.gameManager.getAudioManager().playSound("incorrect"),a.hintCharges>0&&(console.log("Incorrect answer (no shield), resetting hint charges."),a.hintCharges=0,this.uiManager.updateHintIcon(0)),this.gameManager.getLives()<=0&&(i=!0)),this.hintAppliedToQuestionId=null,i?(this.uiManager.updateFeedback("¡Has perdido!","incorrect"),this.nextQuestionTimeoutId&&(clearTimeout(this.nextQuestionTimeoutId),this.nextQuestionTimeoutId=null),setTimeout(()=>{this.gameManager.getStateMachine().getCurrentStateName()==="QuizGameplay"&&this.gameManager.getStateMachine().changeState("GameOver",{finalScore:a.score})},1500)):this.proceedToNextStep()}proceedToNextStep(){var i;const a=(i=this.currentQuestion)==null?void 0:i.explanation;a&&!this.isWaitingForExplanationConfirm?(this.isWaitingForExplanationConfirm=!0,this.uiManager.showExplanation(a,()=>{this.isWaitingForExplanationConfirm=!1,this.scheduleNextQuestion(500)})):this.isWaitingForExplanationConfirm||this.scheduleNextQuestion(1500)}scheduleNextQuestion(a){this.nextQuestionTimeoutId&&clearTimeout(this.nextQuestionTimeoutId),this.gameManager.getStateMachine().getCurrentStateName()==="QuizGameplay"&&(this.nextQuestionTimeoutId=window.setTimeout(()=>{this.nextQuestionTimeoutId=null,this.gameManager.getStateMachine().getCurrentStateName()==="QuizGameplay"&&requestAnimationFrame(()=>this.displayNextQuestion())},a))}displayNextQuestion(){const a=this.gameManager.getQuizSystem();try{this.currentQuestion=a.selectNextQuestion()}catch(p){console.error("Error seleccionando la siguiente pregunta:",p),this.uiManager.updateFeedback("Error al cargar la siguiente pregunta.","info");return}if(!this.currentQuestion){console.log("No quedan más preguntas disponibles."),this.uiManager.updateFeedback("¡Has completado todas las preguntas!","correct");return}this.hintAppliedToQuestionId=null;const i=this.gameManager.getContainerElement();if(!i){console.error("QuizGameplayState: Contenedor #app no encontrado.");return}try{this.uiManager.buildQuizInterface(this.currentQuestion,i,this.handleOptionClick.bind(this),this.consecutiveCorrectAnswers),this.gameManager.getPlayerData().hintCharges>0&&this.currentQuestion&&(this.uiManager.applyHintVisuals(this.currentQuestion.correctAnswerKey),this.hintAppliedToQuestionId=this.currentQuestion.id)}catch(p){console.error("Error construyendo la interfaz del quiz:",p),this.uiManager.updateFeedback("Error al mostrar la pregunta.","info")}}handleOptionClick(a){if(this.isWaitingForExplanationConfirm||!this.currentQuestion||this.nextQuestionTimeoutId!==null)return;this.uiManager.disableOptions();const p=this.gameManager.getQuizSystem().validateAnswer(this.currentQuestion.id,a),n=this.gameManager.getPlayerData();this.hintAppliedToQuestionId===this.currentQuestion.id&&(n.hintCharges>0&&(n.hintCharges--,this.uiManager.updateHintIcon(n.hintCharges)),this.hintAppliedToQuestionId=null),p===!0?this.handleCorrectAnswer(this.currentQuestion.difficulty):p===!1?this.handleIncorrectAnswer():(this.uiManager.updateFeedback("Error al validar la respuesta.","info"),this.hintAppliedToQuestionId=null,this.proceedToNextStep())}rebuildInterface(){const a=this.gameManager.getContainerElement();this.currentQuestion&&a?(this.uiManager.buildQuizInterface(this.currentQuestion,a,this.handleOptionClick.bind(this),this.consecutiveCorrectAnswers),this.hintAppliedToQuestionId===this.currentQuestion.id&&this.uiManager.applyHintVisuals(this.currentQuestion.correctAnswerKey)):console.warn("QuizGameplayState: No se puede reconstruir, falta pregunta actual o contenedor.")}}const de=1,wt=10,he=2,It=10,Te=1,Lt=20,ke=3,At=.5,Tt=35,j=["#a78bfa","#7c3aed","#2563eb","#34d399","#facc15","#f97316","#ef4444"],Pe="#374151",ae={1:{name:"COMÚN",class:"difficulty-1"},2:{name:"POCO COMÚN",class:"difficulty-2"},3:{name:"RARA",class:"difficulty-3"},4:{name:"ÉPICA",class:"difficulty-4",glowColor:"rgba(167, 139, 250, 0.7)",glowBlur:"8px"},5:{name:"LEGENDARIA",class:"difficulty-5",glowColor:"rgba(245, 158, 11, 0.7)",glowBlur:"10px",pulse:!0},easy:{name:"FÁCIL",class:"difficulty-2",glowColor:"rgba(52, 211, 153, 0.6)",glowBlur:"6px"},medium:{name:"MEDIO",class:"difficulty-3",glowColor:"rgba(96, 165, 250, 0.7)",glowBlur:"8px"},hard:{name:"DIFÍCIL",class:"difficulty-4",glowColor:"rgba(248, 113, 113, 0.7)",glowBlur:"10px",pulse:!0}};class kt{constructor(a){T(this,"gameManager");T(this,"currentUIElements",{});T(this,"optionClickCallback",null);T(this,"optionListeners",new Map);T(this,"explanationConfirmListener",null);this.gameManager=a,console.log("UIManager Creado.")}buildQuizInterface(a,i,p,n){if(!a){console.error("UIManager: No se proporcionó pregunta para construir la interfaz."),i.innerHTML='<p class="text-red-500">Error: No hay pregunta para mostrar.</p>';return}this.clearQuizInterface(i),this.optionClickCallback=p;const e={optionButtons:[]},o=this.gameManager.getPlayerData();try{const r=document.createElement("div");r.className="game-container text-center quiz-wrapper",i.appendChild(r),e.quizWrapper=r;const s=document.createElement("div");s.className="quiz-content-container",r.appendChild(s),e.quizContentContainer=s;const h=document.createElement("div");h.id="score-area",h.className="top-ui-container flex flex-col items-center w-full mb-4 gap-1",s.appendChild(h),e.topUIContainer=h;const l=document.createElement("div");l.id="status-wrapper",l.className="status-row flex justify-center items-center w-auto gap-6 mb-1",h.appendChild(l),e.statusRow=l;const g=document.createElement("div");g.id="lives-container",g.className="quiz-lives flex items-center gap-1.5 text-lg";const d=document.createElement("span");d.className="life-emoji",d.textContent="❤️";const t=document.createElement("span");t.id="lives-count",t.textContent="0";const u=document.createElement("span");u.id="shield-icon",u.textContent="🛡️",u.style.display="none";const c=document.createElement("span");c.id="hint-icon",c.textContent="💡",c.style.display="none",g.append(d,t,u,c),l.appendChild(g),e.livesDisplay=g,e.livesDisplayCount=t,e.shieldIcon=u,e.hintIcon=c;const f=document.createElement("div");f.id="score-display-wrapper",f.className="quiz-score relative flex items-center";const y=document.createElement("span");y.className="score-emoji",y.textContent="⭐";const S=document.createElement("span");S.id="score",S.textContent="0";const E=document.createElement("div");E.id="score-pulse",f.append(y,S,E),l.appendChild(f),e.scoreDisplay=f,e.scoreDisplayText=S,e.scorePulse=E;const A=document.createElement("div");A.id="ink-area",A.className="ink-area flex flex-col items-center mt-1",h.appendChild(A),e.inkArea=A;const m=document.createElement("div");m.id="ink-label",m.className="ink-label-base",m.textContent="Tinta",o.isDrawingUnlocked||m.classList.add("hidden"),A.appendChild(m),e.inkLabel=m;const x=document.createElement("div");x.id="ink-bar-container",x.className="ink-bar-container-base relative",o.isDrawingUnlocked||x.classList.add("hidden");const C=o.currentInk,v=o.INK_BAR_CAPACITY,w=Math.floor(C/v);let M=Pe;if(w>0){const N=(w-1)%j.length;M=j[N]}x.style.backgroundColor=M,A.appendChild(x),e.inkBarContainer=x;const L=document.createElement("span");L.id="combo-counter",L.className="combo-counter-base",L.style.display="none",document.body.appendChild(L),e.comboDisplay=L;const I=document.createElement("div");I.id="question-box",I.className="question-box-base card mb-4 w-full",s.appendChild(I),e.questionBox=I;const k=document.createElement("div");k.className="card__content flex flex-col items-center gap-2",I.appendChild(k),e.questionBoxContent=k;const b=document.createElement("span");b.id="difficulty-label",b.className="difficulty-label-base",k.appendChild(b),e.difficultyLabel=b;const P=document.createElement("p");P.id="question",P.className="question-text-base",P.textContent=a.text,k.appendChild(P),e.questionText=P;const D=document.createElement("div");D.className="card__backdrop",I.insertBefore(D,k),e.questionBoxBackdrop=D;const B=document.createElement("div");B.id="options",B.className="options-container-base flex flex-col gap-3 mb-3 w-full",s.appendChild(B),e.optionsContainer=B,a.options.forEach(N=>{var W;if(!(N!=null&&N.key)||typeof N.text>"u"){console.warn("Opción inválida encontrada:",N);return}const U=document.createElement("button");U.className="option-button",U.dataset.key=N.key,U.textContent=N.text;const V=()=>{this.optionClickCallback&&this.optionClickCallback(N.key)};this.optionListeners.set(U,V),U.addEventListener("click",V),B.appendChild(U),(W=e.optionButtons)==null||W.push(U)});const O=document.createElement("div");O.id="feedback",O.className="feedback-area-base mt-4 text-lg h-8",s.appendChild(O),e.feedbackArea=O,e.explanationOverlay=document.getElementById("explanation-overlay"),e.explanationText=document.getElementById("explanation-text-content"),e.blurBackdrop=document.getElementById("blur-backdrop"),e.catFoodUiContainer=document.getElementById("cat-food-ui-container"),e.catFoodButton=document.getElementById("cat-food-button"),e.catFoodBarContainer=document.getElementById("cat-food-bar-container"),e.catFoodBarFill=document.getElementById("cat-food-bar-fill")}catch(r){console.error("UIManager: Error fatal creando elementos de la interfaz:",r),this.clearQuizInterface(i),i.innerHTML='<p class="text-red-500">Error al construir la interfaz del quiz. Revisa la consola.</p>';return}this.currentUIElements=e,this.updateScoreDisplay(o.score),this.updateLivesDisplay(this.gameManager.getLives()),this.updateShieldIcon(o.hasShield),this.updateHintIcon(o.hintCharges),this.updateInkBar(),this.updateInkVisibility(o.isDrawingUnlocked),this.updateDifficultyLabel(a.difficulty),this.updateComboVisuals(n),this.updateCatFoodBar(o.currentCatFood,o.getMaxCatFood()),this.toggleCatFoodUIVisibility(o.isCatFoodUnlocked)}clearQuizInterface(a){this.optionListeners.forEach((p,n)=>{n&&n.isConnected&&n.removeEventListener("click",p)}),this.optionListeners.clear();const i=document.getElementById("combo-counter");i&&i.parentNode&&i.parentNode.removeChild(i),this.removeExplanationListener(),this.currentUIElements={},this.optionClickCallback=null,a.innerHTML=""}showExplanation(a,i){var o,r,s;const p=((o=this.currentUIElements)==null?void 0:o.explanationOverlay)??document.getElementById("explanation-overlay"),n=((r=this.currentUIElements)==null?void 0:r.explanationText)??document.getElementById("explanation-text-content"),e=((s=this.currentUIElements)==null?void 0:s.blurBackdrop)??document.getElementById("blur-backdrop");p&&n&&e?(n.textContent=a,this.removeExplanationListener(),e.style.display="block",p.style.display="flex",p.offsetHeight,e.offsetHeight,e.classList.add("visible"),p.classList.add("visible"),this.explanationConfirmListener=h=>{this.explanationConfirmListener&&(this.hideExplanation(),i())},setTimeout(()=>{this.explanationConfirmListener&&(p.addEventListener("click",this.explanationConfirmListener,{capture:!0,once:!0}),window.addEventListener("keydown",this.explanationConfirmListener,{capture:!0,once:!0}))},0)):(console.error("UIManager: Elementos del overlay de explicación no encontrados."),i())}hideExplanation(){var p,n;const a=((p=this.currentUIElements)==null?void 0:p.explanationOverlay)??document.getElementById("explanation-overlay"),i=((n=this.currentUIElements)==null?void 0:n.blurBackdrop)??document.getElementById("blur-backdrop");if(this.removeExplanationListener(),a&&i){a.classList.remove("visible");const e=document.getElementById("shop-popup");(!e||!e.classList.contains("visible"))&&i.classList.remove("visible");const o=400,r=s=>{s&&(s.target!==a||s.propertyName!=="opacity")||(a&&(a.style.display="none"),(!e||!e.classList.contains("visible"))&&i&&(i.style.display="none"),a&&a.removeEventListener("transitionend",r))};a.addEventListener("transitionend",r),setTimeout(()=>{a!=null&&a.classList.contains("visible")&&r()},o+50)}}removeExplanationListener(){var i;const a=((i=this.currentUIElements)==null?void 0:i.explanationOverlay)??document.getElementById("explanation-overlay");this.explanationConfirmListener&&(a&&a.removeEventListener("click",this.explanationConfirmListener,{capture:!0}),window.removeEventListener("keydown",this.explanationConfirmListener,{capture:!0}),this.explanationConfirmListener=null)}updateScoreDisplay(a){var n,e;const i=(n=this.currentUIElements)==null?void 0:n.scoreDisplayText;i&&(i.textContent=a.toString());const p=(e=this.currentUIElements)==null?void 0:e.scorePulse;p&&(p.classList.remove("pulsing"),p.offsetWidth,p.classList.add("pulsing"))}updateLivesDisplay(a){var p;const i=(p=this.currentUIElements)==null?void 0:p.livesDisplayCount;i&&(i.textContent=a.toString())}updateShieldIcon(a){var p;const i=(p=this.currentUIElements)==null?void 0:p.shieldIcon;i&&(i.style.display=a?"inline":"none")}updateHintIcon(a){var p;const i=(p=this.currentUIElements)==null?void 0:p.hintIcon;i&&(i.style.display=a>0?"inline":"none")}updateFeedback(a,i){var n;const p=(n=this.currentUIElements)==null?void 0:n.feedbackArea;if(p){p.textContent=a,p.className="feedback-area-base mt-4 h-8 text-center font-bold";const e=i==="correct"?"text-green-400 feedback-correct":i==="incorrect"?"text-red-400 feedback-incorrect":i==="shield"?"text-blue-400 feedback-shield":"text-gray-400 feedback-info";p.classList.add(...e.split(" "))}}updateInkBar(){var g;const a=((g=this.currentUIElements)==null?void 0:g.inkBarContainer)??document.getElementById("ink-bar-container");if(!a)return;const i=this.gameManager.getPlayerData(),p=i.currentInk,n=i.INK_BAR_CAPACITY;a.innerHTML="";const e=Math.floor(p/n),o=p%n,r=p===0&&e===0?0:o===0&&e>0?100:o/n*100;let s=Pe;if(e>0){const d=(e-1)%j.length;s=j[d]}a.style.backgroundColor=s;const h=e%j.length,l=j[h];if(r>=0){const d=document.createElement("div");d.className="ink-bar-segment",d.style.backgroundColor=l,d.style.width=`${r}%`,d.style.transition="width 0.3s ease-out, background-color 0.3s ease-out",a.appendChild(d)}}updateInkVisibility(a){var e,o,r;const i=((e=this.currentUIElements)==null?void 0:e.topUIContainer)??document.getElementById("score-area"),p=((o=this.currentUIElements)==null?void 0:o.inkLabel)??document.getElementById("ink-label"),n=((r=this.currentUIElements)==null?void 0:r.inkBarContainer)??document.getElementById("ink-bar-container");p&&p.classList.toggle("hidden",!a),n&&n.classList.toggle("hidden",!a),i&&i.classList.toggle("ink-visible",a)}updateDifficultyLabel(a){var e;const i=(e=this.currentUIElements)==null?void 0:e.difficultyLabel;if(!i)return;let p=ae[Number(a)]||ae[a]||ae[1];i.textContent=`Pregunta: ${p.name}`,Object.values(ae).forEach(o=>{o.class&&i.classList.remove(o.class)}),p.class&&i.classList.add(p.class);const n=document.documentElement;n.style.setProperty("--difficulty-glow-color",p.glowColor||"transparent"),n.style.setProperty("--difficulty-glow-blur",p.glowBlur||"0px"),i.classList.toggle("difficulty-pulse",!!p.pulse)}updateComboVisuals(a){var t,u;const i=document.documentElement,p=(t=this.currentUIElements)==null?void 0:t.comboDisplay,n=(u=this.currentUIElements)==null?void 0:u.scoreDisplayText;if(!i){console.error("[updateComboVisuals] Error: document.documentElement no encontrado.");return}const e=a<de?0:Math.min((a-de+1)/(wt-de+1),1);i.style.setProperty("--flare-intensity",e.toFixed(3));const o=a<he?0:Math.min((a-he+1)/(It-he+1),1);if(i.style.setProperty("--element-glow-intensity",o.toFixed(3)),p)if(a>0){const c=Math.min(Math.max(0,a-1),10),f=ke+c*At;i.style.setProperty("--combo-font-size",`${f.toFixed(2)}rem`),p.textContent=`x${a}`,p.style.display="block";const y=a*Tt%360;p.style.color=`hsl(${y}, 100%, 65%)`,p.style.backgroundImage="none",p.style.backgroundClip="unset",p.style.webkitBackgroundClip="unset"}else p.textContent="",p.style.display="none",i.style.setProperty("--combo-font-size",`${ke}rem`),p.style.color="inherit",p.style.backgroundImage="none",p.style.backgroundClip="unset",p.style.webkitBackgroundClip="unset";const r=Math.min(Math.max(0,a-Te)/(Lt-Te),1),s=r*r,l=(220+a*10)%360,g=30+s*50,d=10+s*15;if(document.body.style.backgroundColor=`hsl(${l.toFixed(0)}, ${g.toFixed(0)}%, ${d.toFixed(0)}%)`,n){const c=e>.3;n.classList.toggle("score-pulsing",c),c||(n.style.textShadow="var(--flare-shadow)");const f=Math.min(a/10,1),y=90+f*10,S=700+Math.floor(f*2)*100,E=(l+180)%360,A=a<2?"#f3f4f6":`hsl(${E}, 80%, ${y}%)`;n.style.color=A,n.style.fontWeight=`${S}`}else console.warn("[updateComboVisuals] Elemento scoreDisplayText (#score) no encontrado.")}disableOptions(){var a,i;(i=(a=this.currentUIElements)==null?void 0:a.optionButtons)==null||i.forEach(p=>{p&&(p.disabled=!0)})}enableOptions(){var a,i;(i=(a=this.currentUIElements)==null?void 0:a.optionButtons)==null||i.forEach(p=>{p&&!p.classList.contains("option-hint-disabled")&&(p.disabled=!1)})}applyHintVisuals(a){var o;let i=0;const p=1,n=(o=this.currentUIElements)==null?void 0:o.optionButtons;if(!n||n.length<=1)return;[...n].sort(()=>.5-Math.random()).forEach(r=>{i>=p||r&&r.dataset.key!==a&&!r.classList.contains("option-hint-disabled")&&(r.classList.add("option-hint-disabled"),i++)})}toggleCatFoodUIVisibility(a){var p;const i=((p=this.currentUIElements)==null?void 0:p.catFoodUiContainer)??document.getElementById("cat-food-ui-container");i?i.classList.toggle("hidden",!a):a&&console.warn("UIManager: Contenedor UI comida (#cat-food-ui-container) no encontrado.")}showCatFoodUI(){this.toggleCatFoodUIVisibility(!0),this.currentUIElements.catFoodButton||(this.currentUIElements.catFoodButton=document.getElementById("cat-food-button"))}updateCatFoodBar(a,i){const p=document.getElementById("cat-food-bar-fill");if(p){const n=i>0?Math.max(0,Math.min(100,a/i*100)):0;p.style.width=`${n}%`}}rebuildInterface(){const a=this.gameManager.getCurrentState();if(a instanceof fe&&a.currentQuestion){const i=this.gameManager.getContainerElement();i?(this.buildQuizInterface(a.currentQuestion,i,a.handleOptionClick.bind(a),a.consecutiveCorrectAnswers),a.hintAppliedToQuestionId===a.currentQuestion.id&&this.gameManager.getPlayerData().hintCharges>0&&this.applyHintVisuals(a.currentQuestion.correctAnswerKey)):console.error("UIManager: Contenedor #app no encontrado al intentar reconstruir.")}}}class Pt{constructor(a="body"){T(this,"themes",[]);T(this,"activeThemeIndex",0);T(this,"defaultThemeId","retro");T(this,"isLoading",!1);T(this,"lastError",null);T(this,"rootElement",document.body);console.log("ThemeManager Creado.");const i=document.querySelector(a);i instanceof HTMLElement?this.rootElement=i:(console.warn(`ThemeManager: Elemento raíz '${a}' no encontrado, usando document.body.`),this.rootElement=document.body)}async loadThemesData(a){if(this.isLoading)return console.warn("ThemeManager: Ya hay una carga en progreso."),!1;console.log("ThemeManager: Procesando datos de temas pre-cargados..."),this.isLoading=!0,this.lastError=null,this.themes=[];try{if(!Array.isArray(a))throw new Error("Los datos de temas proporcionados no son un array válido.");return this.themes=a,console.log(`ThemeManager: ${this.themes.length} temas procesados exitosamente.`),this.activeThemeIndex=Math.max(0,this.themes.findIndex(i=>i.id===this.defaultThemeId)),this.isLoading=!1,this.applyActiveThemeClass(),!0}catch(i){return console.error("ThemeManager: Error al procesar los datos de temas:",i),this.lastError=i instanceof Error?i.message:String(i),this.isLoading=!1,this.themes=[],this.activeThemeIndex=0,!1}}applyActiveThemeClass(){var i,p;if(!this.rootElement)return;this.themes.forEach(n=>{var e,o;(o=(e=n.elements)==null?void 0:e.quizWrapper)!=null&&o.themeClass&&this.rootElement.classList.remove(n.elements.quizWrapper.themeClass)});const a=this.getActiveTheme();if((p=(i=a==null?void 0:a.elements)==null?void 0:i.quizWrapper)!=null&&p.themeClass){const n=a.elements.quizWrapper.themeClass;this.rootElement.classList.add(n),console.log(`ThemeManager: Clase de tema '${n}' aplicada a ${this.rootElement.tagName}.`)}else console.warn("ThemeManager: Tema activo o su themeClass no definidos.")}getActiveTheme(){return this.themes.length===0?null:this.themes[this.activeThemeIndex]??null}getActiveThemeId(){var a;return((a=this.getActiveTheme())==null?void 0:a.id)??null}cycleTheme(){if(this.themes.length<=1)return;this.activeThemeIndex=(this.activeThemeIndex+1)%this.themes.length,this.applyActiveThemeClass();const a=this.getActiveTheme();console.log(`ThemeManager: Tema ciclado a '${(a==null?void 0:a.name)??"N/A"}' (ID: ${(a==null?void 0:a.id)??"N/A"})`)}setActiveTheme(a){var p;const i=this.themes.findIndex(n=>n.id===a);return i!==-1?(this.activeThemeIndex=i,this.applyActiveThemeClass(),console.log(`ThemeManager: Tema establecido a '${(p=this.getActiveTheme())==null?void 0:p.name}' (ID: ${a})`),!0):(console.warn(`ThemeManager: No se encontró el tema con ID '${a}'.`),!1)}getThemes(){return[...this.themes]}getLastError(){return this.lastError}isLoadingThemes(){return this.isLoading}}const se=8,bt=3500,Bt=8,Dt=2,Ft=4e-4,Rt=500*500,Ot=1;class Nt{constructor(a){T(this,"gameManager");T(this,"physicsManager",null);T(this,"playerData",null);T(this,"catManager",null);T(this,"audioManager",null);T(this,"isInitializedSuccessfully",!1);T(this,"isEnabled",!1);T(this,"isActive",!1);T(this,"activePellets",new Map);T(this,"nextPelletId",0);T(this,"catFoodButton",null);T(this,"catFoodContainer",null);T(this,"catContainerElement",null);T(this,"clickListener",null);console.log("CatFoodManager: Constructor iniciado."),this.gameManager=a}init(){this.isInitializedSuccessfully=!1,console.log("CatFoodManager: init");try{if(this.physicsManager=this.gameManager.getPhysicsManager(),this.playerData=this.gameManager.getPlayerData(),this.catManager=this.gameManager.getCatManager(),this.audioManager=this.gameManager.getAudioManager(),this.catContainerElement=document.getElementById("cat-container"),this.catFoodButton=document.getElementById("cat-food-button"),this.catFoodContainer=document.getElementById("cat-food-ui-container"),!this.physicsManager)throw new Error("PhysicsManager no disponible.");if(!this.playerData)throw new Error("PlayerData no disponible.");if(!this.catManager)throw new Error("CatManager no disponible.");if(!this.audioManager)throw new Error("AudioManager no disponible.");if(!this.catContainerElement)throw new Error("Elemento #cat-container no encontrado.");if(!this.catFoodButton)throw new Error("Elemento #cat-food-button no encontrado.");if(!this.catFoodContainer)throw new Error("Elemento #cat-food-ui-container no encontrado.");console.log("CatFoodManager: Inicialización exitosa."),this.isInitializedSuccessfully=!0}catch(a){console.error("CatFoodManager: Error CRÍTICO durante la inicialización:",a),this.isEnabled=!1}}enable(){if(!this.isInitializedSuccessfully){console.error("CatFoodManager: No se puede habilitar, inicialización falló.");return}if(!this.isEnabled){if(console.log("CatFoodManager: Habilitando..."),this.isEnabled=!0,this.catFoodButton||(this.catFoodButton=document.getElementById("cat-food-button")),this.catFoodContainer||(this.catFoodContainer=document.getElementById("cat-food-ui-container")),this.catFoodButton&&this.catFoodContainer){const a=()=>this.gameManager.activateCatFood();this.catFoodButton.addEventListener("click",a),this.catFoodContainer.classList.remove("hidden"),console.log(" -> Listener añadido al botón de comida (llama a GameManager) y UI mostrada.")}else console.warn("CatFoodManager: Botón de comida o contenedor UI no encontrado al habilitar.");this.gameManager.updateCatFoodUI()}}toggleActive(a){var n;if(!this.isEnabled||!this.isInitializedSuccessfully)return;const i=a!==void 0?a:!this.isActive,p=this.isActive;if(console.log(`[CatFoodManager.toggleActive] Called. Current state: ${p}, Forced state: ${a}, New target state: ${i}`),i===!0&&(!this.isEnabled||this.playerData&&this.playerData.currentCatFood<=0)){console.log(`[CatFoodManager.toggleActive] Cannot activate. Enabled: ${this.isEnabled}, Food: ${(n=this.playerData)==null?void 0:n.currentCatFood}`),this.isActive&&(this.isActive=!1,this.updateActiveVisuals(),this.removeClickListener(),console.log("[CatFoodManager.toggleActive] Forced visual deactivation due to activation constraints."));return}if(i===this.isActive){console.log(`[CatFoodManager.toggleActive] State already ${i}. No change needed.`);return}this.isActive=i,console.log(`[CatFoodManager.toggleActive] State CHANGED from ${p} to ${this.isActive}`),this.updateActiveVisuals(),this.isActive?(console.log("[CatFoodManager.toggleActive] Adding click listener."),this.addClickListener()):(console.log("[CatFoodManager.toggleActive] Removing click listener."),this.removeClickListener())}updateActiveVisuals(){if(this.catFoodButton){const a=this.catFoodButton.classList.contains("active");this.catFoodButton.classList.toggle("active",this.isActive);const i=this.catFoodButton.classList.contains("active");console.log(`[CatFoodManager.updateActiveVisuals] Setting button active class to ${this.isActive}. Was active: ${a}, Is now active: ${i}`)}else console.warn("[CatFoodManager.updateActiveVisuals] catFoodButton not found.")}addClickListener(){if(this.clickListener||!this.isInitializedSuccessfully)return;const a=document.body;a&&(this.clickListener=i=>{const p=i.target;if(p.closest("#cat-food-button")||p.closest("#toggle-brush-button")){console.log("CatFood Click Listener: Click en botón de control ignorado para spawn.");return}if(!(!this.isActive||!this.isEnabled)){if(i.preventDefault(),!this.playerData){console.error("ClickListener: PlayerData no disponible.");return}if(this.playerData.currentCatFood>0){const n=this.getClickPosition(i,a);this.spawnFoodPellet(n),this.applyAttractionForce(n),this.playerData.spendCatFoodUnit()?(this.gameManager.updateCatFoodUI(),console.log("[CatFood Click Listener] Comida lanzada.")):(console.warn("[CatFood Click Listener] spendCatFoodUnit falló inesperadamente."),this.toggleActive(!1))}else console.log("[CatFood Click Listener] Sin comida. Desactivando modo."),this.toggleActive(!1)}},console.log("CatFoodManager: Añadiendo listener de click/touch para comida a document.body."),a.addEventListener("mousedown",this.clickListener,{capture:!0}),a.addEventListener("touchstart",this.clickListener,{passive:!1,capture:!0}))}removeClickListener(){if(!this.clickListener)return;const a=document.body;console.log("CatFoodManager: Removiendo listener de click/touch para comida de document.body."),a.removeEventListener("mousedown",this.clickListener,{capture:!0}),a.removeEventListener("touchstart",this.clickListener,{capture:!0}),this.clickListener=null}getClickPosition(a,i){let p=0,n=0;return a instanceof MouseEvent?(p=a.clientX,n=a.clientY):a.touches&&a.touches[0]?(p=a.touches[0].clientX,n=a.touches[0].clientY):a.changedTouches&&a.changedTouches[0]&&(p=a.changedTouches[0].clientX,n=a.changedTouches[0].clientY),{x:p,y:n}}applyAttractionForce(a){if(!this.catManager||!this.physicsManager)return;const i=this.catManager.getAllCats(),p=this.physicsManager.getWorld();i.forEach(n=>{if(n.physics.body&&!n.physics.body.isStatic&&F.Composite.get(p,n.physics.body.id,"body")){const e=n.physics.body,o=F.Vector.sub(a,e.position),r=F.Vector.magnitudeSquared(o);if(r>1&&r<Rt){const s=Math.sqrt(r),h=Ft*s,l=F.Vector.mult(F.Vector.normalise(o),h);try{F.Body.applyForce(e,e.position,l)}catch(g){console.warn(`Error applying attraction force to cat ${n.id}:`,g)}}}})}spawnFoodPellet(a){if(!this.isInitializedSuccessfully||!this.physicsManager||!this.catContainerElement){console.error("Cannot spawn pellet: Falló chequeo inicial."),console.error(` -> Estado: Initialized=${this.isInitializedSuccessfully}, Physics=${!!this.physicsManager}, Container=${!!this.catContainerElement}`);return}const i=`food_${this.nextPelletId++}`,p=F.Bodies.circle(a.x,a.y,se/2,{label:"foodPellet",isSensor:!0,density:1e-4,frictionAir:.02,collisionFilter:{category:Bt,mask:Dt},plugin:{pelletId:i}});try{F.World.add(this.physicsManager.getWorld(),p)}catch(o){console.error(`[SpawnFoodPellet] Error añadiendo cuerpo ${i}:`,o);return}const n=document.createElement("div");n.id=i,n.classList.add("food-pellet"),n.style.width=`${se}px`,n.style.height=`${se}px`,n.style.left="-9999px",n.style.top="-9999px";try{this.catContainerElement.appendChild(n)}catch(o){console.error(`[SpawnFoodPellet] Error añadiendo elemento ${i} al DOM:`,o);try{F.World.remove(this.physicsManager.getWorld(),p)}catch{}return}const e={body:p,element:n,creationTime:performance.now(),id:i};this.activePellets.set(i,e)}update(a){if(!this.isEnabled||!this.isInitializedSuccessfully||this.activePellets.size===0)return;const i=performance.now(),p=[];this.activePellets.forEach(n=>{if(i-n.creationTime>bt)p.push(n.id);else if(n.element&&n.body){const e=se/2;n.element.style.transform=`translate(${n.body.position.x-e}px, ${n.body.position.y-e}px)`,n.element.style.left="",n.element.style.top=""}}),p.forEach(n=>this.removeFoodPellet(n))}removeFoodPellet(a,i=!1){var n;const p=this.activePellets.get(a);if(p){if(this.physicsManager&&p.body)try{F.Composite.get(this.physicsManager.getWorld(),p.body.id,"body")&&F.World.remove(this.physicsManager.getWorld(),p.body)}catch(e){console.warn(`Error removing food pellet body ${a}:`,e)}(n=p.element)==null||n.remove(),this.activePellets.delete(a)}}processCatFoodCollision(a,i){var l,g;const p=(l=i.plugin)==null?void 0:l.pelletId;if(!p||!this.activePellets.has(p)||!this.catManager||!this.playerData||!this.audioManager||!this.physicsManager)return;const n=this.catManager.bodyIdToEntityIdMap.get(a);if(!n)return;const e=this.catManager.getCat(n);if(!e||!e.value||!e.physics.body||!((g=e.render)!=null&&g.element))return;const o=e.value.currentSize,r=this.playerData.getCurrentMaxSizeLimit();let s=Math.min(r,o+Ot);const h=s/o;if(h>1.0001){e.value.currentSize=s;try{if(F.Composite.get(this.physicsManager.getWorld(),e.physics.body.id,"body"))F.Body.scale(e.physics.body,h,h);else throw new Error("Body not found in world")}catch(d){console.error(`Error scaling cat ${e.id} after eating food:`,d),e.value.currentSize=o}}this.audioManager.playSound("eat"),this.removeFoodPellet(p,!0)}destroy(){console.log("CatFoodManager: destroy"),this.removeClickListener(),this.activePellets.forEach(a=>this.removeFoodPellet(a.id)),this.activePellets.clear(),this.isEnabled=!1,this.isActive=!1}}class zt{constructor(a){T(this,"gameManager");this.gameManager=a}enter(a){console.log("LoadingState: enter",a),this.gameManager.setBodyStateClass("loading")}exit(){console.log("LoadingState: exit")}update(a){}}class Ut{constructor(a){T(this,"gameManager");T(this,"containerClickListener",null);T(this,"containerElement",null);T(this,"sparkleIntervalId",null);this.gameManager=a}enter(a){if(console.log("MainMenuState: enter (Whiskers & Wisdom Style)",a),this.gameManager.setBodyStateClass("mainmenu-whiskers"),this.containerElement=this.gameManager.getContainerElement(),!this.containerElement){console.error("MainMenuState: Contenedor principal #app no encontrado.");return}this.containerElement.innerHTML="";const i=document.createElement("div");i.className="paw-wrapper";const p=document.createElement("div");p.className="rainbow-circle";const n=document.createElement("div");n.className="circle-content",p.appendChild(n);const e=document.createElement("span");e.className="title-ampersand font-pacifico",e.textContent="&";const o=document.createElement("div");o.className="container-invisible";const r=document.createElement("div");r.className="title-container";const s=document.createElement("h1");s.className="font-pacifico title-shadow",s.textContent="Whiskers";const h=document.createElement("h1");h.className="font-pacifico title-shadow",h.textContent="Wisdom";const l=document.createElement("span");l.className="animate-paw-wiggle paw-1",l.textContent="🐾";const g=document.createElement("span");g.className="animate-paw-wiggle paw-2",g.textContent="🐾",r.append(s,h,l,g);const d=document.createElement("div");d.id="click-text",d.className="fading-click-text font-poppins",d.textContent="<HAZ CLICK>";const t=document.createElement("div");t.id="loading-message",t.className="mt-10 flex flex-col items-center",t.style.display="none";const u=document.createElement("div");u.className="yarn-spinner mb-4";const c=document.createElement("span");c.className="font-semibold font-geist",c.textContent="Desenredando la diversión...",t.append(u,c),o.append(r,d,t),i.append(p,o);const f=document.createElement("div");f.id="sparkle-container",f.style.position="absolute",f.style.top="0",f.style.left="0",f.style.width="100%",f.style.height="100%",f.style.pointerEvents="none",f.style.zIndex="2",this.containerElement.append(i,e,f),this.containerElement.insertAdjacentHTML("beforeend",`
        <svg id="sparkle-svg-template" style="display: none;" width="50px" height="50px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <defs><style>.cls-sparkle{fill:none;stroke-miterlimit:10; stroke: #fff845; stroke-width: 2px;}</style></defs>
          <line class="cls-sparkle" x1="12" y1="0.5" x2="12" y2="5.29"/>
          <line class="cls-sparkle" x1="12" y1="18.71" x2="12" y2="23.5"/>
          <line class="cls-sparkle" x1="23.5" y1="12" x2="18.71" y2="12"/>
          <line class="cls-sparkle" x1="5.29" y1="12" x2="0.5" y2="12"/>
          <line class="cls-sparkle" x1="20.13" y1="3.87" x2="16.74" y2="7.26"/>
          <line class="cls-sparkle" x1="7.26" y1="16.74" x2="3.87" y2="20.13"/>
          <line class="cls-sparkle" x1="20.13" y1="20.13" x2="16.74" y2="16.74"/>
          <line class="cls-sparkle" x1="7.26" y1="7.26" x2="3.87" y2="3.87"/>
        </svg>
    `);const y=()=>{console.log("Starting Whiskers & Wisdom - Meow!"),this.gameManager.getAudioManager().playSound("ui_confirm"),r&&(r.style.display="none"),p&&(p.style.display="none"),d&&(d.style.display="none"),e&&(e.style.display="none"),l&&(l.style.display="none"),g&&(g.style.display="none"),t&&(t.style.display="flex"),this.sparkleIntervalId&&(clearTimeout(this.sparkleIntervalId),this.sparkleIntervalId=null),this.gameManager.getStateMachine().changeState("QuizGameplay")};this.containerClickListener=y,this.containerElement.style.cursor="pointer",this.containerElement.addEventListener("click",this.containerClickListener,{once:!0}),this.startSparkleEffect(),this.ensureFontsLoaded()}exit(){console.log("MainMenuState: exit (Whiskers & Wisdom Style)"),this.sparkleIntervalId&&(clearTimeout(this.sparkleIntervalId),this.sparkleIntervalId=null),this.containerElement&&this.containerClickListener&&this.containerElement.removeEventListener("click",this.containerClickListener),this.containerClickListener=null,this.containerElement&&(this.containerElement.innerHTML="",this.containerElement.style.cursor=""),this.containerElement=null}update(a){}startSparkleEffect(){const a=()=>{const p=document.getElementById("sparkle-svg-template"),n=document.getElementById("sparkle-container");if(!p||!n)return;const e=p.cloneNode(!0);e.removeAttribute("id"),e.style.display="block",e.classList.add("sparkle-instance");const o=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),r=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),s=50,l=Math.random()*(r-50),g=Math.random()*(o-s);e.style.position="absolute",e.style.top=`${l}px`,e.style.left=`${g}px`,n.appendChild(e),setTimeout(()=>{e.parentNode===n&&n.removeChild(e)},500)},i=()=>{a();const p=Math.random()*150+50;this.sparkleIntervalId=window.setTimeout(i,p)};this.sparkleIntervalId&&clearTimeout(this.sparkleIntervalId),i()}ensureFontsLoaded(){document.fonts&&Promise.all([document.fonts.load("1em Pacifico"),document.fonts.load("1em Geist"),document.fonts.load("1em Poppins")]).then(()=>{}).catch(a=>{console.warn("Error esperando fuentes:",a)})}}class $t{constructor(a){T(this,"gameManager");this.gameManager=a}enter(a){console.log("ResultsState: enter",a),this.gameManager.setBodyStateClass("results")}exit(){console.log("ResultsState: exit")}update(a){}}class Vt{constructor(a){T(this,"gameManager");T(this,"gameOverContainer",null);T(this,"restartListener",null);T(this,"keydownListener",null);this.gameManager=a}enter(a){console.log("GameOverState: enter",a),this.gameManager.setBodyStateClass("gameover");const i=(a==null?void 0:a.finalScore)??0;try{console.log("GameOverState: Limpiando gatos de la partida anterior..."),this.gameManager.getCatManager().removeAllCats()}catch(r){console.error("GameOverState: Error al limpiar gatos:",r)}const p=this.gameManager.getContainerElement();p.innerHTML="",this.gameOverContainer=document.createElement("div"),this.gameOverContainer.className="game-over-container flex flex-col items-center justify-center h-full text-center p-4 bg-gray-900 bg-opacity-90 text-white rounded-lg",this.gameOverContainer.tabIndex=-1;const n=document.createElement("p");n.textContent="A ESTUDIAR!!",n.className="game-over-text text-5xl md:text-6xl font-black text-red-500 mb-4 animate-pulse";const e=document.createElement("p");e.textContent=`Puntaje Final: ${i}`,e.className="final-score text-2xl text-yellow-400 mb-8";const o=document.createElement("p");o.textContent="CLICK O TECLA PARA REINICIAR",o.className="restart-prompt text-lg text-gray-300",this.gameOverContainer.appendChild(n),this.gameOverContainer.appendChild(e),this.gameOverContainer.appendChild(o),p.appendChild(this.gameOverContainer),this.gameOverContainer.focus(),this.gameManager.getAudioManager().playSound("game_over"),this.restartListener=()=>this.triggerRestart(),this.keydownListener=r=>{this.triggerRestart()},this.gameOverContainer.addEventListener("click",this.restartListener),this.gameOverContainer.addEventListener("keydown",this.keydownListener)}triggerRestart(){console.log("Restarting game from GameOver..."),this.gameManager.getStateMachine().changeState("MainMenu")}exit(){console.log("GameOverState: exit"),this.gameOverContainer&&(this.restartListener&&(this.gameOverContainer.removeEventListener("click",this.restartListener),this.restartListener=null),this.keydownListener&&(this.gameOverContainer.removeEventListener("keydown",this.keydownListener),this.keydownListener=null),this.gameOverContainer.parentNode&&this.gameOverContainer.parentNode.removeChild(this.gameOverContainer),this.gameOverContainer=null)}update(a){}}class Wt{constructor(a){T(this,"physicsManager");T(this,"quizSystem");T(this,"stateMachine");T(this,"audioManager");T(this,"catManager");T(this,"playerData");T(this,"shopManager");T(this,"inkManager");T(this,"uiManager");T(this,"themeManager");T(this,"catFoodManager");T(this,"lastTimestamp",0);T(this,"isRunning",!1);T(this,"gameLoopRequestId");T(this,"containerElement");T(this,"previousBodyStateClass",null);T(this,"keydownListener",null);this.containerElement=a,this.audioManager=new Ze,this.quizSystem=new Ye,this.playerData=new pt,this.catManager=new it(this.audioManager,this),this.themeManager=new Pt("body"),this.uiManager=new kt(this),this.shopManager=new gt(this.playerData,this),this.inkManager=new Mt(this),this.catFoodManager=new Nt(this),this.physicsManager=new Ke(this.catManager,this.catFoodManager),this.stateMachine=new Xe,this.catManager.setPhysicsManager(this.physicsManager),this.inkManager.setPhysicsManager(this.physicsManager),this.setupStates()}async init(){console.log("GameManager: init"),this.playerData.reset(),this.physicsManager.init(this.getWorldContainer()),this.catFoodManager.init(),this.addKeyboardListener(),await this.preload(),console.log("GameManager init completado.")}async preload(){console.log("GameManager: preload - Cargando assets...");const a="/data/questions.json",i="/data/cat_templates.json",p="/data/shop_items.json",n="/data/themes.json";try{const[e,o,r,s]=await Promise.all([fetch(a),fetch(i),fetch(p),fetch(n)]);if(!e.ok)throw new Error(`HTTP ${e.status} cargando ${a}`);if(!o.ok)throw new Error(`HTTP ${o.status} cargando ${i}`);if(!r.ok)throw new Error(`HTTP ${r.status} cargando ${p}`);if(!s.ok)throw new Error(`HTTP ${s.status} cargando ${n}`);const h=await e.json(),l=await o.json(),g=await r.json(),d=await s.json();if(!Array.isArray(h))throw new Error("Formato inválido de preguntas.");if(!Array.isArray(l))throw new Error("Formato inválido de plantillas.");if(!Array.isArray(g))throw new Error("Formato inválido de ítems de tienda.");if(!Array.isArray(d))throw new Error("Formato inválido de temas.");if(!await this.quizSystem.loadQuestionsData(h))throw new Error("Fallo al procesar preguntas en QuizSystem.");if(this.catManager.loadTemplates(l),this.shopManager.init(g),!await this.themeManager.loadThemesData(d))throw new Error("Fallo al procesar temas en ThemeManager.");console.log("GameManager: Preload completado exitosamente.")}catch(e){throw console.error("GameManager: Error durante preload:",e),this.containerElement.innerHTML=`Error al cargar assets: ${e.message}. Revisa la consola.`,e}}create(){console.log("GameManager: create"),this.quizSystem.resetAvailableQuestions(),this.catManager.removeAllCats(),this.stateMachine.changeState("MainMenu")}addKeyboardListener(){this.keydownListener||(this.keydownListener=a=>{if(!(a.target instanceof HTMLInputElement||a.target instanceof HTMLTextAreaElement))if(a.key.toLowerCase()==="p"){console.log("Tecla 'P' presionada - Ciclando tema..."),this.themeManager.cycleTheme();const i=this.stateMachine.getCurrentState();i instanceof fe&&i.rebuildInterface()}else a.key.toLowerCase()==="b"?this.playerData.isDrawingUnlocked&&this.activateBrush():a.key.toLowerCase()==="f"&&this.playerData.isCatFoodUnlocked&&this.activateCatFood()},window.addEventListener("keydown",this.keydownListener),console.log("GameManager: Listener de teclado añadido (P, B, F)."))}removeKeyboardListener(){this.keydownListener&&(window.removeEventListener("keydown",this.keydownListener),this.keydownListener=null,console.log("GameManager: Listener de teclado removido."))}gameLoop(a){if(!this.isRunning)return;const i=(a-this.lastTimestamp)/1e3;this.lastTimestamp=a;const p=Math.min(i,.1);this.update(p),this.gameLoopRequestId=requestAnimationFrame(this.gameLoop.bind(this))}update(a){this.stateMachine.update(a),this.catManager.updateCats(a),this.catFoodManager.update(a)}start(){this.isRunning||(console.log("GameManager: Iniciando bucle de juego..."),this.isRunning=!0,this.lastTimestamp=performance.now(),this.physicsManager.start(),this.gameLoopRequestId=requestAnimationFrame(this.gameLoop.bind(this)))}stop(){this.isRunning&&(console.log("GameManager: Deteniendo bucle de juego..."),this.isRunning=!1,this.gameLoopRequestId&&cancelAnimationFrame(this.gameLoopRequestId),this.gameLoopRequestId=void 0,this.physicsManager.stop())}shutdown(){console.log("GameManager: shutdown"),this.stop(),this.removeKeyboardListener(),this.physicsManager.shutdown();const a=this.stateMachine.getCurrentStateName();if(a&&a!=="__shutdown__")try{const i=this.stateMachine.getCurrentState();i==null||i.exit(),this.stateMachine.changeState("__shutdown__")}catch(i){console.warn("Error en exit() durante shutdown:",i)}this.catManager.removeAllCats(),this.inkManager.destroy(),this.shopManager.destroy(),this.catFoodManager.destroy(),this.containerElement.innerHTML="",this.setBodyStateClass(null)}getWorldContainer(){return document.body}setupStates(){this.stateMachine.addState("Loading",new zt(this)),this.stateMachine.addState("MainMenu",new Ut(this)),this.stateMachine.addState("QuizGameplay",new fe(this)),this.stateMachine.addState("Results",new $t(this)),this.stateMachine.addState("GameOver",new Vt(this)),this.stateMachine.addState("__shutdown__",{enter:()=>{},exit:()=>{},update:()=>{}})}setBodyStateClass(a){const i=document.body;if(this.previousBodyStateClass&&i.classList.remove(`state-${this.previousBodyStateClass}`),a){const p=`state-${a}`;i.classList.add(p),this.previousBodyStateClass=a}else this.previousBodyStateClass=null}getLives(){return this.playerData.lives}decrementLives(){this.playerData.lives>0&&(this.playerData.lives--,this.updateExternalLivesUI())}incrementLives(){this.playerData.lives++,this.updateExternalLivesUI()}openShop(){this.shopManager.openShop()}closeShop(){this.shopManager.closeShop()}enableDrawingFeature(){let a=!1;try{console.log("[enableDrawingFeature] STARTING");const i=document.getElementById("right-controls");if(i?i.classList.add("drawing-unlocked"):console.warn("[enableDrawingFeature] #right-controls NOT FOUND. Consider this a failure."),this.inkManager&&typeof this.inkManager.init=="function")console.log("[enableDrawingFeature] Calling inkManager.init()..."),this.inkManager.init(),console.log("[enableDrawingFeature] Calling uiManager.updateInkVisibility(true)..."),this.uiManager.updateInkVisibility(!0),a=!0;else throw console.error("[enableDrawingFeature] InkManager missing or no init method!"),new Error("InkManager not ready during enableDrawingFeature");return console.log("[enableDrawingFeature] FINISHED - Success:",a),a}catch(i){return console.error("!!!!!!!!!!!!!!!!! CRITICAL ERROR in enableDrawingFeature !!!!!!!!!!!!!!!!!!",i),!1}}updateInkUI(){this.inkManager.updateInkUI()}updateExternalLivesUI(){this.uiManager&&this.uiManager.updateLivesDisplay(this.playerData.lives)}updateExternalShieldUI(a){this.uiManager&&this.uiManager.updateShieldIcon(a)}updateExternalHintUI(a){this.uiManager&&this.uiManager.updateHintIcon(a)}updateExternalScoreUI(){this.uiManager&&this.uiManager.updateScoreDisplay(this.playerData.score)}enableCatFoodFeature(){console.log("GameManager: Habilitando función de Comida para Gatos...");try{this.uiManager.showCatFoodUI(),this.catFoodManager.enable(),this.updateCatFoodUI()}catch(a){console.error("GameManager: Error habilitando CatFoodFeature:",a)}}updateCatFoodUI(){try{this.uiManager.updateCatFoodBar(this.playerData.currentCatFood,this.playerData.getMaxCatFood())}catch(a){console.error("GameManager: Error actualizando CatFoodUI:",a)}}activateBrush(){if(!this.playerData.isDrawingUnlocked)return;this.catFoodManager.isActive&&this.catFoodManager.toggleActive(!1),this.inkManager.toggleBrush()}activateCatFood(){if(!this.playerData.isCatFoodUnlocked)return;this.inkManager.isBrushActive&&this.inkManager.toggleBrush(!1),this.catFoodManager.toggleActive()}getQuizSystem(){return this.quizSystem}getPhysicsManager(){return this.physicsManager}getStateMachine(){return this.stateMachine}getAudioManager(){return this.audioManager}getCatManager(){return this.catManager}getShopManager(){return this.shopManager}getPlayerData(){return this.playerData}getInkManager(){return this.inkManager}getUIManager(){if(!this.uiManager)throw new Error("UIManager no inicializado.");return this.uiManager}getThemeManager(){return this.themeManager}getCatFoodManager(){return this.catFoodManager}getContainerElement(){return this.containerElement}getCurrentState(){return this.stateMachine.getCurrentState()}}console.log("DOM Cargado. Iniciando Quiz Felino...");const oe=document.getElementById("app"),be=document.getElementById("shop-button");if(!oe)console.error("Error: Elemento #app no encontrado en el DOM.");else{oe.innerHTML="",console.log("Preparado para inicializar GameManager.");const R=new Wt(oe);window.gameManager=R,console.log("GameManager expuesto como window.gameManager para depuración.");const a=()=>{const i=R.getAudioManager();i.isReady()||(console.log("User interaction detected, attempting to initialize audio..."),i.init())};console.log("Adding one-time listeners for audio initialization..."),document.body.addEventListener("click",a,{once:!0}),document.body.addEventListener("touchstart",a,{once:!0}),be?(console.log("Añadiendo listener al botón de la tienda..."),be.addEventListener("click",()=>{console.log("Botón de tienda clickeado."),R.getAudioManager().isReady()||R.getAudioManager().init(),R.openShop()})):console.warn("Elemento #shop-button no encontrado. El botón de la tienda no funcionará."),R.init().then(()=>{R.create(),R.start(),console.log("GameManager inicializado y arrancado.")}).catch(i=>{console.error("Error durante la inicialización del juego:",i),oe.innerHTML=`Error al cargar el juego: ${i.message}. Revisa la consola.`})}
